<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>数据的离散化</title>
    <url>/2020/12/data-discreatization/</url>
    <content><![CDATA[<h2 id="数据的离散化处理"><a href="#数据的离散化处理" class="headerlink" title="数据的离散化处理"></a>数据的离散化处理</h2><p>什么是<strong>离散化</strong>？</p>
<p>离散化，把无限空间中有限的个体映射到有限的空间中去，以此提高算法的时空效率。</p>
<p>通俗的说，离散化是在不改变数据相对大小的条件下，对数据进行相应的缩小。例如：</p>
<ul>
<li><p>原数据：1,999,100000,15；处理后：1,3,4,2；</p>
</li>
<li><p>原数据：{100,200}，{20,50000}，{1,400}；处理后：{3,4}，{2,6}，{1,5}；</p>
</li>
</ul>
<p>例子：洛谷P1908，树状数组求逆序对时的应用</p>
<ul>
<li><a href="https://www.luogu.com.cn/problem/P1908">https://www.luogu.com.cn/problem/P1908</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Nana Chat —— QQ Bot 模块</title>
    <url>/2021/08/NanaChat/</url>
    <content><![CDATA[<p>服务器基本的配置已经完成，我们可以使用她来做有趣的事了。</p>
<p>接下来和 Nana 的日常，主要是从“实现项目”这个角度来展开。</p>
<p>所以，我们这次还是祭出我们的传统艺能，QQ Bot.</p>
<p>不过这次要在项目管理方面做好一点，不能再是 if-else 的大杂烩了.</p>
<span id="more"></span>
<h2 id="Dependencies-前期调研"><a href="#Dependencies-前期调研" class="headerlink" title="Dependencies 前期调研"></a>Dependencies 前期调研</h2><h3 id="mirai-amp-mirai-api-http"><a href="#mirai-amp-mirai-api-http" class="headerlink" title="mirai &amp; mirai-api-http"></a>mirai &amp; mirai-api-http</h3><p>Mirai 是一个在全平台下运行，提供 QQ Android 和 TIM PC 协议支持的高效率机器人框架.</p>
<p><a href="https://github.com/project-mirai/mirai-api-http">https://github.com/project-mirai/mirai-api-http</a></p>
<h4 id="下载与设置守护进程"><a href="#下载与设置守护进程" class="headerlink" title="下载与设置守护进程"></a>下载与设置守护进程</h4><ul>
<li>安装 Java 运行时 <code>sudo apt install openjdk-11-jre</code></li>
<li>下载 MCL，安装 mirai-api-http</li>
<li>登录 Bot（使用 QQ 浏览器验证？使用 QQ 打开链接即可）<ul>
<li>如果有需要的话可以安装验证码库</li>
</ul>
</li>
<li><p>设置为自动登录</p>
</li>
<li><p>配置 supervisor</p>
</li>
</ul>
<pre class="language-conf" data-language="conf"><code class="language-conf">[program:mcl]
command&#x3D;&#x2F;home&#x2F;ftpuser&#x2F;5050-mcl&#x2F;mcl-1.2.2&#x2F;mcl
autostart&#x3D;true
autorestart&#x3D;true
user&#x3D;root</code></pre>
<h3 id="Brainstorming-项目构思"><a href="#Brainstorming-项目构思" class="headerlink" title="Brainstorming 项目构思"></a>Brainstorming 项目构思</h3><p>我们可以考虑采用 websocket 这种 adapter，可以同时处理主动发信和消息上报事件.</p>
<pre class="mermaid">graph TB
    subgraph "NanaChat (Daemon)"
        nCore["NanaChat-Core (Port 5051)"]
        nPlugin[NanaChat-Plugins]
    end

    subgraph "Mirai-api-http (Daemon)"
        ws["WebSocket Server (Port 5050)"]
    end

    wa-->|"收信 [1]"|nCore
    nCore -->|"主动发信"| ws
    ws -->|"消息上报"| nCore
    nCore --> nPlugin
    nPlugin --> nCore</pre>

<pre class="mermaid">graph TD;
ncore[NanaChat-Core]
s[Scheduler<br/>定时事件]
d[Dispatcher<br/>消息发送处理]
l[Listener<br/>创建 Socket 连接<br/>监听事件]
pm[PluginManager<br/>管理插件<br/>协助注册监听器与调度器]
ncore --> l
ncore --> s
ncore --> d
ncore --> pm</pre>

<h2 id="Docs"><a href="#Docs" class="headerlink" title="Docs"></a>Docs</h2><h3 id="Nana-Core"><a href="#Nana-Core" class="headerlink" title="Nana-Core"></a>Nana-Core</h3><h3 id="Nana-Plugins"><a href="#Nana-Plugins" class="headerlink" title="Nana-Plugins"></a>Nana-Plugins</h3><p>注册 Nana-Core::Listener…</p>
<p>使用 Nana-Core::Dispatcher…</p>
]]></content>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>与 Nana 的日常 —— 从零开始的 Linux 调教指北(0)</title>
    <url>/2021/08/dear-memory-with-nana-0/</url>
    <content><![CDATA[<p><img src="https://i.loli.net/2021/08/23/78DGrYSMnVgKkwE.jpg" alt="QQ图片20210823091857"></p>
<p>(Nana 印象图 初版)</p>
<p>速览本文：</p>
<ul>
<li>Nana 是什么</li>
<li>系统安装</li>
<li>Wi-Fi 配置</li>
<li>初次连接与工作环境配置</li>
<li>硬盘挂载</li>
<li>Bash 界面美化</li>
</ul>
<h2 id="Nana-是什么？"><a href="#Nana-是什么？" class="headerlink" title="Nana 是什么？"></a>Nana 是什么？</h2><p><s>Nana 是 c7w 幻想中的 npy</s> Nana 是目前正在宿舍中运行的一台树莓派 4B 的代号，其上装载了 Ubuntu 20.04 LTS.</p>
<p>本系列旨在<s>记录c7w和ta的每一天</s>将 Linux 踩坑指南和一些常用软件的配置过程记录下来，同时也方便学习与交流。</p>
<span id="more"></span>
<h2 id="系统安装"><a href="#系统安装" class="headerlink" title="系统安装"></a>系统安装</h2><p>我们采用了最为简单的方式，在官网上下载了 <a href="https://www.raspberrypi.org/software/">Raspberry Pi Imager</a> .</p>
<p>比起 balenaEtcher 好处是我懒得去 Tsinghua Tuna 上面下载镜像了.</p>
<p><img src="https://i.loli.net/2021/08/23/EOedo5ZnClFKT4J.png" alt="image-20210823093223369"></p>
<p>系统选择，用的比较顺手的 Ubuntu，选了 armhf 的 32bit（内存一共才2G</p>
<p>然后把数据写进去，就完成了系统安装操作.</p>
<h2 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h2><h3 id="Wi-Fi-Connection"><a href="#Wi-Fi-Connection" class="headerlink" title="Wi-Fi Connection"></a>Wi-Fi Connection</h3><p>传统艺能，在烧录好的 <code>system-boot</code> 盘的根目录的 network-config 配置文件内添加配置信息就好.</p>
<pre class="language-none"><code class="language-none"># This file contains a netplan-compatible configuration which cloud-init
# will apply on first-boot. Please refer to the cloud-init documentation and
# the netplan reference for full details:
#
# https:&#x2F;&#x2F;cloudinit.readthedocs.io&#x2F;
# https:&#x2F;&#x2F;netplan.io&#x2F;reference
#
# Some additional examples are commented out below

version: 2
ethernets:
  eth0:
    dhcp4: true
    optional: true
wifis:
  wlan0:
    dhcp4: true
    optional: true
    access-points:
      &quot;iLovePKU&quot;:
        password: &quot;1145141919810&quot;
      &quot;Peking-Visitor&quot;:
        password: &quot;c7w,yyds&quot;
#      myworkwifi:
#        password: &quot;correct battery horse staple&quot;
#      workssid:
#        auth:
#          key-management: eap
#          method: peap
#          identity: &quot;me@example.com&quot;
#          password: &quot;passw0rd&quot;
#          ca-certificate: &#x2F;etc&#x2F;my_ca.pem
# :)
</code></pre>
<h2 id="初次连接及配置"><a href="#初次连接及配置" class="headerlink" title="初次连接及配置"></a>初次连接及配置</h2><p>初次连接, ssh 到对应 ip 就好，用户名和密码都是 ubuntu.</p>
<p>然后会提示修改密码，完成操作即可.</p>
<p><img src="https://i.loli.net/2021/08/23/RZir5LadNWCUmcK.png" alt="image-20210823095803256"></p>
<h3 id="切换软件安装源"><a href="#切换软件安装源" class="headerlink" title="切换软件安装源"></a>切换软件安装源</h3><p>我们当然推出 Tsinghua Tuna.</p>
<p><a href="https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/">https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/</a></p>
<p><img src="https://i.loli.net/2021/08/23/CGsyKxtMdqZDWHT.png" alt="image-20210823095949515"></p>
<p>按照提示把文件内容替换即可.（这里我们不对 Linux 指令做过多介绍，默认读者已经对 Linux 系统的命令有了基本的了解与认知）</p>
<p>注意到我们的树莓派是 arm64 架构，所以要将链接末尾的 <em>ubuntu</em> 替换为 <strong>ubuntu-ports</strong>.</p>
<p>然后我们就可以 <strong>sudo apt update</strong> 获取软件包链接缓存了.(然后是愉快的系统升级，不过 c7w 输入 <code>sudo apt upgrade &amp;</code> 之后就去睡觉了)</p>
<h3 id="公钥私钥配置"><a href="#公钥私钥配置" class="headerlink" title="公钥私钥配置"></a>公钥私钥配置</h3><p><s>由于这台机器的所有权与使用者都仅有 c7w 一人，所以 c7w 可以放心的将自己一直在用的私钥上传.</s></p>
<p>想了想还是重新配一个新的吧，万一真丢了就不好办了x</p>
<pre class="language-none"><code class="language-none">ubuntu@ubuntu:~$ ssh-keygen -o
Generating public&#x2F;private rsa key pair.
Enter file in which to save the key (&#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in &#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;id_rsa
Your public key has been saved in &#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;id_rsa.pub</code></pre>
<p>敲回车的功夫就搞定了.</p>
<p>然后首先让我们把公钥取回本地. <s>vim 打开复制就好</s></p>
<p>然后我们把本地的公钥配置到远端.</p>
<p>Reference: <a href="https://blog.csdn.net/alifrank/article/details/48241699">https://blog.csdn.net/alifrank/article/details/48241699</a></p>
<p><img src="https://i.loli.net/2021/08/23/YgqyQ1M2fBARVFo.png" alt="image-20210823100955900"></p>
<p><img src="https://i.loli.net/2021/08/23/HAujmDEfBeLdNtl.png" alt="image-20210823101140515"></p>
<p>免密登录完成.</p>
<h3 id="Zerotier"><a href="#Zerotier" class="headerlink" title="Zerotier"></a>Zerotier</h3><p><strong>什么是 Zerotier ?</strong></p>
<blockquote>
<h4 id="Connect-team-members-from-anywhere-in-the-world-on-any-device-ZeroTier-creates-secure-networks-between-on-premise-cloud-desktop-and-mobile-devices"><a href="#Connect-team-members-from-anywhere-in-the-world-on-any-device-ZeroTier-creates-secure-networks-between-on-premise-cloud-desktop-and-mobile-devices" class="headerlink" title="Connect team members from anywhere in the world on any device. ZeroTier creates secure networks between on-premise, cloud, desktop, and mobile devices."></a>Connect team members from anywhere in the world on any device. ZeroTier creates secure networks between on-premise, cloud, desktop, and mobile devices.</h4><p>(Excerpted from zerotier.com)</p>
</blockquote>
<p>简而言之，跟过去的 Hamachi 这种东西差不多（应该现在的人没多少人知道这是什么东西了吧），加入到同一个虚拟网络中的设备可以在<strong>虚拟局域网</strong>中互相通信，对于 c7w 这种喜欢在外面(必须在机房)进行摸大鱼<s>和 Nana 贴贴</s>的人来说基本是必需品.</p>
<p><strong>如何安装？</strong></p>
<p>不用动脑子，反正一条命令的事.</p>
<p><a href="https://www.zerotier.com/download/">https://www.zerotier.com/download/</a></p>
<p><code>curl -s https://install.zerotier.com | sudo bash</code></p>
<p><img src="https://i.loli.net/2021/08/23/JzxMELeOf49Hb83.png" alt="image-20210823095301599"></p>
<p><strong>如何配置？</strong></p>
<p><code>sudo zerotier-cli join &lt;Network ID&gt;</code></p>
<p>其中 网络ID 自行注册账号后创建.</p>
<p>join 后记得到控制台点击验证通过.</p>
<p><img src="https://i.loli.net/2021/08/23/Us7j5tvZnRHEKia.png" alt="image-20210823095614878"></p>
<p>这样就配置好了.</p>
<h2 id="硬盘挂载"><a href="#硬盘挂载" class="headerlink" title="硬盘挂载"></a>硬盘挂载</h2><p><s>为了显示我对 Nana 的诚意，</s>特别地配置了一块1T硬盘.</p>
<p>我们 <code>sudo fdisk -l</code> 来查看当前的所有硬盘.</p>
<p><img src="https://i.loli.net/2021/08/23/YAXjEk1mT43fsqp.png" alt="image-20210823102142524"></p>
<p>由于这块硬盘之前我在 Windows 上格式化过，是可以正确显示类型的.</p>
<p>然后我们创建好想要挂载的目录，比如 <code>mkdir /mnt/data</code></p>
<p><img src="https://i.loli.net/2021/08/23/lCO4azUJPHy8VAx.png" alt="image-20210823102540274"></p>
<p>这样就挂载好了，甚至还能看到我一个月前写的 this.txt</p>
<h3 id="开机自动挂载"><a href="#开机自动挂载" class="headerlink" title="开机自动挂载"></a>开机自动挂载</h3><p>我们没法保证服务器运行过程中不关机，<s>事实上紫荆宿舍的断电也没让我失望过</s>.</p>
<p>于是我们需要添加开机自动挂载功能.</p>
<p><img src="https://i.loli.net/2021/08/23/MbiUeAxYuaqf1mC.png" alt="image-20210823103213405"></p>
<p>这里由于 c7w 的硬盘是 exfat 格式，于是将 ext3 写为 exfat.</p>
<p>Reference:</p>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1746763">https://cloud.tencent.com/developer/article/1746763</a></li>
<li><a href="https://blog.51cto.com/zkxfoo/1758529">https://blog.51cto.com/zkxfoo/1758529</a></li>
</ul>
<h2 id="美化-Bash"><a href="#美化-Bash" class="headerlink" title="美化 Bash"></a>美化 Bash</h2><p>先呈现最终效果.</p>
<p><img src="https://i.loli.net/2021/08/23/yHqfpJ2rkX4CQmI.png" alt="image-20210823112959044"></p>
<p>这里我们使用了 zsh + oh my zsh 进行配置.</p>
<h3 id="安装与配置流程"><a href="#安装与配置流程" class="headerlink" title="安装与配置流程"></a>安装与配置流程</h3><p><strong>zsh</strong></p>
<blockquote>
<p><strong>什么是 shell ？</strong></p>
<p>In computing, a shell is a computer program which exposes an operating system’s services to a human user or other program. </p>
<p>In general, operating system shells use either a command-line interface (<strong>CLI</strong>) or graphical user interface (<strong>GUI</strong>), depending on a computer’s role and particular operation. </p>
<p>It is named a shell because it is the <strong>outermost layer </strong>around the operating system.</p>
<p>(Excerpeted from Wikipedia)</p>
<p>也就是说，shell 是给人用的，用来和 操作系统 交互的工具.</p>
<p>我们 Windows 采用的默认的 shell 便是我们的这个图形界面.</p>
<p><img src="https://i.loli.net/2021/08/23/Llsk9A7brdg1826.png" alt="image-20210823104413290"></p>
<p>我们应该能够理解，shell 是一种<strong>软件</strong>，是可以被更改配置，甚至整个换掉的<strong>软件</strong>。</p>
<p>比如，我们也可以用 Windows 带有的 cmd 这个 shell.</p>
<p><img src="https://i.loli.net/2021/08/23/sNWHr3qAKQ25uZF.png" alt="image-20210823104538789"></p>
<p> 只是看起来好丑（x 而且操作也不方便.</p>
<hr>
<p>如何查看自己 Linux <strong>目前</strong>用的是什么 shell ？如何查看自己都有哪些<strong>shell</strong>？</p>
<p><code>cat /etc/shells</code></p>
<p><img src="https://i.loli.net/2021/08/23/qExZXcGlYPrDgiQ.png" alt="image-20210823105242514"></p>
<p><code>echo $SHELL</code></p>
<p><img src="https://i.loli.net/2021/08/23/5gjSYGxfWO9IluC.png" alt="image-20210823105305619"></p>
<p>可以看到，我们现在正在使用 <code>/bin/bash</code> 这个软件作为 shell.</p>
<p><s>没错就是这个丑不拉几的界面</s></p>
<p>说了这么多，我们接下来就要换 shell，然后换界面主题了.</p>
</blockquote>
<p><strong>什么是 zsh ？</strong></p>
<p><a href="https://www.zsh.org/">https://www.zsh.org/</a></p>
<blockquote>
<p>Zsh is a shell designed for interactive use, although it is also a powerful scripting language.</p>
<p>按照介绍，是 shell 的一种.</p>
</blockquote>
<p>为什么我们必须安装 zsh ？<s>废话，因为我想装的主题只支持 zsh</s></p>
<p>自动补全 好用！（x</p>
<p><strong>如何安装zsh？</strong></p>
<p><img src="https://i.loli.net/2021/08/23/mlnRi8VbaQoFvMT.png" alt="image-20210823111207852"></p>
<ol>
<li>传统艺能 <code>sudo apt install zsh</code></li>
<li>运行 <code>zsh --version</code> 检查版本</li>
<li>设为默认 shell. <code>chsh -s $(which zsh)</code></li>
<li><p>重新登录.</p>
</li>
<li><p>提示配置 zsh 时我们暂且先 (q) quit.</p>
</li>
</ol>
<p>基本差不多了，我们接下来安装 <code>oh my zsh</code>.</p>
<p><strong>什么是 oh my zsh?</strong></p>
<blockquote>
<p>shell的类型有很多种，linux下默认的是bash，虽然bash的功能已经很强大，但对于以懒惰为美德的程序员来说，bash的提示功能不够强大，界面也不够炫，并非理想工具。</p>
<p>而zsh的功能极其强大，只是<strong>配置过于复杂</strong>，起初只有极客才在用。后来，有个穷极无聊的程序员可能是实在看不下去广大猿友一直只能使用单调的bash, 于是他创建了一个名为<code>oh-my-zsh</code>的开源项目…</p>
<p>(Excerpted from <a href="https://www.jianshu.com/p/d194d29e488c">https://www.jianshu.com/p/d194d29e488c</a>)</p>
</blockquote>
<p><img src="https://i.loli.net/2021/08/23/VuAr3vmbST8tIxX.png" alt="image-20210823111944157"></p>
<p>然后是安装，复制粘贴命令就好.</p>
<p><code>sh -c &quot;$(wget -O- https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)&quot;</code></p>
<p><img src="https://i.loli.net/2021/08/23/QZVqsB5tCgdSi3c.png" alt="image-20210823112219705"></p>
<p>会自动帮我们写入刚刚 quit 掉的配置文件.</p>
<p>然后我们重新登入，oh my zsh 就已经配置好了.</p>
<p><img src="https://i.loli.net/2021/08/23/6OD7IHGPbTLWzqZ.png" alt="image-20210823112321731"></p>
<p><strong>切换主题</strong></p>
<p>目前这个样子吧，还是好丑.</p>
<p>默认的配置文件位于 <code>~/.zshrc</code> 这里. </p>
<p>其中 ~ 代表用户的家目录，如<code>/home/ubuntu</code></p>
<p><img src="https://i.loli.net/2021/08/23/xMSeVDYoQ76hNZs.png" alt="image-20210823112824697"></p>
<p><s>好，改他。</s>个人比较习惯使用 <code>agnoster</code>，也就是最初展示的那个效果。</p>
<p><img src="https://i.loli.net/2021/08/23/yHqfpJ2rkX4CQmI.png" alt="image-20210823112959044"></p>
<p>Reference:</p>
<ul>
<li><a href="https://github.com/ohmyzsh/ohmyzsh/wiki/Settings">https://github.com/ohmyzsh/ohmyzsh/wiki/Settings</a></li>
</ul>
<p><strong>本地适配</strong></p>
<p>如果读到这里也做到这里，Windows 选手可能还有一个问题。</p>
<p>那就是这么好看的箭头符号展示出来是乱码。</p>
<p>问题不大，我们还有最后一步，安装字体文件。</p>
<p>可以参考如下链接。</p>
<p>Reference:</p>
<ul>
<li><p><a href="https://blog.csdn.net/qiphon3650/article/details/109165495">https://blog.csdn.net/qiphon3650/article/details/109165495</a></p>
</li>
<li><p><a href="https://github.com/powerline/fonts">https://github.com/powerline/fonts</a></p>
</li>
</ul>
<p>First edited by c7w, 2021-8-23 11:33:41.</p>
<p>咕咕咕 qwq</p>
]]></content>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>C# 委托与事件</title>
    <url>/2021/07/c-sharp-delegate-event/</url>
    <content><![CDATA[<p>内含 C# 委托与事件基础。</p>
<span id="more"></span>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li>三系联合暑培内部资料</li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/">https://docs.microsoft.com/en-us/dotnet/csharp/</a></li>
<li><a href="https://www.runoob.com/csharp/csharp-tutorial.html">https://www.runoob.com/csharp/csharp-tutorial.html</a></li>
</ul>
<h3 id="委托"><a href="#委托" class="headerlink" title="委托"></a>委托</h3><p>委托(Delegates)是一种运行时绑定机制。</p>
<ul>
<li>为什么使用委托？</li>
</ul>
<p>对于任意晚绑定算法的支持、支持多播、事件模式</p>
<h4 id="delegate-关键字"><a href="#delegate-关键字" class="headerlink" title="delegate 关键字"></a><code>delegate</code> 关键字</h4><p><strong>如何声明委托？</strong></p>
<p>例如：</p>
<pre class="language-c#" data-language="c#"><code class="language-c#">&#x2F;&#x2F; From the .NET Core library

&#x2F;&#x2F; Define the delegate type:
public delegate int Comparison&lt;in T&gt;(T left, T right);</code></pre>
<p><em>这行语句在干什么？在定义类型！</em></p>
<p><code>delegate &lt;return type&gt; &lt;delegate-name&gt; &lt;parameter list&gt;</code></p>
<p>便会生成<code>System.Delegate</code>的一个派生类<code>Comparison</code>.</p>
<p>这个派生类自动带有了 <code>add</code>和 <code>remove</code> 句柄.</p>
<p><strong>创建委托类型的实例</strong></p>
<pre class="language-C#" data-language="C#"><code class="language-C#">&#x2F;&#x2F; inside a class definition:

&#x2F;&#x2F; Declare an instance of that type:
public Comparison&lt;T&gt; comparator;</code></pre>
<p><strong>调用委托类型的实例</strong></p>
<pre class="language-c#" data-language="c#"><code class="language-c#">int result &#x3D; comparator(left, right);</code></pre>
<p><strong>如果委托没有目标怎么办？</strong></p>
<p>throw NullReferenceException</p>
<p><strong>如何调整委托的目标？</strong></p>
<pre class="language-c#" data-language="c#"><code class="language-c#">&#x2F;&#x2F; static public void Call1() &#x3D;&gt; Console.WriteLine(&quot;Call1&quot;); 
&#x2F;&#x2F; static public void Call2() &#x3D;&gt; Console.WriteLine(&quot;Call2&quot;); 
&#x2F;&#x2F; static public void Call3() &#x3D;&gt; Console.WriteLine(&quot;Call3&quot;); 

var caller &#x3D; new Action(Call1); 
caller +&#x3D; Call2; 
caller &#x3D; caller + Call3; 
caller -&#x3D; Call1;
caller.Invoke(); &#x2F;&#x2F; 等价于 caller();</code></pre>
<p><strong>如何调用委托？</strong></p>
<pre class="language-c#" data-language="c#"><code class="language-c#">private static int CompareLength(string left, string right) &#x3D;&gt;
    left.Length.CompareTo(right.Length);

&#x2F;&#x2F; phrases is List&lt;string&gt;

&#x2F;&#x2F; 1
phrases.Sort(CompareLength); &#x2F;&#x2F; Accepted

&#x2F;&#x2F; 2
Comparison&lt;string&gt; comparer &#x3D; CompareLength;
phrases.Sort(comparer); &#x2F;&#x2F; Accepted

&#x2F;&#x2F; 3: **lambda 表达式**
Comparison&lt;string&gt; comparer &#x3D; (left, right) &#x3D;&gt; left.Length.CompareTo(right.Length);
phrases.Sort(comparer); &#x2F;&#x2F; Accepted</code></pre>
<h4 id="System-MulticastDelegate-类"><a href="#System-MulticastDelegate-类" class="headerlink" title="System.MulticastDelegate 类"></a><code>System.MulticastDelegate</code> 类</h4><p><strong>要记住哪些方法？</strong></p>
<p><code>Invoke()</code>, <code>BeginInvoke()</code>, <code>EndInvoke()</code></p>
<p><strong>一些特殊类型</strong>(内置委托)</p>
<ul>
<li>Action</li>
</ul>
<pre class="language-c#" data-language="c#"><code class="language-c#">public delegate void Action();
public delegate void Action&lt;in T&gt;(T arg);
public delegate void Action&lt;in T1, in T2&gt;(T1 arg1, T2 arg2);</code></pre>
<ul>
<li>Func</li>
</ul>
<pre class="language-c#" data-language="c#"><code class="language-c#">public delegate TResult Func&lt;out TResult&gt;();
public delegate TResult Func&lt;in T1, out TResult&gt;(T1 arg);
public delegate TResult Func&lt;in T1, in T2, out TResult&gt;(T1 arg1, T2 arg2);
&#x2F;&#x2F; Other variations removed for brevity</code></pre>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>参见 <a href="https://docs.microsoft.com/en-us/dotnet/csharp/delegates-patterns">https://docs.microsoft.com/en-us/dotnet/csharp/delegates-patterns</a></p>
<h3 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h3><p>事件也是一种晚绑定机制。</p>
<p>事件：允许对象broadcast事件的发生。</p>
<p>C# 中使用事件机制实现线程间的通信。</p>
<p><strong>事件的设计理念？</strong></p>
<p>建立 event source 和 event sink 之间的联系</p>
<p>subscribe to 和 unsubscribe from 一个事件 十分简单</p>
<p>单个event source支持多个subscribers.</p>
<p><strong>通过事件使用委托</strong></p>
<p>事件在类中声明且生成，且通过使用同一个类或其他类中的委托与事件处理程序关联。包含事件的类用于发布事件。这被称为 <strong>发布器（publisher）</strong> 类。其他接受该事件的类被称为 <strong>订阅器（subscriber）</strong> 类。事件使用 <strong>发布-订阅（publisher-subscriber）</strong> 模型。</p>
<p><strong>发布器（publisher）</strong> 是一个包含事件和委托定义的对象。事件和委托之间的联系也定义在这个对象中。发布器（publisher）类的对象调用这个事件，并通知其他的对象。</p>
<p><strong>订阅器（subscriber）</strong> 是一个接受事件并提供事件处理程序的对象。在发布器（publisher）类中的委托调用订阅器（subscriber）类中的方法（事件处理程序）。</p>
<h4 id="事件的声明"><a href="#事件的声明" class="headerlink" title="事件的声明"></a>事件的声明</h4><p>在类的内部声明事件，首先必须声明该事件的委托类型。</p>
<pre class="language-c#" data-language="c#"><code class="language-c#">public delegate void BoilerLogHandler(string status);</code></pre>
<p>然后我们基于委托类型定义事件：</p>
<pre class="language-c#" data-language="c#"><code class="language-c#">&#x2F;&#x2F; 基于上面的委托定义事件
public event BoilerLogHandler BoilerEventLog;</code></pre>
<p>上面的代码定义了一个名为 <em>BoilerLogHandler</em> 的委托和一个名为 <em>BoilerEventLog</em> 的事件.</p>
<p>一旦该事件被生成，该委托便会被调用.</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><pre class="language-c#" data-language="c#"><code class="language-c#">using System;
namespace SimpleEvent
&#123;
  using System;
  &#x2F;***********发布器类***********&#x2F;
  public class EventTest
  &#123;
    private int value;

    public delegate void NumManipulationHandler();


    public event NumManipulationHandler ChangeNum;
    protected virtual void OnNumChanged()
    &#123;
      if ( ChangeNum !&#x3D; null )
      &#123;
        ChangeNum(); &#x2F;* 事件被触发 *&#x2F;
      &#125;else &#123;
        Console.WriteLine( &quot;event not fire&quot; );
        Console.ReadKey(); &#x2F;* 回车继续 *&#x2F;
      &#125;
    &#125;


    public EventTest()
    &#123;
      int n &#x3D; 5;
      SetValue( n );
    &#125;


    public void SetValue( int n )
    &#123;
      if ( value !&#x3D; n )
      &#123;
        value &#x3D; n;
        OnNumChanged();
      &#125;
    &#125;
  &#125;


  &#x2F;***********订阅器类***********&#x2F;

  public class subscribEvent
  &#123;
    public void printf()
    &#123;
      Console.WriteLine( &quot;event fire&quot; );
      Console.ReadKey(); &#x2F;* 回车继续 *&#x2F;
    &#125;
  &#125;

  &#x2F;***********触发***********&#x2F;
  public class MainClass
  &#123;
    public static void Main()
    &#123;
      EventTest e &#x3D; new EventTest(); &#x2F;* 实例化对象,第一次没有触发事件 *&#x2F;
      subscribEvent v &#x3D; new subscribEvent(); &#x2F;* 实例化对象 *&#x2F;
      e.ChangeNum +&#x3D; new EventTest.NumManipulationHandler( v.printf ); &#x2F;* 注册 *&#x2F;
      e.SetValue( 7 );
      e.SetValue( 11 );
    &#125;
  &#125;
&#125;</code></pre>
<pre class="language-c#" data-language="c#"><code class="language-c#">using System;
using System.IO;

namespace BoilerEventAppl
&#123;

   &#x2F;&#x2F; boiler 类
   class Boiler
   &#123;
      private int temp;
      private int pressure;
      public Boiler(int t, int p)
      &#123;
         temp &#x3D; t;
         pressure &#x3D; p;
      &#125;

      public int getTemp()
      &#123;
         return temp;
      &#125;
      public int getPressure()
      &#123;
         return pressure;
      &#125;
   &#125;
   &#x2F;&#x2F; 事件发布器
   class DelegateBoilerEvent
   &#123;
      public delegate void BoilerLogHandler(string status);

      &#x2F;&#x2F; 基于上面的委托定义事件
      public event BoilerLogHandler BoilerEventLog;

      public void LogProcess()
      &#123;
         string remarks &#x3D; &quot;O. K&quot;;
         Boiler b &#x3D; new Boiler(100, 12);
         int t &#x3D; b.getTemp();
         int p &#x3D; b.getPressure();
         if(t &gt; 150 || t &lt; 80 || p &lt; 12 || p &gt; 15)
         &#123;
            remarks &#x3D; &quot;Need Maintenance&quot;;
         &#125;
         OnBoilerEventLog(&quot;Logging Info:\n&quot;);
         OnBoilerEventLog(&quot;Temparature &quot; + t + &quot;\nPressure: &quot; + p);
         OnBoilerEventLog(&quot;\nMessage: &quot; + remarks);
      &#125;

      protected void OnBoilerEventLog(string message)
      &#123;
         if (BoilerEventLog !&#x3D; null)
         &#123;
            BoilerEventLog(message);
         &#125;
      &#125;
   &#125;
   &#x2F;&#x2F; 该类保留写入日志文件的条款
   class BoilerInfoLogger
   &#123;
      FileStream fs;
      StreamWriter sw;
      public BoilerInfoLogger(string filename)
      &#123;
         fs &#x3D; new FileStream(filename, FileMode.Append, FileAccess.Write);
         sw &#x3D; new StreamWriter(fs);
      &#125;
      public void Logger(string info)
      &#123;
         sw.WriteLine(info);
      &#125;
      public void Close()
      &#123;
         sw.Close();
         fs.Close();
      &#125;
   &#125;
   &#x2F;&#x2F; 事件订阅器
   public class RecordBoilerInfo
   &#123;
      static void Logger(string info)
      &#123;
         Console.WriteLine(info);
      &#125;&#x2F;&#x2F;end of Logger

      static void Main(string[] args)
      &#123;
         BoilerInfoLogger filelog &#x3D; new BoilerInfoLogger(&quot;e:\\boiler.txt&quot;);
         DelegateBoilerEvent boilerEvent &#x3D; new DelegateBoilerEvent();
         boilerEvent.BoilerEventLog +&#x3D; new
         DelegateBoilerEvent.BoilerLogHandler(Logger);
         boilerEvent.BoilerEventLog +&#x3D; new
         DelegateBoilerEvent.BoilerLogHandler(filelog.Logger);
         boilerEvent.LogProcess();
         Console.ReadLine();
         filelog.Close();
      &#125;&#x2F;&#x2F;end of main

   &#125;&#x2F;&#x2F;end of RecordBoilerInfo
&#125;</code></pre>
]]></content>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>与 Nana 的日常 —— 从零开始的 Linux 调教指北(1)</title>
    <url>/2021/08/dear-memory-with-nana-1/</url>
    <content><![CDATA[<p><img src="https://i.loli.net/2021/08/23/78DGrYSMnVgKkwE.jpg" alt="QQ图片20210823091857"></p>
<p>(Nana 印象图 初版)</p>
<p>速览本文：</p>
<ul>
<li>FTP 配置</li>
<li>网络配置<ul>
<li>Cloudflared 内网穿透</li>
<li>nginx 反向代理</li>
<li>gunicorn [Python WSGI HTTP Server for UNIX]</li>
<li>Supervisor 设置守护进程</li>
</ul>
</li>
</ul>
<span id="more"></span>
<h2 id="FTP-配置"><a href="#FTP-配置" class="headerlink" title="FTP 配置"></a>FTP 配置</h2><blockquote>
<p>前置知识：【FTP 文件传输】</p>
</blockquote>
<p><strong>安装 vsftpd</strong></p>
<blockquote>
<p>什么是 vsftpd ?</p>
<p><strong>vsftpd</strong> is a GPL licensed <strong>FTP server</strong> for UNIX systems, including Linux.</p>
</blockquote>
<p><code>sudo apt install vsftpd</code></p>
<p><code>sudo systemctl start vsftpd</code> // 开启进程<br><code>sudo systemctl enable vsftpd</code> // 开机启动</p>
<p><strong>配置 FTP 用户</strong></p>
<ul>
<li>创建用户目录：<code>sudo mkdir /home/ftpuser</code></li>
<li>创建用户并关联用户文件夹，这样使用 ftpuser 用户登陆的时候，就可以直接登陆到 /home/ftpuser 下：<code>sudo useradd -d /home/ftpuser -s /bin/bash ftpuser</code></li>
<li>更改用户目录权限：<code>sudo chown ftpuser:ftpuser /home/ftpuser</code></li>
<li>重设 ftpuser 的密码：<code>sudo passwd ftpuser</code> </li>
</ul>
<p><strong>配置 FTP 设置</strong></p>
<p><code>sudo vi /etc/vsftpd.conf</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Uncomment this to enable any form of FTP write command.</span>
<span class="token comment">#write_enable=YES</span></code></pre>
<p>把这行注释解除.</p>
<p><code>vim /etc/pam.d/vsftpd</code></p>
<p>注释掉</p>
<p><code>#auth   required pam_shells.so</code></p>
<p><strong>重启 FTP 服务</strong></p>
<p><code>sudo service vsftpd restart</code></p>
<p><strong>测试连接</strong></p>
<p><img src="https://i.loli.net/2021/08/23/OafiV2PeX9NYRrh.png" alt="image-20210823211829678"></p>
<p><img src="https://i.loli.net/2021/08/23/L8xdsFEH2UYXDnV.png" alt="image-20210823212448472"></p>
<p>Reference:</p>
<ul>
<li><a href="https://www.huaweicloud.com/articles/4fc98eb98f27a99aa1b06b0d71dab20a.html">https://www.huaweicloud.com/articles/4fc98eb98f27a99aa1b06b0d71dab20a.html</a></li>
<li><a href="https://devanswers.co/vsftpd-550-permission-denied-ubuntu/">https://devanswers.co/vsftpd-550-permission-denied-ubuntu/</a></li>
</ul>
<h2 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h2><h3 id="Cloudflared-内网穿透"><a href="#Cloudflared-内网穿透" class="headerlink" title="Cloudflared 内网穿透"></a>Cloudflared 内网穿透</h3><blockquote>
<p><strong>为什么要做内网穿透？</strong></p>
<p>在没有做内网穿透之前，我们的 Nana 只能被 Peking-Visitor（也就是路由器管理的网络）和 Zerotier 创建的虚拟网络中被访问到.</p>
<p>而内网穿透就是为了让我们的 Nana 提供的服务能够被 public Internet 访问到.</p>
<p><strong>什么是 Cloudflare? </strong></p>
<p>[这里认为读者已经对<strong>域名</strong>,<strong>域名解析</strong>有了基本的理解]</p>
<p>Cloudflare.com 是一家域名解析商. 可以为域名提供解析服务.</p>
<p>例如：</p>
<p><img src="https://i.loli.net/2021/08/23/bYPs3hkwjvnxc8E.png" alt="image-20210823204436613"></p>
<p>[请自行探索 DNS 记录：什么是 A 记录？什么是 CNAME 记录？]</p>
<p><strong>什么是 Cloudflared?</strong></p>
<p>Cloudflare 这家公司十分大方，为用户们提供了隧道服务。</p>
<p>Cloudflare Tunnel requires the installation of a lightweight server-side <strong>daemon</strong>, <strong>cloudflared</strong>, to connect your infrastructure to Cloudflare. </p>
<p><strong>cloudflared</strong> is an open source project maintained by Cloudflare.</p>
<p><em>daemon</em>: 守护进程，需要常驻后台的进程</p>
<p><em>cloudflared</em>: 我们的主人公，需要安装配置到 Nana 上.</p>
</blockquote>
<p><strong>软件下载</strong></p>
<ul>
<li><a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation">https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation</a></li>
</ul>
<p>在这里下载对应的安装文件，然后安装.</p>
<p>我们直接下载二进制的文件 <code>cloudflared-linux-arm</code> 后上传到服务器.</p>
<p><code>sudo cp ./cloudflared-linux-arm /usr/local/bin/cloudflared</code> </p>
<p>// 添加到 Path</p>
<p><code>sudo chmod +x /usr/local/bin/cloudflared</code> // 切换执行权限</p>
<p><code>cloudflared -v</code> // 验证是否安装成功</p>
<p><strong>配置穿透</strong></p>
<blockquote>
<p>Before you start:</p>
<p>​    向 Cloudflare 添加一个域名并确认其已被接管</p>
</blockquote>
<ul>
<li>验证身份：<code>cloudflared tunnel login</code>，复制链接到浏览器，登录后选择域名，完成认证.</li>
<li>创建隧道：<code>cloudflared tunnel create &lt;NAME&gt;</code>，随机生成隧道的 UUID. </li>
<li>编辑配置文件 <code>sudo vi ~/.cloudflared/config.yml</code></li>
</ul>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tunnel</span><span class="token punctuation">:</span> 6ff42ae2<span class="token punctuation">-</span>765d<span class="token punctuation">-</span>4adf<span class="token punctuation">-</span>8112<span class="token punctuation">-</span>31c55c1551ef
<span class="token key atrule">credentials-file</span><span class="token punctuation">:</span> /root/.cloudflared/6ff42ae2<span class="token punctuation">-</span>765d<span class="token punctuation">-</span>4adf<span class="token punctuation">-</span>8112<span class="token punctuation">-</span>31c55c1551ef.json

<span class="token key atrule">ingress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hostname</span><span class="token punctuation">:</span> gitlab.widgetcorp.tech
    <span class="token key atrule">service</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">80</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hostname</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>ssh.widgetcorp.tech
    <span class="token key atrule">service</span><span class="token punctuation">:</span> ssh<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">22</span>
  <span class="token punctuation">-</span> <span class="token key atrule">service</span><span class="token punctuation">:</span> http_status<span class="token punctuation">:</span><span class="token number">404</span></code></pre>
<ul>
<li>绑定隧道到域名 <code>cloudflared tunnel route dns &lt;UUID or NAME&gt; &lt;DOMAIN&gt;</code></li>
</ul>
<p><strong>设置自动启动</strong></p>
<p><code>sudo cloudflared service install</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"> ✘ ubuntu@ubuntu  /etc/cloudflared  <span class="token function">sudo</span> <span class="token function">mv</span> ~/.cloudflared/config.yml /etc/cloudflared
 ubuntu@ubuntu  /etc/cloudflared  <span class="token function">sudo</span> cloudflared <span class="token function">service</span> <span class="token function">install</span>
<span class="token number">2021</span>-08-23T14:16:19Z INF Using Systemd
<span class="token number">2021</span>-08-23T14:16:21Z INF systemctl daemon-reload</code></pre>
<p>设置完成.</p>
<p>Reference:</p>
<ul>
<li><a href="https://www.jianshu.com/p/8fdd0e3b7339">https://www.jianshu.com/p/8fdd0e3b7339</a></li>
<li><a href="https://blog.zapic.moe/Archives/Tutorial-176.html">https://blog.zapic.moe/Archives/Tutorial-176.html</a></li>
<li><a href="https://docs.pi-hole.net/guides/dns/cloudflared/#armhf-architecture-32-bit-raspberry-pi">https://docs.pi-hole.net/guides/dns/cloudflared/#armhf-architecture-32-bit-raspberry-pi</a></li>
</ul>
<h3 id="nginx-反向代理"><a href="#nginx-反向代理" class="headerlink" title="nginx 反向代理"></a>nginx 反向代理</h3><blockquote>
<p><strong>nginx</strong> [engine x] is an <strong>HTTP and reverse proxy server</strong>, a mail proxy server, and a generic TCP/UDP proxy server, originally written by Igor Sysoev.</p>
<p><strong>什么是正向代理？什么是反向代理？</strong></p>
<p><strong>正向代理（forward proxy）</strong>：是一个位于客户端和目标服务器之间的服务器(代理服务器)，为了从目标服务器取得内容，客户端向代理服务器发送一个请求并指定目标，然后代理服务器向目标服务器转交请求并将获得的内容返回给客户端。（例如 酸酸乳，幻影飞梭，蓝色宝灯 etc.）</p>
<p><strong>反向代理（reverse proxy）</strong>：是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。（例如我们本节的主角 nginx）</p>
<p>二者的功能不同，适用的场景也不同。</p>
</blockquote>
<p><strong>安装 Nginx</strong></p>
<p><code>sudo apt install nginx</code></p>
<p><strong>命令</strong></p>
<ul>
<li><code>nginx -s stop</code> 关闭</li>
<li><code>nginx -s reload</code> 重载配置</li>
</ul>
<p><strong>常用功能介绍</strong></p>
<ul>
<li>提供静态文件（根据访问路径路由）</li>
</ul>
<p>我们可以先去看一下默认配置，<code>sudo vi /etc/nginx/nginx.conf</code></p>
<p>先把 <code>user</code> 改成 <code>ftpuser</code>，给予文件读写权限.</p>
<p>可以看到，在 HTTP 节 的 <code>Virtual Host Configs</code> 中 include 了 sites-enabled 的所有文件. 也就是说，我们可以通过在这个目录中新建文件的方式，来进行站点的添加.</p>
<p>在文件的最后，我们可以看到一份默认站点的样子.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Virtual Host configuration for example.com                                              </span>
<span class="token comment">#                                                                                         </span>
<span class="token comment"># You can move that to a different file under sites-available/ and symlink that           </span>
<span class="token comment"># to sites-enabled/ to enable it.                                                         </span>
<span class="token comment">#                                                                                         </span>
<span class="token comment">#server &#123;                                                                                 </span>
<span class="token comment">#       listen 80;                                                                        </span>
<span class="token comment">#       listen [::]:80;                                                                   </span>
<span class="token comment">#                                                                                         </span>
<span class="token comment">#       server_name example.com;                                                          </span>
<span class="token comment">#                                                                                         </span>
<span class="token comment">#       root /var/www/example.com;                                                        </span>
<span class="token comment">#       index index.html;</span>
<span class="token comment">#</span>
<span class="token comment">#       location / &#123;</span>
<span class="token comment">#               try_files $uri $uri/ =404;</span>
<span class="token comment">#       &#125;</span>
<span class="token comment">#&#125;</span></code></pre>
<p>改一改，写一份自己的网站配置，然后丢到 sites-enabled 里面：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 10001-TestPage.conf</span>
server <span class="token punctuation">&#123;</span>                                                                                 
      listen <span class="token number">10001</span><span class="token punctuation">;</span>                                                                        
      listen <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:10001<span class="token punctuation">;</span>                                                                   
                                                                                        
      server_name server.cc7w.cf<span class="token punctuation">;</span>                                                          
                                                                                        
      root /home/ftpuser/10001-TestPage<span class="token punctuation">;</span>                                                
      index index.html<span class="token punctuation">;</span>

      location / <span class="token punctuation">&#123;</span>
              try_files <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ <span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>Reference:</p>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1418457">https://cloud.tencent.com/developer/article/1418457</a></li>
<li><a href="https://nginx.org/en/docs/beginners_guide.html">https://nginx.org/en/docs/beginners_guide.html</a></li>
<li><a href="https://tengine.taobao.org/nginx_docs/cn/docs/http/request_processing.html">https://tengine.taobao.org/nginx_docs/cn/docs/http/request_processing.html</a></li>
</ul>
<h3 id="Gunicorn-绿色独角兽"><a href="#Gunicorn-绿色独角兽" class="headerlink" title="Gunicorn 绿色独角兽"></a>Gunicorn 绿色独角兽</h3><blockquote>
<p><strong>什么是 gunicorn?</strong></p>
<p><strong>Gunicorn (Green Unicorn)</strong> 是 Python Web 服务器网关接口HTTP服务器。</p>
<p>对于 Python App 接口，我们显然是不可能像上面的静态文件一样，直接提供给用户，因此便需要 Gunicorn 进行转接.</p>
<p><strong>我还没有安装 pip ?</strong></p>
<p><code>sudo apt install python3-pip</code></p>
<p><strong>我的 pip 还没有连接 Tsinghua 源？</strong></p>
<p><code>sudo pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</code></p>
</blockquote>
<p><strong>安装</strong></p>
<p><code>sudo pip3 install gunicorn</code></p>
<p><em>在之前进行 pip 包管理时，不同用户安装的包会存储在不同的地方，有些需要修改 Path 的包也没能获得足够的权限，懒得改配置文件的 c7w 决定所有的包安装干脆全用 sudo 完事.</em></p>
<p><strong>以命令方式运行 Gunicorn 的参数</strong></p>
<ul>
<li><p><code>-c CONFIG_PATH</code> 以配置文件运行</p>
</li>
<li><p><code>-b BIND</code> Support <code>(HOST)</code>, <code>(HOST):(PORT)</code>, or <code>unix:(PATH)</code>(Use socket)</p>
</li>
<li><code>-w WORKERS</code> 线程数</li>
</ul>
<p><strong>通过配置文件写入</strong></p>
<p>这里我们选择通过配置文件运行 Gunicorn.</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> multiprocessing
<span class="token keyword">import</span> uvicorn

debug <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token builtin">reload</span> <span class="token operator">=</span> <span class="token boolean">True</span>
loglevel <span class="token operator">=</span> <span class="token string">'debug'</span>
bind <span class="token operator">=</span> <span class="token string">'unix:/home/ftpuser/10002-TikTokTeenBackend/gunicorn/gunicorn.sock'</span>
pidfile <span class="token operator">=</span> <span class="token string">'/home/ftpuser/10002-TikTokTeenBackend/gunicorn/gunicorn.pid'</span>
logfile <span class="token operator">=</span> <span class="token string">'/home/ftpuser/10002-TikTokTeenBackend/gunicorn/debug.log'</span>
workers <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span>
worker_class <span class="token operator">=</span> <span class="token string">'uvicorn.workers.UvicornWorker'</span> <span class="token comment"># 这里一般用 sync</span>
<span class="token comment"># 但因为我要部署 FastAPI 项目，所以就用了 uvicorn</span></code></pre>
<p>注意到，我们的 bind 填写了本地 socket，这样可以让 nginx 与 gunicorn 通过本地 socket 通信.</p>
<p>然后在 nginx 里新建一个站点.</p>
<pre class="language-none"><code class="language-none">server &#123;
    listen 10002;
    root &#x2F;home&#x2F;ftpuser&#x2F;10002-TikTokTeenBackend&#x2F;Backend;
    server_name server.cc7w.cf;
    location &#x2F; &#123;
        proxy_set_header x-Real-IP $remote_addr;                                                  
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;                                                         
        proxy_pass unix:&#x2F;home&#x2F;ftpuser&#x2F;10002-TiktokTeenBackend&#x2F;gunicorn&#x2F;gunicorn.sock
    &#125;                                                                                 
&#125;</code></pre>
<h3 id="Supervisor-设置守护进程"><a href="#Supervisor-设置守护进程" class="headerlink" title="Supervisor 设置守护进程"></a>Supervisor 设置守护进程</h3><blockquote>
<p><strong>什么是 Supervisor?</strong></p>
<p>Supervisor是用Python开发的一套通用的<strong>进程管理程序</strong>，能将一个普通的命令行进程变为后台daemon（守护进程，一直在运行的进程），并监控进程状态，异常退出时能自动重启。</p>
</blockquote>
<p><strong>安装</strong></p>
<p><code>sudo apt install supervisor</code></p>
<blockquote>
<p>这里真的很坑，c7w 查资料发现是 Python 开发的后，没动脑子直接 <code>pip3 install supervisor</code>，发现配置无效后<code>sudo pip3 install supervisor</code>，发现还是没有默认配置后去 stackoverflow 了一波甚至补全了配置文件，但是还是没有成功运行. 仔细阅读安装方式后才发现应该用 apt 装.</p>
</blockquote>
<p><strong>配置</strong></p>
<pre class="language-conf" data-language="conf"><code class="language-conf">[program:10002-TikTokTeenBackend]
command&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;gunicorn -c gunicorn_config.py main:app
directory&#x3D;&#x2F;home&#x2F;ftpuser&#x2F;10002-TikTokTeenBackend&#x2F;backend
user&#x3D;root
autorestart&#x3D;true
startretires&#x3D;3</code></pre>
<p>这样我们的 App 应该至少是能够跑起来了.</p>
<p><img src="https://i.loli.net/2021/08/24/gpVzlniWst5jYmJ.png" alt="image-20210824114820839"></p>
<p>Reference:</p>
<ul>
<li><p><a href="https://docs.gunicorn.org/en/stable/deploy.html">https://docs.gunicorn.org/en/stable/deploy.html</a></p>
</li>
<li><p><a href="https://mirrors.tuna.tsinghua.edu.cn/help/pypi/">https://mirrors.tuna.tsinghua.edu.cn/help/pypi/</a></p>
</li>
<li><a href="https://www.jianshu.com/p/be2b587a900e">https://www.jianshu.com/p/be2b587a900e</a></li>
</ul>
<p><em>TO BE CONTINUED</em></p>
]]></content>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>与 Nana 的日常 —— 从零开始的 Linux 调教指北(2)</title>
    <url>/2021/08/dear-memory-with-nana-2/</url>
    <content><![CDATA[<p><img src="https://i.loli.net/2021/08/23/78DGrYSMnVgKkwE.jpg" alt="QQ图片20210823091857"></p>
<p>(Nana 印象图 初版)</p>
<p>速览本文：</p>
<ul>
<li>Docker 的安装</li>
<li>数据库的安装<ul>
<li>MariaDB</li>
<li>phpMyAdmin</li>
</ul>
</li>
<li>nodejs 与 npm 的安装</li>
</ul>
<span id="more"></span>
<h2 id="Docker-的介绍与安装"><a href="#Docker-的介绍与安装" class="headerlink" title="Docker 的介绍与安装"></a>Docker 的介绍与安装</h2><blockquote>
<p>What is <strong>Docker</strong>?</p>
<p>Docker takes away repetitive, mundane configuration tasks and is used throughout the development lifecycle for fast, easy and portable application development - desktop and cloud.</p>
<p>简而言之，就是打包好的应用，可以创建Docker容器来托管一系列应用.</p>
</blockquote>
<p><strong>安装</strong>：</p>
<p>(Option 1) 使用官方安装脚本自动安装即可</p>
<p><code>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</code></p>
<p>(Option 2) 也可使用国内 daocloud 一键安装：</p>
<p><code>curl -sSL https://get.daocloud.io/docker | sh</code></p>
<blockquote>
<p>但是在这里 c7w ran into problems.</p>
<p>详情可以看这里. 针对 armhf ubuntu 20.04: <a href="https://github.com/docker/for-linux/issues/1035">https://github.com/docker/for-linux/issues/1035</a></p>
<p>如果一键安装成功，请略过此处.</p>
<p><s><strong>想不到吧 爷去装arm64了 不伺候您armhf了</strong> <strong>只不过是从头再来</strong> <strong>停更一天</strong></s></p>
<p>大家就当无事发生过，这里 Nana 已经变成 arm64 了.</p>
</blockquote>
<p>(Option 3) 也可以使用 Tsinghua 源.</p>
<p>可以参考 <a href="https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/">https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/</a> 手动安装.</p>
<h2 id="数据库安装与配置"><a href="#数据库安装与配置" class="headerlink" title="数据库安装与配置"></a>数据库安装与配置</h2><h3 id="MariaDB"><a href="#MariaDB" class="headerlink" title="MariaDB"></a>MariaDB</h3><blockquote>
<p>什么是 <strong>MariaDB</strong>?</p>
<p>MariaDB Server is one of the most popular database servers in the world. It’s made by the original developers of MySQL and guaranteed to stay open source. </p>
<p>MariaDB数据库管理系统是MySQL的一个分支，主要由开源社区在维护，采用GPL授权许可。 开发这个分支的原因之一是：甲骨文公司收购了MySQL后，有将MySQL闭源的潜在风险，因此社区采用分支的方式来避开这个风险。 MariaDB的目的是完全兼容MySQL，包括API和命令行，使之能轻松成为MySQL的代替品。</p>
<p>Reference:</p>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1635038">https://cloud.tencent.com/developer/article/1635038</a></li>
<li><a href="https://hub.docker.com/_/mariadb">https://hub.docker.com/_/mariadb</a></li>
</ul>
</blockquote>
<p><strong>安装</strong></p>
<p><code>sudo apt install mariadb-server</code></p>
<p><strong>查看字符集</strong></p>
<ul>
<li><code>sudo mysql</code> 进入控制台</li>
</ul>
<pre class="language-none"><code class="language-none"> ubuntu@ubuntu &gt; &#x2F;etc&#x2F;mysql &gt; sudo mysql
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 52
Server version: 10.3.31-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.

MariaDB [(none)]&gt; </code></pre>
<ul>
<li><code>show variables like &quot;%character%&quot;;show variables like &quot;%collation%&quot;;</code> 查看当前字符集</li>
</ul>
<pre class="language-none"><code class="language-none">+--------------------------+----------------------------+
| Variable_name            | Value                      |
+--------------------------+----------------------------+
| character_set_client     | utf8mb4                    |
| character_set_connection | utf8mb4                    |
| character_set_database   | utf8mb4                    |
| character_set_filesystem | binary                     |
| character_set_results    | utf8mb4                    |
| character_set_server     | utf8mb4                    |
| character_set_system     | utf8                       |
| character_sets_dir       | &#x2F;usr&#x2F;share&#x2F;mysql&#x2F;charsets&#x2F; |
+--------------------------+----------------------------+
8 rows in set (0.004 sec)

+----------------------+--------------------+
| Variable_name        | Value              |
+----------------------+--------------------+
| collation_connection | utf8mb4_general_ci |
| collation_database   | utf8mb4_general_ci |
| collation_server     | utf8mb4_general_ci |
+----------------------+--------------------+
3 rows in set (0.003 sec)</code></pre>
<p>这里已经是 <code>utf8mb4</code> 了，无须再更多配置.</p>
<p><strong>安全性配置</strong></p>
<p><code>sudo mysql_secure_installation</code> 进行安全性配置.</p>
<pre class="language-none"><code class="language-none">NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB
      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!

In order to log into MariaDB to secure it, we&#39;ll need the current
password for the root user.  If you&#39;ve just installed MariaDB, and
you haven&#39;t set the root password yet, the password will be blank,
so you should just press enter here.

Enter current password for root (enter for none):
OK, successfully used password, moving on...

Setting the root password ensures that nobody can log into the MariaDB
root user without the proper authorisation.

Set root password? [Y&#x2F;n] Y
New password:
Re-enter new password:
Password updated successfully!
Reloading privilege tables..
 ... Success!


By default, a MariaDB installation has an anonymous user, allowing anyone
to log into MariaDB without having to have a user account created for
them.  This is intended only for testing, and to make the installation
go a bit smoother.  You should remove them before moving into a
production environment.

Remove anonymous users? [Y&#x2F;n] Y
 ... Success!

Normally, root should only be allowed to connect from &#39;localhost&#39;.  This
ensures that someone cannot guess at the root password from the network.

Disallow root login remotely? [Y&#x2F;n] Y
 ... Success!

By default, MariaDB comes with a database named &#39;test&#39; that anyone can
access.  This is also intended only for testing, and should be removed
before moving into a production environment.

Remove test database and access to it? [Y&#x2F;n] Y
 - Dropping test database...
 ... Success!
 - Removing privileges on test database...
 ... Success!

Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.

Reload privilege tables now? [Y&#x2F;n] Y
 ... Success!

Cleaning up...

All done!  If you&#39;ve completed all of the above steps, your MariaDB
installation should now be secure.

Thanks for using MariaDB!</code></pre>
<p><strong>新建管理员用户</strong></p>
<p>先 <code>sudo mysql</code> 进入控制台.</p>
<ul>
<li><code>CREATE USER &#39;&lt;USERNAME&gt;&#39;@&#39;%&#39; IDENTIFIED BY &#39;&lt;YOUR PASSWORD&gt;&#39;;</code> 创建用户</li>
<li><code>GRANT ALL PRIVILEGES ON *.* TO &#39;&lt;USERNAME&gt;&#39;@&#39;%&#39; WITH GRANT OPTION;</code> 给予管理员权限</li>
</ul>
<h3 id="phpMyAdmin"><a href="#phpMyAdmin" class="headerlink" title="phpMyAdmin"></a>phpMyAdmin</h3><p><strong>安装</strong></p>
<p><code>sudo apt install phpmyadmin</code></p>
<p>在询问是否需要帮助创建数据库时，选择取消.</p>
<p>在询问选择哪个软件作为管理 phpmyadmin server 的工具时，选择 apache2.</p>
<p><strong>更改配置</strong></p>
<ul>
<li>把 phpmyadmin 提供的默认的 apache2 配置文件移动到 apache2 目录下:</li>
</ul>
<p><code>sudo mv /etc/phpmyadmin/apache.conf /etc/apache2/conf-enabled</code></p>
<ul>
<li>然后更改 apache2 监听的端口：</li>
</ul>
<p><code>sudo vi /etc/apache2/ports.conf</code></p>
<p>把 80 端口改为没有被占用的端口.</p>
<ul>
<li>重启 apache2 服务：<code>sudo systemctl apache2 restart</code></li>
<li>尝试访问 <a href="http://IP_ADDRESS:PORT/phpmyadmin，然后使用上述新建的管理员账户密码完成登录">http://IP_ADDRESS:PORT/phpmyadmin，然后使用上述新建的管理员账户密码完成登录</a>.</li>
</ul>
<p><img src="https://i.loli.net/2021/08/25/NsUTCOdzWXnYmSu.png" alt="image-20210825202754563"></p>
<h2 id="Node-的安装"><a href="#Node-的安装" class="headerlink" title="Node 的安装"></a>Node 的安装</h2><p>我们直接使用已完成编译的包.</p>
<ul>
<li><p>先下载安装文件 <code>wget https://nodejs.org/dist/v14.17.5/node-v14.17.5-linux-arm64.tar.xz</code></p>
</li>
<li><p>解压 <code>tar xf node-v14.17.5-linux-arm64.tar.xz</code></p>
</li>
<li>进入目录 <code>cd node-v14.17.5-linux-arm64/</code></li>
<li>执行 node 查看版本 <code>./bin/node -v</code></li>
</ul>
<blockquote>
<p>这里 c7w 强迫症，还去搜索了这个文件应该放哪里比较好.</p>
<pre><code>有时候需要配置ubuntu安装的软件，一般安装软件都是使用apt-get install。那么安装完后，软件的安装目录在哪里呢，可执行文件又放在哪里呢。

A、下载的软件的存放位置：/var/cache/apt/archives

B、安装后软件的默认位置：/usr/share

C、可执行文件位置：/usr/bin

D、配置文件位置：/etc

E、lib文件位置：/usr/lib
</code></pre><p>Reference:</p>
<ul>
<li><a href="https://blog.csdn.net/u013276277/article/details/81033129">https://blog.csdn.net/u013276277/article/details/81033129</a></li>
</ul>
</blockquote>
<ul>
<li>移动文件： <code>sudo mv node-v14.17.5-linux-arm64 /usr/share</code></li>
<li>建立软链接</li>
</ul>
<pre class="language-none"><code class="language-none">ubuntu@ubuntu  &#x2F;usr&#x2F;bin  sudo ln -s &#x2F;usr&#x2F;share&#x2F;node-v14.17.5-linux-arm64&#x2F;bin&#x2F;npm &#x2F;usr&#x2F;local&#x2F;bin
 ubuntu@ubuntu  &#x2F;usr&#x2F;bin  sudo ln -s &#x2F;usr&#x2F;share&#x2F;node-v14.17.5-linux-arm64&#x2F;bin&#x2F;node &#x2F;usr&#x2F;local&#x2F;bin
 ubuntu@ubuntu  &#x2F;usr&#x2F;bin  node
Welcome to Node.js v14.17.5.
Type &quot;.help&quot; for more information.
&gt;</code></pre>
]]></content>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>动态规划的背包问题</title>
    <url>/2020/12/dp-backpack/</url>
    <content><![CDATA[<p>所以为什么要找一个背包图片当头图啊喂</p>
<h2 id="0-1-背包问题"><a href="#0-1-背包问题" class="headerlink" title="0/1 背包问题"></a>0/1 背包问题</h2><p>有$N$件物品和一个容量为$V$的背包。<strong>每种物品仅有一件，可以选择放或不放。</strong> 第$i$件物品的费用是$w[i]$，价值是$c[i]$。求解将哪些物品装入背包可使这些物品的费用总和不超过背包容量，且价值总和最大。 </p>
<p>设$f[i][v]$表示前$i$件物品(部分或全部)<em>恰</em>放入一个容量为$v$的背包可以获得的最大价值。则其状态转移方程便是：</p>
<script type="math/tex; mode=display">
f[i][v]=\max(f[i-1][v],f[i-1][v-w[i]]+c[i])</script><h3 id="0-1背包的空间优化"><a href="#0-1背包的空间优化" class="headerlink" title="0/1背包的空间优化"></a>0/1背包的空间优化</h3><p>我们可以将二维数组存储优化为一维数组存储。</p>
<p>在每次主循环中，如果我们以$v=V…0$的逆序推$f[v]$，这样就能保证推$f[v]$时$f[v-w[i]]$保存的是状态$f[i-1][v-w[i]]$的值。</p>
<p>伪代码如下：</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>N 
	<span class="token keyword">for</span> v <span class="token operator">=</span> V<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">.0</span> 
        f<span class="token punctuation">[</span>v<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>f<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">,</span> f<span class="token punctuation">[</span>v<span class="token operator">-</span>w<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span>c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </code></pre>
<p>　　其中$f[v]=max(f[v],f[v-w[i]]+c[i])$便与原转移方程等价。</p>
<h2 id="完全背包问题"><a href="#完全背包问题" class="headerlink" title="完全背包问题"></a>完全背包问题</h2><p>有$N$种物品和一个容量为$V$的背包，<strong>每种物品都有无限件可用</strong>。第$i$种物品的费用是$w[i]$，价值是$c[i]$。求解将哪些物品装入背包可使这些物品的费用总和不超过背包容量，且价值总和最大。 </p>
<p>令$f[i][v]$表示前$i$种物品<em>恰</em>放入一个容量为$v$的背包的最大价值，于是可以按照每种物品不同的策略写出状态转移方程：</p>
<script type="math/tex; mode=display">
f[i][v]=\max(f[i-1][v-k*{w[i]}]+k*{c[i]}) (k = 0, 1, ..., floor(\frac v {w[i]}))</script><h3 id="完全背包问题的空间优化"><a href="#完全背包问题的空间优化" class="headerlink" title="完全背包问题的空间优化"></a>完全背包问题的空间优化</h3><p>完全背包的特点恰是每种物品可选无限件，所以我们可以考虑“加选一件第$i$种物品”策略。因此我们可以使用<strong>可能已选入第i种物品</strong>的子结果$f[i][v-w[i]]$，于是我们必须采用$v=0…V$的顺序循环。</p>
<p>伪代码如下：</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>N 
	<span class="token keyword">for</span> v <span class="token operator">=</span> <span class="token number">0.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>V
		f<span class="token punctuation">[</span>v<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>f<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">,</span> f<span class="token punctuation">[</span>v<span class="token operator">-</span>w<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span>c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </code></pre>
<h3 id="另一种解法：转化为0-1背包问题"><a href="#另一种解法：转化为0-1背包问题" class="headerlink" title="另一种解法：转化为0/1背包问题"></a>另一种解法：转化为0/1背包问题</h3><p>考虑到第$i$种物品最多选$floor(\frac V {w[i]})$件，于是可以把第$i$种物品转化为$floor(\frac V {w[i]})$件费用及价值均不变的物品，然后求解这个0/1背包问题。</p>
<p>更高效的转化方法是：把第$i$种物品拆成费用为$2^kw[i]$、价值为$2^kc[i]$的若干件物品，其中$k$满足$2^kw[i]&lt;V$。这是二进制的思想，因为不管最优策略选几件第$i$种物品，总可以表示成若干个$2^k$件物品的和。</p>
<h2 id="多重背包问题"><a href="#多重背包问题" class="headerlink" title="多重背包问题"></a>多重背包问题</h2><p>有$N$种物品和一个容量为$V$的背包。<strong>第$i$种物品最多有$n[i]$件可用</strong>，每件费用是$w[i]$，价值是$c[i]$。求解将哪些物品装入背包可使这些物品的费用总和不超过背包容量，且价值总和最大。</p>
<p>基本的方程只需将完全背包问题的方程略微一改即可，因为对于第$i$种物品有$n[i]+1$种策略：取$0$件，取$1$件……取$n[i]$件。令$f[i][v]$表示前$i$种物品恰放入一个容量为$v$的背包的最大价值，则：</p>
<script type="math/tex; mode=display">
for \ k\ in \ range[0, n[i]]:\\
f[i][v]=max(f[i-1][v-k*w[i]]+ k*c[i])</script><p>循环时注意$v-k*w[i]$ 非负即可。</p>
<h3 id="转化为0-1背包问题"><a href="#转化为0-1背包问题" class="headerlink" title="转化为0/1背包问题"></a>转化为0/1背包问题</h3><p>将第$i$种物品分成若干件物品，其中每件物品有一个系数，这件物品的费用和价值均是原来的费用和价值乘以这个系数。使这些系数分别为</p>
<script type="math/tex; mode=display">
1,2,4,...,2^{k-1},n[i]-2^k+1</script><p>且k是满足$n[i]-2^k+1&gt;0$的最大整数。</p>
<p>例如，如果$n[i]$为$13$，就将这种物品分成系数分别为$1,2,4,6$的四件物品。 </p>
<h2 id="二维背包问题"><a href="#二维背包问题" class="headerlink" title="二维背包问题"></a>二维背包问题</h2><p>二维费用的背包问题是指：对于每件物品，具有两种不同的费用；选择这件物品必须同时付出这两种代价；对于每种代价都有一个可付出的最大值（背包容量）。问怎样选择物品可以得到最大的价值。</p>
<p>设这两种代价分别为代价1和代价2，第$i$件物品所需的两种代价分别为$a[i]$和$b[i]$。两种代价可付出的最大值（两种背包容量）分别为$V$和$U$。物品的价值为$c[i]$。</p>
<p>费用加了一维，只需状态也加一维即可。设$f[i][v][u]$表示前$i$件物品付出两种代价分别恰为$v$和$u$时可获得的最大价值。状态转移方程就是：</p>
<script type="math/tex; mode=display">
f[i][v][u]=max(f[i-1][v][u], f[i-1][v-a[i]][u-b[i]]+c[i])</script><p>如前述方法，可以只使用二维的数组：当每件物品只可以取一次时变量$v$和$u$采用逆序的循环，当物品有如完全背包问题时采用顺序的循环。当物品有如多重背包问题时拆分物品。</p>
<h3 id="物品总个数的限制"><a href="#物品总个数的限制" class="headerlink" title="物品总个数的限制"></a>物品总个数的限制</h3><p>有时，“二维费用”的条件是以这样一种隐含的方式给出的：最多只能取$M$件物品。这事实上相当于每件物品多了一种“件数”的费用，每个物品的件数费用均为$1$，可以付出的最大件数费用为$M$。</p>
<h2 id="咕咕咕"><a href="#咕咕咕" class="headerlink" title="咕咕咕"></a>咕咕咕</h2><p>还有分组背包还有依赖背包但懒得写，源代码也有空再说8</p>
<p>诶mathjax怎么又炸了</p>
<h2 id="Practice"><a href="#Practice" class="headerlink" title="Practice"></a>Practice</h2><ul>
<li><a href="https://www.luogu.com.cn/problem/P1833">https://www.luogu.com.cn/problem/P1833</a></li>
</ul>
<p>附AC代码：</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">int</span> v<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//  i j   k</span>
<span class="token keyword">int</span> f<span class="token punctuation">[</span><span class="token number">1001</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> a <span class="token operator">></span> b <span class="token operator">?</span> a <span class="token operator">:</span> b<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">processTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d:%d %d:%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v <span class="token operator">=</span> d <span class="token operator">-</span> b <span class="token operator">+</span> <span class="token punctuation">(</span>c <span class="token operator">-</span> a<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">tryItem</span><span class="token punctuation">(</span><span class="token keyword">int</span> cost<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">,</span> <span class="token keyword">bool</span> inf<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>inf<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> cost<span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> v<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            f<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>f<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> f<span class="token punctuation">[</span>j <span class="token operator">-</span> cost<span class="token punctuation">]</span><span class="token operator">+</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> v<span class="token punctuation">;</span> j <span class="token operator">>=</span> cost<span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            f<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>f<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> f<span class="token punctuation">[</span>j <span class="token operator">-</span> cost<span class="token punctuation">]</span><span class="token operator">+</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">decompose</span><span class="token punctuation">(</span><span class="token keyword">int</span> cost<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> base <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>num<span class="token operator">>=</span>base<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">tryItem</span><span class="token punctuation">(</span>cost <span class="token operator">*</span> base<span class="token punctuation">,</span> value <span class="token operator">*</span> base<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        num <span class="token operator">-=</span> base<span class="token punctuation">;</span>
        base <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>num<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">tryItem</span><span class="token punctuation">(</span>cost <span class="token operator">*</span> num<span class="token punctuation">,</span> value <span class="token operator">*</span> num<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">processTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    cin <span class="token operator">>></span> n<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d %d %d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>c<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">tryItem</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>c<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">tryItem</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token function">decompose</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> v<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        result <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    cout <span class="token operator">&lt;&lt;</span> result<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
]]></content>
      <tags>
        <tag>dp</tag>
        <tag>背包</tag>
      </tags>
  </entry>
  <entry>
    <title>但是什么是神经网络？</title>
    <url>/2021/09/but-what-is-a-neural-network/</url>
    <content><![CDATA[<p>Notes taken from watching <strong>3Blue1Brown series: Nerual networks</strong>.</p>
<ul>
<li>But what is a nerual network?</li>
<li>Gradient Descent</li>
<li>Back Propagation</li>
</ul>
<span id="more"></span>
<h2 id="Chapter-1-Overview"><a href="#Chapter-1-Overview" class="headerlink" title="Chapter 1: Overview"></a>Chapter 1: Overview</h2><p>Consider <strong>Nerual network</strong>:</p>
<ul>
<li>What are the neurons?<ul>
<li>Functions, which take several numbers as input and give a number as output</li>
</ul>
</li>
<li>How are they linked together? </li>
</ul>
<p><strong>Layers</strong> (Each layer made up of neurons):</p>
<ul>
<li>The activations of one layer determines the activations of the next layer.</li>
</ul>
<p>What those <strong>middle layers</strong> might be doing?</p>
<ul>
<li>It may be holding subcomponents of the image.</li>
<li>Input layer -&gt; Edge layer -&gt; Pattern layer -&gt; Output Digit Layer (?)</li>
</ul>
<p><strong>Edge Detection Example</strong></p>
<ul>
<li>Assign a weight to <strong>each connection</strong> between the neuron and the neurons from the former layer</li>
</ul>
<p><img src="https://i.loli.net/2021/09/03/2OhjAcN1p9JesRX.png" alt="image-20210903150326487"></p>
<ul>
<li>Let activations from the last layer be $a_1, a_2, a_3, …a_n$​ and the weight numbers be $w_1, w_2, w_3, …w_n$​​.</li>
<li>Let $w_1a_1 + w_2a_2 + … + w_na_n$ represent the neuron activation? No! We have to make the range of activation between [0, 1], but the result comes along with any possible real number.</li>
</ul>
<p><img src="https://i.loli.net/2021/09/03/pQn9PXsdu3lZNO1.png" alt="image-20210903150746983"></p>
<ul>
<li>We could use the <strong>sigmoid function</strong>, or the <strong>logistic curve</strong> to solve this. $\sigma(x) = \frac 1 {1+e^{-x}}$​</li>
</ul>
<p><img src="https://i.loli.net/2021/09/03/aZoQXd3Ec2T1GFL.png" alt="image-20210903151057105"></p>
<ul>
<li>So can we let the activation of the neuron be $\sigma(w_1a_1 + w_2a_2 + … + w_na_n)$​, which is basically a measure of how <strong>positively</strong> the relevant weighted sum is?</li>
<li>Well, maybe we need some <strong>bias</strong>, say, only activate when $w_1a_1 + w_2a_2 + … + w_na_n &gt; 10$?</li>
<li>So finally we get, the activation of the neuron, which is $\sigma(w_1a_1 + w_2a_2 + … + w_na_n + bias)$, which is -10 in this case.​​</li>
</ul>
<p><strong>Counting weights and biases</strong></p>
<ul>
<li>All described above is just above <strong>one specific neuron</strong>, and in fact, in a middle layer, we have several neurons!</li>
<li>Take the video example, just a two-middle-layered network have more than 13k parameters to tweak!</li>
</ul>
<p><img src="https://i.loli.net/2021/09/03/OLumsy3nIMQtekc.png" alt="image-20210903151909640"></p>
<ul>
<li>So when we talk about learning, it is about <strong>finding the right weights and biases</strong> to make the network behave in the right way.</li>
</ul>
<p><strong>Notations and linear algebra</strong></p>
<ul>
<li><p>Let activations from one layer be a column vector: $\begin {bmatrix} a_1^{(0)}\ a_2^{(0)}\ \vdots\ a_n^{(0)}\ \end {bmatrix}$​​​​​​</p>
</li>
<li><p>Let weights of connection between two adjacent layers be a matrix: $\begin {bmatrix} w<em>{1,1} &amp; w</em>{1,2} &amp; \cdots &amp; w<em>{1,n} \ w</em>{2,1} &amp; w<em>{2,2} &amp; \cdots &amp; w</em>{2,n} \ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \ w<em>{k,1} &amp; w</em>{k,2} &amp; \cdots &amp; w_{k,n}  \end {bmatrix}$​​</p>
<ul>
<li>Row $i$ of the matrix represents the connection weight between neuron $i$ with the neurons from the last layer.</li>
</ul>
</li>
</ul>
<ul>
<li><p>Let the biases be in a column vector: $\begin {bmatrix} b_1\ b_2\ \vdots\ b_n\ \end {bmatrix}$​​​​</p>
</li>
<li><p>And let $\sigma(\begin {bmatrix} x\ y\ \vdots\ z\ \end {bmatrix}) \ := \ \begin {bmatrix} \sigma(x)\ \sigma(y)\ \vdots\ \sigma(z)\ \end {bmatrix}$</p>
</li>
<li><p>So we get our notation now: $a^{(2)} = \sigma(W^{(2)}a^{(1)}+b^{(2)})$​​​</p>
<ul>
<li>$a^{(i)}$: the activations of the $i$​-th layer</li>
<li>$W^{(i)}$: connection weight matrix between layer $i$ and $i-1$</li>
<li>$b^{(i)}$: biases of neurons in the layer $i$</li>
</ul>
</li>
</ul>
<h2 id="Chapter-2-Gradient-descent"><a href="#Chapter-2-Gradient-descent" class="headerlink" title="Chapter 2: Gradient descent"></a>Chapter 2: Gradient descent</h2><p><strong>Using training data</strong></p>
<ul>
<li>We can divide our data with labels into two groups, the training group and the testing group.</li>
<li>Firstly, we can use the data in the training group to train our network.</li>
<li>Then we could use the test group to check its accuracy.</li>
</ul>
<p><strong>Cost Function</strong></p>
<ul>
<li>Review: Nerual network function<ul>
<li>Input: 784 numbers (pixels)</li>
<li>Output: 10 numbers</li>
<li>Parameters: 13k weights or biases</li>
</ul>
</li>
<li>But the cost function might be like…<ul>
<li>Input: 13k weights or biases</li>
<li>Output: 1 single number (namely the cost)</li>
<li>Parameters: Different set of training examples</li>
</ul>
</li>
<li>Notation<ul>
<li>$C(w<em>1, w_2, \cdots, w</em>{13002}) := \frac 1 {2n} \sum_x|| y(x)-a ||^2$​</li>
<li>Now we can just try to solve this problem: how to find the minimum of $C$ and the corresponding set of $w$​!</li>
</ul>
</li>
<li>It is hard to solve this minimum problem using mathematic methods when the amount of parameters is high, but we can…<ul>
<li>Start at an old input</li>
<li>Figure out which direction you should step to make the cost lower</li>
<li>And that direction is: $-\nabla C$​</li>
</ul>
</li>
<li>So we could just choose $\Delta v =-\eta\nabla C$​.<ul>
<li>In which $\eta$​ is a small, positive parameter (known as <em>learning rate</em>) </li>
<li>Then we can make $ v \rightarrow (v’=v-\eta\nabla C)$​ in every iteration</li>
</ul>
</li>
</ul>
<p><strong>Anaylsing the network</strong></p>
<ul>
<li>Does the network’s middle layer really doing what was imagined? Namely, edges, patterns, etc.?<ul>
<li>Not at all!</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/09/03/BrJF1SleKfVTqOD.png" alt="image-20210903164518327"></p>
<ul>
<li>The magnitude of each element in the gradient is indicating how sensitive the cost function is to each weight or bias.</li>
</ul>
<h2 id="Chapter-3-Back-Propagation"><a href="#Chapter-3-Back-Propagation" class="headerlink" title="Chapter 3: Back Propagation"></a>Chapter 3: Back Propagation</h2><p><strong>What is back propagation?</strong></p>
<ul>
<li>It is an algorithm for computing the gradients of the cost function.</li>
</ul>
<p><strong>Stochastic gradient descent</strong></p>
<ul>
<li>It takes the computer rather long time to add up the influence of every single training example.</li>
<li>So we can randomly shuffle our training data, then divide it into mini-batches.</li>
<li>Then we can compute a step according to the mini-batch.</li>
</ul>
<p><strong>Chain rule</strong></p>
<p><img src="https://i.loli.net/2021/09/03/rpMKl7V1faHI4S5.png" alt="image-20210903215157598"></p>
<pre class="mermaid">graph LR
subgraph "Layer m-1"
A0("1")
A1("2")
A2("3")
A3("4")
end
subgraph "Layer m"
B2("output(i-1)")
B0("output(i)")
B1("output(i+1)")
end
subgraph "Anticipated label"
C2("y(i-1)")
C0("y(i)")
C1("y(i+1)")
end
A0 --> B0
A1 --> B0
A2 --> B0
A3 --> B0
B0 --> C0
B1 --> C1
B2 --> C2</pre>

<ul>
<li>We remember $\begin {bmatrix} a<em>1^{(2)}\ a_2^{(2)}\ \vdots\ a_k^{(2)}\ \end {bmatrix}= \sigma (\begin {bmatrix} w^{(2)}</em>{1,1} &amp; w^{(2)}<em>{1,2} &amp; \cdots &amp; w^{(2)}</em>{1,n} \ w^{(2)}<em>{2,1} &amp; w^{(2)}</em>{2,2} &amp; \cdots &amp; w^{(2)}<em>{2,n} \ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \ w^{(2)}</em>{k,1} &amp; w^{(2)}<em>{k,2} &amp; \cdots &amp; w^{(2)}</em>{k,n}  \end {bmatrix}\begin {bmatrix} a_1^{(1)}\ a_2^{(1)}\ \vdots\ a_n^{(1)}\ \end {bmatrix} + \begin {bmatrix} b_1^{(2)}\ b_2^{(2)}\ \vdots\ b_k^{(2)}\ \end {bmatrix})$<ul>
<li>Namely $a^{(L)}<em>i  = \sigma( \sum_jw^{(L)}</em>{i, j}a_j^{(L-1)}+ b^{(L)})$​​​​​.​</li>
<li>We denote this by $z^l = w^la^{l-1}+b^l$​ and $a^l = \sigma(z^l)$​</li>
</ul>
</li>
<li>And we have $C(\vec W, \vec b) = \frac 1 {2n} \sum_x|| y(x)-a ||^2$<ul>
<li>We assume that $C = \frac 1 n \sum_x C_x$​, in which $C_x = \frac 1 2 ||y-a^{L}||^2$​​​</li>
</ul>
</li>
</ul>
<pre class="mermaid">graph RL
CX("$C$")
aE("$a^L$")
zE("$z^L$")
wE("$w^L$")
aEL("$a^{L-1}$")
bE("$b^L$")
zEL("$z^{L-1}$")
wEL("$w^{L-1}$")
aELL("$a^{L-2}$")
bEL("$b^{L-1}$")

aE -->|"$(y_x-a^L_x)^2$"| CX
zE -->|"$\sigma$"| aE
wE --> zE
aEL --> zE
bE --> zE
zEL -->|"$\sigma$"| aEL
wEL --> zEL
aELL --> zEL
bEL --> zEL
dot("$\cdots$") --> aELL</pre>

<ul>
<li>Then the core equations of back propagation…<ul>
<li>$\frac {\partial C} {\partial z_i^L} = \frac {\partial C} {\partial a_i^L}\frac {\partial a_i^L} {\partial z_i^L} = (a_i^L-y_i)\sigma’(z_i^L)$​​​​ (Initialize)​<ul>
<li>That is $\delta := \frac {\partial C} {\partial z^L} = (a^L-y) \odot \sigma’(z^L)$​​</li>
</ul>
</li>
<li>According to $z^{(L)}<em>i = \sum_jw^{(L)}</em>{i, j}a_j^{(L-1)}+ b_i^{(L)}$​​​​, suppose we have calculated $\frac {\partial C} {\partial z^M_i}$​​​ for all neuron $i$​​​ in layer $M$​​​.<ul>
<li>How can we get $\frac {\partial C} {\partial w^M_{i, j}}$​​​ for all neuron $i$​​​ in layer $M$​​ and $j$​​ in layer $M-1$​​​​?<ul>
<li>$\frac {\partial C} {\partial w^M<em>{i, j}} = \frac {\partial C} {\partial z^M_i} \frac {\partial z^M_i}{\partial w^M</em>{i, j}} = \frac {\partial C} {\partial z^M_i} a_j^{M-1}$​<ul>
<li>$\frac {\partial C} {\partial w^M} = \frac {\partial C} {\partial z^L} (a^{M-1})^T$</li>
</ul>
</li>
</ul>
</li>
<li>How can we get $\frac {\partial C} {\partial b^M_i} $​​ for all neuron $i$​​ in layer $M$​?<ul>
<li>$\frac {\partial C} {\partial b^M<em>{i}} = \frac {\partial C} {\partial z^M_i} \frac {\partial z^M_i}{\partial b^M</em>{i}} = \frac {\partial C} {\partial z^M_i}$​<ul>
<li>$\frac {\partial C} {\partial b^M} = \frac {\partial C} {\partial z^M}$</li>
</ul>
</li>
</ul>
</li>
<li>How can we get $\frac {\partial C} {\partial a^{M-1}_j} $ and $\frac {\partial C} {\partial z^{M-1}_j} $ for all neuron $j$ in layer $M-1$?<ul>
<li>$\frac {\partial C} {\partial a^{M-1}<em>j}  = \sum_i \frac {\partial C}{\partial z^M_i} \frac {\partial z^M_i} {a_j^{M-1}} = \sum_i \frac {\partial C}{\partial z^M_i} w</em>{i,j}^M$​<ul>
<li>$\frac {\partial C} {\partial a^{M-1}} = (w^M)^T \frac {\partial C} {\partial z^M}$​</li>
</ul>
</li>
<li>Then $\frac {\partial C} {\partial z^{M-1}_j} = \frac {\partial C} {\partial a^{M-1}_j} \sigma’(z^{M-1}_j)$​<ul>
<li>$\frac {\partial C} {\partial z^{M-1}} = (w^M)^T \frac {\partial C} {\partial z^M}\odot\sigma’(z^{M-1})$</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Then by recursion, we could calculate all the partial derivatives of weights and biases.</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>Machine Learning</tag>
      </tags>
  </entry>
  <entry>
    <title>数据结构-堆</title>
    <url>/2020/11/ds-heap/</url>
    <content><![CDATA[<p>　　　数据结构中的堆结构　　　</p>
<h2 id="Knowledge-Base"><a href="#Knowledge-Base" class="headerlink" title="Knowledge Base"></a>Knowledge Base</h2><ul>
<li>完全二叉树：</li>
</ul>
<p>​        如果一棵深度为 $k$ 的二叉树，$1$ 至$ k-1$ 层的结点都是满的，即满足 $2^i-1$，只有最下面的一层的结点数小于$2^i-1$，并且最下面一层的结点都集中在该层最左边的若干位置，则此二叉树称为完全二叉树。</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>​        堆结构是一种数组对象，它可以被视为一棵完全二叉树。树中每个结点与数组中存放该结点中值的那个元素相对应，如下图：</p>
<p><a href="https://imgchr.com/i/Da1oSH"><img src="https://s3.ax1x.com/2020/11/25/Da1oSH.png" alt="Da1oSH.png"></a></p>
<h2 id="性质"><a href="#性质" class="headerlink" title="性质"></a>性质</h2><ul>
<li><p>下标：</p>
<p>​    第$i$个结点的父结点（parent(i)）、左结点(left(i))、右结点(right(i))的下标分别为：$\frac {i}{2}$、$2i$、$2i+1$；</p>
</li>
<li><p>大小：</p>
<p>堆可以分为<strong>最大堆(max-heap)</strong>和<strong>最小堆(min-heap)</strong>两种，分别满足对于任意的$i$, $A[parent(i)] &gt;(&lt;)A[i]$.</p>
</li>
</ul>
<h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><ul>
<li><a href="http://www.cplusplus.com/reference/algorithm/make_heap/">make_heap</a></li>
<li><a href="http://www.cplusplus.com/reference/algorithm/push_heap/">push_heap</a></li>
<li><a href="http://www.cplusplus.com/reference/algorithm/pop_heap/">pop_heap</a></li>
</ul>
<h2 id="src"><a href="#src" class="headerlink" title="src"></a>src</h2><pre class="language-c++" data-language="c++"><code class="language-c++">&#x2F;&#x2F;最小堆
class smallHeap &#123;
public:
	int size, maxSize, * head &#x3D; NULL;

	void init(int depth) &#123;
        int p &#x3D; qpow(2, depth, 19260817);
        head &#x3D; new int[p-1];
        maxSize &#x3D; p - 1;
	&#125;

	smallHeap(int depth) &#123;
		init(depth);
	&#125;

	int getSize() &#123;
		return size;
	&#125;

	bool put(int val) &#123;
		if (size &#x3D;&#x3D; maxSize) return false;
		size++;
		int currentNode &#x3D; size; head[currentNode] &#x3D; val;
		while (currentNode !&#x3D; 1) &#123;
			int parentNode &#x3D; currentNode &#x2F; 2;
			if (head[parentNode] &gt; head[currentNode]) &#123;
				int temp &#x3D; head[parentNode];
				head[parentNode] &#x3D; head[currentNode];
				head[currentNode] &#x3D; temp;
				currentNode &#x3D; parentNode;
			&#125;
			else &#123;
				break;
			&#125;
		&#125;
		return true;
	&#125;

	int get() &#123;
		int currentNode &#x3D; 1;
		int tempValue &#x3D; head[currentNode];
		head[currentNode] &#x3D; head[size];
		size--;
		int parentNode &#x3D; 1;
		while (1) &#123;
			if (parentNode * 2 &gt; size) break;
			currentNode &#x3D; (head[parentNode * 2] &lt; head[parentNode * 2 + 1]) ? (parentNode * 2) : (parentNode * 2 + 1);
			if (head[parentNode] &gt; head[currentNode]) &#123;
				int temp &#x3D; head[parentNode];
				head[parentNode] &#x3D; head[currentNode];
				head[currentNode] &#x3D; temp;
				parentNode &#x3D; currentNode;
			&#125;
			else &#123;
				break;
			&#125;
		&#125;

		return tempValue;
	&#125;
    
    int top() &#123; return head[1]; &#125;

	void show() &#123;
		for (int i &#x3D; 1; i &lt;&#x3D; size; i++) &#123;
			cout &lt;&lt; head[i] &lt;&lt; &quot; &quot;;
		&#125;
	&#125;
&#125;;

&#x2F;&#x2F;最大堆
class bigHeap &#123;
public:
	int size, maxSize, * head &#x3D; NULL;

	void init(int depth) &#123;
        int p &#x3D; qpow(2, depth, 19260817);
        head &#x3D; new int[p-1];
        maxSize &#x3D; p - 1;
	&#125;

	bigHeap(int depth) &#123;
		init(depth);
	&#125;

	int getSize() &#123;
		return size;
	&#125;

	bool put(int val) &#123;
		if (size &#x3D;&#x3D; maxSize) return false;
		size++;
		int currentNode &#x3D; size; head[currentNode] &#x3D; val;
		while (currentNode !&#x3D; 1) &#123;
			int parentNode &#x3D; currentNode &#x2F; 2;
			if (head[parentNode] &lt; head[currentNode]) &#123;
				int temp &#x3D; head[parentNode];
				head[parentNode] &#x3D; head[currentNode];
				head[currentNode] &#x3D; temp;
				currentNode &#x3D; parentNode;
			&#125;
			else &#123;
				break;
			&#125;
		&#125;
		return true;
	&#125;

	int get() &#123;
		int currentNode &#x3D; 1;
		int tempValue &#x3D; head[currentNode];
		head[currentNode] &#x3D; head[size];
		size--;
		int parentNode &#x3D; 1;
		while (1) &#123;
			if (parentNode * 2 &gt; size) break;
			currentNode &#x3D; (head[parentNode * 2] &gt; head[parentNode * 2 + 1]) ? (parentNode * 2) : (parentNode * 2 + 1);
			if (head[parentNode] &lt; head[currentNode]) &#123;
				int temp &#x3D; head[parentNode];
				head[parentNode] &#x3D; head[currentNode];
				head[currentNode] &#x3D; temp;
				parentNode &#x3D; currentNode;
			&#125;
			else &#123;
				break;
			&#125;
		&#125;

		return tempValue;
	&#125;
    
    int top() &#123; return head[1]; &#125;

	void show() &#123;
		for (int i &#x3D; 1; i &lt;&#x3D; size; i++) &#123;
			cout &lt;&lt; head[i] &lt;&lt; &quot; &quot;;
		&#125;
	&#125;
&#125;;</code></pre>
<h2 id="Practice"><a href="#Practice" class="headerlink" title="Practice"></a>Practice</h2><ul>
<li><a href="https://www.luogu.com.cn/problem/P1090">https://www.luogu.com.cn/problem/P1090</a></li>
<li><a href="https://www.luogu.com.cn/problem/P1168">https://www.luogu.com.cn/problem/P1168</a></li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://github.com/raywenderlich/swift-algorithm-club/tree/master/Heap">https://github.com/raywenderlich/swift-algorithm-club/tree/master/Heap</a></li>
<li><a href="http://www.cplusplus.com/reference/algorithm/">http://www.cplusplus.com/reference/algorithm/</a></li>
</ul>
]]></content>
      <tags>
        <tag>Data Structure</tag>
        <tag>Heap</tag>
      </tags>
  </entry>
  <entry>
    <title>DSA 学习笔记</title>
    <url>/2021/08/dsa-note/</url>
    <content><![CDATA[<p>《数据结构与算法》课程笔记整理，目前更新中.</p>
<p><a href="/DSA/">跳转链接</a></p>
]]></content>
      <tags>
        <tag>Data Structure</tag>
      </tags>
  </entry>
  <entry>
    <title>一些参数方程/极坐标图像</title>
    <url>/2020/12/figure-of-some-curves/</url>
    <content><![CDATA[<p>菜鸡没学过4-4，在微积分应用里面积面积和体积的时候有的草图画不出来…</p>
<h2 id="星形线"><a href="#星形线" class="headerlink" title="星形线"></a>星形线</h2><script type="math/tex; mode=display">
x^{\frac 2 3}+y^{\frac 2 3}=a^{\frac 2 3} \\
\begin{cases}
x=a\cos^3t\\
y=a\sin^3t
\end{cases}</script><p><img src="https://s3.ax1x.com/2020/12/26/r4AL8K.png" alt=""></p>
<h2 id="摆线"><a href="#摆线" class="headerlink" title="摆线"></a>摆线</h2><script type="math/tex; mode=display">
\begin {cases}
x= a(t-\sin t)\\
y=a(1-\cos t)
\end {cases}</script><p><img src="https://s3.ax1x.com/2020/12/26/r4E12T.png" alt=""></p>
<p>图为$-4\pi \le t \le 4\pi, a=1$的图像.</p>
<p>周期为$2\pi$.</p>
<h2 id="双纽线"><a href="#双纽线" class="headerlink" title="双纽线"></a>双纽线</h2><p><a href="https://imgchr.com/i/r4VeSK"><img src="https://s3.ax1x.com/2020/12/26/r4VeSK.png" alt="r4VeSK.png"></a></p>
<h2 id="笛卡尔心形线"><a href="#笛卡尔心形线" class="headerlink" title="笛卡尔心形线"></a>笛卡尔心形线</h2><p><a href="https://imgchr.com/i/r4ZSht"><img src="https://s3.ax1x.com/2020/12/26/r4ZSht.png" alt="r4ZSht.png"></a></p>
<h2 id="其它曲线"><a href="#其它曲线" class="headerlink" title="其它曲线"></a>其它曲线</h2><p><a href="https://imgchr.com/i/r4ZeNn"><img src="https://s3.ax1x.com/2020/12/26/r4ZeNn.png" alt="r4ZeNn.png"></a></p>
<p><a href="https://imgchr.com/i/r4Zu90"><img src="https://s3.ax1x.com/2020/12/26/r4Zu90.png" alt="r4Zu90.png"></a></p>
<p><a href="https://imgchr.com/i/r4ZK3V"><img src="https://s3.ax1x.com/2020/12/26/r4ZK3V.png" alt="r4ZK3V.png"></a></p>
<p><a href="https://imgchr.com/i/r4ZMcT"><img src="https://s3.ax1x.com/2020/12/26/r4ZMcT.png" alt="r4ZMcT.png"></a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://mm.edrawsoft.cn/template/65439">https://mm.edrawsoft.cn/template/65439</a></li>
<li>部分图像采用 GeoGebra 绘制</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Hash Table（散列表）</title>
    <url>/2020/11/hash-table/</url>
    <content><![CDATA[<p>　　散列表的相关概念和内容　　</p>
<p>​        <strong>散列表</strong>（<strong>Hash table</strong>，也叫<strong>哈希表</strong>），是根据键（Key）而直接访问在内存储存位置的数据结构。</p>
<p>​        也就是说，它通过计算一个关于键值的函数，将所需查询的数据映射到表中一个位置来访问记录，这加快了查找速度。</p>
<p>​        这个映射函数称做<strong>散列函数</strong>，存放记录的数组称做<strong>散列表</strong>。</p>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><ul>
<li>关键字为$k$的值存储在$f(k)$的存储位置中，称映射$f$为散列函数，按照这个思想建立的表称为<strong>散列表</strong>。</li>
<li>对不同的关键字可能得到同一散列地址，即$k_1 \neq k_2$，而$f(k_1) = f(k_2)$，这种现象称为<strong>冲突</strong>（Collision）。具有相同函数值的关键字对该散列函数来说称做<strong>同义词</strong>。</li>
<li>若对于关键字集合中的任一个关键字，经散列函数映象到地址集合中任何一个地址的概率是相等的，则称此类散列函数为<strong>均匀散列函数</strong>，这就使关键字经过散列函数得到一个“随机的地址”，从而减少冲突。</li>
</ul>
<h2 id="构造散列函数的方法"><a href="#构造散列函数的方法" class="headerlink" title="构造散列函数的方法"></a>构造散列函数的方法</h2><p>​        若采用求余的方法，采用质数可以在一定程度上解决冲突问题。</p>
<h2 id="处理冲突的方法"><a href="#处理冲突的方法" class="headerlink" title="处理冲突的方法"></a>处理冲突的方法</h2><ul>
<li>开放定址法</li>
<li>避免聚集：<ul>
<li>单独链表法</li>
<li>再散列</li>
</ul>
</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><p><a href="https://zh.wikipedia.org/wiki/%E5%93%88%E5%B8%8C%E8%A1%A8">https://zh.wikipedia.org/wiki/%E5%93%88%E5%B8%8C%E8%A1%A8</a></p>
</li>
<li><p><a href="https://blog.csdn.net/zmxiangde_88/article/details/8025541">https://blog.csdn.net/zmxiangde_88/article/details/8025541</a></p>
</li>
<li>Computer Science: An Overview, § 9.5 Traditional File Structures.</li>
</ul>
]]></content>
      <tags>
        <tag>Data Structure</tag>
        <tag>Hash Table</tag>
      </tags>
  </entry>
  <entry>
    <title>树状数组-入门</title>
    <url>/2020/12/ds-fenwick-tree-basic/</url>
    <content><![CDATA[<h2 id="Basic-Concept"><a href="#Basic-Concept" class="headerlink" title="Basic Concept"></a>Basic Concept</h2><p>树状数组可以用于高效计算数列的前缀和，区间和等等。</p>
<p>它可以支持在$O(logn)$的时间内得到任意前缀和，以及在$O(logn)$时间内支持对区间单点值的修改。空间复杂度为$O(n)$。</p>
<h3 id="数组存储方式"><a href="#数组存储方式" class="headerlink" title="数组存储方式"></a>数组存储方式</h3><p><img src="https://s3.ax1x.com/2020/12/22/rD8IfS.png" alt="rD8IfS.png"></p>
<p>如图所示。</p>
<p>$A[i]$代表原数组的元素，$C[i]$代表树状数组中的元素。</p>
<pre class="language-c++" data-language="c++"><code class="language-c++">C[1]&#x3D;A[1];
C[2]&#x3D;A[1]+A[2];
C[3]&#x3D;A[3];
C[4]&#x3D;A[1]+A[2]+A[3]+A[4];
C[5]&#x3D;A[5];
C[6]&#x3D;A[5]+A[6];
C[7]&#x3D;A[7];
C[8]&#x3D;A[1]+A[2]+A[3]+A[4]+A[5]+A[6]+A[7]+A[8];</code></pre>
<p>而其索引的二进制表示如下：</p>
<pre class="language-c++" data-language="c++"><code class="language-c++">C[1] &#x3D; C[0001] &#x3D; A[1];
C[2] &#x3D; C[0010] &#x3D; A[1]+A[2];
C[3] &#x3D; C[0011] &#x3D; A[3];
C[4] &#x3D; C[0100] &#x3D; A[1]+A[2]+A[3]+A[4];
C[5] &#x3D; C[0101] &#x3D; A[5];
C[6] &#x3D; C[0110] &#x3D; A[5]+A[6];
C[7] &#x3D; C[0111] &#x3D; A[7];
C[8] &#x3D; C[1000] &#x3D; A[1]+A[2]+A[3]+A[4]+A[5]+A[6]+A[7]+A[8];</code></pre>
<p>我们可以找出规律，</p>
<script type="math/tex; mode=display">
C[i] =\sum_{k=把i二进制表示的最低位1置为0后，将新的值+1}^i A[k]</script><p>也就是说，问题在于如何找出$i$的最低位$1$所代表的数值。</p>
<h3 id="lowbit"><a href="#lowbit" class="headerlink" title="lowbit"></a>lowbit</h3><p>这里我们可以引入<code>lowbit</code>函数。</p>
<pre class="language-c++" data-language="c++"><code class="language-c++">int lowbit (int x)
&#123;
	return x &amp; (-x);
&#125;</code></pre>
<p>我们已经知道，对于整数表示，有</p>
<ul>
<li><p>正数的补码是其本身；</p>
</li>
<li><p>负数的补码是在反码的基础上$+1$；</p>
</li>
</ul>
<p>因此<code>x &amp; (-x)</code>就可以满足我们对于查找最低位$1$的需求。</p>
<p>举个例子：</p>
<ul>
<li>二进制数 $11010$ (1) </li>
<li><p>其反码为 $00101$ (2)</p>
</li>
<li><p>加 $1$ 后为 $00110$ (3)</p>
</li>
<li>将(1)(3)两者相与便得到最低位的 $1$ 所表示的数值</li>
</ul>
<h2 id="树状数组的建立"><a href="#树状数组的建立" class="headerlink" title="树状数组的建立"></a>树状数组的建立</h2><p>上面准备工作都做好了，码就行了:(</p>
<pre class="language-c++" data-language="c++"><code class="language-c++">#include &lt;iostream&gt;
#define MAXN 12
using namespace std;

int ft[MAXN+1] &#x3D; &#123;0&#125;;
int a[MAXN + 1] &#x3D; &#123;0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12&#125;;

int lowbit(int x)&#123;
    return x &amp; (-x);
&#125;

void generateTree()&#123;
    for (int i &#x3D; 1; i &lt;&#x3D; MAXN; i++)&#123;
        for (int k &#x3D; i - lowbit(i) + 1; k &lt;&#x3D; i; k++)
            ft[i] +&#x3D; a[k];
    &#125;
&#125;

int main()&#123;
    generateTree();
    return 0;
&#125;</code></pre>
<h2 id="单点更新"><a href="#单点更新" class="headerlink" title="单点更新"></a>单点更新</h2><p>再把这张图拿过来：</p>
<p><img src="https://s3.ax1x.com/2020/12/22/rD8IfS.png" alt="rD8IfS.png"></p>
<p>如果我们要更改$A[3]$的值，那么我们知道，$C[3], C[4], C[8]$ 的值都会受到影响。</p>
<ul>
<li>$3(011)$ =&gt; <code>C[3] += temp;</code></li>
<li>$lowbit(3) = 001$, $3 + lowbit(3)= 100 = 4(100)$ =&gt; <code>C[4] += temp;</code></li>
<li>$lowbit(4) = 100$, $4+lowbit(4)=1000=8(1000)$ =&gt; <code>C[8] += temp;</code></li>
<li>……</li>
</ul>
<p>因此，我们只需要对所要更新的数据不断使其自增lowbit后，</p>
<p>使树状数组的对应索引增加 temp 值即可。</p>
<pre class="language-c++" data-language="c++"><code class="language-c++">void update(int index, int val)&#123;
    for (int i &#x3D; index; i &lt;&#x3D; MAXN; i &#x3D; i + lowbit(i))&#123;
        ft[i] +&#x3D; val;
    &#125;
&#125;</code></pre>
<h2 id="区间查询"><a href="#区间查询" class="headerlink" title="区间查询"></a>区间查询</h2><p>假设现在我们要查询1~7的前缀和。</p>
<pre class="language-c++" data-language="c++"><code class="language-c++">C[7] &#x3D; C[0111] &#x3D; A[7];
C[6] &#x3D; C[0110] &#x3D; A[5] + A[6];
C[4] &#x3D; C[0100] &#x3D; A[1] + A[2] + A[3] + A[4];</code></pre>
<p>归纳可知，我们只需每次将索引减少i的lowbit，然后将对应的树状数组的值求和即可。</p>
<pre class="language-c++" data-language="c++"><code class="language-c++">int getSum(int index)&#123;
    int result &#x3D; 0;
    for (int k &#x3D; index; k &gt; 0; k-&#x3D;lowbit(k))&#123;
        result +&#x3D; ft[k];
    &#125;
    return result;
&#125;</code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://zh.wikipedia.org/wiki/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84">https://zh.wikipedia.org/wiki/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84</a>‘</li>
<li><a href="https://bestsort.cn/2019/04/26/195/">https://bestsort.cn/2019/04/26/195/</a></li>
</ul>
]]></content>
      <tags>
        <tag>Data Structure</tag>
      </tags>
  </entry>
  <entry>
    <title>实现 MNIST 鉴别手写数字过程手记</title>
    <url>/2021/09/implementing-MNIST-classifier/</url>
    <content><![CDATA[<p>在学习了相关的<a href="https://cc7w.cf/but-what-is-a-neural-network/">理论基础</a>之后，我们自然是要投入到实践之中，完成这项机器学习领域的 Hello World 任务.</p>
<p>本篇文章会用来记录 c7w 操作的全过程，以及他试图使用 python3 来拟合一篇 python2 教程的痛苦.</p>
<span id="more"></span>
<h1 id="MNIST-Classifier-Implemention"><a href="#MNIST-Classifier-Implemention" class="headerlink" title="MNIST Classifier Implemention"></a>MNIST Classifier Implemention</h1><h2 id="Fetch-dataset"><a href="#Fetch-dataset" class="headerlink" title="Fetch dataset"></a>Fetch dataset</h2><h3 id="Download"><a href="#Download" class="headerlink" title="Download"></a>Download</h3><p>下载数据包，前往 <a href="http://yann.lecun.com/exdb/mnist/">MNIST 官方网站</a>，把 Trainset 和 Testset 的两组数据全部下载。<s>然后去摸鱼</s></p>
<p><img src="https://i.loli.net/2021/09/03/yRuLJvqO2eEI9MX.png" alt="image-20210903235728102"></p>
<p><strong>数据格式</strong></p>
<blockquote>
<h3 id="TRAINING-SET-LABEL-FILE-train-labels-idx1-ubyte"><a href="#TRAINING-SET-LABEL-FILE-train-labels-idx1-ubyte" class="headerlink" title="TRAINING SET LABEL FILE (train-labels-idx1-ubyte):"></a>TRAINING SET LABEL FILE (train-labels-idx1-ubyte):</h3><pre class="language-none"><code class="language-none">&gt;[offset] [type]     [value]     [description]&#96;
&gt;&#96;0000   32 bit integer 0x00000801(2049) magic number (MSB first)&#96;
&gt;&#96;0004   32 bit integer 60000      number of items&#96;
&gt;&#96;0008   unsigned byte  ??        label&#96;
&gt;&#96;0009   unsigned byte  ??        label&#96;
&gt;&#96;........&#96;
&gt;&#96;xxxx   unsigned byte  ??        label
&gt;The labels values are 0 to 9.</code></pre>
<h3 id="TRAINING-SET-IMAGE-FILE-train-images-idx3-ubyte"><a href="#TRAINING-SET-IMAGE-FILE-train-images-idx3-ubyte" class="headerlink" title="TRAINING SET IMAGE FILE (train-images-idx3-ubyte):"></a>TRAINING SET IMAGE FILE (train-images-idx3-ubyte):</h3><pre class="language-none"><code class="language-none">&gt;[offset] [type]     [value]     [description]&#96;
&gt;&#96;0000   32 bit integer 0x00000803(2051) magic number&#96;
&gt;&#96;0004   32 bit integer 60000      number of images&#96;
&gt;&#96;0008   32 bit integer 28        number of rows&#96;
&gt;&#96;0012   32 bit integer 28        number of columns&#96;
&gt;&#96;0016   unsigned byte  ??        pixel&#96;
&gt;&#96;0017   unsigned byte  ??        pixel&#96;
&gt;&#96;........&#96;
&gt;&#96;xxxx   unsigned byte  ??        pixel</code></pre>
</blockquote>
<h3 id="Use-Pickle-to-load-dataset"><a href="#Use-Pickle-to-load-dataset" class="headerlink" title="Use Pickle to load dataset"></a>Use <strong>Pickle</strong> to load dataset</h3><h2 id="Define-network"><a href="#Define-network" class="headerlink" title="Define network"></a>Define network</h2><h3 id="Init-function"><a href="#Init-function" class="headerlink" title="Init function"></a>Init function</h3><p><strong><code>np.random.randn(d0, d1, ...)</code> 生成随机初值</strong></p>
<p>生成均值为 0，标准差为 1 的正态分布</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token operator">>></span><span class="token operator">></span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">0.5868205495246934</span>
<span class="token operator">>></span><span class="token operator">></span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">1.0092581568418932</span>
<span class="token operator">>></span><span class="token operator">></span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">0.056108818546049016</span>
<span class="token operator">>></span><span class="token operator">></span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.19376191</span><span class="token punctuation">,</span>  <span class="token number">0.28157974</span><span class="token punctuation">,</span>  <span class="token number">0.77366971</span><span class="token punctuation">,</span>  <span class="token number">0.06783304</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.8541143</span> <span class="token punctuation">,</span>  <span class="token number">0.75650134</span><span class="token punctuation">,</span>  <span class="token number">0.59333362</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.65325825</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p><strong><code>zip(a, b)</code> 生成矩阵大小元组</strong></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">zip</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token builtin">zip</span> <span class="token builtin">object</span> at <span class="token number">0x7f48aac07140</span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">1</span> <span class="token number">5</span>
<span class="token number">2</span> <span class="token number">6</span>
<span class="token number">3</span> <span class="token number">7</span>
<span class="token number">4</span> <span class="token number">8</span>

<span class="token comment"># If their size does not match ?</span>
<span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">zip</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token builtin">zip</span> <span class="token builtin">object</span> at <span class="token number">0x7f48a93bfb00</span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>
<p><strong>Network 类的构造</strong></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np


<span class="token keyword">class</span> <span class="token class-name">Network</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sizes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>num_layers <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sizes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sizes <span class="token operator">=</span> sizes
        self<span class="token punctuation">.</span>biases <span class="token operator">=</span> <span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> y <span class="token keyword">in</span> sizes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>weights <span class="token operator">=</span> <span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
                        <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>sizes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sizes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre>
<p>对构造函数进行测试…</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Test</span>
network <span class="token operator">=</span> Network<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>network<span class="token punctuation">.</span>biases<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>network<span class="token punctuation">.</span>weights<span class="token punctuation">)</span></code></pre>
<pre class="language-none"><code class="language-none">[array([[-0.69137659],
       [ 0.38159818],
       [ 1.99258114],
       [-0.21144943]]), array([[1.71569818]])]
# Biases: [&lt;Array 4x1&gt;, &lt;Array 1x1&gt;]

[array([[-1.23719403,  1.53304051,  1.33083345,  0.57793759,  1.64201695,
        -1.09019958, -1.72304327, -1.37257551],
       [ 1.55140653, -0.66066249,  0.24355521, -0.06090572,  0.7280547 ,    
        -0.09691786, -1.06502271, -0.39097928],
       [-0.37874956,  0.71162084,  0.23456423, -0.34639554, -1.13344851,    
         0.89943267,  0.44945541, -0.59622082],
       [ 1.90930694,  0.4098545 ,  1.7352552 ,  1.04517198, -0.2241232 ,    
         0.14171245,  0.07186716,  2.50271226]]), array([[ 0.58568595, -1.9973499 ,  0.36131549, -0.07790474]])]
# Weights: [&lt;Array 4x8&gt;, &lt;Array 1x4&gt;]</code></pre>
<p>为什么要这么构造？我们回忆…</p>
<ul>
<li>Our notations are: $a^{(2)} = \sigma(W^{(2)}a^{(1)}+b^{(2)})$</li>
<li>Namely $\begin {bmatrix} a<em>1^{(2)}\ a_2^{(2)}\ \vdots\ a_k^{(2)}\ \end {bmatrix}= \sigma( \begin {bmatrix} w^{(2)}</em>{1,1} &amp; w^{(2)}<em>{1,2} &amp; \cdots &amp; w^{(2)}</em>{1,n} \ w^{(2)}<em>{2,1} &amp; w^{(2)}</em>{2,2} &amp; \cdots &amp; w^{(2)}<em>{2,n} \ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \ w^{(2)}</em>{k,1} &amp; w^{(2)}<em>{k,2} &amp; \cdots &amp; w^{(2)}</em>{k,n}  \end {bmatrix}\begin {bmatrix} a_1^{(1)}\ a_2^{(1)}\ \vdots\ a_n^{(1)}\ \end {bmatrix} + \begin {bmatrix} b_1^{(2)}\ b_2^{(2)}\ \vdots\ b_k^{(2)}\ \end {bmatrix})$</li>
<li>Suppose Layer $m-1$​ has $n$​​ neurons and layer $m$ has $k$ neurons.<ul>
<li>Layer $m$ has $k$​ biases because each neuron in layer $m$ has its own bias.</li>
<li>Each neuron in layer $m$​ has $n$ related weights in layer $m-1$​, namely neuron $i$ in layer $m$ has its weights $w<em>{i, 1}, w</em>{i, 2}, \cdots, w_{1, n}$</li>
</ul>
</li>
</ul>
<pre class="mermaid">graph LR
subgraph "Layer m-1"
A0("1")
A1("2")
A2("3")
A3("4")
end
subgraph "Layer m"
B2("m(i-1)")
B0("m(i)")
B1("m(i+1)")
end
A0 --> B0
A1 --> B0
A2 --> B0
A3 --> B0</pre>

<p>也就是说，layer $m-1$ 与 layer $m$​​ 之间的权矩阵大小应该是 <code>len(m) * len(m-1)</code>, namely 构造函数中的 <code>y * x</code>.</p>
<h3 id="Sigmoid-function-and-its-deriative"><a href="#Sigmoid-function-and-its-deriative" class="headerlink" title="Sigmoid function and its deriative"></a>Sigmoid function and its deriative</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">sigmoid</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">+</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">sigmoid_deriative</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<script type="math/tex; mode=display">
\begin{align*}
\sigma'(x) & =  (\frac 1 {1+e^{-x}})' \\
& = \frac {e^{-x}} {({1+e^{-x}})^2} \\
& = (\frac 1 {1+e^{-x}})*(\frac {e^{-x}} {1+e^{-x}}) \\ 
& = (\frac 1 {1+e^{-x}})*(1 -\frac {1} {1+e^{-x}}) \\
& = \sigma(x)*(1-\sigma(x))
\end{align*}</script><h3 id="Stochastic-gradient-descent"><a href="#Stochastic-gradient-descent" class="headerlink" title="Stochastic gradient descent"></a>Stochastic gradient descent</h3><h4 id="Concept"><a href="#Concept" class="headerlink" title="Concept"></a>Concept</h4><p>我们回忆，在理论学习中，我们学到的 SGD 内容。</p>
<p><strong>Batch_size? Epoch? Iteration?</strong></p>
<p>比如你有1000个数据，这个数据集可能太大了，全部跑一次再调参很慢，于是可以分成100个为一个数据集，这样有10份。<strong>batch_size=100</strong></p>
<p>这100个数据组成的数据集叫 <strong>batch</strong>，每跑完一个 <strong>batch</strong> 都要更新参数，这个过程叫一个<strong>iteration</strong>.</p>
<p><strong>epoch</strong> 指的就是跑完这 10 个 <strong>batch</strong> （ 10 个 <strong>iteration</strong> ）的这个过程.</p>
<h4 id="Implemention"><a href="#Implemention" class="headerlink" title="Implemention"></a>Implemention</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Stochastic gradient descent</span>
<span class="token keyword">def</span> <span class="token function">SGD</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> training_data<span class="token punctuation">,</span> epochs<span class="token punctuation">,</span> mini_batch_size<span class="token punctuation">,</span> eta<span class="token punctuation">,</span> test_data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> test_data<span class="token punctuation">:</span>
        n_test <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>test_data<span class="token punctuation">)</span>
    n <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>training_data<span class="token punctuation">)</span>

    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>training_data<span class="token punctuation">)</span>
        <span class="token comment"># Divide training data into lists</span>
        mini_batches <span class="token operator">=</span> <span class="token punctuation">[</span>training_data<span class="token punctuation">[</span>mini_batch_size<span class="token operator">*</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span> mini_batch_size<span class="token operator">*</span><span class="token punctuation">(</span>
            k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>n<span class="token operator">+</span>mini_batch_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">//</span>mini_batch_size<span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> mini_batch <span class="token keyword">in</span> mini_batches<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>update_mini_batch<span class="token punctuation">(</span>mini_batch<span class="token punctuation">,</span> eta<span class="token punctuation">)</span>

    <span class="token keyword">if</span> test_data<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f'''Epoch </span><span class="token interpolation"><span class="token punctuation">&#123;</span>j<span class="token punctuation">&#125;</span></span><span class="token string"> finished, with an accuracy of </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>n_test<span class="token punctuation">&#125;</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span><span class="token operator">/</span>n_test<span class="token punctuation">&#125;</span></span><span class="token string">)'''</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Epoch </span><span class="token interpolation"><span class="token punctuation">&#123;</span>j<span class="token punctuation">&#125;</span></span><span class="token string"> finished."</span></span><span class="token punctuation">)</span></code></pre>
<h4 id="Parameters"><a href="#Parameters" class="headerlink" title="Parameters"></a>Parameters</h4><ul>
<li>training_data: list of tuples, where each tuple is (DATA, LABEL)</li>
<li>epochs: determines the training data would be used how many times</li>
<li>mini_batch_size: determines the size of every small batch</li>
<li>eta: learning rate, in $ v \rightarrow (v’=v-\eta\nabla C)$</li>
<li>test_data: for verifying accuracy after each epoch</li>
</ul>
<h4 id="Update-mini-batches"><a href="#Update-mini-batches" class="headerlink" title="Update mini-batches"></a>Update mini-batches</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">update_mini_batch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mini_batch<span class="token punctuation">,</span> eta<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Init nabla matrices</span>
    nabla_b <span class="token operator">=</span> <span class="token punctuation">[</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>b<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> self<span class="token punctuation">.</span>biases<span class="token punctuation">]</span>
    nabla_w <span class="token operator">=</span> <span class="token punctuation">[</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>w<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token keyword">for</span> w <span class="token keyword">in</span> self<span class="token punctuation">.</span>weights<span class="token punctuation">]</span>

    <span class="token comment"># Accumulate to calc nablas</span>
    <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> mini_batch<span class="token punctuation">:</span>
        delta_nabla_b<span class="token punctuation">,</span> delta_nabla_w <span class="token operator">=</span> self<span class="token punctuation">.</span>backprop<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        nabla_b <span class="token operator">=</span> <span class="token punctuation">[</span>nb<span class="token operator">+</span>dnb <span class="token keyword">for</span> nb<span class="token punctuation">,</span> dnb <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>nabla_b<span class="token punctuation">,</span> delta_nabla_b<span class="token punctuation">)</span><span class="token punctuation">]</span>
        nabla_w <span class="token operator">=</span> <span class="token punctuation">[</span>nw<span class="token operator">+</span>dnw <span class="token keyword">for</span> nw<span class="token punctuation">,</span> dnw <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>nabla_w<span class="token punctuation">,</span> delta_nabla_w<span class="token punctuation">)</span><span class="token punctuation">]</span>
    
    <span class="token comment"># Update weights and biases</span>
    self<span class="token punctuation">.</span>biases <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token operator">-</span>nb<span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>mini_batch<span class="token punctuation">)</span><span class="token operator">*</span>eta <span class="token keyword">for</span> b<span class="token punctuation">,</span>
                   nb <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>biases<span class="token punctuation">,</span> nabla_b<span class="token punctuation">)</span><span class="token punctuation">]</span>
    self<span class="token punctuation">.</span>weights <span class="token operator">=</span> <span class="token punctuation">[</span>w<span class="token operator">-</span>nw<span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>mini_batch<span class="token punctuation">)</span><span class="token operator">*</span>eta <span class="token keyword">for</span> w<span class="token punctuation">,</span>
                    nw <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> nabla_w<span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>
<h3 id="Back-propagation"><a href="#Back-propagation" class="headerlink" title="Back propagation"></a>Back propagation</h3><pre class="mermaid">graph LR
subgraph "Layer m-1"
A0("1")
A1("2")
A2("3")
A3("4")
end
subgraph "Layer m"
B2("output(i-1)")
B0("output(i)")
B1("output(i+1)")
end
subgraph "Anticipated<br/>Label"
C2("y(i-1)")
C0("y(i)")
C1("y(i+1)")
end
A0 --> B0
A1 --> B0
A2 --> B0
A3 --> B0
B0 --> C0
B1 --> C1
B2 --> C2</pre>

<p>考虑计算过程…</p>
<pre class="mermaid">graph RL
CX("$C$")
aE("$a^L$")
zE("$z^L$")
wE("$w^L$")
aEL("$a^{L-1}$")
bE("$b^L$")
zEL("$z^{L-1}$")
wEL("$w^{L-1}$")
aELL("$a^{L-2}$")
bEL("$b^{L-1}$")

aE -->|"$(y_x-a^L_x)^2$"| CX
zE -->|"$\sigma$"| aE
wE --> zE
aEL --> zE
bE --> zE
zEL -->|"$\sigma$"| aEL
wEL --> zEL
aELL --> zEL
bEL --> zEL
dot("$\cdots$") --> aELL</pre>

<ul>
<li>Then the core equations of back propagation…<ul>
<li>$\frac {\partial C} {\partial z_i^L} = \frac {\partial C} {\partial a_i^L}\frac {\partial a_i^L} {\partial z_i^L} = (a_i^L-y)\sigma’(z_i^L)$​​ (Initialize)​</li>
<li>According to $z^{(L)}<em>i = \sum_jw^{(L)}</em>{i, j}a_j^{(L-1)}+ b_i^{(L)}$​​​​, suppose we have calculated $\frac {\partial C} {\partial z^M_i}$​​​ for all neuron $i$​​​ in layer $M$​​​.<ul>
<li>How can we get $\frac {\partial C} {\partial w^M_{i, j}}$​​​ for all neuron $i$​​​ in layer $M$​​ and $j$​​ in layer $M-1$​​​​?<ul>
<li>$\frac {\partial C} {\partial w^M<em>{i, j}} = \frac {\partial C} {\partial z^M_i} \frac {\partial z^M_i}{\partial w^M</em>{i, j}} = \frac {\partial C} {\partial z^M_i} a_j^{M-1}$​​</li>
</ul>
</li>
<li>How can we get $\frac {\partial C} {\partial b^M_i} $​​ for all neuron $i$​​ in layer $M$​?<ul>
<li>$\frac {\partial C} {\partial b^M<em>{i}} = \frac {\partial C} {\partial z^M_i} \frac {\partial z^M_i}{\partial b^M</em>{i}} = \frac {\partial C} {\partial z^M_i}$​​​</li>
</ul>
</li>
<li>How can we get $\frac {\partial C} {\partial a^{M-1}_j} $ and $\frac {\partial C} {\partial z^{M-1}_j} $ for all neuron $j$ in layer $M-1$?<ul>
<li>$\frac {\partial C} {\partial a^{M-1}<em>j}  = \sum_i \frac {\partial C}{\partial z^M_i} \frac {\partial z^M_i} {a_j^{M-1}} = \sum_i \frac {\partial C}{\partial z^M_i} w</em>{i,j}^M$</li>
<li>Then $\frac {\partial C} {\partial z^{M-1}_j} = \frac {\partial C} {\partial a^{M-1}_j} \sigma’(z^{M-1}_j)$</li>
</ul>
</li>
</ul>
</li>
<li>Then by recursion, we could calculate all the partial derivatives of weights and biases.</li>
</ul>
</li>
</ul>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">backprop</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''Return (nabla_b, nabla_w) representing the
    gradient for the cost function C.
    Each of the return value are layer-by-layer lists of numpy arrays.'''</span>
    
    nabla_b <span class="token operator">=</span> <span class="token punctuation">[</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>b<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> self<span class="token punctuation">.</span>biases<span class="token punctuation">]</span>
    nabla_w <span class="token operator">=</span> <span class="token punctuation">[</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>w<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token keyword">for</span> w <span class="token keyword">in</span> self<span class="token punctuation">.</span>weights<span class="token punctuation">]</span>
    
    <span class="token comment"># Feed forward</span>
    activation <span class="token operator">=</span> x
    activations <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">]</span>
    zs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># Store all Z vectors. z = w*a + b</span>
    
    <span class="token keyword">for</span> b<span class="token punctuation">,</span> w <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>biases<span class="token punctuation">,</span> self<span class="token punctuation">.</span>weights<span class="token punctuation">)</span><span class="token punctuation">:</span>
        z <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>w<span class="token punctuation">,</span> activation<span class="token punctuation">)</span> <span class="token operator">+</span> b
        zs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>z<span class="token punctuation">)</span>
        activation <span class="token operator">=</span> sigmoid<span class="token punctuation">(</span>z<span class="token punctuation">)</span>
        activations<span class="token punctuation">.</span>append<span class="token punctuation">(</span>activation<span class="token punctuation">)</span>
    
    <span class="token triple-quoted-string string">'''After feeding forward in a M-layer network, 
    Zs have M-1 elements while Activations have M elements'''</span>
    <span class="token comment"># Preparations for recursion</span>
    delta <span class="token operator">=</span> <span class="token punctuation">(</span>activations<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> y<span class="token punctuation">)</span> <span class="token operator">*</span> sigmoid_deriative<span class="token punctuation">(</span>z<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    nabla_b<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> delta
    nabla_w<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>delta<span class="token punctuation">,</span> activations<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_layers<span class="token punctuation">)</span><span class="token punctuation">:</span>
        delta <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>weights<span class="token punctuation">[</span><span class="token operator">-</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delta<span class="token punctuation">)</span> <span class="token operator">*</span> sigmoid_deriative<span class="token punctuation">(</span>zs<span class="token punctuation">[</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        nabla_b<span class="token punctuation">[</span><span class="token operator">-</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> delta
        nabla_w<span class="token punctuation">[</span><span class="token operator">-</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>delta<span class="token punctuation">,</span> activations<span class="token punctuation">[</span><span class="token operator">-</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">(</span>nabla_b<span class="token punctuation">,</span> nabla_w<span class="token punctuation">)</span></code></pre>
<h3 id="Evaluate"><a href="#Evaluate" class="headerlink" title="Evaluate"></a>Evaluate</h3><p><strong>Use <code>np.argmax()</code> to find the predicted label</strong></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">7</span></code></pre>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> test_data<span class="token punctuation">,</span> see<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># for x, y in test_data:</span>
    <span class="token comment">#     print(self.feedforward(x))</span>
    test_results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>self<span class="token punctuation">.</span>feedforward<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> test_data<span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token operator">==</span>y<span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">in</span> test_results<span class="token punctuation">)</span></code></pre>
<h2 id="Test-our-network"><a href="#Test-our-network" class="headerlink" title="Test our network"></a>Test our network</h2><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><p><a href="http://neuralnetworksanddeeplearning.com/chap1.html#implementing_our_network_to_classify_digits">http://neuralnetworksanddeeplearning.com/chap1.html#implementing_our_network_to_classify_digits</a></p>
</li>
<li><p><a href="https://www.zhihu.com/question/43673341/answer/341556216">https://www.zhihu.com/question/43673341/answer/341556216</a></p>
</li>
</ul>
]]></content>
      <tags>
        <tag>Machine Learning</tag>
      </tags>
  </entry>
  <entry>
    <title>合同矩阵与相似矩阵</title>
    <url>/2020/12/matrix-congruence-and-similarity/</url>
    <content><![CDATA[<h2 id="合同矩阵"><a href="#合同矩阵" class="headerlink" title="合同矩阵"></a>合同矩阵</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>称两矩阵$A,B$合同，当且仅当存在可逆矩阵$C$，使得</p>
<script type="math/tex; mode=display">
A=C^TBC</script><h3 id="性质"><a href="#性质" class="headerlink" title="性质"></a>性质</h3><ol>
<li>合同关系是等价关系.</li>
</ol>
<ul>
<li>自反性: $A$与$A$本身合同</li>
<li>对称性: $A$合同于$B$, 则$B$合同于$A$</li>
<li>传递性: $A$合同于$B$, $B$合同于$C$, 则$A$合同于$C$.</li>
</ul>
<ol>
<li>合同矩阵的<strong>秩</strong>相同。</li>
</ol>
<h2 id="相似矩阵"><a href="#相似矩阵" class="headerlink" title="相似矩阵"></a>相似矩阵</h2><h3 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h3><p>称两矩阵$A,B$相似，当且仅当存在可逆矩阵$C$，使得</p>
<script type="math/tex; mode=display">
A=C^{-1}BC</script><h3 id="性质-1"><a href="#性质-1" class="headerlink" title="性质"></a>性质</h3><ol>
<li>相似关系是等价关系.</li>
</ol>
<ul>
<li>自反性: $A$与$A$本身相似</li>
<li>对称性: $A$相似于$B$, 则$B$相似于$A$</li>
<li>传递性: $A$相似于$B$, $B$相似于$C$, 则$A$相似于$C$.</li>
</ul>
<ol>
<li>相似矩阵具有一系列相同的特点.</li>
</ol>
<ul>
<li>两者的秩相等；</li>
<li>两者的行列式值相等；</li>
<li>两者的迹相等；</li>
<li>两者拥有同样的特征值，但相应的特征向量一般不同；</li>
<li>两者拥有同样的特征多项式；<br>（我们可以利用这些必要条件来判断两个矩阵是否相似）</li>
</ul>
<ol>
<li>相似矩阵具有相同的可逆性，当它们可逆时，则它们的逆矩阵也相似。</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>Hello, World.</title>
    <url>/2020/11/hello-world/</url>
    <content><![CDATA[<p>没钱结款只得把自己博客搬家的屑</p>
<h2 id="c7w-的破站-ver-2-0"><a href="#c7w-的破站-ver-2-0" class="headerlink" title="c7w 的破站 ver 2.0"></a>c7w 的破站 ver 2.0</h2><p>​        之前用 WordPress 搭的小站快要到期了，现在也不好找免费的虚拟主机薅羊毛，遂借用 github.io + Hexo 搭建本“静态博客”，来记录今后的点滴。</p>
<p><s>         azaz，我打点滴第一候选项是垫底，bksw</s></p>
<p>​        然后强行安利了贵班的文艺委员也用上了这种方法建的博客，甚至还组建了班级的github organisation.</p>
<p>​    等有空了就写博文，咕咕咕</p>
]]></content>
      <tags>
        <tag>日志</tag>
      </tags>
  </entry>
  <entry>
    <title>《机器学习笔记》笔记</title>
    <url>/2021/09/ml-notes/</url>
    <content><![CDATA[<p><strong>Notes for LeeML-Notes</strong></p>
<p>正如篇名，是机器学习笔记的笔记。</p>
<p>主要还是记录一些重要概念和思考的过程吧。</p>
<p>笔记的笔记中，第一个笔记的链接：</p>
<ul>
<li><a href="https://datawhalechina.github.io/leeml-notes/#/">https://datawhalechina.github.io/leeml-notes/#/</a></li>
</ul>
<p>对应视频的链接：</p>
<ul>
<li><a href="https://www.bilibili.com/video/BV1Ht411g7Ef">https://www.bilibili.com/video/BV1Ht411g7Ef</a></li>
</ul>
<span id="more"></span>
<h2 id="机器学习介绍"><a href="#机器学习介绍" class="headerlink" title="机器学习介绍"></a>机器学习介绍</h2><h3 id="发展历程及基础概念"><a href="#发展历程及基础概念" class="headerlink" title="发展历程及基础概念"></a>发展历程及基础概念</h3><ul>
<li>在存在深度学习之前，通过 hand-crafted rules 来设定过滤规则</li>
<li>机器学习的过程<ul>
<li>Training<ul>
<li>Define a set of functions as <strong>Model</strong></li>
<li>Evaluate the goodness of these functions</li>
<li>Pick the best function $f^<em>$ from the <em>*Model</em></em></li>
</ul>
</li>
<li>Testing<ul>
<li>Using $f^*$</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://datawhalechina.github.io/leeml-notes/chapter1/res/chapter1-21.png" alt="img"></p>
<h3 id="相关技术"><a href="#相关技术" class="headerlink" title="相关技术"></a>相关技术</h3><ul>
<li>监督学习 Supervised learning<ul>
<li>Tasks<ul>
<li>Regression<ul>
<li>The output of the target function $f$ is scalar.</li>
</ul>
</li>
<li>Classification<ul>
<li>Binary classification (Output: yes/no)</li>
<li>Multi-class classification</li>
</ul>
</li>
<li>Structured Learning<ul>
<li>The output is well-structured.</li>
</ul>
</li>
</ul>
</li>
<li>How to select function set?<ul>
<li>Non-linear model, the most famous of which is <strong>Deep Learning</strong></li>
<li>Other non-linear models, like SVM…</li>
</ul>
</li>
</ul>
</li>
<li>半监督学习 Semi-supervised Learning<ul>
<li>non-labelled data</li>
</ul>
</li>
<li>迁移学习 Transfer Learning<ul>
<li>Pictures that are not related to the topic could help…?</li>
</ul>
</li>
<li>无监督学习 Unsupervised Learning</li>
<li>强化学习 Reinforcement Learning<ul>
<li>我们没有告诉机器正确的答案是什么，机器所拥有的只有一个分数，就是他做的好还是不好</li>
</ul>
</li>
</ul>
<h2 id="Regression"><a href="#Regression" class="headerlink" title="Regression"></a>Regression</h2><p>找到函数$f$，使得对于任意给定特征$x$，输出数值$scalar$.</p>
<h3 id="Steps"><a href="#Steps" class="headerlink" title="Steps"></a>Steps</h3><ul>
<li>模型假设，选择模型框架（线性模型）</li>
<li>模型评估，如何判断众多模型的好坏（损失函数）</li>
<li>模型优化，如何筛选最优的模型（梯度下降）</li>
</ul>
<h3 id="可能出现的问题"><a href="#可能出现的问题" class="headerlink" title="可能出现的问题"></a>可能出现的问题</h3><ul>
<li>过拟合</li>
<li>Customize learning rate</li>
</ul>
<h3 id="步骤优化"><a href="#步骤优化" class="headerlink" title="步骤优化"></a>步骤优化</h3><ul>
<li>合并多个线性模型，使用 $\delta$ 函数</li>
<li>给予更多参数</li>
<li>正则化 Regularization<ul>
<li>$L=\sum_n (y-(b+\sum_iw_ix_i)) + \lambda\sum w_i^2$</li>
<li>使得 Loss function 更加平滑</li>
</ul>
</li>
</ul>
<h2 id="分析误差"><a href="#分析误差" class="headerlink" title="分析误差"></a>分析误差</h2><p>通过分析误差的来源，以期达到改善模型时有着手点的效果.</p>
<h3 id="Concept"><a href="#Concept" class="headerlink" title="Concept"></a>Concept</h3><ul>
<li>Average Error = error due to “bias” + error due to variance</li>
<li>Notation<ul>
<li>$\hat f$ := the actual function</li>
<li>$f^*$:= the best function picked from the model trained from the training data</li>
<li>$f^*$ is an $estimator$ of $\hat f$​ </li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/09/08/eqEIoViJlbtsuyj.png" alt="image-20210908141646887"></p>
<p><img src="https://i.loli.net/2021/09/08/jmIgTdBbVQr9Al5.jpg" alt="img"></p>
<ul>
<li>Conclusion<ul>
<li>Simple Model<ul>
<li>Large Bias</li>
<li>Small Variance</li>
</ul>
</li>
<li>Complex Model<ul>
<li>Small Bias</li>
<li>Large Variance</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/09/08/lXDf6xgFKIP3HZs.png" alt="image-20210908143937650"></p>
<p><strong>How to diagnose?</strong></p>
<ul>
<li>If your model cannot fit the training data, then you have large bias. (Underfitting)<ul>
<li>Redesign your model.<ul>
<li>Add more features…</li>
<li>A more complex model…</li>
</ul>
</li>
</ul>
</li>
<li>If your model can fit the training data, but has large error on the testing data, then you have the large variance. (Overfitting)<ul>
<li>More data.<ul>
<li>Effective but not always practical.</li>
</ul>
</li>
<li>Regularization. (May do harm to bias)</li>
</ul>
</li>
</ul>
<h3 id="Cross-Validation"><a href="#Cross-Validation" class="headerlink" title="Cross Validation"></a>Cross Validation</h3><ul>
<li>In each epoch, divide your training set into <strong>training set</strong> and <strong>validation set</strong>.</li>
<li>Use <strong>training set</strong> to train your model, and use <strong>validation set</strong> to pick the best one.</li>
<li>Then by this way, the average error of <strong>testing set</strong> could represent the real error when the model is applied.</li>
<li>What if the <strong>validation set</strong> has its biases? <strong>N-fold Cross Validation</strong></li>
</ul>
<p><img src="https://i.loli.net/2021/09/08/B5v8uoTOKUFHEMD.png" alt="image-20210908145850518"></p>
<ul>
<li>Firstly pick the best model using the validation approach, then train it using the whole training set.</li>
</ul>
<h2 id="Gradient-Descent"><a href="#Gradient-Descent" class="headerlink" title="Gradient Descent"></a>Gradient Descent</h2><h3 id="Tuning-learning-rates"><a href="#Tuning-learning-rates" class="headerlink" title="Tuning learning rates"></a>Tuning learning rates</h3><p>Visualize the figure of <strong>the loss</strong> and <strong>the turn of parameters updated</strong></p>
<p><img src="https://i.loli.net/2021/09/08/j64LqduhrsWzeTa.png" alt="image-20210908153835553"></p>
<h4 id="Adaptive-learning-rates"><a href="#Adaptive-learning-rates" class="headerlink" title="Adaptive learning rates"></a>Adaptive learning rates</h4><ul>
<li>Popular &amp; Simple Idea: Reduce the learning rate by some factor every few epochs.<ul>
<li>(E.g.) $\frac 1 t \ Decay$: $\eta^{(t)} = \frac {\eta^{(0)}} {\sqrt {t+1}}$</li>
<li>But tuning learning rate cannot be one-size for all parameters. That is to say, we need to <strong>give different parameters different learning rates</strong>.</li>
</ul>
</li>
<li><p>Adagrad</p>
<ul>
<li>Divide the learning rate of each parameter by the root mean square of its previous derivatives.</li>
<li>Vanilla gradient descent: $w^{(t+1)} \leftarrow w^{(t)} - \eta^{(t)}g^{(t)}$​​​, $t\ge0$.<ul>
<li>$g$​​​ is partial derivatives</li>
</ul>
</li>
<li>Adagrad: $w^{(t+1)} \leftarrow w^{(t)} - \frac {\eta^{(t)}}{\sigma^{(t)}}g^{(t)}$, $t\ge0$.<ul>
<li>$\sigma^{(t)} = \sqrt{\frac 1 {t+1} \sum_{i=0}^t[(g^{(i)})^2]}$</li>
</ul>
</li>
<li>If we use $\frac 1 t\ Decay$ and $Adagrad$ together, we could easily have:<ul>
<li>$w^{(t+1)} = w^{(t)}-\frac{\eta^{(0)}}{\sqrt {\sum_{i=0}^t[(g^{(i)})^2]}}g^{(t)}$​</li>
</ul>
</li>
</ul>
</li>
<li><p>The best step is $\frac{|一阶偏导|}{二阶偏导}$</p>
</li>
</ul>
<h3 id="Stochastic-Gradient-Descent"><a href="#Stochastic-Gradient-Descent" class="headerlink" title="Stochastic Gradient Descent"></a>Stochastic Gradient Descent</h3><p>随机梯度下降法. Make your training faster.</p>
<ul>
<li>每处理一个例子就更新.</li>
</ul>
<h3 id="Feature-Scaling-特征缩放"><a href="#Feature-Scaling-特征缩放" class="headerlink" title="Feature Scaling 特征缩放"></a>Feature Scaling 特征缩放</h3><p><img src="https://i.loli.net/2021/09/08/dz9XaEv26imuFY3.png" alt="image-20210908161121857"></p>
<ul>
<li>两个输入的分布的范围很不一样，建议把他们的范围缩放，使得不同输入的范围是一样的.</li>
</ul>
<p><img src="https://i.loli.net/2021/09/08/hruapvB7snqGtPk.png" alt="image-20210908161952204"></p>
<h3 id="Possible-Problems"><a href="#Possible-Problems" class="headerlink" title="Possible Problems"></a>Possible Problems</h3><p><img src="https://datawhalechina.github.io/leeml-notes/chapter6/res/chapter6-23.png" alt="img"></p>
<h2 id="Classification-概率分类模型"><a href="#Classification-概率分类模型" class="headerlink" title="Classification 概率分类模型"></a>Classification 概率分类模型</h2><h3 id="回归模型与概率模型"><a href="#回归模型与概率模型" class="headerlink" title="回归模型与概率模型"></a>回归模型与概率模型</h3><ul>
<li>回归模型有其缺陷.</li>
<li>Ideal Alternatives<ul>
<li><img src="https://datawhalechina.github.io/leeml-notes/chapter10/res/chapter10-7.png" alt="img"></li>
</ul>
</li>
</ul>
<h3 id="Generative-Model"><a href="#Generative-Model" class="headerlink" title="Generative Model"></a>Generative Model</h3><p><img src="https://datawhalechina.github.io/leeml-notes/chapter10/res/chapter10-9.png" alt="img"></p>
<ul>
<li>如何进行问题的转化?<ul>
<li>两个盒子中抽一个球，抽到的是盒子1中蓝色球的概率是多少？</li>
<li>相当于两个类别中抽一个 x，抽到的是类别1中 x 的概率是多少？</li>
<li>可以转化成，随机给出一个 x，那么它属于哪一个类别（属于<strong>概率相对比较大</strong>的类别）？<ul>
<li>If $P(C_1|x) \ge 0.5$, then output $C_1$​.</li>
<li>Else output $C_2$​.</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>Prior<ul>
<li>计算 $P(C_1), P(C_2)$: $P(C_1) = N(C_1)/N(All)$</li>
</ul>
</li>
<li>Probability from Class?<ul>
<li>我们假设 Training Data 中的数据全部是从一个 Gaussian Distribution 中 sample 出来.</li>
<li><a href="https://zh.wikipedia.org/zh-hans/%E5%A4%9A%E5%85%83%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83">https://zh.wikipedia.org/zh-hans/%E5%A4%9A%E5%85%83%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83</a></li>
<li>$f_{\mu, \Sigma}(x) = \frac 1 {(2\pi)^{D/2}}\frac 1 {|\Sigma|^{1/2}} exp{-\frac 1 2 (x-\mu)^T\Sigma^{-1}(x-\mu)}$</li>
</ul>
</li>
<li>那么如何找 $\mu$ 与 $\Sigma$ ？<strong>Maximum Likelihood</strong>, 最大似然估计.<ul>
<li>Likelihood of a <em>Gaussian</em> with mean $\mu$ and covariance matrix $\Sigma$:</li>
<li>$L(\mu, \Sigma) = \Pi<em>{i=1}^n f</em>{\mu, \Sigma}(x^{(i)})$</li>
<li>Assume that $\mu^<em>, \Sigma^</em>$ is the argument of the Gaussian Distribution with the maximum likelihood.</li>
<li>And the solution…<ul>
<li>$\mu^* = \frac 1 n \sum_{i=1}^nx^{(i)}$</li>
<li>$\Sigma ^{<em>} = \frac 1 n \sum_{i=1}^n (x^{(i)}-\mu^</em>)(x^{(i)}-\mu^*)^T$​}</li>
</ul>
</li>
</ul>
</li>
<li><p>Modifying Model</p>
<ul>
<li>Using the same Covariant Matrix</li>
<li>$L(\mu^1, \mu^2, \Sigma)$ <ul>
<li>Where $\Sigma = \frac {N(C_1)} {N(All)}\Sigma^1 + \frac {N(C_2)} {N(All)}\Sigma^2$ ​</li>
</ul>
</li>
<li>经过推导，我们的 Model 可以写成 $P_{w,b}(C_1|x) = \sigma(z), z=w \cdot x + b$</li>
</ul>
</li>
<li><p>假设所有的feature都是相互独立产生的，这种分类叫做 <strong>Naive Bayes Classifier</strong>（朴素贝叶斯分类器）</p>
</li>
</ul>
<h3 id="Logistic-Regression"><a href="#Logistic-Regression" class="headerlink" title="Logistic Regression"></a>Logistic Regression</h3><ul>
<li>Review<ul>
<li>Step 1: Function Set<ul>
<li>We want to find $P_{w,b}(C_1|x)$​.<ul>
<li>If $P_{w,b}(C_1|x) \ge 0.5$ then output $C_1$, else output $C_2$.</li>
</ul>
</li>
<li>$f<em>{w,b}(x):=P</em>{w,b}(C_1|x) = \sigma(z)$, where $z=w\cdot x + b$​</li>
</ul>
</li>
<li>Step 2: Goodness of the function<ul>
<li><img src="https://i.loli.net/2021/09/09/dT4isEYZSD5QGnH.png" alt="image-20210909203309727"></li>
<li><img src="https://datawhalechina.github.io/leeml-notes/chapter11/res/chapter11-5.png" alt="img"></li>
<li><img src="https://datawhalechina.github.io/leeml-notes/chapter11/res/chapter11-6.png" alt="img"></li>
<li>Cross Entropy</li>
</ul>
</li>
<li>Step 3: Find the best<ul>
<li><img src="https://i.loli.net/2021/09/09/I2isBxThM9nrNV4.png" alt="image-20210909205827591"></li>
<li>The partial derivatives are the same as those in linear regression.</li>
<li>The logistic regression is called discriminative method.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Discriminative-v-s-Generative"><a href="#Discriminative-v-s-Generative" class="headerlink" title="Discriminative v.s. Generative"></a>Discriminative v.s. Generative</h3><ul>
<li>Same model. $P(C_1|x) = \sigma(w\cdot x + b)$<ul>
<li>Logistic Regression: Directly find $w$ and $b$</li>
<li>Generative Model: Find $\mu^1$, $\mu^2$, $\Sigma^{-1}$</li>
<li>But we won’t obtain the same set of $w$ and $b$.</li>
</ul>
</li>
</ul>
<h3 id="Multi-class-Classification"><a href="#Multi-class-Classification" class="headerlink" title="Multi-class Classification"></a>Multi-class Classification</h3><h4 id="Softmax"><a href="#Softmax" class="headerlink" title="Softmax"></a>Softmax</h4><p><img src="https://datawhalechina.github.io/leeml-notes/chapter11/res/chapter11-18.png" alt="img"></p>
<ul>
<li>Definition of the target</li>
</ul>
<p><img src="https://datawhalechina.github.io/leeml-notes/chapter11/res/chapter11-19.png" alt="img"></p>
<h3 id="Limitation-of-logistic-regression"><a href="#Limitation-of-logistic-regression" class="headerlink" title="Limitation of logistic regression"></a>Limitation of logistic regression</h3><h4 id="Feature-Transformation"><a href="#Feature-Transformation" class="headerlink" title="Feature Transformation"></a>Feature Transformation</h4><p><img src="https://datawhalechina.github.io/leeml-notes/chapter11/res/chapter11-23.png" alt="img"></p>
<ul>
<li>Middle Layer!<ul>
<li>可以将很多的逻辑回归接到一起，就可以进行特征转换.</li>
<li><img src="https://datawhalechina.github.io/leeml-notes/chapter11/res/chapter11-26.png" alt="img"></li>
</ul>
</li>
</ul>
<h2 id="Deep-Learning"><a href="#Deep-Learning" class="headerlink" title="Deep Learning"></a>Deep Learning</h2><p><strong>Step 1: Neural Network</strong></p>
<ul>
<li>Fully Connect Feedforward Network<ul>
<li>Why call it deep? <strong>Deep = Many Hidden Layers</strong></li>
<li>本质：通过 Hidden Layers 进行 Feature Transformation</li>
</ul>
</li>
</ul>
<p><strong>Step 2: Loss Function</strong></p>
<ul>
<li>Cross Entropy</li>
</ul>
<p><strong>Step 3: Find the best function</strong></p>
<ul>
<li>Gradient Descent</li>
</ul>
<h3 id="Why-deep"><a href="#Why-deep" class="headerlink" title="Why deep?"></a>Why deep?</h3><ul>
<li>More parameters, better performance</li>
<li><p>Universality Theorem</p>
<ul>
<li>Any continuous function $f:R^N \rightarrow R^M$​ can be realized by a network with one hidden layer with enough neurons.</li>
<li>So why <strong>Deep Learning</strong>, not <strong>Fat Learning</strong>?</li>
</ul>
<h2 id="CNN-Convolutional-Neuronal-Network）"><a href="#CNN-Convolutional-Neuronal-Network）" class="headerlink" title="CNN (Convolutional Neuronal Network）"></a>CNN (Convolutional Neuronal Network）</h2></li>
</ul>
<h3 id="Why-CNN-for-image"><a href="#Why-CNN-for-image" class="headerlink" title="Why CNN for image"></a>Why CNN for image</h3><ul>
<li>Some patterns are much smaller than the whole image. That is to say, a neuron only need to have connection with a small region of the image, but not the whole image.</li>
<li>But the same pattern may appear in different regions in different images.<ul>
<li>We could let these neurons share their parameters…</li>
</ul>
</li>
<li>Subsampling the pixels will not change the object.</li>
</ul>
<h3 id="The-whole-CNN-architecture"><a href="#The-whole-CNN-architecture" class="headerlink" title="The whole CNN architecture"></a>The whole CNN architecture</h3><p>Image -&gt; (Convolution -&gt; Max Pooling)$^{+}$ -&gt; Flatten -(as input)-&gt; Fully Connected Feedforward Network </p>
<h4 id="Convolution"><a href="#Convolution" class="headerlink" title="Convolution"></a>Convolution</h4><ul>
<li>Calculation approaches</li>
<li>Feature Map</li>
<li>Colorful Image</li>
</ul>
<p><img src="https://i.loli.net/2021/10/02/Y3GhrSRlVWsnofc.png" alt="image-20211002101802253"></p>
<ul>
<li><strong>Channel</strong>: 颜色通道</li>
<li>What does CNN learn? 使用 gradient ascent 寻找 input $x^{*} = arg \max_x{a^k}$</li>
<li>Deep Dream: let CNN exaggerate what it sees</li>
<li>以 Alpha Go 为例讲解 Architecture 的可选择性</li>
</ul>
<h2 id="RNN-Recurrent-Neural-Network"><a href="#RNN-Recurrent-Neural-Network" class="headerlink" title="RNN (Recurrent Neural Network)"></a>RNN (Recurrent Neural Network)</h2><ul>
<li>Example Application<ul>
<li>Slot filling: Nerual Network needs memory!</li>
<li><img src="https://i.loli.net/2021/10/02/eJHzUvSWnOcTtBD.png" alt="image-20211002120218869"></li>
<li>Bidirectional RNN<ul>
<li><img src="https://i.loli.net/2021/10/02/r4fRUpxLKGBbnyc.png" alt="image-20211002120401629"></li>
<li>Why? Have a broader view of context. 正向只看前面，反向只看后面.</li>
</ul>
</li>
<li>Long Short-term Memory (LSTM)<ul>
<li>Input signal and output signal are learned by the network itself.</li>
<li><img src="https://i.loli.net/2021/10/02/FQIxTbOJPH25DvY.png" alt="image-20211002120742395"></li>
<li><img src="https://i.loli.net/2021/10/02/Z1V2qWHmAg354ku.png" alt="image-20211002121407528"></li>
</ul>
</li>
<li>How to train RNN?<ul>
<li>Loss function? Sum over cross entropy.</li>
<li>Learning? Gradient descent. <ul>
<li>How to calc partial derivative? BPTT (Back propagation through time).</li>
<li>The error surface may be very flat or very steep. Clipping…</li>
<li>LSTM may deal with gradient vanishing, but not with gradient explode.</li>
</ul>
</li>
</ul>
</li>
<li>Applications</li>
</ul>
</li>
</ul>
<h2 id="Semi-supervised-Learning-半监督学习"><a href="#Semi-supervised-Learning-半监督学习" class="headerlink" title="Semi-supervised Learning 半监督学习"></a>Semi-supervised Learning 半监督学习</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><ul>
<li>Semi-supervised learning ${(x^r, \hat y^r)}<em>{r=1}^R, {x^u}</em>{u=R}^{R+U}$<ul>
<li>A set of unlabeled data, usually $U\gg R$</li>
</ul>
</li>
<li>Classification 半监督学习的分类<ul>
<li>Transductive learning: unlabelled data is the testing data</li>
<li>Inductive learning: unlabelled data is not in the testing data</li>
</ul>
</li>
<li>Why semi-supervised learning?<ul>
<li>Collecting data is easy, but collecting “labelled” data is expensive</li>
<li>We do semi-supervised learning in our lives</li>
</ul>
</li>
</ul>
<h3 id="Semi-supervised-learning-for-Generative-Model"><a href="#Semi-supervised-learning-for-Generative-Model" class="headerlink" title="Semi-supervised learning for Generative Model"></a>Semi-supervised learning for Generative Model</h3><p><img src="https://i.loli.net/2021/10/03/WhAsVmULjZCRGMq.png" alt="image-20211003005516326"></p>
<h3 id="Low-density-separation-assumption"><a href="#Low-density-separation-assumption" class="headerlink" title="Low-density separation assumption"></a><strong>Low-density separation assumption</strong></h3><ul>
<li>Assumption<ul>
<li>两个 Class 之间非黑即白 (Black or white)</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/10/03/nWAefx6phy41tUK.png" alt="image-20211003010157597"></p>
<p><img src="https://i.loli.net/2021/10/03/YEya7komzgsGPM6.png" alt="image-20211003011038595"></p>
<h3 id="Smoothness-assumption"><a href="#Smoothness-assumption" class="headerlink" title="Smoothness assumption"></a>Smoothness assumption</h3><ul>
<li>近朱者赤 近墨者黑<ul>
<li>“similar” x has the same $\hat y$</li>
<li>More precisely:<ul>
<li>x is not uniform.</li>
<li>if $x^1$ and $x^2$​ are close in a high density region (connected by a high density path)</li>
<li>then $y^1$ and $y^2$ are the same</li>
</ul>
</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>Machine Learning</tag>
      </tags>
  </entry>
  <entry>
    <title>【机器学习】自注意力机制 (Self-attention) 笔记</title>
    <url>/2021/10/ml-self-attention/</url>
    <content><![CDATA[<p>$Seq2seq$，自注意力机制模型的介绍。</p>
<span id="more"></span>
<h2 id="Self-attention"><a href="#Self-attention" class="headerlink" title="Self-attention"></a>Self-attention</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><ul>
<li>Input: vector set<ul>
<li>将其中每一个向量称为一个 frame</li>
</ul>
</li>
<li>Output: three possibilities<ul>
<li>Each vector has a label. $len(input) = len(output)$<ul>
<li>POS tagging （词性标注）</li>
</ul>
</li>
<li>The whole sequence has a label. $len(output) = 1$<ul>
<li>Sentiment Analysis</li>
<li>语者辨认</li>
<li>预测分子的性质</li>
</ul>
</li>
<li>Model decides the number of labels itself. $seq2seq$<ul>
<li>机器翻译</li>
<li>语音辨识</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Sequence-Labeling"><a href="#Sequence-Labeling" class="headerlink" title="Sequence Labeling"></a>Sequence Labeling</h2><p><img src="https://i.loli.net/2021/10/03/eGAKFEL3doTvXh9.png" alt="image-20211003114720496"></p>
<p><img src="https://i.loli.net/2021/10/03/8OVmctukgGzfS4i.png" alt="image-20211003115024375"></p>
<h3 id="Basic-Steps"><a href="#Basic-Steps" class="headerlink" title="Basic Steps"></a>Basic Steps</h3><p>How to find $b^1$ according to $a$?</p>
<ul>
<li>Find the vectors relevant to $a^1$​ in a sequence<ul>
<li>let $\alpha$​ (attention score) denote the relevance between $a^i$​ and $a^j$​</li>
<li>We can use dot-product to calc the relevance</li>
<li>方案一 $q:=W^q a^i, k:=W^k a^j, \alpha := q \cdot k$​​</li>
<li>方案二 $q:=W^q a^i, k:=W^k a^j, \alpha:=W \tanh(q+k)$</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/10/03/XUo5MGEvk7wm68K.png" alt="image-20211003115822530"></p>
<p><img src="https://i.loli.net/2021/10/03/xZinBGON4RFlH9a.png" alt="image-20211003115939363"></p>
<ul>
<li>使用线性代数，写成矩阵表示</li>
</ul>
<p><img src="https://i.loli.net/2021/10/03/bp9dkUsKoxACquS.png" alt="image-20211003144405767"></p>
<ul>
<li><p>Multi-head self-attention</p>
<ul>
<li>“相关性”有很多不同的形式，不同的定义。</li>
<li>不同的 $W^q$​ 负责不同的相关性.</li>
<li><img src="https://i.loli.net/2021/10/03/t7wsBjF5pHIh6cx.png" alt="image-20211003144758794"></li>
<li>不同的 Head 分别计算</li>
</ul>
</li>
<li><p>但是缺少了“相对位置”这一重要的 info..</p>
</li>
</ul>
<h3 id="Positional-Encoding"><a href="#Positional-Encoding" class="headerlink" title="Positional Encoding"></a>Positional Encoding</h3><ul>
<li>Each position has a unique positional vector $e^i$<ul>
<li>$a^i \leftarrow a^i+e^i$</li>
<li>hand-craft rules? generated from data?</li>
</ul>
</li>
</ul>
<h2 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h2><ul>
<li>Self-attention has a broad usage in NLP, such as <em>Transformer</em>, <em>BERT</em>…</li>
<li>Self-attention for speech<ul>
<li>Truncated self-attention 看一个小的 window</li>
</ul>
</li>
<li>Self-attention for image<ul>
<li>Self-attention v.s. CNN<ul>
<li><img src="https://i.loli.net/2021/10/03/kcLiRl3S7pQsmF6.png" alt="image-20211003150120112"></li>
</ul>
</li>
<li>Self-attention v.s. RNN<ul>
<li>RNN 仅考虑了左边的输入. biRNN?</li>
<li>中间的门逻辑可能会让数据遗忘</li>
<li>the latter is non-parallel 不适用于并发处理</li>
</ul>
</li>
<li>Self-attention for Graph</li>
</ul>
</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://www.youtube.com/watch?v=hYdO9CscNes">https://www.youtube.com/watch?v=hYdO9CscNes</a></li>
<li><a href="https://www.youtube.com/watch?v=gmsMY5kc-zw">https://www.youtube.com/watch?v=gmsMY5kc-zw</a></li>
<li><a href="https://speech.ee.ntu.edu.tw/~hylee/ml/2021-spring.html">https://speech.ee.ntu.edu.tw/~hylee/ml/2021-spring.html</a></li>
</ul>
]]></content>
      <tags>
        <tag>Machine Learning</tag>
      </tags>
  </entry>
  <entry>
    <title>【机器学习】Transformer 笔记</title>
    <url>/2021/10/ml-transformer/</url>
    <content><![CDATA[<p>$Transformer$ 模型的介绍。</p>
<span id="more"></span>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><ul>
<li><em>Transformer</em> is a <em>sequence to sequence</em> model. $Seq2seq$</li>
<li>Application…<ul>
<li>Speech Recognition</li>
<li>Machine Translation</li>
<li>Speech Translation</li>
<li>Syntactic Parsing（文法剖析）</li>
<li>Multi-label Classification</li>
</ul>
</li>
<li>Most NLP applications could be considered as <strong>Question Answering</strong></li>
<li>比起单纯用 seq2seq，Task-specific model 对于某些任务更合适</li>
<li>Architecture<ul>
<li><img src="https://i.loli.net/2021/10/03/QJFbND5rkBjZli6.png" alt="image-20211003151722794"></li>
</ul>
</li>
</ul>
<h2 id="Encoder"><a href="#Encoder" class="headerlink" title="Encoder"></a>Encoder</h2><ul>
<li><p>Given a set of vectors and output another set of vectors.</p>
<ul>
<li>Self-attention, CNN, RNN… All of them could realize this!</li>
<li><img src="https://i.loli.net/2021/10/03/fIVaFX65TWJcOl1.png" alt="image-20211003151915990"></li>
</ul>
</li>
<li><p><img src="https://i.loli.net/2021/10/03/rSqZC57w2jfveAk.png" alt="image-20211003152146306"></p>
</li>
<li>Residual Connection<ul>
<li><img src="https://i.loli.net/2021/10/03/KnYwBAroMfI5dFV.png" alt="image-20211003152616828"></li>
</ul>
</li>
</ul>
<h2 id="Decoder"><a href="#Decoder" class="headerlink" title="Decoder"></a>Decoder</h2><h3 id="1-Autoregressive-AT"><a href="#1-Autoregressive-AT" class="headerlink" title="(1) Autoregressive (AT)"></a>(1) Autoregressive (AT)</h3><p><img src="https://i.loli.net/2021/10/03/QTnXwExY2VjkLlR.png" alt="image-20211003153626358"></p>
<p><img src="https://i.loli.net/2021/10/03/zkqyt6LX2ZEcIJ3.png" alt="image-20211003153834166"></p>
<ul>
<li>Architecture</li>
</ul>
<p><img src="https://i.loli.net/2021/10/03/RimUkCW6bKHMXVe.png" alt="image-20211003153922255"></p>
<ul>
<li>Masked Multi-head Attention?<ul>
<li>Like RNN…</li>
<li><img src="https://i.loli.net/2021/10/03/eRHTsgjEmAay3WO.png" alt="image-20211003154121360"></li>
</ul>
</li>
<li>Adding “Stop Token”</li>
</ul>
<h3 id="2-Non-autoregressive-NAT"><a href="#2-Non-autoregressive-NAT" class="headerlink" title="(2) Non-autoregressive (NAT)"></a>(2) Non-autoregressive (NAT)</h3><p><img src="https://i.loli.net/2021/10/03/EY3eAv68mshjZVO.png" alt="image-20211003155032111"></p>
<h2 id="Encoder-Decoder"><a href="#Encoder-Decoder" class="headerlink" title="Encoder-Decoder"></a>Encoder-Decoder</h2><p><img src="https://i.loli.net/2021/10/03/Xao8lTPvudAC7j5.png" alt="image-20211003155352197"></p>
<p><img src="https://i.loli.net/2021/10/03/bTLuX5Ve9ExRirH.png" alt="image-20211003155455569"></p>
<h2 id="Training"><a href="#Training" class="headerlink" title="Training"></a>Training</h2><ul>
<li>Minimize the cross entropy<ul>
<li>The input of the decoder is the ground truth.</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/10/03/zQgEb4YLiA6ceV9.png" alt="image-20211003160151665"></p>
<h2 id="Tips-for-training"><a href="#Tips-for-training" class="headerlink" title="Tips for training"></a>Tips for training</h2><ul>
<li>Copy Mechanism<ul>
<li>Chat-bot</li>
</ul>
</li>
<li><p>Guided Attention</p>
<ul>
<li>Monotonic attention</li>
<li>Location-aware attention</li>
</ul>
</li>
<li><p>Beam Search</p>
</li>
</ul>
<p><img src="https://i.loli.net/2021/10/03/v74KjoIAMQuDT1F.png" alt="image-20211003161025399"></p>
<p><img src="https://i.loli.net/2021/10/03/8oCmEM2dxJeujFs.png" alt="image-20211003161307181"></p>
<ul>
<li>Scheduled Sampling</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://www.youtube.com/watch?v=n9TlOhRjYoc">https://www.youtube.com/watch?v=n9TlOhRjYoc</a></li>
<li><a href="https://www.youtube.com/watch?v=N6aRv06iv2g">https://www.youtube.com/watch?v=N6aRv06iv2g</a></li>
</ul>
]]></content>
      <tags>
        <tag>Machine Learning</tag>
      </tags>
  </entry>
  <entry>
    <title>自监督式学习（Self-supervised Learning）</title>
    <url>/2021/10/ml-self-supervised/</url>
    <content><![CDATA[<p>以 BERT 和 GPT 为例分析自监督式学习的架构。</p>
<span id="more"></span>
<h2 id="BERT"><a href="#BERT" class="headerlink" title="BERT"></a>BERT</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><ul>
<li>BERT is a kind of <strong>transformer encoder</strong>.</li>
</ul>
<h3 id="Basic-Steps"><a href="#Basic-Steps" class="headerlink" title="Basic Steps"></a>Basic Steps</h3><ul>
<li>Mask<ul>
<li>Randomly masking some tokens.</li>
<li>Randomly replacing some tokens.</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/10/03/5qAycs8TR7zm9LM.png" alt="image-20211003222046934"></p>
<ul>
<li>Train goal:</li>
</ul>
<p><img src="https://i.loli.net/2021/10/03/Lh5lZuBDadc2gFT.png" alt="image-20211003222105101"></p>
<ul>
<li>Next sentence prediction</li>
</ul>
<p><img src="https://i.loli.net/2021/10/03/3cfvb2VBtqKrCdo.png" alt="image-20211003222412031"></p>
<h3 id="Fine-tuning-for-downstream-tasks"><a href="#Fine-tuning-for-downstream-tasks" class="headerlink" title="Fine-tuning for downstream-tasks"></a>Fine-tuning for downstream-tasks</h3><p><img src="https://i.loli.net/2021/10/03/EekjwNaRW1DyCt3.png" alt="image-20211003223325577"></p>
<h3 id="GLUE-General-Language-Understanding-Evaluation"><a href="#GLUE-General-Language-Understanding-Evaluation" class="headerlink" title="GLUE: General Language Understanding Evaluation"></a>GLUE: General Language Understanding Evaluation</h3><p><img src="https://i.loli.net/2021/10/03/gvQtEZ3ORVxUk5n.png" alt="image-20211003234413065"></p>
<h3 id="How-to-use-BERT"><a href="#How-to-use-BERT" class="headerlink" title="How to use BERT"></a>How to use BERT</h3><ul>
<li>Case 1<ul>
<li>Input a sequence, output a class.<ul>
<li>Sentimental Analysis</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/10/03/KUyO9mFxqHpvST5.png" alt="image-20211003234839607"></p>
<ul>
<li>Case 2<ul>
<li>Input a sequence and output a sequence of the same length.<ul>
<li>POS tagging</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/10/03/m2OFX7sVIWC6zd4.png" alt="image-20211003235251180"></p>
<ul>
<li><p>Case 3</p>
<ul>
<li>Input two sequences and output a class<ul>
<li>Natural Language Inference (NLI)</li>
</ul>
</li>
</ul>
</li>
<li><p>Case 4</p>
<ul>
<li>Input a sequence and output a sequence<ul>
<li>Extraction-based Question Answering</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/10/04/rLO5AnoRiYN1tF2.png" alt="image-20211004215647151"></p>
<p><img src="https://i.loli.net/2021/10/04/qUB2oTwpGdKNbcj.png" alt="image-20211004220019462"></p>
<h3 id="Why-does-BERT-work"><a href="#Why-does-BERT-work" class="headerlink" title="Why does BERT work?"></a>Why does BERT work?</h3><ul>
<li>The tokens with similar meanings have similar embeddings.</li>
<li>You shall know a word by the company it keeps.</li>
</ul>
<h2 id="GPT"><a href="#GPT" class="headerlink" title="GPT"></a>GPT</h2><h3 id="Predict-Next-Token"><a href="#Predict-Next-Token" class="headerlink" title="Predict Next Token"></a>Predict Next Token</h3><p><img src="https://i.loli.net/2021/10/04/akuvyBx9AD6XS8c.png" alt="image-20211004225110571"></p>
<p>架构像是 Transformer 的 Decoder，取消 cross attention.</p>
<h3 id="How-to-use-GPT"><a href="#How-to-use-GPT" class="headerlink" title="How to use GPT?"></a>How to use GPT?</h3><p><img src="https://i.loli.net/2021/10/04/mQjp7eLRnaWdM21.png" alt="image-20211004230723769"></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><p><a href="https://www.youtube.com/watch?v=gh0hewYkjgo">https://www.youtube.com/watch?v=gh0hewYkjgo</a></p>
</li>
<li><p><a href="https://www.youtube.com/watch?v=WY_E0Sd4K80">https://www.youtube.com/watch?v=WY_E0Sd4K80</a></p>
</li>
</ul>
]]></content>
      <tags>
        <tag>Machine Learning</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 中的多线程</title>
    <url>/2021/06/multi-thread-java/</url>
    <content><![CDATA[<p><img src="https://i.loli.net/2021/06/22/x74o9FEeajuzrpk.png" alt="image-20210622084907577"></p>
<p>其中摘记了书中关于 Java 多线程编程的基础部分。</p>
<span id="more"></span>
<h2 id="Chapter-8-多线程"><a href="#Chapter-8-多线程" class="headerlink" title="Chapter 8 多线程"></a>Chapter 8 多线程</h2><h3 id="如何创建多线程"><a href="#如何创建多线程" class="headerlink" title="如何创建多线程"></a>如何创建多线程</h3><h4 id="继承-Thread-类"><a href="#继承-Thread-类" class="headerlink" title="继承 Thread 类"></a>继承 Thread 类</h4> <pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigInteger</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadTest</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Start of the main Thread."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AnotherThread</span> th1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnotherThread</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AnotherThread</span> th2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnotherThread</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        th1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        th2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"End of the main thread."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">AnotherThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> num<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">AnotherThread</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">=</span> num<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">BigInteger</span> i <span class="token operator">=</span> <span class="token class-name">BigInteger</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigInteger</span> result <span class="token operator">=</span> <span class="token class-name">BigInteger</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"A new thread has been created with number "</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            i <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Calc Ans: "</span> <span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">" with number "</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Thread has ended with number"</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>
<h4 id="Runnable-接口"><a href="#Runnable-接口" class="headerlink" title="Runnable 接口"></a>Runnable 接口</h4><p><img src="https://i.loli.net/2021/06/22/xq2eEdBO1LhCUNp.png" alt="image-20210622134139451"></p>
<p><img src="https://i.loli.net/2021/06/22/E7C4eYTcBwIvtRp.png" alt="image-20210622134156347"></p>
<h3 id="线程间的资源共享"><a href="#线程间的资源共享" class="headerlink" title="线程间的资源共享"></a>线程间的资源共享</h3><p>当多个线程的执行代码来自于同一个类的run方法时，则称它们共享相同的代码；而当它们访问相同的对象时，则称它们共享相同的数据。</p>
<p>线程间数据共享的实现方法：<strong>用一个 Runnable 类型的对象创建多个线程</strong></p>
<p><img src="https://i.loli.net/2021/06/22/UiedvSbgnKCX4Va.png" alt="image-20210622134610122"></p>
<h3 id="多线程间的同步控制"><a href="#多线程间的同步控制" class="headerlink" title="多线程间的同步控制"></a>多线程间的同步控制</h3><p><img src="https://i.loli.net/2021/06/22/86GhI5Kabnr4ilV.png" alt="image-20210622151938199"></p>
<p><img src="https://i.loli.net/2021/06/22/xDBimG3KEbYJhsr.png" alt="image-20210622152001891"></p>
<p><img src="https://i.loli.net/2021/06/22/grM9S8DeBVbzhFW.png" alt="image-20210622152340500"></p>
<p><img src="https://i.loli.net/2021/06/22/SAXKpEbT6Pr3lF7.png" alt="image-20210622152550427"></p>
<p><img src="https://i.loli.net/2021/06/22/F3lYMpQ46ijmgtP.png" alt="image-20210622152613819"></p>
<p>改进后的代码：</p>
<p><img src="https://i.loli.net/2021/06/22/8Eha4etDxWRVHmL.png" alt="image-20210622153052026"></p>
<p><img src="https://i.loli.net/2021/06/22/a9hEeXUrMOlo7cs.png" alt="image-20210622153137260"></p>
<p><img src="https://i.loli.net/2021/06/22/Q5NBhT8gdAeLJ9v.png" alt="image-20210622153143586"></p>
<h3 id="线程之间的通信、后台进程"><a href="#线程之间的通信、后台进程" class="headerlink" title="线程之间的通信、后台进程"></a>线程之间的通信、后台进程</h3>]]></content>
      <tags>
        <tag>Java</tag>
        <tag>多线程</tag>
      </tags>
  </entry>
  <entry>
    <title>洛谷 P1908 求逆序对</title>
    <url>/2020/12/luogu-P1908/</url>
    <content><![CDATA[<h2 id="归并排序求逆序对数目"><a href="#归并排序求逆序对数目" class="headerlink" title="归并排序求逆序对数目"></a>归并排序求逆序对数目</h2><pre class="language-c++" data-language="c++"><code class="language-c++">#include &lt;iostream&gt;
#include &lt;cstdio&gt;
using namespace std;

unsigned long long result &#x3D; 0;
int a[500001] &#x3D; &#123;0&#125;;
int cache[500001] &#x3D; &#123;0&#125;;

void sort(int l, int r)&#123;
    if (r &lt;&#x3D; l) return;
    if(r-l&#x3D;&#x3D;1)&#123;
        if(a[l]&gt;a[r])&#123;
            int temp &#x3D; a[l];
            a[l] &#x3D; a[r];
            a[r] &#x3D; temp;
            result++;
        &#125;
        return;
    &#125;
    int mid &#x3D; (l + r) &#x2F; 2;
    &#x2F;&#x2F;[l, mid] &amp;&amp; [mid+1, r]
    sort(l, mid);
    sort(mid + 1, r);
    int len &#x3D; r - l + 1;
    int x &#x3D; l, y &#x3D; mid + 1;
    int pos &#x3D; 0;
    while(x&lt;&#x3D;mid &amp;&amp; y&lt;&#x3D;r)&#123;
        while (x &lt;&#x3D; mid &amp;&amp; y &lt;&#x3D; r &amp;&amp; a[x] &lt;&#x3D; a[y]) &#123;
            pos++;
            cache[pos] &#x3D; a[x];
            x++;
        &#125;
        if (x &lt;&#x3D; mid &amp;&amp; y &lt;&#x3D; r &amp;&amp; a[x] &gt; a[y])&#123;
            pos++;
            cache[pos] &#x3D; a[y];
            y++;
            result +&#x3D; mid-x+1;
        &#125; 
        if(x&gt;mid)&#123;
            while(y&lt;&#x3D;r)&#123;
                pos++;
                cache[pos] &#x3D; a[y];
                y++;
            &#125;
            break;
        &#125;
        if(y&gt;r)&#123;
            while (x&lt;&#x3D;mid) &#123;
                pos++;
                cache[pos] &#x3D; a[x];
                x++;
            &#125;
            break;
        &#125;
    &#125;
    for (int i &#x3D; l; i &lt;&#x3D; r; i++)&#123;
        a[i] &#x3D; cache[i - l + 1];
    &#125;
&#125;

int main()&#123;
    int n;
    cin &gt;&gt; n;
    for (int i &#x3D; 1; i &lt;&#x3D; n; i++)&#123;
        scanf(&quot;%d&quot;, &amp;a[i]);
    &#125;
    sort(1, n);
    cout &lt;&lt; result;
    return 0;
&#125;</code></pre>
<h2 id="树状数组-离散化求逆序对数目"><a href="#树状数组-离散化求逆序对数目" class="headerlink" title="树状数组+离散化求逆序对数目"></a>树状数组+离散化求逆序对数目</h2><pre class="language-c++" data-language="c++"><code class="language-c++">#include &lt;iostream&gt;
#define MAXN 500001
using namespace std;

int n;
unsigned long long result &#x3D; 0;
int a[MAXN] &#x3D; &#123;0&#125;;
int ft[MAXN + 1] &#x3D; &#123;0&#125;;

int lowbit(int x) &#123;
    return x &amp; (-x);
&#125;

void update(int index, int val) &#123;
    for (int i &#x3D; index; i &lt;&#x3D; n; i &#x3D; i + lowbit(i)) &#123;
        ft[i] +&#x3D; val;
    &#125;
&#125;

int getSum(int index) &#123;
    int result &#x3D; 0;
    for (int k &#x3D; index; k &gt; 0; k -&#x3D; lowbit(k)) &#123;
        result +&#x3D; ft[k];
    &#125;
    return result;
&#125;

class entry &#123;
    public:
     int id, val, rank;
&#125; m[500001];

&#x2F;&#x2F; Last Update: 2020-12-30
&#x2F;* Quick Sort With CMP Start *&#x2F;
&#x2F;&#x2F; Sort the element between [a+left, a+right)
&#x2F;&#x2F; You need to implement the &quot;compare&quot; function.
&#x2F;&#x2F; You&#39;d better implement a strict inequality in the set.
&#x2F;&#x2F; An example is given in pseudocode.
&#x2F;*
bool compare(T A, T B)&#123;
    if(A precedes B)&#123;
        return true;
    &#125;else&#123;
        return false;
    &#125;
&#125;
*&#x2F;
template &lt;class T&gt;
void quickSort(T* a, int left, int right, bool (*cmp)(T, T)) &#123;
    T pivot &#x3D; *(a + right - 1);
    int l &#x3D; left, r &#x3D; right - 1;
    while (l &lt; r) &#123;
        while (l &lt; r &amp;&amp; !cmp(pivot, a[l])) &#123;  &#x2F;&#x2F; a[l] &gt;&#x3D; pivot then continue
            l++;
        &#125;
        while (l &lt; r &amp;&amp; !cmp(a[r], pivot)) &#123;  &#x2F;&#x2F; a[r] &lt;&#x3D; pivot then continue
            r--;
        &#125;
        if (l !&#x3D; r) &#123;
            T temp &#x3D; a[l];
            a[l] &#x3D; a[r];
            a[r] &#x3D; temp;
        &#125; else &#123;
            a[right - 1] &#x3D; a[l];
            a[l] &#x3D; pivot;
            quickSort(a, left, l, cmp);
            quickSort(a, l + 1, right, cmp);
        &#125;
    &#125;
&#125;
&#x2F;* Quick Sort With CMP End *&#x2F;

bool compare1(entry a, entry b)&#123;
    if (a.val &lt; b.val) return true;
    if (a.val &gt; b.val) return false;
    if (a.id &lt; b.id) return true;
    return false;
&#125;

bool compare2(entry a, entry b)&#123;
    if (a.id &lt; b.id) return true;
    return false;
&#125;



int main()&#123;
    cin &gt;&gt; n;
    for (int i &#x3D; 1; i &lt;&#x3D; n; i++)&#123;
        cin &gt;&gt; a[i];
        m[i].id &#x3D; i;
        m[i].val &#x3D; a[i]; 
    &#125;
    quickSort(m, 1, n + 1, compare1);
    for (int i &#x3D; 1; i &lt;&#x3D; n; i++)&#123;
        m[i].rank &#x3D; i;
    &#125;
    quickSort(m, 1, n + 1, compare2);
    for (int i &#x3D; n; i &gt;&#x3D; 1; i--) &#123;
        update(m[i].rank, 1);
        result &#x3D; result + getSum(m[i].rank - 1);
    &#125;
    cout &lt;&lt; result;
    return 0;
&#125;</code></pre>
]]></content>
      <tags>
        <tag>code</tag>
        <tag>luogu</tag>
      </tags>
  </entry>
  <entry>
    <title>多线程思想</title>
    <url>/2021/07/multi-thread-and-concurrent/</url>
    <content><![CDATA[<p>多线程思想。内含临界区，信号量，死锁以及读者写者问题。</p>
<p><img src="https://i.loli.net/2021/07/15/MlNJHgWGeiE1ADk.png" alt="1024px-An_illustration_of_the_dining_philosophers_problem"></p>
<span id="more"></span>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li>三系联合暑培 内部讲义</li>
<li><a href="https://baike.baidu.com/item/%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6">https://baike.baidu.com/item/%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6</a></li>
<li><a href="https://zh.wikipedia.org/zh-hans/%E4%BF%A1%E5%8F%B7%E9%87%8F">https://zh.wikipedia.org/zh-hans/%E4%BF%A1%E5%8F%B7%E9%87%8F</a></li>
</ul>
<h3 id="临界区"><a href="#临界区" class="headerlink" title="临界区"></a>临界区</h3><p>多个进程在访问<strong>共享数据</strong>的时候，为防止对资源的竞争，我们提出<strong>临界区</strong>的概念。</p>
<p><strong>临界区</strong>这一概念满足，对于任意的两个进程，不能同时进入临界区，即达到一种进程间“互斥”的效果。</p>
<p>具体来说，临界区的设计需要满足：（摘自讲义）</p>
<ul>
<li><p>任何两个进程不能同时处于临界区 </p>
</li>
<li><p>对 CPU 的速度和数量没有要求 </p>
</li>
<li><p>临界区外运行的进程不能阻塞到其他进程 </p>
</li>
<li><p>不能让一个进程无限期等待进入临界区 </p>
</li>
</ul>
<h4 id="需要被舍弃的做法"><a href="#需要被舍弃的做法" class="headerlink" title="需要被舍弃的做法"></a>需要被舍弃的做法</h4><p><strong>锁变量</strong></p>
<pre class="language-c#" data-language="c#"><code class="language-c#">int lock;

void Process1()
&#123;
	while (lock &#x3D;&#x3D; 1);  &#x2F;&#x2F; (2)
    lock &#x3D; 1;   &#x2F;&#x2F; (5)
    &#x2F;&#x2F; 临界区   &#x2F;&#x2F; (5)
    lock &#x3D; 0; 
    &#x2F;&#x2F; 非临界区
&#125;

void Process2()
&#123;
	while (lock &#x3D;&#x3D; 1); &#x2F;&#x2F; (3)
    lock &#x3D; 1;   &#x2F;&#x2F; (4)
    &#x2F;&#x2F; 临界区   &#x2F;&#x2F; (5)
    lock &#x3D; 0;  &#x2F;&#x2F; (1)
    &#x2F;&#x2F; 非临界区
&#125;</code></pre>
<p>错误原因：</p>
<p><code>Process1</code>在 <code>lock == 1</code> 判断为False后的瞬间，进行了进程调度；</p>
<p>而此时<code>Process2</code>从(1)处继续运行，跨过非临界区，判断 <code>lock==1</code> 为 False 后，进入了临界区；</p>
<p>而此时再发生一次进程调度，<code>Process1</code>也进入了临界区。</p>
<p><strong>严格轮换法</strong></p>
<pre class="language-c#" data-language="c#"><code class="language-c#">int turn &#x3D; 0;

void Process1()
&#123;
	while (turn &#x3D;&#x3D; 0);  
    &#x2F;&#x2F; 临界区   
    turn &#x3D; 0;
    &#x2F;&#x2F; 非临界区
&#125;

void Process2()
&#123;
	while (turn &#x3D;&#x3D; 1);  
    &#x2F;&#x2F; 临界区   
    turn &#x3D; 1;
    &#x2F;&#x2F; 非临界区
&#125;</code></pre>
<p>舍弃原因：</p>
<p>(1) 自旋锁（用于忙等待的锁），过于浪费资源</p>
<p>(2) 优先级翻转问题：当某个进程的优先级高…</p>
<p><strong>休眠与唤醒</strong></p>
<pre class="language-c#" data-language="c#"><code class="language-c#">int cnt &#x3D; 0;

void Process1()
&#123;
	while (1)
	&#123;
		if (cnt &#x3D;&#x3D; 1) sleep();
		&#x2F;&#x2F; 临界区
		cnt &#x3D; 1;
		wakeup(Process2);
		&#x2F;&#x2F; 非临界区
	&#125;
&#125;

void Process2()
&#123;
	while (1)
	&#123;
		if(cnt &#x3D;&#x3D; 0) sleep();
		cnt &#x3D; 0;
		wakeup(1);
	&#125;
&#125;</code></pre>
<p>存在的问题：</p>
<p><code>Process1</code>判断<code>cnt==1</code>时进入条件结构体，此时发生了一次进程调度；</p>
<p><code>Process2</code>此时将<code>cnt</code>置为0，并且尝试唤醒<code>Process1</code>，而<code>Process1</code>此时还没有休眠.</p>
<p>然后<code>Process2</code>判断<code>cnt==0</code>为True，进入休眠.</p>
<p>此时再发生一次进程调度，<code>Process1</code>也进入休眠,</p>
<h3 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h3><p>上述做法均存在一定的问题，而能够解决这个临界区问题的一个很好的概念便是Dijkstra提出的<code>信号量</code>.</p>
<p>信号量(Semaphore)，有时被称为信号灯，是在多线程环境下使用的一种设施，是可以用来保证两个或多个关键代码段不被并发调用。<strong>在进入一个关键代码段之前，线程必须获取一个信号量；一旦该关键代码段完成了，那么该线程必须释放信号量。</strong></p>
<p>计数讯号量具备两种操作动作，称为V（<code>signal()</code>）与P（<code>wait()</code>）（即部分参考书常称的“PV操作”）。V操作会增加信号标S的数值，P操作会减少它。</p>
<p>计数讯号量具备两种操作动作，称为V（signal()）与P（wait()）（即部分参考书常称的“PV操作”）。V操作会增加信号标S的数值，P操作会减少它。</p>
<p>运作方式：</p>
<ol>
<li>初始化，给与它一个非负数的整数值。</li>
<li>执行P（wait()），信号标S的值将被减少。企图进入临界区段的行程，需要先执行P（wait()）。当信号标S减为负值时，行程会被挡住，不能继续；当信号标S不为负值时，行程可以获准进入临界区段。</li>
<li>执行V（signal()），信号标S的值会被增加。结束离开临界区段的行程，将会执行V（signal()）。当信号标S不为负值时，先前被挡住的其他行程，将可获准进入临界区段。</li>
</ol>
<pre class="language-c#" data-language="c#"><code class="language-c#">int sem &#x3D; 1; 

void Process1()
&#123;
	while (1)
	&#123;
		P(sem);
		&#x2F;&#x2F; 临界区
		V(sem);
	&#125;
&#125;

void Process2()
&#123;
	while (1)
	&#123;
		P(sem);
		&#x2F;&#x2F; 临界区
		V(sem);
	&#125;
&#125;</code></pre>
<h4 id="互斥量"><a href="#互斥量" class="headerlink" title="互斥量"></a>互斥量</h4><p>我们的sem变量满足以下要求：<br>信号量的初始值是 1，且 P、V 操作在一个线程中成对出现，先有 P，后有 V，两个操作之间是互斥的临界区。</p>
<p>这意味着同时只能有一个进程进入两个 P、V 操作之间。</p>
<p>因此我们对这种特殊的情况进行单独处理，对信号量进行简化，得到“互斥量（mutex）”。 </p>
<p>一个互斥量包含两个操作：<strong>加锁</strong>（lock，对应于 P 操作）和<strong>解锁</strong>（unlock，对应于 V 操作）。</p>
<h4 id="条件变量"><a href="#条件变量" class="headerlink" title="条件变量"></a>条件变量</h4><p>条件变量（condition variable）是与互斥量配合使用的。在互斥量<strong>已经加锁</strong>的条件下，条件变量的基本操作有三个：</p>
<ul>
<li><p>将互斥量解锁并进入休眠状态（被唤醒时会重新加锁互斥量） </p>
</li>
<li><p>唤醒一个被休眠的进程 </p>
</li>
<li><p>唤醒所有休眠的进程</p>
</li>
</ul>
<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p>死锁产生的条件：</p>
<ul>
<li><p>互斥条件：资源要么分配给了某个进程，要么就是可用的 </p>
</li>
<li><p>占有和等待条件：已经得到了某个资源的进程可以再请求新的资源（即一层锁不会导致死锁） </p>
</li>
<li><p>不可抢占条件：已经分配给一个进程的资源不能强制抢占，只能由占有它的进程自己释放 </p>
</li>
<li><p>环路等待条件：死锁发生时，进程一定可以形成一个环路，环路中每一个进程都等待着下一个进程占有的资源 </p>
</li>
</ul>
<p><img src="https://i.loli.net/2021/07/16/uVrpkj4i7xFKOX2.png" alt="image-20210716122611212"></p>
<h4 id="经典例子：DiningPhilosophers"><a href="#经典例子：DiningPhilosophers" class="headerlink" title="经典例子：DiningPhilosophers"></a>经典例子：DiningPhilosophers</h4><p><a href="https://leetcode-cn.com/problems/the-dining-philosophers/">https://leetcode-cn.com/problems/the-dining-philosophers/</a></p>
<p>5 个沉默寡言的哲学家围坐在圆桌前，每人面前一盘意面。叉子放在哲学家之间的桌面上。（5 个哲学家，5 根叉子）</p>
<p>所有的哲学家都只会在思考和进餐两种行为间交替。哲学家只有同时拿到左边和右边的叉子才能吃到面，而同一根叉子在同一时间只能被一个哲学家使用。每个哲学家吃完面后都需要把叉子放回桌面以供其他哲学家吃面。只要条件允许，哲学家可以拿起左边或者右边的叉子，但在没有同时拿到左右叉子时不能进食。</p>
<p>假设面的数量没有限制，哲学家也能随便吃，不需要考虑吃不吃得下。</p>
<p>设计一个进餐规则（并行算法）使得每个哲学家都不会挨饿；也就是说，在没有人知道别人什么时候想吃东西或思考的情况下，每个哲学家都可以在吃饭和思考之间一直交替下去。</p>
<p>哲学家从 0 到 4 按 顺时针 编号。请实现函数 <code>void wantsToEat(philosopher, pickLeftFork, pickRightFork, eat, putLeftFork, putRightFork);</code></p>
<p>philosopher 哲学家的编号。<br>pickLeftFork 和 pickRightFork 表示拿起左边或右边的叉子。<br>eat 表示吃面。<br>putLeftFork 和 putRightFork 表示放下左边或右边的叉子。<br>由于哲学家不是在吃面就是在想着啥时候吃面，所以思考这个方法没有对应的回调。<br>给你 5 个线程，每个都代表一个哲学家，请你使用类的同一个对象来模拟这个过程。在最后一次调用结束之前，可能会为同一个哲学家多次调用该函数。</p>
<p>解题思路：</p>
<ul>
<li>使用C++ std::lock实现多锁原子锁定</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">DiningPhilosophers</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>mutex mutexs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">DiningPhilosophers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">wantsToEat</span><span class="token punctuation">(</span><span class="token keyword">int</span> philosopher<span class="token punctuation">,</span>
                    function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> pickLeftFork<span class="token punctuation">,</span>
                    function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> pickRightFork<span class="token punctuation">,</span>
                    function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> eat<span class="token punctuation">,</span>
                    function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> putLeftFork<span class="token punctuation">,</span>
                    function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> putRightFork<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> lhs <span class="token operator">=</span> philosopher<span class="token punctuation">;</span>
        <span class="token keyword">int</span> rhs <span class="token operator">=</span> <span class="token punctuation">(</span>philosopher<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">5</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span><span class="token function">lock</span><span class="token punctuation">(</span>mutexs<span class="token punctuation">[</span>lhs<span class="token punctuation">]</span><span class="token punctuation">,</span> mutexs<span class="token punctuation">[</span>rhs<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock_a</span><span class="token punctuation">(</span>mutexs<span class="token punctuation">[</span>lhs<span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>adopt_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock_b</span><span class="token punctuation">(</span>mutexs<span class="token punctuation">[</span>rhs<span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>adopt_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">pickLeftFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pickRightFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">putLeftFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">putRightFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//在临界区内，其实左边右边顺序无关紧要</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>随意指定一个人和其他人拿筷子的顺序不一样，这样也可以破坏闭环结构。<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">DiningPhilosophers</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>mutex forks<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">DiningPhilosophers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">wantsToEat</span><span class="token punctuation">(</span><span class="token keyword">int</span> philosopher<span class="token punctuation">,</span>
                    function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> pickLeftFork<span class="token punctuation">,</span>
                    function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> pickRightFork<span class="token punctuation">,</span>
                    function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> eat<span class="token punctuation">,</span>
                    function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> putLeftFork<span class="token punctuation">,</span>
                    function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> putRightFork<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>philosopher <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            forks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            forks<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pickLeftFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pickRightFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">putRightFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">putLeftFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            forks<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            forks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        forks<span class="token punctuation">[</span>philosopher<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        forks<span class="token punctuation">[</span>philosopher<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pickLeftFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pickRightFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">putRightFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">putLeftFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        forks<span class="token punctuation">[</span>philosopher<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        forks<span class="token punctuation">[</span>philosopher<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>
</li>
</ul>
<h3 id="读者写者问题"><a href="#读者写者问题" class="headerlink" title="读者写者问题"></a>读者写者问题</h3><p>一个资源，我们可以需要对它进行读写。</p>
<p>读操作是不对资源进行更改的，而写操作对资源进行更改。</p>
<p>这对我们提出了要求：可以多个进程同时读，但是读的过程中不允许写；只能有一个进程对它写入，写的过程不允许任何其他进程同时写或读。</p>
<p>即我们要求：</p>
<ol>
<li>允许多个读者可同时对文件执行读操作</li>
<li>只允许一个写者往文件中写信息</li>
<li>任一写者在完成写操作之前不允许其他读者或写者工作</li>
<li>写者执行写操作前，应让已有的写者和读者全部退出</li>
</ol>
<h4 id="读者优先的操作模式"><a href="#读者优先的操作模式" class="headerlink" title="读者优先的操作模式"></a>读者优先的操作模式</h4><pre class="language-cpp" data-language="cpp"><code class="language-cpp">semaphore rmutex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 读进程互斥信号量</span>
semaphore wmutex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 写进程互斥信号量</span>
<span class="token keyword">int</span> readcount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// 读进程计数</span>

process <span class="token function">reader_i</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 读进程</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">P</span><span class="token punctuation">(</span>rmutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        readcount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>readcount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        	<span class="token function">P</span><span class="token punctuation">(</span>wmutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">V</span><span class="token punctuation">(</span>rmutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#123;</span>读文件<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">P</span><span class="token punctuation">(</span>rmutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        readcount<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>readcount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        	<span class="token function">V</span><span class="token punctuation">(</span>wmutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">V</span><span class="token punctuation">(</span>rmutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

process <span class="token function">writer_i</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 写进程</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">P</span><span class="token punctuation">(</span>wmutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#123;</span>写文件<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">V</span><span class="token punctuation">(</span>wmutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>要点：<strong>读者优先</strong>，读者可以抢占写者的资源。</p>
<p>参考链接：<a href="https://liuwynn.github.io/2018/11/28/%E8%AF%BB%E8%80%85-%E5%86%99%E8%80%85%E9%97%AE%E9%A2%98/">https://liuwynn.github.io/2018/11/28/%E8%AF%BB%E8%80%85-%E5%86%99%E8%80%85%E9%97%AE%E9%A2%98/</a></p>
]]></content>
      <tags>
        <tag>C#</tag>
        <tag>多线程</tag>
      </tags>
  </entry>
  <entry>
    <title>同余 逆元 费马小定理</title>
    <url>/2020/12/inverse-element/</url>
    <content><![CDATA[<p>　　　如果会数学就好了　　　　</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>菜鸡不会打【<a href="https://www.luogu.com.cn/problem/P7108?contestId=13515">P7108</a>】，来补数学知识</p>
<h2 id="同余"><a href="#同余" class="headerlink" title="同余"></a>同余</h2><p>​        给定一个正整数$m$，如果两个整数$a$和$b$满足$a-b$能够被$m$整除，即$(a-b)/m$得到一个整数，那么就称整数$a$与$b$对模$m$同余，记作<script type="math/tex">a≡b(mod m)</script>。</p>
<p>​        对模$m$同余是整数的一个<strong>等价关系</strong>。</p>
<h2 id="费马小定理"><a href="#费马小定理" class="headerlink" title="费马小定理"></a>费马小定理</h2><p>​        如果$p$是一个质数，而整数$a$不是$p$的倍数，则有<script type="math/tex">a^{p-1}≡1（mod p）</script>。</p>
<h2 id="逆元"><a href="#逆元" class="headerlink" title="逆元"></a>逆元</h2><script type="math/tex; mode=display">
1\%p=a^{p-1}\%p \\
=> \frac 1 a \% p = a^{p-2}\%p</script><p>​        因此，在计算$\frac{b^h-1}{b-1}$时，我们可以将其转化成$(b^h-1)*inverse(b-1)$计算。</p>
<h2 id="最后有用的代码"><a href="#最后有用的代码" class="headerlink" title="最后有用的代码"></a>最后有用的代码</h2><pre class="language-c++" data-language="c++"><code class="language-c++">long long invEl(int x)
&#123;
    return qpow(x, M - 2, M);
&#125;</code></pre>
<p>【黑人问号脸.jpeg】</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://www.cnblogs.com/kongbursi-2292702937/p/10582258.html">https://www.cnblogs.com/kongbursi-2292702937/p/10582258.html</a></li>
<li><a href="https://baike.baidu.com/item/%E8%B4%B9%E9%A9%AC%E5%B0%8F%E5%AE%9A%E7%90%86/4776158?fr=aladdin">https://baike.baidu.com/item/%E8%B4%B9%E9%A9%AC%E5%B0%8F%E5%AE%9A%E7%90%86/4776158?fr=aladdin</a></li>
</ul>
]]></content>
      <tags>
        <tag>数学</tag>
        <tag>逆元</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 语言程序设计 Chap 12, 13 笔记</title>
    <url>/2021/06/intro-to-java/</url>
    <content><![CDATA[<p><img src="https://i.loli.net/2021/06/20/hn4zWvlPVmRAfjs.png" alt="image-20210620145438112"></p>
<p>主要内容：异常处理，文件IO，抽象类与接口</p>
<span id="more"></span>
<h2 id="Java-语言程序设计-Chap-12-13-笔记"><a href="#Java-语言程序设计-Chap-12-13-笔记" class="headerlink" title="Java 语言程序设计 Chap 12, 13 笔记"></a>Java 语言程序设计 Chap 12, 13 笔记</h2><h3 id="§-12-异常处理和文本I-O"><a href="#§-12-异常处理和文本I-O" class="headerlink" title="§ 12 异常处理和文本I/O"></a>§ 12 异常处理和文本I/O</h3><h4 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h4><p>Java 中的<strong>运行时错误</strong>会作为<strong>异常</strong>，这种<strong>对象</strong>被抛出，而如果抛出的异常没有被处理，程序会非正常终止。</p>
<p><img src="https://i.loli.net/2021/06/20/XOrLyW3uFJ5Dwqm.png" alt="image-20210620150112414"></p>
<ul>
<li>异常的类型</li>
</ul>
<p><img src="https://i.loli.net/2021/06/20/2Ga1goTf5FDRxEy.png" alt="image-20210620152135135"></p>
<p><img src="https://i.loli.net/2021/06/20/RL2cOK8rluwJUG7.png" alt="image-20210620152415538"></p>
<ul>
<li>异常处理模型 declaring -&gt; throwing -&gt; catching</li>
</ul>
<p><img src="https://i.loli.net/2021/06/20/T3lVvEK5xo9Wkuc.png" alt="image-20210620152541858"></p>
<p><img src="https://i.loli.net/2021/06/20/CRFP5L1WHIYEBpx.png" alt="image-20210620153031756"></p>
<ul>
<li><p>finally 语句</p>
</li>
<li><p>自定义异常类</p>
</li>
</ul>
<p><img src="https://i.loli.net/2021/06/20/wPzZaL7VIYKWUNc.png" alt="image-20210620153455786"></p>
<h4 id="文件I-O"><a href="#文件I-O" class="headerlink" title="文件I/O"></a>文件I/O</h4><ul>
<li>文件类 File</li>
</ul>
<p><img src="https://i.loli.net/2021/06/20/B2MxU41hQq3kwFu.png" alt="image-20210620153648056"></p>
<ul>
<li>写入数据 PrintWriter 类</li>
</ul>
<p><img src="https://i.loli.net/2021/06/20/4362nMRXLCJaqYx.png" alt="image-20210620155626076"></p>
<ul>
<li>读入数据 Scanner 类</li>
</ul>
<p><img src="https://i.loli.net/2021/06/20/gzUiAfGE6v83WCx.png" alt="image-20210620160405882"></p>
<h3 id="§-13-抽象类和接口"><a href="#§-13-抽象类和接口" class="headerlink" title="§ 13 抽象类和接口"></a>§ 13 抽象类和接口</h3><ul>
<li>使用 <code>abstract</code> 关键字</li>
<li>接口</li>
</ul>
<p><img src="https://i.loli.net/2021/06/20/j3RAO1wqDsgG9ar.png" alt="image-20210620162928845"></p>
<p><img src="https://i.loli.net/2021/06/20/JWalQBtCKkYA61m.png" alt="image-20210620163020435"></p>
<p><img src="https://i.loli.net/2021/06/20/gLMbBeXJCQAaVzr.png" alt="image-20210620163038375"></p>
<p><img src="https://i.loli.net/2021/06/20/dOLDjAVpaSyem8Z.png" alt="image-20210620163054898"></p>
<p><img src="https://i.loli.net/2021/06/20/QVeTfHq9aBj4puS.png" alt="image-20210620163120256"></p>
<ul>
<li>几种常用的接口<ul>
<li>Comparable<E></li>
<li>Cloneable</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>OOP 课程笔记 Week 05 创建和销毁</title>
    <url>/2021/03/oop-05/</url>
    <content><![CDATA[<h2 id="Week-05-创建和销毁"><a href="#Week-05-创建和销毁" class="headerlink" title="Week 05 创建和销毁"></a>Week 05 创建和销毁</h2><h3 id="5-0-Overview"><a href="#5-0-Overview" class="headerlink" title="5.0 Overview"></a>5.0 Overview</h3><ul>
<li>5.1 友元</li>
<li>5.2 静态成员与常量成员</li>
<li>5.3 常量/静态/参数对象的构造与析构时机</li>
<li>5.4 对象的new和delete</li>
</ul>
<h3 id="5-1-友元"><a href="#5-1-友元" class="headerlink" title="5.1 友元"></a>5.1 友元</h3><ul>
<li><p>友元</p>
<ul>
<li>被声明为友元的函数或类，具有对出现友元声明的类的private及protected成员的访问权限，即可以访问该类的一切成员。</li>
<li>友元的声明只能在类内进行。</li>
</ul>
</li>
<li><p>可以声明别的类的成员函数，包括构造和析构函数，为当前类的友元。</p>
</li>
<li>友元的声明与当前所在域是否为private或public无关。</li>
</ul>
<h3 id="5-2-静态成员与常量成员"><a href="#5-2-静态成员与常量成员" class="headerlink" title="5.2 静态成员与常量成员"></a>5.2 静态成员与常量成员</h3><h4 id="5-2-1-static"><a href="#5-2-1-static" class="headerlink" title="5.2.1 static"></a>5.2.1 static</h4><ol>
<li>静态变量与静态函数</li>
</ol>
<ul>
<li>静态变量：使用static修饰的变量<ul>
<li>初始化：初次定义时需要初始化，且只能初始化一次。</li>
<li>静态局部变量存储在静态存储区，生命周期将持续到整个程序结束</li>
<li>静态全局变量是<strong>内部可链接</strong>的，作用域仅限其声明的文件，不能被其他文件所用，可以避免和其他文件中的同名变量冲突</li>
</ul>
</li>
<li>静态函数：使用static修饰的函数<ul>
<li>静态函数是<strong>内部可链接</strong>的，作用域仅限其声明的文件，不能被其他文件所用，可以避免和其他文件中的同名函数冲突</li>
</ul>
</li>
</ul>
<ol>
<li>静态数据成员与静态成员函数</li>
</ol>
<ul>
<li><p>静态数据成员：使用static修饰的数据成员，是隶属于类的，称为类的静态数据成员，也称“类变量”</p>
<ul>
<li>静态数据成员被该类的所有对象共享（即所有对象中的这个数据域处在同一内存位置）</li>
<li>类的静态成员（数据、函数）既可以通过对象来访问，也可以通过类名来访问，如<code>ClassName::static_var</code>或者<code>a.static_var</code>（a为ClassName类的对象）</li>
<li>类的静态数据成员要在实现文件中赋初值，格式为：<code>Type ClassName::static_var = Value;</code></li>
<li>和全局变量一样，类的静态数据成员在程序开始前初始化</li>
</ul>
</li>
<li><p>静态成员函数：在返回值前面添加static修饰的成员函数，称为类的静态成员函数</p>
<ul>
<li>和静态数据成员类似，类的静态成员函数既可以通过对象来访问，也可以通过类名来访问，如<code>ClassName::static_function</code>或者<code>a.static_function</code>(a为ClassName类的对象）</li>
</ul>
</li>
<li><p><strong>静态成员函数不能访问非静态成员</strong>。（原因：分配时序）</p>
</li>
</ul>
<h4 id="5-2-2-const"><a href="#5-2-2-const" class="headerlink" title="5.2.2 const"></a>5.2.2 const</h4><ol>
<li>常量</li>
</ol>
<ul>
<li>修饰变量时（如<code>const int n = 1;</code>），必须就地初始化，该变量的值在其生命周期内都不会发生变化</li>
<li>修饰引用/指针时（如<code>int a=1; const int&amp; b=a;</code>），不能通过该引用/指针修改相应变量的值，常用于函数参数以保证函数体中无法修改参数的值</li>
<li>修饰函数返回值时（如<code>const int* func() &#123;…&#125;</code>），函数返回值的内容（或其指向的内容）不能被修改</li>
</ul>
<ol>
<li>常量数据成员和常量成员函数</li>
</ol>
<ul>
<li><p>常量数据成员：使用const修饰的数据成员，称为类的常量数据成员，在对象的整个生命周期里不可更改</p>
<ul>
<li>常量数据成员可以在<ul>
<li>构造函数的初始化列表中被初始化</li>
<li>就地初始化</li>
<li><strong>不允许</strong>在构造函数的函数体中通过赋值来设置</li>
</ul>
</li>
</ul>
</li>
<li><p>常量成员函数</p>
<ul>
<li>成员函数也能用const来修饰，称为常量成员函数。</li>
<li>常量成员函数的访问权限：实现语句不能修改类的数据成员，即不能改变对象状态（内容）<br><code>ReturnType Func(…) const &#123;…&#125;</code></li>
<li>注意区别：<code>const ReturnType Func(…) &#123;…&#125;</code></li>
<li>若对象被定义为常量(<code>const ClassName a;</code>)，则它只能调用以const修饰的成员函数<ul>
<li>常量对象：对象中的“数据”不能变</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol>
<li>常量静态变量</li>
</ol>
<ul>
<li>当然，我们可以定义既是常量也是静态的变量<ul>
<li>作为类的常量变量</li>
</ul>
</li>
<li>常量静态变量需要在类外进行定义，但有两个例外：int和enum类型可以就地初始化</li>
<li>常量静态变量和静态变量一样，满足访问权限的任意函数均可访问，但都不能修改</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">foo</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> cs<span class="token punctuation">;</span> <span class="token comment">// 不可就地初始化</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 可以就地初始化</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment">// 也可以在类外定义</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> foo<span class="token double-colon punctuation">::</span>cs <span class="token operator">=</span> <span class="token string">"foo C string"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> foo<span class="token double-colon punctuation">::</span>j <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span></code></pre>
<h3 id="5-3-常量-静态-参数对象的构造与析构时机"><a href="#5-3-常量-静态-参数对象的构造与析构时机" class="headerlink" title="5.3 常量/静态/参数对象的构造与析构时机"></a>5.3 常量/静态/参数对象的构造与析构时机</h3><h4 id="5-3-1-常量对象的构造与析构"><a href="#5-3-1-常量对象的构造与析构" class="headerlink" title="5.3.1 常量对象的构造与析构"></a>5.3.1 常量对象的构造与析构</h4><ul>
<li><strong>常量全局/局部对象</strong>的构造与析构时机和<strong>普通全局/局部对象</strong>相同</li>
<li>常量全局对象：在main()函数调用之前进行初始化，在main()函数执行完return，程序结束时，对象被析构<br>常量局部对象：在程序执行到该局部对象的代码时被初始化。在局部对象生命周期结束、即所在作用域结束后被析构</li>
</ul>
<h4 id="5-3-2-静态对象的构造与析构"><a href="#5-3-2-静态对象的构造与析构" class="headerlink" title="5.3.2 静态对象的构造与析构"></a>5.3.2 静态对象的构造与析构</h4><ol>
<li>静态全局对象</li>
</ol>
<ul>
<li>静态全局对象的构造与析构时机和普通全局对象相同</li>
</ul>
<ol>
<li>函数中静态对象</li>
</ol>
<ul>
<li><p>函数内部定义的静态局部对象</p>
</li>
<li><p>在程序执行到该静态局部对象的代码时被初始化，离开作用域不析构。</p>
</li>
<li>第二次执行到该对象代码时，不再初始化，直接使用上一次的对象。</li>
<li>在main()函数结束后被析构。</li>
</ul>
<ol>
<li>类静态对象</li>
</ol>
<ul>
<li>类A的对象a作为类B的静态变量</li>
<li>a的构造与析构表现和全局对象类似，即在main()函数调用之前进行初始化，在main()函数执行完return，程序结束时，对象被析构</li>
<li>和B是否实例化无关</li>
</ul>
<h4 id="5-3-3-参数对象的构造和析构"><a href="#5-3-3-参数对象的构造和析构" class="headerlink" title="5.3.3 参数对象的构造和析构"></a>5.3.3 参数对象的构造和析构</h4><h3 id="5-4-对象的new和delete"><a href="#5-4-对象的new和delete" class="headerlink" title="5.4 对象的new和delete"></a>5.4 对象的new和delete</h3>]]></content>
      <tags>
        <tag>OOP</tag>
      </tags>
  </entry>
  <entry>
    <title>OOP 课程笔记 Week 06 引用与复制</title>
    <url>/2021/03/oop-06/</url>
    <content><![CDATA[<h2 id="§-6-引用与复制"><a href="#§-6-引用与复制" class="headerlink" title="§ 6 引用与复制"></a>§ 6 引用与复制</h2><h3 id="§-6-0-Overview"><a href="#§-6-0-Overview" class="headerlink" title="§ 6.0 Overview"></a>§ 6.0 Overview</h3><ul>
<li>6.1 常量引用</li>
<li>6.2 拷贝构造函数</li>
<li>6.3 右值引用</li>
<li>6.4 移动构造函数</li>
<li>6.5 赋值运算符</li>
<li>6.6 类型转换</li>
</ul>
<h3 id="§-6-1-常量引用"><a href="#§-6-1-常量引用" class="headerlink" title="§ 6.1 常量引用"></a>§ 6.1 常量引用</h3><ul>
<li>最小特权原则：给函数足够的权限去完成相应的任务，但不要给予他多余的权限。<ul>
<li>例如函数<code>void add(int&amp; a, int&amp; b)</code>，如果将参数类型定义为<code>int&amp;</code>，则给予该函数在函数体内修改a和b的值的权限</li>
<li>如果我们不想给予函数修改权限，则可以在参数中使用常量/常量引用</li>
<li><code>void add(const int&amp; a, const int&amp; b)</code></li>
<li>此时函数中仅能读取a和b的值，无法对a, b进行任何修改操作。</li>
</ul>
</li>
</ul>
<h3 id="§-6-2-拷贝构造函数"><a href="#§-6-2-拷贝构造函数" class="headerlink" title="§ 6.2 拷贝构造函数"></a>§ 6.2 拷贝构造函数</h3><ul>
<li>拷贝构造函数是一种特殊的构造函数，它的参数是语言规定的，是同类对象的常量引用</li>
<li><code>MyClass(const MyClass&amp;) &#123;&#125;</code></li>
<li>拷贝构造函数被调用的三种常见情况<ul>
<li>用一个类对象定义另一个新的类对象</li>
<li>函数调用时以类的对象为形参</li>
<li>函数返回类对象</li>
</ul>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 6.2.1</span>

<span class="token comment">// a</span>
Test a<span class="token punctuation">;</span> <span class="token comment">// NO</span>
Test <span class="token function">b</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//YES</span>
Test c <span class="token operator">=</span> a<span class="token punctuation">;</span> <span class="token comment">//YES</span>

<span class="token comment">// b</span>
<span class="token function">Func</span><span class="token punctuation">(</span>Test a<span class="token punctuation">)</span>

<span class="token comment">// c</span>
<span class="token keyword">return</span> a<span class="token punctuation">;</span></code></pre>
<ul>
<li>如果<strong>调用拷贝构造函数</strong>且当前<strong>没有</strong>给类<strong>显式定义</strong>拷贝构造函数，编译器将自动合成“<strong>隐式定义</strong>的拷贝构造函数”，其功能是<strong>调用所有数据成员的拷贝构造函数或拷贝赋值运算符</strong>。</li>
<li>隐式定义拷贝构造函数在遇到<strong>指针类型</strong>成员时可能会出错,导致多个指针类型的变量指向同一个地址。</li>
<li>拷贝构造函数的频繁调用会降低程序运行的效率，解决方法：<ul>
<li>使用引用/常量引用来传参或返回对象</li>
<li>将拷贝构造函数声明为 <code>private</code> ，或使用 <code>delete</code> 取消拷贝构造函数的隐式合成</li>
</ul>
</li>
</ul>
<h3 id="§-6-3-右值引用"><a href="#§-6-3-右值引用" class="headerlink" title="§ 6.3 右值引用"></a>§ 6.3 右值引用</h3><ul>
<li>左值和右值<ul>
<li>左值：可以取地址、有名字的值。</li>
<li>右值：不能取地址、没有名字的值; 常见于常值、函数返回值、表达式</li>
</ul>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 6.3.1</span>
<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token comment">// 其中a、b、c为左值，1、func函数返回值、a+b的结果为右值。</span></code></pre>
<ul>
<li>右值引用<ul>
<li>虽然右值无法取地址，但可以被&amp;&amp;引用(右值引用)<ul>
<li><code>int &amp;&amp;e = a+b;</code></li>
</ul>
</li>
<li>右值引用无法绑定左值<ul>
<li><code>int &amp;&amp;e = a; //Compile Error</code></li>
</ul>
</li>
<li>例外：常量左值引用能也绑定右值<ul>
<li><code>const int &amp;e = 3;</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="§-6-4-移动构造函数"><a href="#§-6-4-移动构造函数" class="headerlink" title="§ 6.4 移动构造函数"></a>§ 6.4 移动构造函数</h3><ul>
<li>移动构造函数<ul>
<li>右值引用可以延续即将销毁变量的生命周期，用于构造函数可以<strong>提升处理效率</strong>，在此过程中尽可能少地进行拷贝。</li>
<li>使用右值引用作为参数的构造函数叫做移动构造函数。</li>
</ul>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 6.4.1</span>

<span class="token comment">// 拷贝构造函数</span>
<span class="token function">ClassName</span><span class="token punctuation">(</span><span class="token keyword">const</span> ClassName<span class="token operator">&amp;</span> VariableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 移动构造函数</span>
<span class="token function">ClassName</span><span class="token punctuation">(</span>ClassName<span class="token operator">&amp;&amp;</span> VariableName<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>移动构造函数与拷贝构造函数最主要的差别就是类中堆内存是重新开辟并拷贝，还是直接将指针指向那块地址。</li>
<li>对于一些即将析构的临时类，移动构造函数直接利用了原来临时对象中的堆内存，新的对象无需开辟内存，临时对象无需释放内存，从而大大提高计算效率。</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 6.4.2</span>

<span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">int</span> <span class="token operator">*</span> buf<span class="token punctuation">;</span> <span class="token comment">//// only for demo.</span>
	<span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//申请一块内存</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Test(): this->buf @ "</span> <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> buf <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token operator">~</span><span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Test(): this->buf @ "</span> <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> buf <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">const</span> Test<span class="token operator">&amp;</span> t<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">buf</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
			buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//拷贝数据</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Test(const Test&amp;) called. this->buf @ "</span>
			<span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> buf <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">Test</span><span class="token punctuation">(</span>Test<span class="token operator">&amp;&amp;</span> t<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">buf</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>buf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//直接复制地址，避免拷贝</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Test(Test&amp;&amp;) called. this->buf @ "</span>
			<span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> buf <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		t<span class="token punctuation">.</span>buf <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span> <span class="token comment">//将t.buf改为nullptr，使其不再指向原来内存区域</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

Test <span class="token function">GetTemp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	Test tmp<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"GetTemp(): tmp.buf @ "</span>
		<span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> tmp<span class="token punctuation">.</span>buf <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token keyword">return</span> tmp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span>Test t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"fun(Test t): t.buf @ "</span>
		<span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> t<span class="token punctuation">.</span>buf <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	Test a <span class="token operator">=</span> <span class="token function">GetTemp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main() : a.buf @ "</span> <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> a<span class="token punctuation">.</span>buf <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token function">fun</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// g++ test.cpp --std=c++11 -fno-elide-constructors -o test</span></code></pre>
<ul>
<li>移动语义<ul>
<li><code>std::move</code> 函数<ul>
<li>输入：左值（包括变量等，该左值一般不再使用）</li>
<li>返回值：该左值对应的右值</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="§-6-5-赋值运算符"><a href="#§-6-5-赋值运算符" class="headerlink" title="§ 6.5 赋值运算符"></a>§ 6.5 赋值运算符</h3><ul>
<li>拷贝复制运算符</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 6.5.1</span>

<span class="token comment">// 区分</span>
ClassName a<span class="token punctuation">;</span>
ClassName b<span class="token punctuation">;</span>
a <span class="token operator">=</span> b<span class="token punctuation">;</span>

ClassName a <span class="token operator">=</span> b<span class="token punctuation">;</span>

<span class="token comment">// 前者调用</span>
ClassName<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> ClassName<span class="token operator">&amp;</span> right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">!=</span> <span class="token operator">&amp;</span>right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 避免自己赋值给自己</span>
		<span class="token comment">// 将right对象中的内容拷贝到当前对象中...</span>
	<span class="token punctuation">&#125;</span>
   <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<ul>
<li>移动赋值运算符</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 6.5.2</span>
Test<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span> <span class="token punctuation">(</span>Test<span class="token operator">&amp;&amp;</span> right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> <span class="token operator">&amp;</span>right<span class="token punctuation">)</span>  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"same obj!\n"</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>	
		<span class="token keyword">this</span><span class="token operator">-></span>buf <span class="token operator">=</span> right<span class="token punctuation">.</span>buf<span class="token punctuation">;</span>  <span class="token comment">//直接赋值地址</span>
		right<span class="token punctuation">.</span>buf <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"operator=(Test&amp;&amp;) called.\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="§-6-6-类型转换"><a href="#§-6-6-类型转换" class="headerlink" title="§ 6.6 类型转换"></a>§ 6.6 类型转换</h3><ol>
<li>在源类中定义<strong>目标类型转换运算符</strong></li>
</ol>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 6.6.1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>


<span class="token keyword">class</span> <span class="token class-name">Dst</span> <span class="token punctuation">&#123;</span> <span class="token comment">//目标类Destination</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">Dst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Dst::Dst()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>



<span class="token keyword">class</span> <span class="token class-name">Src</span> <span class="token punctuation">&#123;</span> <span class="token comment">//源类Source</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">Src</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Src::Src()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">operator</span> <span class="token function">Dst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> 
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Src::operator Dst() called"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">Dst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>
<ol>
<li>在目标类中定义“源类对象作参数的构造函数”</li>
</ol>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 6.6.2</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Src</span><span class="token punctuation">;</span>	<span class="token comment">// 前置类型声明，因为在Dst中要用到Src类</span>
<span class="token keyword">class</span> <span class="token class-name">Dst</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">Dst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Dst::Dst()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token function">Dst</span><span class="token punctuation">(</span><span class="token keyword">const</span> Src<span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Dst::Dst(const Src&amp;)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> 
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Src</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">Src</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Src::Src()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>
<ul>
<li><p>注意：两种自动类型转换的方法不能同时使用，使用时请任选其中一种。</p>
</li>
<li><p>禁止自动类型转换</p>
<ul>
<li>如果用 <code>explicit</code> 修饰类型转换运算符或类型转换构造函数，则相应的类型转换必须显式地进行</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>OOP</tag>
      </tags>
  </entry>
  <entry>
    <title>OOP 课程笔记 Week 08 组合与继承</title>
    <url>/2021/04/oop-08/</url>
    <content><![CDATA[<h2 id="Week-08-组合与继承"><a href="#Week-08-组合与继承" class="headerlink" title="Week 08 组合与继承"></a>Week 08 组合与继承</h2><h3 id="§-8-0-Overview"><a href="#§-8-0-Overview" class="headerlink" title="§ 8.0 Overview"></a>§ 8.0 Overview</h3><ul>
<li>组合</li>
<li>继承</li>
<li>成员访问权限</li>
<li>重写隐藏与重载</li>
<li>多重继承</li>
</ul>
<h3 id="§-8-1-组合"><a href="#§-8-1-组合" class="headerlink" title="§ 8.1 组合"></a>§ 8.1 组合</h3><ul>
<li>对象组合的两种实现方法：<ul>
<li>已有类的对象作为新类的公有数据成员，这样通过允许直接访问子对象而“提供”旧类接口</li>
<li>已有类的对象作为新类的私有数据成员。新类可以调整旧类的对外接口，可以不使用旧类原有的接口（相当于对接口作了转换）</li>
</ul>
</li>
<li>对象拷贝与赋值运算<ul>
<li>如果调用拷贝构造函数且没有给类显式定义拷贝构造函数，编译器将自动合成：<ul>
<li>对有显式定义拷贝构造函数的子对象调用该拷贝构造函数</li>
<li>对无显式定义拷贝构造函数的子对象采用位拷贝</li>
</ul>
</li>
<li>赋值的默认操作类似</li>
</ul>
</li>
</ul>
<h3 id="§-8-2-继承"><a href="#§-8-2-继承" class="headerlink" title="§ 8.2 继承"></a>§ 8.2 继承</h3><ul>
<li><p>基本概念</p>
<ul>
<li>被继承的已有类，被称为基类 <strong>base class</strong>，也称“父类”。</li>
<li>通过继承得到的新类，被为派生类 <strong>derived class</strong>，也称“子类”、“扩展类”。</li>
</ul>
</li>
<li><p>继承方式</p>
<ul>
<li>常见的继承方式：public, private<ul>
<li><code>class Derived : [private] Base &#123; .. &#125;;</code> 缺省继承方式</li>
<li><code>class Derived : public Base &#123; ... &#125;;</code></li>
</ul>
</li>
<li>protected 继承很少被使用<ul>
<li><code>class Derived : protected Base &#123; ... &#125;;</code></li>
</ul>
</li>
</ul>
</li>
<li><p>什么不能被继承？</p>
<ul>
<li>构造函数：创建派生类对象时，必须调用派生类的构造函数，派生类构造函数调用基类的构造函数，以创建派生对象的基类部分。C++11新增了继承构造函数的机制（使用using），但默认不继承</li>
<li>析构函数：释放对象时，先调用派生类析构函数，再调用基类析构函数</li>
<li>赋值运算符：因为赋值运算符包含一个类型为其所属类的形参</li>
<li>友元函数：不是类成员</li>
</ul>
</li>
<li>派生类对象的构造与析构过程</li>
<li><p>调用基类构造函数</p>
<ul>
<li>若没有显式调用，则编译器会自动生成一个对基类的默认构造函数的调用。</li>
<li>若想要显式调用，则<strong>只能</strong>在派生类构造函数的<strong>初始化成员列表</strong>中进行。</li>
</ul>
</li>
<li><p>继承基类构造函数</p>
<ul>
<li>在派生类中使用 <code>using Base::Base;</code> 来继承基类构造函数，相当于给派生类“定义”了相应参数的构造函数，如下例 8.2.1.</li>
</ul>
</li>
<li>当基类存在多个构造函数时，使用using会给派生类自动构造多个相应的构造函数，如下例 8.2.2.<ul>
<li>如果基类的某个构造函数被声明为私有成员函数，则不能在派生类中声明继承该构造函数。</li>
<li>如果派生类使用了继承构造函数，编译器就不会再为派生类生成默认构造函数。</li>
</ul>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 8.2.1</span>
<span class="token keyword">class</span> <span class="token class-name">Base</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> data<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Base</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">data</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::Base("</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">")\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Derive</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span></span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">using</span> Base<span class="token double-colon punctuation">::</span>Base<span class="token punctuation">;</span> 		<span class="token comment">///相当于 Derive(int i):Base(i)&#123;&#125;;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Derive <span class="token function">obj</span><span class="token punctuation">(</span><span class="token number">356</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> </code></pre>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 8.2.2</span>
<span class="token keyword">class</span> <span class="token class-name">Base</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> data<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Base</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">data</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::Base("</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">")\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
	<span class="token function">Base</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span> 
		<span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::Base("</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> “<span class="token punctuation">,</span><span class="token string">" &lt;&lt; j &lt;&lt; "</span><span class="token punctuation">)</span>\n"<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Derive</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span></span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">using</span> Base<span class="token double-colon punctuation">::</span>Base<span class="token punctuation">;</span> 		<span class="token comment">///相当于 Derive(int i):Base(i)&#123;&#125;;</span>
                     <span class="token comment">///加上 Derive(int i, int j):Base(i，j)&#123;&#125;;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Derive <span class="token function">obj</span><span class="token punctuation">(</span><span class="token number">356</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Derive <span class="token function">obj</span><span class="token punctuation">(</span><span class="token number">356</span><span class="token punctuation">,</span> <span class="token number">789</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<ul>
<li>继承方式<ul>
<li>public 继承：基类中公有成员仍能在派生类中保持公有。（图 8.2.3）</li>
<li>private 继承：用基类接口实现派生类功能。（图 8.2.4）</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/04/12/EwhXWMB2RUrOzkT.png" alt="image-20210412091000928"></p>
<p>（图 8.2.3）</p>
<p><img src="https://i.loli.net/2021/04/12/5Q9VMBnZk7YUHpq.png" alt="image-20210412091010013"></p>
<p>（图 8.2.4）</p>
<h3 id="§-8-3-成员访问权限"><a href="#§-8-3-成员访问权限" class="headerlink" title="§ 8.3 成员访问权限"></a>§ 8.3 成员访问权限</h3><ul>
<li>基类中的私有成员<ul>
<li>不允许在派生类成员函数中访问</li>
<li>不允许派生类的对象访问它们</li>
</ul>
</li>
<li>基类中的公有成员<ul>
<li>允许在派生类成员函数中被访问</li>
<li>若是使用<code>public</code>继承方式，则成为派生类公有成员，可以被派生类的对象访问</li>
<li>若是使用 <code>private/protected</code> 继承方式，则成为派生类私有/保护成员，不能被派生类的对象访问<ul>
<li>若想让某成员能被派生类的对象访问，可在派生类 <code>public</code> 部分用关键字 <code>using</code>  声明它的名字（例 8.3.1）</li>
</ul>
</li>
</ul>
</li>
<li>基类中的保护成员<ul>
<li>与基类中的私有成员的不同在于：保护成员允许在派生类成员函数中被访问。</li>
</ul>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 8.3.1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span> 
  <span class="token keyword">void</span> <span class="token function">baseFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"in Base::baseFunc()..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Derive3</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">private</span> <span class="token class-name">Base</span></span> <span class="token punctuation">&#123;</span><span class="token comment">// B的私有继承</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">/// 私有继承时，在派生类public部分声明基类成员名字</span>
  <span class="token keyword">using</span> Base<span class="token double-colon punctuation">::</span>baseFunc<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  Derive3 obj3<span class="token punctuation">;</span>
  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"calling obj3.baseFunc()..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
  obj3<span class="token punctuation">.</span><span class="token function">baseFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//基类接口在派生类public部分声明，则派生类对象可调用</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<ul>
<li>基类成员的访问权限<ul>
<li>public 继承：基类的公有成员，保护成员，私有成员作为派生类的成员时，都保持原有的状态。</li>
<li>private 继承：基类的公有成员，保护成员，私有成员作为派生类的成员时，都作为私有成员。</li>
<li>protected 继承：基类的公有成员，保护成员作为派生类的成员时，都成为保护成员，基类的私有成员仍然是私有的。</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/04/12/Wsf9mCAqRuQMdHz.png" alt="image-20210412091900016"></p>
<p>（表 8.3.2）</p>
<h3 id="§-8-4-重写隐藏与重载"><a href="#§-8-4-重写隐藏与重载" class="headerlink" title="§ 8.4 重写隐藏与重载"></a>§ 8.4 重写隐藏与重载</h3><ul>
<li>重载(overload)：<ul>
<li>目的：提供同名函数的不同实现，属于静态多态。</li>
<li>函数名必须相同，函数参数必须不同，作用域相同（如位于同一个类中；或同名全局函数）。</li>
</ul>
</li>
<li>重写隐藏(redefining)：<ul>
<li>目的：在派生类中重新定义基类函数，实现派生类的特殊功能。</li>
<li>屏蔽了基类的所有其它同名函数。（例 8.4.1）</li>
<li>函数名必须相同，函数参数可以不同</li>
<li>可以在派生类中通过 <code>using 类名::成员函数名;</code> 在派生类中“恢复”指定的基类成员函数（即去掉屏蔽），使之重新可用（例 8.4.2）</li>
</ul>
</li>
</ul>
<blockquote>
<p>程序编译时系统就能决定调用哪个函数，因此静态多态性又称为编译时的多态性。</p>
<p>多态分为两类：静态多态性和动态多态性，以前学过的函数重载和运算符重载实现的多态性属于静态多态性，在程序编译时系统就能决定调用哪个函数，因此静态多态性又称为编译时的多态性。静态多态性是通过函数的重载实现的。动态多态性是在程序运行过程中才动态地确定操作所针对的对象。它又称运行时的多态性。动态多态性是通过虚函数实现的。</p>
</blockquote>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 8.4.1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">T</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"B::f()\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::f("</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">")\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">/// 重载</span>
  <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">double</span> d<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::f("</span> <span class="token operator">&lt;&lt;</span> d <span class="token operator">&lt;&lt;</span> <span class="token string">")\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">///重载</span>
  <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::f(T)\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">///重载</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Derive</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span></span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Derive::f("</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">")\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">///重写隐藏</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  Derive d<span class="token punctuation">;</span>
  d<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  d<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4.9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">/// 编译警告。执行自动类型转换。</span>
  <span class="token comment">//  d.f();		/// 被屏蔽，编译错误</span>
  <span class="token comment">//  d.f(T());	/// 被屏蔽，编译错误</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 8.4.2</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">T</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::f()\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::f("</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">")\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">double</span> d<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::f("</span> <span class="token operator">&lt;&lt;</span> d <span class="token operator">&lt;&lt;</span> <span class="token string">")\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::f(T)\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Derive</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span></span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">using</span> Base<span class="token double-colon punctuation">::</span>f<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Derive::f("</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">")\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  Derive d<span class="token punctuation">;</span>
  d<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  d<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4.9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  d<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  d<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<ul>
<li><code>using</code> 关键字<ul>
<li>继承基类构造函数</li>
<li>恢复被屏蔽的基类成员函数</li>
<li>还可用于：<ul>
<li>指示命名空间，<code>using namespace std;</code></li>
<li>将另一个命名空间的成员引入当前命名空间<code>using std::cout; cout &lt;&lt; endl;</code></li>
<li>定义类型别名，<code>using a = int;</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="§-8-5-多重继承"><a href="#§-8-5-多重继承" class="headerlink" title="§ 8.5 多重继承"></a>§ 8.5 多重继承</h3><ul>
<li>派生类同时继承多个基类</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 
<span class="token keyword">class</span> <span class="token class-name">InputFile</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">File</span></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 
<span class="token keyword">class</span> <span class="token class-name">OutputFile</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">File</span></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 
<span class="token keyword">class</span> <span class="token class-name">IOFile</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">InputFile</span><span class="token punctuation">,</span> <span class="token keyword">public</span> <span class="token class-name">OutputFile</span></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>
<p><img src="https://i.loli.net/2021/04/12/jCy49k6pKcM7XhE.png" alt="image-20210412092825715"></p>
<p>（图 8.5.1）</p>
<ul>
<li>数据存储<ul>
<li>如果派生类D继承的两个基类A,B，是同一基类Base的不同继承，则A,B中继承自Base的数据成员会在D有两份独立的副本，可能带来数据冗余。</li>
</ul>
</li>
<li>二义性<ul>
<li>如果派生类D继承的两个基类A,B，有同名成员a，则访问D中a时，编译器无法判断要访问的哪一个基类成员。</li>
</ul>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 8.5.2</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">int</span> a<span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MiddleA</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span></span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">addA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"a="</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">++</span>a <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"A::bar"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MiddleB</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span></span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">addB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"a="</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">++</span>a <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"B::bar"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Derive</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">MiddleA</span><span class="token punctuation">,</span> <span class="token keyword">public</span> <span class="token class-name">MiddleB</span></span><span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  Derive d<span class="token punctuation">;</span>
  d<span class="token punctuation">.</span><span class="token function">addA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">/// 输出 a=1。</span>
  d<span class="token punctuation">.</span><span class="token function">addB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">/// 仍然输出 a=1。</span>
  cout <span class="token operator">&lt;&lt;</span> d<span class="token punctuation">.</span>a<span class="token punctuation">;</span> 	<span class="token comment">/// 编译错误，A和B都有成员a</span>
  cout <span class="token operator">&lt;&lt;</span> d<span class="token punctuation">.</span>A<span class="token double-colon punctuation">::</span>a<span class="token punctuation">;</span> <span class="token comment">/// 输出A中的成员a的值</span>
  d<span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">/// 编译错误，A和B都有成员函数bar</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
]]></content>
      <tags>
        <tag>OOP</tag>
      </tags>
  </entry>
  <entry>
    <title>OOP 课程笔记 Week 09 虚函数</title>
    <url>/2021/04/oop-09/</url>
    <content><![CDATA[<h2 id="Week-09-虚函数"><a href="#Week-09-虚函数" class="headerlink" title="Week 09 虚函数"></a>Week 09 虚函数</h2><h3 id="9-0-Overview"><a href="#9-0-Overview" class="headerlink" title="9.0 Overview"></a>9.0 Overview</h3><ul>
<li>向上类型转换</li>
<li>对象切片</li>
<li>函数调用捆绑</li>
<li>虚函数和虚函数表</li>
<li>虚函数和构造函数、析构函数</li>
<li>重写覆盖，override和final</li>
</ul>
<h3 id="9-1-向上类型转换"><a href="#9-1-向上类型转换" class="headerlink" title="9.1 向上类型转换"></a>9.1 向上类型转换</h3><ul>
<li><strong>派生类</strong>对象/引用/指针<strong>转换成基类</strong>对象/引用/指针，称为向上类型转换。只对<code>public</code>继承有效，在继承图上是上升的；对<code>private</code>、<code>protected</code>继承无效。</li>
<li>向上类型转换（派生类到基类）可以由编译器自动完成，是一种隐式类型转换。</li>
<li>凡是<strong>接受基类对象/引用/指针的地方</strong>（如函数参数），都可以<strong>使用派生类对象/引用/指针</strong>，编译器会自动将派生类对象转换为基类对象以便使用。</li>
</ul>
<h3 id="9-2-对象切片"><a href="#9-2-对象切片" class="headerlink" title="9.2 对象切片"></a>9.2 对象切片</h3><ul>
<li><p>当<strong>派生类的对象</strong><code>(不是指针或引用)</code>被通过<strong>传参或赋值</strong>的方式转换为<strong>基类的对象</strong>时，派生类的对象被<strong>切片</strong>为对应基类的子对象。</p>
<ul>
<li><img src="https://i.loli.net/2021/04/19/2tVMgrhZ3GPT1cI.png" alt="image-20210419081125275"></li>
<li>派生类的新数据和新方法丢失（图 9.2.1）</li>
</ul>
</li>
<li><p>当派生类的<code>指针（引用）</code>被通过<strong>传参或赋值</strong>的方式转换为基类<code>指针（引用）</code>时，不会创建新的对象，但只保留基类的接口。</p>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 9.2.2 私有继承“照此实现”</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> data<span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> data<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">void</span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> data <span class="token operator">=</span> i<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">D1</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">private</span> <span class="token class-name">B</span></span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">using</span> B<span class="token double-colon punctuation">::</span>getData<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    D1 d1<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> d1<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// d1.setData(10) //隐藏了基类的setData函数，不可访问 </span>
    <span class="token comment">// B&amp; b = d1;     //不允许私有继承的向上转换</span>
    <span class="token comment">// b.setData(10); //否则可以绕过D1，调用基类的setData函数</span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="9-3-函数调用捆绑"><a href="#9-3-函数调用捆绑" class="headerlink" title="9.3 函数调用捆绑"></a>9.3 函数调用捆绑</h3><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 9.3.1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Instrument</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Instrument::play"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Wind</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Instrument</span></span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">// Redefine interface function:</span>
  <span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Wind::play"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">tune</span><span class="token punctuation">(</span>Instrument<span class="token operator">&amp;</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  i<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  Wind flute<span class="token punctuation">;</span>
  <span class="token function">tune</span><span class="token punctuation">(</span>flute<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//引用的向上类型转换(传参)，编译器早绑定，无对象切片产生</span>
  Instrument <span class="token operator">&amp;</span>inst <span class="token operator">=</span> flute<span class="token punctuation">;</span>  <span class="token comment">// 引用的向上类型转换(赋值)</span>
  inst<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<ul>
<li>把函数体与函数调用相联系称为<strong>捆绑</strong>(binding)。<ul>
<li>即将函数体实现代码的入口地址，与调用的函数名绑定。执行到调用代码时进入函数体内部。</li>
</ul>
</li>
<li>当捆绑在程序运行之前（由编译器和连接器）完成时，称为<strong>早捆绑</strong>(early binding)。<ul>
<li>运行之前已经决定了函数调用代码到底进入哪个函数。</li>
<li>上面程序中的问题是早捆绑引起的，编译器将tune中的函数调用i.play()与Instrument::play()绑定。</li>
</ul>
</li>
<li>当捆绑根据对象的实际类型(上例中即子类Wind而非Instrument)，发生在程序运行时，称为<strong>晚捆绑</strong>(late binding)，又称动态捆绑或运行时捆绑。<ul>
<li>要求在运行时能确定对象的实际类型，并绑定正确的函数。</li>
<li>晚捆绑只对类中的虚函数起作用，使用 virtual 关键字声明虚函数。</li>
</ul>
</li>
</ul>
<h3 id="9-4-虚函数与虚函数表"><a href="#9-4-虚函数与虚函数表" class="headerlink" title="9.4 虚函数与虚函数表"></a>9.4 虚函数与虚函数表</h3><ul>
<li>对于被派生类重新定义的成员函数，若它<strong>在基类中被声明为虚函数</strong>，则通过基类<strong><code>指针或引用</code></strong>调用该成员函数时，编译器将根据所指（或引用）对象的实际类型决定是调用基类中的函数，还是调用派生类重写的函数。</li>
<li>若某成员函数在基类中声明为虚函数，当派生类重写覆盖(同名，同参数函数)它时，无论是否声明为虚函数，该成员函数都仍然是虚函数。</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 9.4.1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Instrument</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Instrument::play"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Wind</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Instrument</span></span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Wind::play"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
     <span class="token comment">/// 重写覆盖(稍后：重写隐藏和重写覆盖的区别）</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">tune</span><span class="token punctuation">(</span>Instrument<span class="token operator">&amp;</span> ins<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  ins<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/// 由于 Instrument::play 是虚函数，编译时不再直接绑定，运行时根据 ins 的实际类型调用。</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  Wind flute<span class="token punctuation">;</span>
  <span class="token function">tune</span><span class="token punctuation">(</span>flute<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/// 向上类型转换</span>
<span class="token punctuation">&#125;</span>
</code></pre>
<ul>
<li><p>一般来说，派生类虚函数的返回类型应该和基类相同。</p>
<ul>
<li><p>或者，是协变(Covariant)的，例如</p>
<ul>
<li>基类和派生类的指针是协变的</li>
<li>基类和派生类的引用是协变的</li>
</ul>
</li>
<li><p>```cpp<br>// Example 9.4.2</p>
<h1 id="include"><a href="#include" class="headerlink" title="include "></a>include <iostream></h1><p>using namespace std;</p>
<p>class Instrument {<br>public:<br>  virtual Instrument&amp; getObj() { return *this; }<br>};</p>
<p>class Wind : public Instrument {<br>public:<br>  virtual Wind&amp; getObj() { return *this;}<br>  //Wind&amp;和Instrument&amp;协变<br>};</p>
<pre class="language-none"><code class="language-none">
+ 虚函数表
  + 对象自身要包含自己实际类型的信息：用虚函数表表示。运行时通过虚函数表确定对象的实际类型。
  + **虚函数表**(VTABLE)：每个包含虚函数的类用于存储虚函数地址的表(虚函数表有唯一性，即使没有重写虚函数)。
  + 每个**包含虚函数的类对象**中，编译器秘密地放一个**指针**，称为**虚函数指针**(vpointer&#x2F;VPTR)，指向这个类的VTABLE。
  + 当通过基类指针做虚函数调用时，编译器静态地插入能取得这个VPTR并在VTABLE表中查找函数地址的代码，这样就能调用正确的函数并引起晚捆绑的发生。
    + **编译**期间：**建立虚函数表VTABLE**，记录每个类或该类的基类中所有已声明的虚函数入口地址。
    + **运行**期间：**建立虚函数指针VPTR**，在构造函数中发生，指向相应的VTABLE。

&#96;&#96;&#96;cpp
&#x2F;&#x2F; Example 9.4.3
#include &lt;iostream&gt;
using namespace std;
class B &#123;
   public:
    virtual void fun1() &#123; cout &lt;&lt; &quot;B::fun1()&quot; &lt;&lt; endl; &#125;
    virtual void fun2() &#123; cout &lt;&lt; &quot;B::fun2()&quot; &lt;&lt; endl; &#125;

   private:
    int i;
    float j;
&#125;;
class D : public B &#123;
   public:
    virtual void fun1() &#123;
        cout &lt;&lt; &quot;D::fun1()&quot; &lt;&lt; endl;
    &#125;  &#x2F;&#x2F;&#x2F;对fun1重写覆盖，对fun2没有，则fun2使用基类的虚函数地址
    double k;
&#125;;
int main() &#123;
    B b;
    D d;
    B* pB &#x3D; &amp;d;
    pB-&gt;fun1();
&#125;</code></pre>
</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2021/04/19/LEmhf6Y7igcUnPT.png" alt="image-20210419083950089"></p>
<p>（图 9.4.4）</p>
<h3 id="9-5-虚函数与构造函数、析构函数"><a href="#9-5-虚函数与构造函数、析构函数" class="headerlink" title="9.5 虚函数与构造函数、析构函数"></a>9.5 虚函数与构造函数、析构函数</h3><ul>
<li><p>虚函数与构造函数</p>
<ul>
<li>当创建一个包含有虚函数的对象时，必须初始化它的VPTR以指向相应的VTABLE。设置VPTR的工作由构造函数完成。编译器在构造函数的开头秘密的插入能初始化VPTR的代码。</li>
<li>构造函数不能也不必是虚函数。<ul>
<li>不能：如果构造函数是虚函数，则创建对象时需要先知道VPTR，而在构造函数调用前，VPTR未初始化。</li>
<li>不必：构造函数的作用是提供类中成员初始化，调用时明确指定要创建对象的类型，没有必要是虚函数。</li>
</ul>
</li>
<li>在构造函数中调用一个虚函数，被调用的只是这个函数的本地版本(即当前类的版本)，即虚机制在构造函数中不工作。</li>
<li>初始化顺序：(与构造函数初始化列表顺序无关)<ul>
<li>基类初始化</li>
<li>对象成员初始化</li>
<li>构造函数体</li>
</ul>
</li>
<li>原因：基类的构造函数比派生类先执行，调用基类构造函数时派生类中的数据成员还没有初始化。如果允许调用实际对象的虚函数，则可能会用到未初始化的派生类成员。</li>
</ul>
</li>
<li><p>虚函数与析构函数</p>
<ul>
<li>析构函数能是虚的，且常常是虚的。虚析构函数仍需定义函数体。</li>
<li>虚析构函数的用途：当删除基类对象指针时，编译器将根据指针所指对象的实际类型，调用相应的析构函数。</li>
<li>若基类析构不是虚函数，则删除基类指针所指派生类对象时，编译器仅自动调用基类的析构函数，而不会考虑实际对象是不是基类的对象。这可能会导致内存泄漏。</li>
<li>在析构函数中调用一个虚函数，被调用的只是这个函数的本地版本，即虚机制在析构函数中不工作。 </li>
</ul>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 9.5.1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Base1</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token operator">~</span><span class="token function">Base1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Base1()\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Derived1</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base1</span></span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token operator">~</span><span class="token function">Derived1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Derived1()\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Base2</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Base2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Base2()\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Derived2</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base2</span></span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token operator">~</span><span class="token function">Derived2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Derived2()\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  Base1<span class="token operator">*</span> bp <span class="token operator">=</span> <span class="token keyword">new</span> Derived1<span class="token punctuation">;</span>
  <span class="token keyword">delete</span> bp<span class="token punctuation">;</span> <span class="token comment">/// 只调用了基类的虚析构函数</span>
  Base2<span class="token operator">*</span> b2p <span class="token operator">=</span> <span class="token keyword">new</span> Derived2<span class="token punctuation">;</span>
  <span class="token keyword">delete</span> b2p<span class="token punctuation">;</span> <span class="token comment">/// 派生类虚析构函数调用完后调用基类的虚析构函数</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Output</span>
<span class="token operator">~</span><span class="token function">Base1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">~</span><span class="token function">Derived2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">~</span><span class="token function">Base2</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<ul>
<li>重要原则：总是将基类的析构函数设置为虚析构函数</li>
</ul>
<h3 id="9-6-重载、重写覆盖与重写隐藏"><a href="#9-6-重载、重写覆盖与重写隐藏" class="headerlink" title="9.6 重载、重写覆盖与重写隐藏"></a>9.6 重载、重写覆盖与重写隐藏</h3><ul>
<li><strong>重载(overload)：</strong><ul>
<li>函数名必须相同，函数参数必须不同，作用域相同(同一个类)，返回值可以相同或不同。</li>
</ul>
</li>
<li><strong>重写覆盖(override)：</strong><ul>
<li>派生类重新定义基类中的<strong>虚函数</strong>，<strong>函数名必须相同</strong>，函数<strong>参数必须相同</strong>，<strong>返回值一般情况应相同</strong>。</li>
<li>派生类的虚函数表中原基类的虚函数指针会被派生类中重新定义的虚函数指针覆盖掉。</li>
</ul>
</li>
<li><strong>重写隐藏(redefining)：</strong><ul>
<li>派生类重新定义基类中的函数，<strong>函数名相同</strong>，但是<strong>参数不同或者基类的函数不是虚函数</strong>。</li>
<li>虚函数表不会发生覆盖。</li>
</ul>
</li>
<li><p>重写覆盖和重写隐藏：</p>
<ul>
<li>相同点：<ul>
<li>都要求派生类定义的函数与基类同名。</li>
<li>都会屏蔽基类中的同名函数，即派生类的实例无法调用基类的同名函数。</li>
</ul>
</li>
<li>不同点：<ul>
<li>重写覆盖要求基类的函数是虚函数，且函数参数相同，返回值一般情况应相同；重写隐藏要求基类的函数不是虚函数或者函数参数不同。</li>
<li>重写覆盖会使派生类虚函数表中基类的虚函数的指针被派生类的虚函数指针覆盖。重写隐藏不会。</li>
</ul>
</li>
</ul>
</li>
<li><p>override与final关键字</p>
<ul>
<li>重写覆盖要满足的条件很多，很容易写错，可以使用override关键字辅助检查。</li>
<li>override关键字明确地告诉编译器一个函数是对基类中一个虚函数的重写覆盖，编译器将对重写覆盖要满足的条件进行检查，正确的重写覆盖才能通过编译。</li>
<li>如果没有override关键字，但是满足了重写覆盖的各项条件，也能实现重写覆盖。它只是编译器的一个检查，正确实现override时，对编译结果没有影响。</li>
</ul>
</li>
<li><p>不想让使用者继承？-&gt; final关键字!</p>
<ul>
<li>在虚函数声明或定义中使用时，final确保函数为虚且不可被派生类重写。可在继承关系链的“中途”进行设定，禁止后续派生类对指定虚函数重写。</li>
<li>在类定义中使用时，final指定此类不可被继承。</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>OOP</tag>
      </tags>
  </entry>
  <entry>
    <title>OOP 课程笔记 Week 11 模板与STL初步</title>
    <url>/2021/05/oop-11/</url>
    <content><![CDATA[<h2 id="Week-11-模板与STL初步"><a href="#Week-11-模板与STL初步" class="headerlink" title="Week 11 模板与STL初步"></a>Week 11 模板与STL初步</h2><h3 id="11-0-Overview"><a href="#11-0-Overview" class="headerlink" title="11.0 Overview"></a>11.0 Overview</h3><ul>
<li><s>类模板与函数模板特化</s></li>
<li>命名空间</li>
<li>STL初步——容器与迭代器</li>
</ul>
<h3 id="11-1-命名空间"><a href="#11-1-命名空间" class="headerlink" title="11.1 命名空间"></a>11.1 命名空间</h3><ul>
<li>为了避免在大规模程序的设计中，以及在程序员使用各种各样的C++库时，标识符的命名发生冲突，标准C++引入了关键字namespace（命名空间），可以更好地控制标识符的作用域。</li>
<li>标准C++库（不包括标准C库）中所包含的所有内容（包括常量、变量、结构、类和函数等）都被定义在命名空间std（standard标准）中。</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 11.1.1</span>
<span class="token comment">// 定义命名空间</span>
<span class="token keyword">namespace</span> A <span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 使用命名空间</span>
A<span class="token double-colon punctuation">::</span>x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
A<span class="token double-colon punctuation">::</span>y <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>使用using声明简化命名空间使用</li>
<li>使用整个命名空间：所有成员都直接可用<code>using namespace A;</code> <code>x = 3; y = 6;</code></li>
<li>使用部分成员：所选成员可直接使用  <code>using A::x;</code> <code>x = 3; A::y = 6;</code></li>
<li>任何情况下，都不应出现命名冲突</li>
</ul>
<h3 id="11-2-STL初步"><a href="#11-2-STL初步" class="headerlink" title="11.2 STL初步"></a>11.2 STL初步</h3><ul>
<li><p>标准模板库（英文：Standard Template Library，缩写：STL），是一个高效的C++软件库，它被容纳于C++ 标准程序库C++ Standard Library中。其中包含4个组件，分别为算法、容器、函数、迭代器。基于模板编写。关键理念：将“在数据上执行的操作”与“要执行操作的数据”分离。</p>
</li>
<li><p>简单容器</p>
<ul>
<li>容器是包含、放置数据的工具。通常为数据结构。<ul>
<li>简单容器（simple container）</li>
<li>序列容器（sequence container）</li>
<li>关系容器（associative container）</li>
</ul>
</li>
</ul>
</li>
<li><code>std::pair</code></li>
<li><code>std::tuple</code></li>
<li><p><code>std::vector</code></p>
<ul>
<li>创建：<code>std::vector&lt;int&gt; x;</code></li>
<li>当前数组长度： <code>x.size();</code></li>
<li>清空： <code>x.clear();</code></li>
<li>在末尾添加/删除：（高速）<code>x.push_back(1); x.pop_back();</code></li>
<li>在中间添加/删除：（使用迭代器，低速）<code>x.insert(x.begin()+1, 5);</code> <code>x.erase(x.begin()+1);</code></li>
</ul>
</li>
<li><p>迭代器</p>
<ul>
<li>一种检查容器内元素并遍历元素的数据类型。</li>
<li>提供一种方法顺序访问一个聚合对象中各个元素, 而又不需暴露该对象的内部表示。</li>
<li>为遍历不同的聚合结构（需拥有相同的基类）提供一个统一的接口。</li>
<li>使用上类似指针。</li>
</ul>
</li>
<li><p>迭代器：失效</p>
</li>
<li><p>当迭代器不再指向本应指向的元素时，称此迭代器失效。</p>
<ul>
<li>vector中什么情况下会发生迭代器失效？</li>
<li>看作纯粹的指针<ul>
<li>调用insert/erase后，所修改位置之后的所有迭代器失效。（原先的内存空间存储的元素被改变）</li>
<li>调用push_back等修改vector大小的方法时，可能会使所有迭代器失效（Push_back到了一定程度之后，可能会造成数组的整体移动，导致所有的内存地址发生改变。）</li>
</ul>
</li>
</ul>
</li>
<li><p><code>std::list</code></p>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 插入前端：</span>
 l<span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 插入末端：</span>
 l<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 查询：</span>
 std<span class="token double-colon punctuation">::</span><span class="token function">find</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回迭代器</span>
<span class="token comment">// 插入指定位置：</span>
 l<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//it为迭代器</span></code></pre>
<ul>
<li><p><code>std::list</code></p>
<ul>
<li>不支持下标等随机访问</li>
<li>支持高速的在任意位置插入/删除数据</li>
<li>其访问主要依赖迭代器</li>
<li>操作不会导致迭代器失效（除指向被删除的元素的迭代器外）</li>
</ul>
</li>
<li><p><code>std::set</code></p>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 插入：</span>
 s<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 查询：</span>
 s<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回迭代器</span>
<span class="token comment">// 删除：</span>
 s<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//导致被删除元素的迭代器失效</span>
<span class="token comment">// 统计：</span>
 s<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//1的个数，总是0或1</span></code></pre>
<ul>
<li><code>std::map</code><ul>
<li>其值类型为pair<Key, T>。</li>
<li>map中的元素key互不相同，需要key存在比较器。</li>
<li>可以通过下标访问（即使key不是整数）。下标访问时如果元素不存在，则创建对应元素。</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>OOP</tag>
      </tags>
  </entry>
  <entry>
    <title>OOP 课程笔记 Week 10 多态与模板</title>
    <url>/2021/04/oop-10/</url>
    <content><![CDATA[<h2 id="Week-10-多态与模板"><a href="#Week-10-多态与模板" class="headerlink" title="Week 10 多态与模板"></a>Week 10 多态与模板</h2><h3 id="10-0-Overview"><a href="#10-0-Overview" class="headerlink" title="10.0 Overview"></a>10.0 Overview</h3><ul>
<li>纯虚函数与抽象类</li>
<li>向下类型转换</li>
<li>多重继承的虚函数表，多重继承的利弊</li>
<li>多态</li>
<li>函数模板与类模板</li>
</ul>
<h3 id="10-1-纯虚函数与抽象类"><a href="#10-1-纯虚函数与抽象类" class="headerlink" title="10.1 纯虚函数与抽象类"></a>10.1 纯虚函数与抽象类</h3><ul>
<li><p>虚函数还可以进一步声明为纯虚函数，包含纯虚函数的类，通常被称为“抽象类”。</p>
<ul>
<li><code>virtual 返回类型 函数名(形式参数) = 0;</code></li>
</ul>
</li>
<li><p>抽象类不允许定义对象，定义基类为抽象类的主要用途是为派生类规定共性“接口”</p>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 10.1.1</span>
<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/// 可在类外定义函数体提供默认实现。派生类通过 A::f() 调用</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
A obj<span class="token punctuation">;</span> <span class="token comment">/// 不准抽象类定义对象！编译不通过！</span></code></pre>
<ul>
<li><p>抽象类</p>
<ul>
<li>定义：含有至少一个纯虚函数。</li>
<li>特点：<ul>
<li>不允许定义对象。</li>
<li>只能为派生类提供接口。</li>
<li>能避免对象切片：保证只有指针和引用能被向上类型转换。</li>
</ul>
</li>
</ul>
</li>
<li><p>基类纯虚函数被派生类重写覆盖之前仍是纯虚函数。因此当继承一个抽象类时，必须实现所有纯虚函数，否则继承出的类也是抽象类。</p>
</li>
<li><strong>纯虚析构函数除外</strong><ul>
<li>对于纯虚析构函数而言，即便派生类中不显式实现，编译器也会自动合成默认析构函数。因此，即使派生类不覆盖纯虚析构函数，派生类可以不是抽象类，可以定义派生类对象。</li>
<li>回顾：虚函数与析构函数<ul>
<li>析构函数能是虚的，且常常是虚的。<strong>虚析构函数仍需定义函数体</strong>。</li>
<li>虚析构函数的用途：当删除基类对象指针时，编译器将根据指针所指对象的实际类型，调用相应的析构函数。</li>
</ul>
</li>
<li>析构函数也可以是纯虚函数<ul>
<li>纯虚析构函数仍然需要函数体</li>
<li>目的：使基类成为抽象类，不能创建基类的对象。如果有其他函数是纯虚函数，则析构函数不必是纯虚的。</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 10.1.2</span>
<span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span><span class="token operator">:</span> 
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">Base</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">/// 必须有函数体</span>
<span class="token keyword">class</span> <span class="token class-name">Derive</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Base b<span class="token punctuation">;</span> <span class="token comment">/// 编译错误，基类是抽象类</span>
    Derive d1<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="10-2-向下类型转换"><a href="#10-2-向下类型转换" class="headerlink" title="10.2 向下类型转换"></a>10.2 向下类型转换</h3><ul>
<li>基类指针/引用转换成派生类指针/引用，则称为向下类型转换。（类层次中向下移动）</li>
<li>如何确保转换的正确性？<ul>
<li>如何保证基类指针指向的对象也可以被要转换的派生类的指针指向？—— 借助虚函数表进行动态类型检查！</li>
</ul>
</li>
<li>C++提供了一个特殊的显式类型转换，称为<code>dynamic_cast</code>，是一种安全类型向下类型转换。<ul>
<li>使用dynamic_cast的对象必须有虚函数，因为它使用了存储在虚函数表中的信息判断实际的类型。使用方法：<ul>
<li>obj_p，obj_r分别是T1类型的指针和引用<ul>
<li><code>T2* pObj = dynamic_cast&lt;T2*&gt;(obj_p);</code>//转换为T2指针，运行时失败返回 <code>nullptr</code></li>
<li><code>T2&amp; refObj = dynamic_cast&lt;T2&amp;&gt;(obj_r);</code> //转换为T2引用，运行时失败抛出 <code>bad_cast</code> 异常</li>
</ul>
</li>
<li>T1必须是多态类型（声明或继承了至少一个虚函数的类），否则不过编译；T2不必。T1,T2没有继承关系也能通过编译，只不过运行时会转换失败。</li>
</ul>
</li>
<li>如果我们知道正在处理的是哪些类型，可以使用static_cast来避免这种开销。<ul>
<li>static_cast在编译时静态浏览类层次，只检查继承关系。没有继承关系的类之间，必须具有转换途径才能进行转换（要么自定义，要么是语言语法支持），否则不过编译。运行时无法确认是否正确转换。</li>
<li>static_cast使用方法：<ul>
<li>obj_p，obj_r分别是T1类型的指针和引用</li>
<li><code>T2* pObj = static_cast&lt;T2*&gt;(obj_p);</code>   //转换为T2指针</li>
<li><code>T2&amp; refObj = static_cast&lt;T2&amp;&gt;(obj_r);</code>   //转换为T2引用</li>
<li>不安全：不保证转换后的目标是T2类型的，可能导致非法内存访问。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 10.2.1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">D</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">B</span></span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">int</span> i<span class="token punctuation">&#123;</span><span class="token number">2018</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    D d<span class="token punctuation">;</span>
    B b<span class="token punctuation">;</span>
    <span class="token comment">//    D d1 = static_cast&lt;D>(b); ///未定义类型转换方式</span>
    <span class="token comment">//    D d2 = dynamic_cast&lt;D>(b); ///只允许指针和引用转换</span>

    D<span class="token operator">*</span> pd1 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>D<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/// 有继承关系，允许转换</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pd1 <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"static_cast, B*(B) --> D*: OK"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"D::i="</span> <span class="token operator">&lt;&lt;</span> pd1<span class="token operator">-></span>i <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/// 但是不安全：对D中成员i可能非法访问</span>

    D<span class="token operator">*</span> pd2 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>D<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pd2 <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>  <span class="token comment">/// 不允许不安全的转换</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"dynamic_cast, B*(B) --> D*: FAILED"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">static_cast</span><span class="token punctuation">,</span> B<span class="token operator">*</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">></span> D<span class="token operator">*</span><span class="token operator">:</span>OK
<span class="token operator">>></span><span class="token operator">></span> D<span class="token double-colon punctuation">::</span>i<span class="token operator">=</span><span class="token number">124455624</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">dynamic_cast</span><span class="token punctuation">,</span> B<span class="token operator">*</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">></span> D<span class="token operator">*</span><span class="token operator">:</span> FAILED</code></pre>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 10.2.2</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">D</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">B</span></span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">int</span> i<span class="token punctuation">&#123;</span><span class="token number">2018</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    D d<span class="token punctuation">;</span>
    B b<span class="token punctuation">;</span>
    <span class="token comment">//    D d1 = static_cast&lt;D>(b); ///未定义类型转换</span>
    <span class="token comment">//    D d2 = dynamic_cast&lt;D>(b); ///只允许指针和引用转换</span>
    B<span class="token operator">*</span> pb <span class="token operator">=</span> <span class="token operator">&amp;</span>d<span class="token punctuation">;</span>
    D<span class="token operator">*</span> pd3 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>D<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pd3 <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"static_cast, B*(D) --> D*: OK"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"D::i="</span> <span class="token operator">&lt;&lt;</span> pd3<span class="token operator">-></span>i <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    D<span class="token operator">*</span> pd4 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>D<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pd4 <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"dynamic_cast, B*(D) --> D*: OK"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"D::i="</span> <span class="token operator">&lt;&lt;</span> pd4<span class="token operator">-></span>i <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">static_cast</span><span class="token punctuation">,</span> B<span class="token operator">*</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">></span> D<span class="token operator">*</span><span class="token operator">:</span> OK
<span class="token operator">>></span><span class="token operator">></span> D<span class="token double-colon punctuation">::</span>i<span class="token operator">=</span><span class="token number">2018</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">dynamic_cast</span><span class="token punctuation">,</span> B<span class="token operator">*</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">></span> D<span class="token operator">*</span><span class="token operator">:</span> OK
<span class="token operator">>></span><span class="token operator">></span> D<span class="token double-colon punctuation">::</span>i<span class="token operator">=</span><span class="token number">2018</span></code></pre>
<ul>
<li><p>重要原则(清楚指针所指向的真正对象)：<br>1）指针或引用的向上转换总是安全的；<br>2）向下转换时用dynamic_cast，安全检查；<br>3）避免对象之间的转换。</p>
</li>
<li><p>对于基类中有虚函数的情况：</p>
<ul>
<li>向上类型转换：<ul>
<li>转换为基类指针或引用，则对应虚函数表仍为派生类的虚函数表（晚绑定）。</li>
<li>转换为基类对象，则对应虚函数表是基类的虚函数表（早绑定）。</li>
</ul>
</li>
<li>向下类型转换：<br>dynamic_cast通过虚函数表来判断是否能进行向下类型转换。</li>
</ul>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 10.2.3</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Pet</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Pet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Dog</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Pet</span></span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"dog run"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Bird</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Pet</span></span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">fly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"bird fly"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">action</span><span class="token punctuation">(</span>Pet<span class="token operator">*</span> p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">auto</span> d <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Dog<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/// 向下类型转换</span>
    <span class="token keyword">auto</span> b <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Bird<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/// 向下类型转换</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">)</span>  <span class="token comment">/// 运行时根据实际类型表现特性</span>
        d<span class="token operator">-></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span>
        b<span class="token operator">-></span><span class="token function">fly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Pet<span class="token operator">*</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> Dog<span class="token punctuation">;</span>   <span class="token comment">/// 向上类型转换</span>
    p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> Bird<span class="token punctuation">;</span>  <span class="token comment">/// 向上类型转换</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">action</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="10-3-多重继承的虚函数表与利弊"><a href="#10-3-多重继承的虚函数表与利弊" class="headerlink" title="10.3 多重继承的虚函数表与利弊"></a>10.3 多重继承的虚函数表与利弊</h3><ul>
<li>多重继承中的虚函数<ul>
<li>最多继承一个非抽象类 <strong>避免</strong> 多重继承的二义性</li>
<li>可以集成多个抽象类 <strong>利用</strong> 一个对象可以实现多个接口</li>
</ul>
</li>
</ul>
<h3 id="10-4-多态"><a href="#10-4-多态" class="headerlink" title="10.4 多态"></a>10.4 多态</h3><ul>
<li><p>按照基类的接口定义，调用指针或引用所指对象的接口函数，函数执行过程因对象实际所属派生类的不同而呈现不同的效果（表现），这个现象被称为“多态”。</p>
<ul>
<li>当利用基类指针/引用调用函数时<ul>
<li>虚函数在运行时确定执行哪个版本，取决于引用或指针对象的真实类型</li>
<li>非虚函数在编译时绑定</li>
</ul>
</li>
<li>当利用类的对象直接调用函数时<ul>
<li>无论什么函数，均在编译时绑定</li>
</ul>
</li>
<li>产生多态效果的条件：继承 &amp;&amp; 虚函数 &amp;&amp; (引用 || 指针)</li>
</ul>
</li>
<li><p>应用：TEMPLATE METHOD设计模式</p>
<ul>
<li>在接口的一个方法中定义算法的骨架</li>
<li>将一些步骤的实现延迟到子类中</li>
<li>使得子类可以在不改变算法结构的情况下，重新定义算法中的某些步骤。</li>
</ul>
</li>
<li>模板方法是一种源代码重用的基本技术，在类库的设计实现中应用十分广泛，因为这个设计模式能有效地解决 “类库提供公共行为”与“用户定制特殊细节”之间的折中平衡。</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 10.4.1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::step1"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::step2"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base::step3"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Derived1</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Derived1::step1"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Derived2</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Derived2::step2"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Base<span class="token operator">*</span> ba<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token keyword">new</span> Base<span class="token punctuation">,</span> <span class="token keyword">new</span> Derived1<span class="token punctuation">,</span> <span class="token keyword">new</span> Derived2<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        ba<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"==="</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token operator">>></span><span class="token operator">></span>
Base<span class="token double-colon punctuation">::</span>step1
Base<span class="token double-colon punctuation">::</span>step2
Base<span class="token double-colon punctuation">::</span>step3
<span class="token operator">==</span><span class="token operator">=</span>
Derived1<span class="token double-colon punctuation">::</span>step1
Base<span class="token double-colon punctuation">::</span>step2
Base<span class="token double-colon punctuation">::</span>step3
<span class="token operator">==</span><span class="token operator">=</span>
Base<span class="token double-colon punctuation">::</span>step1
Derived2<span class="token double-colon punctuation">::</span>step2
Base<span class="token double-colon punctuation">::</span>step3
<span class="token operator">==</span><span class="token operator">=</span></code></pre>
<h3 id="10-5-函数模板与类模板"><a href="#10-5-函数模板与类模板" class="headerlink" title="10.5 函数模板与类模板"></a>10.5 函数模板与类模板</h3><ol>
<li>函数模板</li>
</ol>
<ul>
<li>有些算法实现与类型无关，所以可以将函数的参数类型也定义为一种特殊的“参数”，这样就得到了“函数模板”。</li>
<li>定义函数模板的方法<ul>
<li><code>template &lt;typename T&gt; ReturnType Func(Args)；</code></li>
<li>如：任意类型两个变量相加的“函数模板”</li>
<li><code>template &lt;typename T&gt;  T sum(T a, T b) &#123; return a + b; &#125;</code></li>
<li>注：typename也可换为class</li>
</ul>
</li>
<li>函数模板在调用时，编译器能自动推导出实际参数的类型（这个过程叫做实例化）。<ul>
<li>所以，形式上调用一个函数模板与普通函数没有区别。</li>
<li>当多个参数的类型不一致时，无法推导：<ul>
<li><code>cout &lt;&lt; sum(9, 2.1);</code> //编译错误</li>
<li>手工指定调用类型：<code>sum&lt;int&gt;(9, 2.1);</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<ol>
<li>类模板</li>
</ol>
<ul>
<li>在定义类时也可以将一些类型信息抽取出来，用模板参数来替换，从而使类更具通用性。这种类被称为“类模板”。</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 10.5.1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span>
    T data<span class="token punctuation">;</span>

   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> data <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    A<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> a<span class="token punctuation">;</span>
    a<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<ul>
<li>类模板中成员函数的类外定义</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 10.5.2</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span>
    T data<span class="token punctuation">;</span>

   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">void</span> <span class="token class-name">A</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    cout <span class="token operator">&lt;&lt;</span> data <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    A<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> a<span class="token punctuation">;</span>
    a<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<ul>
<li>类模板的“模板参数”<ul>
<li>类型参数：使用typename或class标记</li>
<li>非类型参数：整数，枚举，指针（指向对象或函数），引用（引用对象或引用函数）。整数型比较常用。</li>
</ul>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example 10.5.3</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> size<span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">array</span> <span class="token punctuation">&#123;</span>
    T elems<span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

array<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">></span> array0<span class="token punctuation">;</span></code></pre>
<ul>
<li>模板与多态<ul>
<li>模板使用泛型标记，使用同一段代码，来关联不同但相似的特定行为，最后可以获得不同的结果。模板也是多态的一种体现。</li>
<li>但模板的关联是在编译期处理，称为静多态。<ul>
<li>往往和函数重载同时使用</li>
<li>高效，省去函数调用</li>
<li>编译后代码增多</li>
</ul>
</li>
<li>基于继承和虚函数的多态在运行期处理，称为动多态<ul>
<li>运行时，灵活方便</li>
<li>侵入式，必须继承</li>
<li>存在函数调用</li>
</ul>
</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>OOP</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 中 Package 的概念</title>
    <url>/2021/06/package-java/</url>
    <content><![CDATA[<p><img src="https://i.loli.net/2021/06/22/x74o9FEeajuzrpk.png" alt="image-20210622084907577"></p>
<span id="more"></span>
<h2 id="§-2-2-5-类的组织——包的概念"><a href="#§-2-2-5-类的组织——包的概念" class="headerlink" title="§ 2.2.5 类的组织——包的概念"></a>§ 2.2.5 类的组织——包的概念</h2><h3 id="编译单元与类空间"><a href="#编译单元与类空间" class="headerlink" title="编译单元与类空间"></a>编译单元与类空间</h3><ul>
<li>编译单元：一个 Java 源代码文件<ul>
<li>一个编译单元中只能有 一个 public 权限的类</li>
<li>且该类名与文件名相同</li>
<li>类名存在冲突问题</li>
</ul>
</li>
<li>编译单元的组成部分<ul>
<li>所属包的声明；</li>
<li>Import 包的声明用来导入外部类；</li>
<li>类和接口的声明.</li>
</ul>
</li>
</ul>
<h3 id="包与目录"><a href="#包与目录" class="headerlink" title="包与目录"></a>包与目录</h3><p><img src="https://i.loli.net/2021/06/22/PfxFjRqTn4pAGwb.png" alt="image-20210622093402716"></p>
<p><img src="https://i.loli.net/2021/06/22/R5vp4OgNIoc3XVS.png" alt="image-20210622093500242"></p>
<h3 id="引入包与静态引入"><a href="#引入包与静态引入" class="headerlink" title="引入包与静态引入"></a>引入包与静态引入</h3><p><img src="https://i.loli.net/2021/06/22/MVz5RybwFh9UrLT.png" alt="image-20210622093702915"></p>
]]></content>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Python BeautifulSoup4 库的基本操作</title>
    <url>/2021/08/python-bs4/</url>
    <content><![CDATA[<p><strong>Beautiful Soup 4 是什么？</strong></p>
<p>是一个 Python 库，协助解析 HTML 和 XML 的内容的 Python 库。</p>
<p>可以协助开发者在文档中准确定位到想要寻找的元素。</p>
<span id="more"></span>
<h2 id="Basic-usage"><a href="#Basic-usage" class="headerlink" title="Basic usage"></a>Basic usage</h2><h3 id="Installing-and-importing"><a href="#Installing-and-importing" class="headerlink" title="Installing and importing"></a>Installing and importing</h3><p><strong>Installing</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">pip3 <span class="token function">install</span> beautifulsoup4</code></pre>
<p>Very easy.</p>
<p><strong>Importing</strong></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup</code></pre>
<h3 id="Create-a-BeautifulSoup-Object"><a href="#Create-a-BeautifulSoup-Object" class="headerlink" title="Create a BeautifulSoup Object"></a>Create a <code>BeautifulSoup</code> Object</h3><pre class="language-python" data-language="python"><code class="language-python">soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>markup<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>soup<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># &lt;class 'bs4.BeautifulSoup'></span></code></pre>
<p>接下来我们会详细介绍这个 <code>BeautifulSoup</code> 对象。</p>
<h2 id="Objects-可能用到的对象类型"><a href="#Objects-可能用到的对象类型" class="headerlink" title="Objects 可能用到的对象类型"></a>Objects 可能用到的对象类型</h2><p>BeautifulSoup 会将一个复杂的 HTML 文档转化成一颗树，但我们真正需要处理的只有四种对象：</p>
<ul>
<li>Tag</li>
<li>NavigableString</li>
<li>BeautifulSoup</li>
<li>Comment</li>
</ul>
<p>下面我们将一一介绍。</p>
<h3 id="Tag"><a href="#Tag" class="headerlink" title="Tag"></a>Tag</h3><pre class="language-python" data-language="python"><code class="language-python">soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span><span class="token string">'&lt;b class="boldest">Extremely bold&lt;/b>'</span><span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>
tag <span class="token operator">=</span> soup<span class="token punctuation">.</span>b
<span class="token builtin">type</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
<span class="token comment"># &lt;class 'bs4.element.Tag'></span></code></pre>
<blockquote>
<p>Tag 的基本属性：</p>
<p><code>&lt;b class=&quot;boldest&quot;&gt;Extremely bold&lt;/b&gt;</code> 中：</p>
<ul>
<li>Name: <code>b</code>  # <code>tag.name</code> == b</li>
<li>Attributes:<ul>
<li>class # <code>tag[&#39;class&#39;]</code> == “boldest”</li>
<li>// Use <code>tag.attrs</code> to get all attributes</li>
</ul>
</li>
</ul>
<p>特别说明：对于多值属性，查询时会返回列表.</p>
</blockquote>
<h3 id="NavigableString"><a href="#NavigableString" class="headerlink" title="NavigableString"></a>NavigableString</h3><p><code>NavigableString</code>类存储了 HTML 中可以被划分出来的 Tag 中的<code>文本内容</code>，如<code>&lt;div&gt;bulabula&lt;/div&gt;</code>.</p>
<pre class="language-python" data-language="python"><code class="language-python">soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span><span class="token string">'&lt;b class="boldest">Extremely bold&lt;/b>'</span><span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>
tag <span class="token operator">=</span> soup<span class="token punctuation">.</span>b
tag<span class="token punctuation">.</span>string
<span class="token comment"># 'Extremely bold'</span>
<span class="token builtin">type</span><span class="token punctuation">(</span>tag<span class="token punctuation">.</span>string<span class="token punctuation">)</span>
<span class="token comment"># &lt;class 'bs4.element.NavigableString'></span></code></pre>
<p><code>NavigableString</code> 对象大可当做普通的 <code>str</code> 来使用，只是在其上又实现了在文档中定位和搜索的功能而已。</p>
<ul>
<li>要想把<code>NavigableString</code>转换成<code>str</code>，自然可以使用<code>str()</code>强制类型转换。</li>
<li>要想修改<code>NavigableString</code>内存储的文本内容的话，可以使用<code>replace_with()</code> 函数</li>
</ul>
<pre class="language-python" data-language="python"><code class="language-python">tag<span class="token punctuation">.</span>string<span class="token punctuation">.</span>replace_with<span class="token punctuation">(</span><span class="token string">"No longer bold"</span><span class="token punctuation">)</span>
tag
<span class="token comment"># &lt;b class="boldest">No longer bold&lt;/b></span></code></pre>
<h3 id="BeautifulSoup"><a href="#BeautifulSoup" class="headerlink" title="BeautifulSoup"></a>BeautifulSoup</h3><p><code>BeautifulSoup</code> 对象将整个文档解析成了一个整体。</p>
<p>大多数情况下，我们可以把 <code>BeautifulSoup</code> 对象看作是 <code>Tag</code> 对象。</p>
<p>它的 <code>.name</code> 字段返回 <code>[document]</code>，无其它附加属性<code>attrs</code>.</p>
<h3 id="Comments-and-other-special-strings"><a href="#Comments-and-other-special-strings" class="headerlink" title="Comments and other special strings"></a>Comments and other special strings</h3><p><code>Comment</code> 对象是一种特殊的 <code>NavigableString</code> 对象。</p>
<pre class="language-python" data-language="python"><code class="language-python">markup <span class="token operator">=</span> <span class="token string">"&lt;b>&lt;!--Hey, buddy. Want to buy a used parser?-->&lt;/b>"</span>
soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>markup<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>
comment <span class="token operator">=</span> soup<span class="token punctuation">.</span>b<span class="token punctuation">.</span>string
<span class="token builtin">type</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span>
<span class="token comment"># &lt;class 'bs4.element.Comment'></span></code></pre>
<p>除了<code>Comment</code>之外，<code>BS4</code>还提供了<code>Stylesheet</code>, <code>Script</code>, <code>TemplateString</code> 等类。</p>
<h2 id="Navigating-the-tree-逐级导航"><a href="#Navigating-the-tree-逐级导航" class="headerlink" title="Navigating the tree 逐级导航"></a>Navigating the tree 逐级导航</h2><pre class="language-python" data-language="python"><code class="language-python">html_doc <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
&lt;html>
&lt;head>&lt;title>The Dormouse's story&lt;/title>&lt;/head>
&lt;body>
&lt;p class="title">&lt;b>The Dormouse's story&lt;/b>&lt;/p>

&lt;p class="story">Once upon a time there were three little sisters; and their names were
&lt;a href="http://example.com/elsie" class="sister" id="link1">Elsie&lt;/a>,
&lt;a href="http://example.com/lacie" class="sister" id="link2">Lacie&lt;/a> and
&lt;a href="http://example.com/tillie" class="sister" id="link3">Tillie&lt;/a>;
and they lived at the bottom of a well.&lt;/p>

&lt;p class="story">...&lt;/p>
&lt;/body>
&lt;/html>
"""</span>

<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>html_doc<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span></code></pre>
<p>示例 HTML 文件如上。</p>
<h3 id="Going-down-向下一级"><a href="#Going-down-向下一级" class="headerlink" title="Going down 向下一级"></a>Going down 向下一级</h3><p>一个 <code>Tag</code> 的子元素可能包括 <code>string</code> 和其他 <code>Tag</code>.</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> soup<span class="token punctuation">.</span>head
<span class="token comment"># &lt;head>&lt;title>The Dormouse's story&lt;/title>&lt;/head></span>
<span class="token operator">>></span><span class="token operator">></span> soup<span class="token punctuation">.</span>title
<span class="token comment"># &lt;title>The Dormouse's story&lt;/title></span>
<span class="token operator">>></span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> soup<span class="token punctuation">.</span>body
<span class="token comment">#&lt;body></span>
<span class="token comment">#&lt;p class="title">&lt;b>The Dormouse's story&lt;/b>&lt;/p></span>
<span class="token comment">#&lt;p class="story">Once upon a time there were three little sisters; and their names were</span>
<span class="token comment">#&lt;a class="sister" href="http://example.com/elsie" id="link1">Elsie&lt;/a>,</span>
<span class="token comment">#&lt;a class="sister" href="http://example.com/lacie" id="link2">Lacie&lt;/a> and</span>
<span class="token comment">#&lt;a class="sister" href="http://example.com/tillie" id="link3">Tillie&lt;/a>;</span>
<span class="token comment">#and they lived at the bottom of a well.&lt;/p></span>
<span class="token comment">#&lt;p class="story">...&lt;/p></span>
<span class="token comment">#&lt;/body></span>
<span class="token operator">>></span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> soup<span class="token punctuation">.</span>body<span class="token punctuation">.</span>b
<span class="token comment">#&lt;b>The Dormouse's story&lt;/b></span>
<span class="token operator">>></span><span class="token operator">></span> soup<span class="token punctuation">.</span>a
<span class="token comment">#&lt;a class="sister" href="http://example.com/elsie" id="link1">Elsie&lt;/a></span>
<span class="token comment"># Only returns the first matched tag.</span>
<span class="token operator">>></span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> soup<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token comment">#[&lt;a class="sister" href="http://example.com/elsie" id="link1">Elsie&lt;/a>, &lt;a class="sister" href="http://example.com/lacie" id="link2">Lacie&lt;/a>, &lt;a class="sister" href="http://example.com/tillie" id="link3">Tillie&lt;/a>]</span>
<span class="token comment"># Use find_all() if you need all matched tags.</span></code></pre>
<h4 id="contents-and-children"><a href="#contents-and-children" class="headerlink" title=".contents and .children"></a><code>.contents</code> and <code>.children</code></h4><ul>
<li><p><code>tag.contents</code> 返回一个tag下的所有子元素 List.</p>
</li>
<li><p><code>tag.children</code> 返回一个tag下的所有子元素的集合的迭代器.</p>
</li>
</ul>
<h4 id="descendants"><a href="#descendants" class="headerlink" title=".descendants"></a>.descendants</h4><p><code>.contents</code> 和 <code>.children</code> 只能用于获取某个 tag 下<strong>一级</strong>的子元素。而 <code>.descendants</code> 可以返回某个 tag 下属的所有子元素的迭代器。</p>
<h4 id="string"><a href="#string" class="headerlink" title=".string"></a>.string</h4><p>返回某个只有一个 <code>NavigableString</code> 作为子元素的元素的该子元素的文本内容。</p>
<h4 id="strings-and-stripped-strings"><a href="#strings-and-stripped-strings" class="headerlink" title=".strings and stripped_strings"></a>.strings and stripped_strings</h4><p>返回所有子元素中字符的迭代器。</p>
<h3 id="Going-up-向上一级"><a href="#Going-up-向上一级" class="headerlink" title="Going up 向上一级"></a>Going up 向上一级</h3><h4 id="parent"><a href="#parent" class="headerlink" title=".parent"></a>.parent</h4><p>返回上层元素.</p>
<h4 id="parents"><a href="#parents" class="headerlink" title=".parents"></a>.parents</h4><p>返回上层元素的迭代器.</p>
<h3 id="Going-sideways-找同级别"><a href="#Going-sideways-找同级别" class="headerlink" title="Going sideways 找同级别"></a>Going sideways 找同级别</h3><h4 id="next-sibling-and-previous-sibling"><a href="#next-sibling-and-previous-sibling" class="headerlink" title=".next_sibling and .previous_sibling"></a>.next_sibling and .previous_sibling</h4><h4 id="next-siblings-and-previous-siblings"><a href="#next-siblings-and-previous-siblings" class="headerlink" title=".next_siblings and .previous_siblings"></a>.next_siblings and .previous_siblings</h4><h2 id="Searching-the-tree-查询搜索"><a href="#Searching-the-tree-查询搜索" class="headerlink" title="Searching the tree 查询搜索"></a>Searching the tree 查询搜索</h2><p>本节主要介绍两个主要方法：</p>
<ul>
<li>find()</li>
<li>find_all()</li>
</ul>
<h3 id="Filters-过滤器类型"><a href="#Filters-过滤器类型" class="headerlink" title="Filters 过滤器类型"></a>Filters 过滤器类型</h3><h4 id="String"><a href="#String" class="headerlink" title="String"></a>String</h4><p>过滤出所有 <code>tag.name == (Input)</code> 的 tag.</p>
<h4 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h4><p>过滤出满足 <code>tag.name</code> matches <code>pattern</code> 的tag.</p>
<h4 id="List"><a href="#List" class="headerlink" title="List"></a>List</h4><p>List 是上述两个项目的组合，过滤结果是并集。</p>
<h4 id="True"><a href="#True" class="headerlink" title="True"></a>True</h4><p>返回所有内容.</p>
<h4 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h4><p>回调函数，接受一个参数 tag，如果返回True则过滤出来.</p>
<h3 id="find-all-name-attrs-recursive-True-string-kwargs"><a href="#find-all-name-attrs-recursive-True-string-kwargs" class="headerlink" title="find_all(name, attrs, recursive=True, string, **kwargs)"></a>find_all(name, attrs, recursive=True, string, **kwargs)</h3><p>注意：keyword arguments 也可以帮助 attrs 查找.</p>
<pre class="language-python" data-language="python"><code class="language-python">soup<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span>href<span class="token operator">=</span>re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">"elsie"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'link1'</span><span class="token punctuation">)</span>
<span class="token comment"># [&lt;a class="sister" href="http://example.com/elsie" id="link1">Elsie&lt;/a>]</span></code></pre>
<h3 id="Searching-by-CSS-class"><a href="#Searching-by-CSS-class" class="headerlink" title="Searching by CSS class"></a>Searching by CSS class</h3><p>Usage:  <code>soup.find_ll(&quot;p&quot;, class_=&quot;body&quot;)</code></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">https://www.crummy.com/software/BeautifulSoup/bs4/doc/</a></li>
</ul>
]]></content>
      <tags>
        <tag>Python</tag>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 函数装饰器</title>
    <url>/2021/08/python-func-decorators/</url>
    <content><![CDATA[<p>Python 函数的装饰器是<strong>修改其他函数功能的函数</strong>。</p>
<span id="more"></span>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>首先，我们需要将 Python 中的<code>函数</code>作为函数对象来理解。</p>
<p><strong>函数名只是引用标识名</strong></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">hi</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"yasoob"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"hi "</span> <span class="token operator">+</span> name
 
<span class="token keyword">print</span><span class="token punctuation">(</span>hi<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># output: 'hi yasoob'</span>
 
<span class="token comment"># 我们甚至可以将一个函数赋值给一个变量，比如</span>
greet <span class="token operator">=</span> hi
<span class="token comment"># 我们这里没有在使用小括号，因为我们并不是在调用hi函数</span>
<span class="token comment"># 而是在将它放在greet变量里头。我们尝试运行下这个</span>
 
<span class="token keyword">print</span><span class="token punctuation">(</span>greet<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># output: 'hi yasoob'</span>
 
<span class="token comment"># 如果我们删掉旧的hi函数，看看会发生什么！</span>
<span class="token keyword">del</span> hi
<span class="token keyword">print</span><span class="token punctuation">(</span>hi<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#outputs: NameError</span>
 
<span class="token keyword">print</span><span class="token punctuation">(</span>greet<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#outputs: 'hi yasoob'</span></code></pre>
<p><strong>函数的返回值可以是函数对象</strong></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">hi</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"yasoob"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"now you are in the greet() function"</span>
    
	<span class="token keyword">def</span> <span class="token function">welcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"now you are in the welcome() function"</span>
    
    <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">"yasoob"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> greet
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> welcome
    
a <span class="token operator">=</span> hi<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token comment">#outputs: &lt;function greet at 0x7f2143c01500></span>
 
<span class="token comment">#上面清晰地展示了`a`现在指向到hi()函数中的greet()函数</span>
<span class="token comment">#现在试试这个</span>
 
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#outputs: now you are in the greet() function</span></code></pre>
<p><strong>函数的参数可以是函数对象</strong></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">hi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"hi yasoob!"</span>
 
<span class="token keyword">def</span> <span class="token function">doSomethingBeforeHi</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"I am doing some boring work before executing hi()"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

doSomethingBeforeHi<span class="token punctuation">(</span>hi<span class="token punctuation">)</span>
<span class="token comment">#outputs:I am doing some boring work before executing hi()</span>
<span class="token comment">#        hi yasoob!</span></code></pre>
<h2 id="So-what-is-a-decorator"><a href="#So-what-is-a-decorator" class="headerlink" title="So what is a decorator?"></a>So what is a decorator?</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">a_new_decorator</span><span class="token punctuation">(</span>a_func<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">wrapTheFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"I am doing some boring work before executing a_func()"</span><span class="token punctuation">)</span>

        a_func<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"I am doing some boring work after executing a_func()"</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> wrapTheFunction
 
<span class="token keyword">def</span> <span class="token function">a_function_requiring_decoration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"I am the function which needs some decoration to remove my foul smell"</span><span class="token punctuation">)</span>

a_function_requiring_decoration<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#outputs: "I am the function which needs some decoration to remove my foul smell"</span>
 
a_function_requiring_decoration <span class="token operator">=</span> a_new_decorator<span class="token punctuation">(</span>a_function_requiring_decoration<span class="token punctuation">)</span>
<span class="token comment">#now a_function_requiring_decoration is wrapped by wrapTheFunction()</span>
 
a_function_requiring_decoration<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#outputs:I am doing some boring work before executing a_func()</span>
<span class="token comment">#        I am the function which needs some decoration to remove my foul smell</span>
<span class="token comment">#        I am doing some boring work after executing a_func()</span></code></pre>
<p>这段代码等价于…</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@a_new_decorator</span>
<span class="token keyword">def</span> <span class="token function">a_function_requiring_decoration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Hey you! Decorate me!"""</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"I am the function which needs some decoration to "</span>
          <span class="token string">"remove my foul smell"</span><span class="token punctuation">)</span>

a_function_requiring_decoration<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#outputs: I am doing some boring work before executing a_func()</span>
<span class="token comment">#         I am the function which needs some decoration to remove my foul smell</span>
<span class="token comment">#         I am doing some boring work after executing a_func()</span>
 
<span class="token comment">#the @a_new_decorator is just a short way of saying:</span>
a_function_requiring_decoration <span class="token operator">=</span> a_new_decorator<span class="token punctuation">(</span>a_function_requiring_decoration<span class="token punctuation">)</span></code></pre>
<p>但是，这样的代码存在的问题有，比如，<code>__name__</code>获取不到正确的函数名。</p>
<p>于是稍加修改，我们有了以下解释器函数的编写模板：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps
 
<span class="token keyword">def</span> <span class="token function">a_new_decorator</span><span class="token punctuation">(</span>a_func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>a_func<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">wrapTheFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"I am doing some boring work before executing a_func()"</span><span class="token punctuation">)</span>
        a_func<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"I am doing some boring work after executing a_func()"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> wrapTheFunction
 
<span class="token decorator annotation punctuation">@a_new_decorator</span>
<span class="token keyword">def</span> <span class="token function">a_function_requiring_decoration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Hey yo! Decorate me!"""</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"I am the function which needs some decoration to "</span>
          <span class="token string">"remove my foul smell"</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>a_function_requiring_decoration<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># Output: a_function_requiring_decoration</span></code></pre>
<h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example 1"></a>Example 1</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps
 
<span class="token keyword">def</span> <span class="token function">logit</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">with_logging</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>__name__ <span class="token operator">+</span> <span class="token string">" was called"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> with_logging
 
<span class="token decorator annotation punctuation">@logit</span>
<span class="token keyword">def</span> <span class="token function">addition_func</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Do some math."""</span>
   	<span class="token keyword">return</span> x <span class="token operator">+</span> x
 

result <span class="token operator">=</span> addition_func<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token comment"># Output: addition_func was called</span></code></pre>
<h2 id="Decorators-with-parameters"><a href="#Decorators-with-parameters" class="headerlink" title="Decorators with parameters"></a>Decorators with parameters</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps
 
<span class="token keyword">def</span> <span class="token function">logit</span><span class="token punctuation">(</span>logfile<span class="token operator">=</span><span class="token string">'out.log'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">logging_decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
        <span class="token keyword">def</span> <span class="token function">wrapped_function</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            log_string <span class="token operator">=</span> func<span class="token punctuation">.</span>__name__ <span class="token operator">+</span> <span class="token string">" was called"</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>log_string<span class="token punctuation">)</span>
            <span class="token comment"># 打开logfile，并写入内容</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>logfile<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>
                <span class="token comment"># 现在将日志打到指定的logfile</span>
                opened_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>log_string <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> wrapped_function
    <span class="token keyword">return</span> logging_decorator
 
<span class="token decorator annotation punctuation">@logit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">myfunc1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
 
myfunc1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Output: myfunc1 was called</span>
<span class="token comment"># 现在一个叫做 out.log 的文件出现了，里面的内容就是上面的字符串</span>
 
<span class="token decorator annotation punctuation">@logit</span><span class="token punctuation">(</span>logfile<span class="token operator">=</span><span class="token string">'func2.log'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">myfunc2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
 
myfunc2<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Output: myfunc2 was called</span>
<span class="token comment"># 现在一个叫做 func2.log 的文件出现了，里面的内容就是上面的字符串</span></code></pre>
<h2 id="Class-of-Decorator"><a href="#Class-of-Decorator" class="headerlink" title="Class of Decorator"></a>Class of Decorator</h2><p>By means of class inheritance, we could implement effects of different kinds of decorations.</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps
 
<span class="token keyword">class</span> <span class="token class-name">logit</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> logfile<span class="token operator">=</span><span class="token string">'out.log'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>logfile <span class="token operator">=</span> logfile

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
            <span class="token keyword">def</span> <span class="token function">wrapped_function</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
                log_string <span class="token operator">=</span> func<span class="token punctuation">.</span>__name__ <span class="token operator">+</span> <span class="token string">" was called"</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>log_string<span class="token punctuation">)</span>
                <span class="token comment"># 打开logfile并写入</span>
                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>logfile<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>
                    <span class="token comment"># 现在将日志打到指定的文件</span>
                    opened_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>log_string <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
                <span class="token comment"># 现在，发送一个通知</span>
                self<span class="token punctuation">.</span>notify<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
            <span class="token keyword">return</span> wrapped_function

    <span class="token keyword">def</span> <span class="token function">notify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># logit只打日志，不做别的</span>
            <span class="token keyword">pass</span>
    
<span class="token keyword">class</span> <span class="token class-name">email_logit</span><span class="token punctuation">(</span>logit<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    一个logit的实现版本，可以在函数调用时发送email给管理员
    '''</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">'admin@myproject.com'</span><span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>email <span class="token operator">=</span> email
        <span class="token builtin">super</span><span class="token punctuation">(</span>email_logit<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">notify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 发送一封email到self.email</span>
        <span class="token comment"># 这里就不做实现了</span>
        <span class="token keyword">pass</span>

<span class="token decorator annotation punctuation">@logit</span>
<span class="token keyword">def</span> <span class="token function">myfunc1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

<span class="token decorator annotation punctuation">@email_logit</span>
<span class="token keyword">def</span> <span class="token function">myfunc2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span></code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://www.runoob.com/w3cnote/python-func-decorators.html">https://www.runoob.com/w3cnote/python-func-decorators.html</a></li>
</ul>
]]></content>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python Requests 库的基本使用</title>
    <url>/2021/08/python-requests/</url>
    <content><![CDATA[<p>Requests 库的基本用法，内含对 HTTP 请求方法的介绍，request 和 response 类的介绍，Session 类的使用，附加参数的选择等等。</p>
<span id="more"></span>
<h2 id="创建请求-Creating-requests"><a href="#创建请求-Creating-requests" class="headerlink" title="创建请求 Creating requests"></a>创建请求 Creating requests</h2><h3 id="安装与引入"><a href="#安装与引入" class="headerlink" title="安装与引入"></a>安装与引入</h3><pre class="language-bash" data-language="bash"><code class="language-bash">pip3 <span class="token function">install</span> requests</code></pre>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests</code></pre>
<p>十分简单，不再赘述.</p>
<h3 id="选择请求方法"><a href="#选择请求方法" class="headerlink" title="选择请求方法"></a>选择请求方法</h3><blockquote>
<p>HTTP 定义了一组<strong>请求方法</strong>, 以表明要对给定资源执行的操作。指示针对给定资源要执行的期望动作。</p>
<ul>
<li><strong>GET</strong><br>GET 方法请求一个指定资源的表示形式. 使用 GET 的请求应该只被用于获取数据.</li>
<li>HEAD<br>HEAD 方法请求一个与 GET 请求的响应相同的响应，但没有响应体.</li>
<li><strong>POST</strong><br>POST 方法用于将实体提交到指定的资源，通常导致在服务器上的状态变化或副作用. </li>
<li>PUT<br>PUT 方法用请求有效载荷替换目标资源的所有当前表示。</li>
<li>DELETE<br>DELETE 方法删除指定的资源。</li>
<li>CONNECT<br>CONNECT 方法建立一个到由目标资源标识的服务器的隧道。</li>
<li>OPTIONS<br>OPTIONS 方法用于描述目标资源的通信选项。</li>
<li>TRACE<br>TRACE 方法沿着到目标资源的路径执行一个消息环回测试。</li>
<li>PATCH<br>PATCH 方法用于对资源应用部分修改。</li>
</ul>
<p>我们常说的 CRUD (Create, Read/Retrieve, Update, Delete) 可以说成<code>增删查改</code>，即对应前四种方法。</p>
<p>参考资料：<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods</a></p>
</blockquote>
<p>我们就可以采用对应的 <code>requests</code> 模块所提供的方法来创建请求.</p>
<pre class="language-python" data-language="python"><code class="language-python">requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
requests<span class="token punctuation">.</span>head<span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> json<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
requests<span class="token punctuation">.</span>put<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">[</span>source<span class="token punctuation">]</span>
requests<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></code></pre>
<p>当然，我们也可以使用简单的<code>request</code>方法来构建请求。</p>
<pre class="language-python" data-language="python"><code class="language-python">requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
<span class="token comment"># Where method should be one of GET, OPTIONS, HEAD, POST, PUT, PATCH, or DELETE.</span></code></pre>
<h3 id="添加可选参数"><a href="#添加可选参数" class="headerlink" title="添加可选参数"></a>添加可选参数</h3><p>这里仅列出部分常用参数.</p>
<ul>
<li>params: Dict</li>
</ul>
<p>Mainly used for GET method. 帮助构建 Query 字符串。</p>
<ul>
<li>data : str | json : Dict</li>
</ul>
<p>Mainly used for POST/PUT method. 作为 Request Body.</p>
<pre class="language-python" data-language="python"><code class="language-python">URL <span class="token operator">=</span> PluginManager<span class="token punctuation">.</span>CONFIGURATION<span class="token punctuation">[</span><span class="token string">'destinations'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'QQ'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'http-adapter-address'</span><span class="token punctuation">]</span>
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>URL<span class="token operator">+</span><span class="token string">'/sendFriendMessage'</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> json<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"target"</span><span class="token punctuation">:</span> destination<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token string">"messageChain"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Plain"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"hello world"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">//</span> Equals to data<span class="token operator">=</span><span class="token string">"JSON STRING"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<ul>
<li>headers : Dict</li>
</ul>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Example</span>
response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>URL<span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span>
                            <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.107 Safari/537.36'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre>
<ul>
<li>cookies: Dict</li>
</ul>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Attached: get cookies in Dict from documen.cookie</span>
<span class="token keyword">def</span> <span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"cookies"</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> entry <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
        entryGroup <span class="token operator">=</span> entry<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span>
        result<span class="token punctuation">[</span>entryGroup<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> entryGroup<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> result

<span class="token comment"># Maybe the code could be more pythonic...??</span></code></pre>
<ul>
<li>timeout: float (seconds)</li>
</ul>
<h3 id="Optional-使用-Session"><a href="#Optional-使用-Session" class="headerlink" title="(Optional) 使用 Session"></a>(Optional) 使用 Session</h3><p>如果只需要对单个链接进行数据获取，那么我们上述的方法执行一次就够了.</p>
<p>但是某些网站可能需要前后访问的 Session 是一致的，这样才能够实现，先 Login 后 Verify 等等操作…</p>
<p>这时就需要我们的 Session 类了.</p>
<pre class="language-python" data-language="python"><code class="language-python">s <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment"># Configurate headers</span>
s<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://httpbin.org/get'</span><span class="token punctuation">)</span>
<span class="token comment"># Other Operations with s...</span>
s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h2 id="提取响应-Parsing-responses"><a href="#提取响应-Parsing-responses" class="headerlink" title="提取响应 Parsing responses"></a>提取响应 Parsing responses</h2><p>上述方法的返回值为 <code>Response</code> 类的对象。</p>
<p><code>Response</code> 类的对象具有以下常用属性。</p>
<ul>
<li>ok</li>
</ul>
<p>Returns true if return code is less than 400.</p>
<ul>
<li>text</li>
</ul>
<p>Content of the response, in unicode.</p>
<ul>
<li>json(**kwargs)</li>
</ul>
<p>Returns the json-encoded content of a response if any.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://docs.python-requests.org/en/master/">https://docs.python-requests.org/en/master/</a></li>
<li><a href="https://docs.python-requests.org/en/latest/api/">https://docs.python-requests.org/en/latest/api/</a></li>
</ul>
]]></content>
      <tags>
        <tag>Python</tag>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>React Redux 学习手记</title>
    <url>/2021/08/react-redux/</url>
    <content><![CDATA[<blockquote>
<p><strong>React Redux</strong> is the official React UI bindings layer for Redux. It lets your React components read data from a Redux store, and dispatch actions to the store to update state.</p>
<p>(Excerpted from react-redux.js.org)</p>
<p>Redux 是 JavaScript 应用的<strong>状态容器</strong>，提供可预测的状态管理。</p>
</blockquote>
<p><s>想做全局变量管理，于是来学</s></p>
<span id="more"></span>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p><img src="http://cn.redux.js.org/assets/images/ReduxDataFlowDiagram-49fa8c3968371d9ef6f2a1486bd40a26.gif" alt="数据流更新动画"></p>
<h3 id="单向数据流"><a href="#单向数据流" class="headerlink" title="单向数据流"></a>单向数据流</h3><p>有以下基本流程：</p>
<ul>
<li>用 state 来描述应用程序在特定时间点的状况</li>
<li>基于 state 来渲染出 view</li>
<li>当发生某些事情时（例如用户单击按钮），state 会根据发生的事情进行更新，生成新的 state</li>
<li>基于新的 state 重新渲染 view</li>
</ul>
<h3 id="不可变性"><a href="#不可变性" class="headerlink" title="不可变性"></a>不可变性</h3><p>原来的对象或数组中的内容<strong>不改变</strong>，通过复制的方式先获取一份 copy，然后更新 copy 中的内容。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  a<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 为了安全的更新 obj.a.c，需要先复制一份</span>
    c<span class="token operator">:</span> <span class="token number">3</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  b<span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// obj 的备份</span>
  <span class="token operator">...</span>obj<span class="token punctuation">,</span>
  <span class="token comment">// 覆盖 a</span>
  a<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// obj.a 的备份</span>
    <span class="token operator">...</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">,</span>
    <span class="token comment">// 覆盖 c</span>
    c<span class="token operator">:</span> <span class="token number">42</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span>
<span class="token comment">// 创建 arr 的备份，并把 c 拼接到最后。</span>
<span class="token keyword">const</span> arr2 <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span>

<span class="token comment">// 或者，可以对原来的数组创建复制体</span>
<span class="token keyword">const</span> arr3 <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 修改复制体</span>
arr3<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span></code></pre>
<p><em>Redux 期望所有状态更新都是使用不可变的方式</em>。</p>
<h3 id="state-view-action"><a href="#state-view-action" class="headerlink" title="state, view, action"></a>state, view, action</h3><ul>
<li>state: 储存数据的一个个“状态”</li>
<li>view: 当前绘制出的 UI</li>
<li>action: 由用户交互而触发的<strong>事件</strong>，可以引起 state 的更新，进而重新渲染 view.<ul>
<li><strong>action</strong> 是一个具有 <code>type</code> 字段的普通 JavaScript 对象。</li>
<li><code>type</code> 字段是一个字符串，给这个 action 一个描述性的名字，比如<code>&quot;todos/todoAdded&quot;</code>。我们通常把那个类型的字符串写成“域/事件名称”，其中第一部分是这个 action 所属的特征或类别，第二部分是发生的具体事情。</li>
<li>action 对象可以有其他字段，其中包含有关发生的事情的附加信息。按照惯例，我们将该信息放在名为 <code>payload</code> 的字段中。</li>
</ul>
</li>
</ul>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Example for action</span>
<span class="token keyword">const</span> addTodoAction <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  type<span class="token operator">:</span> <span class="token string">'todos/todoAdded'</span><span class="token punctuation">,</span>
  payload<span class="token operator">:</span> <span class="token string">'Buy milk'</span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="reducer"><a href="#reducer" class="headerlink" title="reducer"></a>reducer</h3><p><strong>reducer</strong> 是一个函数，接收当前的 <code>state</code> 和一个 <code>action</code> 对象，必要时决定如何更新状态，并返回新状态。函数签名是：<code>(state, action) =&gt; newState</code>。 </p>
<p><strong>你可以将 reducer 视为一个事件监听器，它根据接收到的 action（事件）类型处理事件。</strong></p>
<p>Reducer 必需符合以下规则：</p>
<ul>
<li>仅使用 <code>state</code> 和 <code>action</code> 参数计算新的状态值</li>
<li>禁止直接修改 <code>state</code>。必须通过复制现有的 <code>state</code> 并对复制的值进行更改的方式来做 <em>不可变更新（immutable updates）</em>。</li>
<li>禁止任何异步逻辑、依赖随机值或导致其他“副作用”的代码</li>
</ul>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">&#123;</span> value<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">counterReducer</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 检查 reducer 是否关心这个 action</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'counter/increment'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 如果是，复制 `state`</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token operator">...</span>state<span class="token punctuation">,</span>
      <span class="token comment">// 使用新值更新 state 副本</span>
      value<span class="token operator">:</span> state<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 返回原来的 state 不变</span>
  <span class="token keyword">return</span> state
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="store"><a href="#store" class="headerlink" title="store"></a>store</h3><p>当前 Redux 应用的状态存在于一个名为 <strong>store</strong> 的对象中。</p>
<p>store 是通过传入一个 reducer 来创建的，并且有一个名为 <code>getState</code> 的方法，它返回当前状态值.</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> configureStore <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@reduxjs/toolkit'</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">configureStore</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> reducer<span class="token operator">:</span> counterReducer <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// &#123;value: 0&#125;</span></code></pre>
<h3 id="dispatch"><a href="#dispatch" class="headerlink" title="dispatch"></a>dispatch</h3><p><strong>dispatch 一个 action 可以形象的理解为 “触发一个事件”</strong>。</p>
<p>Reducer 就像事件监听器一样，当它们收到关注的 action 后，它就会更新 state 作为响应。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">'counter/increment'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// &#123;value: 1&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">increment</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    type<span class="token operator">:</span> <span class="token string">'counter/increment'</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// &#123;value: 2&#125;</span></code></pre>
<h3 id="辅助函数类型"><a href="#辅助函数类型" class="headerlink" title="辅助函数类型"></a>辅助函数类型</h3><h4 id="action-creator"><a href="#action-creator" class="headerlink" title="action creator"></a>action creator</h4><p><strong>action creator</strong> (<strong>[text =&gt; action]</strong>)是一个创建并返回一个 action 对象的函数。它的作用是让你不必每次都手动编写 action 对象.</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">addTodo</span> <span class="token operator">=</span> <span class="token parameter">text</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    type<span class="token operator">:</span> <span class="token string">'todos/todoAdded'</span><span class="token punctuation">,</span>
    payload<span class="token operator">:</span> text
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h4 id="selector"><a href="#selector" class="headerlink" title="selector"></a>selector</h4><p><strong>Selector</strong> 函数可以从 store 状态树中提取指定的片段.</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">selectCounterValue</span> <span class="token operator">=</span> <span class="token parameter">state</span> <span class="token operator">=></span> state<span class="token punctuation">.</span>value

<span class="token keyword">const</span> currentValue <span class="token operator">=</span> <span class="token function">selectCounterValue</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>currentValue<span class="token punctuation">)</span>
<span class="token comment">// 2</span></code></pre>
<h3 id="functions-provided-by-toolkit"><a href="#functions-provided-by-toolkit" class="headerlink" title="functions provided by toolkit"></a>functions provided by toolkit</h3><h4 id="createSlice"><a href="#createSlice" class="headerlink" title="createSlice"></a>createSlice</h4><p>可以定义 初始状态, reducer 函数, slice name, 然后自动生成相应的action creator 和 action type.</p>
<p>内部重写了实现逻辑，可以使用<strong>可变</strong>的方式来进行状态修改。</p>
<pre class="language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createSlice<span class="token punctuation">,</span> PayloadAction <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@reduxjs/toolkit'</span>

<span class="token keyword">interface</span> <span class="token class-name">CounterState</span> <span class="token punctuation">&#123;</span>
  value<span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">&#123;</span> value<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span> <span class="token keyword">as</span> CounterState

<span class="token keyword">const</span> counterSlice <span class="token operator">=</span> <span class="token function">createSlice</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  name<span class="token operator">:</span> <span class="token string">'counter'</span><span class="token punctuation">,</span>
  initialState<span class="token punctuation">,</span>
  reducers<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token function">increment</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      state<span class="token punctuation">.</span>value<span class="token operator">++</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function">decrement</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      state<span class="token punctuation">.</span>value<span class="token operator">--</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function">incrementByAmount</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token operator">:</span> PayloadAction<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      state<span class="token punctuation">.</span>value <span class="token operator">+=</span> action<span class="token punctuation">.</span>payload
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> increment<span class="token punctuation">,</span> decrement<span class="token punctuation">,</span> incrementByAmount <span class="token punctuation">&#125;</span> <span class="token operator">=</span> counterSlice<span class="token punctuation">.</span>actions
<span class="token keyword">export</span> <span class="token keyword">default</span> counterSlice<span class="token punctuation">.</span>reducer</code></pre>
<p>Return values:</p>
<pre class="language-typescript" data-language="typescript"><code class="language-typescript"><span class="token punctuation">&#123;</span>
    name <span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    reducer <span class="token operator">:</span> ReducerFunction<span class="token punctuation">,</span>
    actions <span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> ActionCreator<span class="token operator">></span><span class="token punctuation">,</span>
    caseReducers<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> CaseReducer<span class="token operator">></span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="Redux-数据流"><a href="#Redux-数据流" class="headerlink" title="Redux 数据流"></a>Redux 数据流</h3><p>具体来说，对于 Redux，我们可以将这些步骤分解为更详细的内容：</p>
<ul>
<li>初始启动：<ul>
<li>使用最顶层的 root reducer 函数创建 Redux store</li>
<li>store 调用一次 root reducer，并将返回值保存为它的初始 <code>state</code></li>
<li>当 UI 首次渲染时，UI 组件访问 Redux store 的当前 state，并使用该数据来决定要呈现的内容。同时监听 store 的更新，以便他们可以知道 state 是否已更改。</li>
</ul>
</li>
<li>更新环节：<ul>
<li>应用程序中发生了某些事情，例如用户单击按钮</li>
<li>dispatch 一个 action 到 Redux store，例如 <code>dispatch(&#123;type: &#39;counter/increment&#39;&#125;)</code></li>
<li>store 用之前的 <code>state</code> 和当前的 <code>action</code> 再次运行 reducer 函数，并将返回值保存为新的 <code>state</code></li>
<li>store 通知所有订阅过的 UI，通知它们 store 发生更新</li>
<li>每个订阅过 store 数据的 UI 组件都会检查它们需要的 state 部分是否被更新。</li>
<li>发现数据被更新的每个组件都强制使用新数据重新渲染，紧接着更新网页</li>
</ul>
</li>
</ul>
<p><img src="http://cn.redux.js.org/assets/images/ReduxDataFlowDiagram-49fa8c3968371d9ef6f2a1486bd40a26.gif" alt="数据流更新动画"></p>
<h2 id="Practice"><a href="#Practice" class="headerlink" title="Practice"></a>Practice</h2><p><s>好，现在我已经掌握了 React Redux 的基本用法了</s></p>
<p><img src="https://i.loli.net/2021/08/23/EFG2eolQ7dzgkm3.png" alt="img"></p>
<p><strong>Store.tsx</strong></p>
<pre class="language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>configureStore<span class="token punctuation">,</span> createSlice<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@reduxjs/toolkit'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> DataSlice <span class="token operator">=</span> <span class="token function">createSlice</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  name<span class="token operator">:</span> <span class="token string">'data'</span><span class="token punctuation">,</span>
  initialState<span class="token operator">:</span> <span class="token punctuation">&#123;</span>loggedIn<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> role<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> childProps<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> parentProps<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  reducers<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token function-variable function">setLoggedIn</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      state<span class="token punctuation">.</span>loggedIn <span class="token operator">=</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">setRole</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      state<span class="token punctuation">.</span>role <span class="token operator">=</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">setChildProps</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      state<span class="token punctuation">.</span>childProps <span class="token operator">=</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">setParentProps</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      state<span class="token punctuation">.</span>parentProps <span class="token operator">=</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>setLoggedIn<span class="token punctuation">,</span> setRole<span class="token punctuation">,</span> setChildProps<span class="token punctuation">,</span> setParentProps<span class="token punctuation">&#125;</span> <span class="token operator">=</span>
  DataSlice<span class="token punctuation">.</span>actions<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">configureStore</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  reducer<span class="token operator">:</span> <span class="token punctuation">&#123;</span>data<span class="token operator">:</span> DataSlice<span class="token punctuation">.</span>reducer<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><strong>App.tsx</strong></p>
<pre class="language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>Provider<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'./UI/Child'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">&#123;</span>Store<span class="token punctuation">&#125;</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>View <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>
<p>然后就可以在代码中调用 Store 提供的 setLoggedIn, setRole, setChildProps, setParentProps 这些 action creators 和 dispatch 方法了.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://react-redux.js.org/tutorials/quick-start">https://react-redux.js.org/tutorials/quick-start</a></li>
<li><a href="http://cn.redux.js.org/tutorials/essentials/part-1-overview-concepts">http://cn.redux.js.org/tutorials/essentials/part-1-overview-concepts</a></li>
<li><a href="https://redux-toolkit.js.org/api/createslice">https://redux-toolkit.js.org/api/createslice</a></li>
</ul>
]]></content>
      <tags>
        <tag>React</tag>
      </tags>
  </entry>
  <entry>
    <title>Python asyncio, thread 与 websocket 库初探</title>
    <url>/2021/09/python-asyncio-websocket/</url>
    <content><![CDATA[<p>在写 Nanachat-core 的时候打算写事件循环，还要使用到 websocket，于是想参考下相关的设计模式。</p>
<span id="more"></span>
<h2 id="异步-I-O"><a href="#异步-I-O" class="headerlink" title="异步 I/O"></a>异步 I/O</h2><p>异步IO模型需要一个消息循环，在消息循环中，主线程不断地重复“读取消息-处理消息”这一过程，我们称其为<strong>消息模型</strong>：</p>
<pre class="language-python" data-language="python"><code class="language-python">loop <span class="token operator">=</span> get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    event <span class="token operator">=</span> loop<span class="token punctuation">.</span>get_event<span class="token punctuation">(</span><span class="token punctuation">)</span>
    process_event<span class="token punctuation">(</span>event<span class="token punctuation">)</span></code></pre>
<p>消息模型是如何解决同步IO必须等待IO操作这一问题的呢？</p>
<ul>
<li><p>当遇到IO操作时，代码只负责发出IO请求，不等待IO结果，然后直接结束本轮消息处理，进入下一轮消息处理过程。</p>
</li>
<li><p>当IO操作完成后，将收到一条“IO完成”的消息，处理该消息时就可以直接获取IO操作结果。</p>
</li>
</ul>
<h3 id="Coroutine-协程"><a href="#Coroutine-协程" class="headerlink" title="Coroutine 协程"></a>Coroutine 协程</h3><p>协程看上去也是子程序，但执行过程中，在子程序内部可中断，然后转而执行别的子程序，在适当的时候再返回来接着执行。</p>
<p>注意，在一个子程序中中断，去执行其他子程序，不是函数调用，有点类似CPU的中断。比如子程序A、B：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'z'</span><span class="token punctuation">)</span></code></pre>
<p>And we may get…</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token number">1</span>
<span class="token number">2</span>
x
y
<span class="token number">3</span>
z</code></pre>
<p>协程的执行效率比线程切换高，减少了线程切换的开销；同时，我们也不需要考虑锁机制的问题。</p>
<h4 id="Python-generator"><a href="#Python-generator" class="headerlink" title="Python generator"></a>Python generator</h4><p>Python对协程的支持是通过generator实现的。</p>
<p>在generator中，我们不但可以通过<code>for</code>循环来迭代，还可以不断调用<code>next()</code>函数获取由<code>yield</code>语句返回的下一个值。</p>
<p>但是Python的<code>yield</code>不但可以返回一个值，它还可以接收调用者发出的参数。</p>
<p>我们写一个简单的程序来输出 yield 关键字的执行顺序.</p>
<blockquote>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[CONSUMER] Entering function..."</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[CONSUMER] Entering while loop..."</span><span class="token punctuation">)</span>
        n <span class="token operator">=</span> <span class="token keyword">yield</span> r
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[CONSUMER] Fetched n..."</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> n<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[CONSUMER] Before returning..."</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[CONSUMER] Consuming </span><span class="token interpolation"><span class="token punctuation">&#123;</span>n<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        r <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'Consumed </span><span class="token interpolation"><span class="token punctuation">&#123;</span>n<span class="token punctuation">&#125;</span></span><span class="token string">!'</span></span>
        
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[MAIN] Entering main..."</span><span class="token punctuation">)</span>
c <span class="token operator">=</span> consumer<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Get the generator</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[MAIN] Generating generator object..."</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[MAIN] Starting first send..."</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> c<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[MAIN] Ending first send..."</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[MAIN] First send end with result '</span><span class="token interpolation"><span class="token punctuation">&#123;</span>r<span class="token punctuation">&#125;</span></span><span class="token string">'..."</span></span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[MAIN] Starting second send..."</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> c<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[MAIN] Ending second send..."</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[MAIN] Second send end with result '</span><span class="token interpolation"><span class="token punctuation">&#123;</span>r<span class="token punctuation">&#125;</span></span><span class="token string">'..."</span></span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[MAIN] Starting last send..."</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> c<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[MAIN] Ending last send..."</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[MAIN] Last send end with result '</span><span class="token interpolation"><span class="token punctuation">&#123;</span>r<span class="token punctuation">&#125;</span></span><span class="token string">'..."</span></span><span class="token punctuation">)</span></code></pre>
</blockquote>
<p>输出结果为：</p>
<blockquote>
<pre class="language-none"><code class="language-none">[MAIN] Entering main...
[MAIN] Generating generator object...       
[MAIN] Starting first send...
[CONSUMER] Entering function...
[CONSUMER] Entering while loop...
[MAIN] Ending first send...
[MAIN] First send end with result &#39;&#39;...     
[MAIN] Starting second send...
[CONSUMER] Fetched n...
[CONSUMER] Consuming 2
[CONSUMER] Entering while loop...
[MAIN] Ending second send...
[MAIN] Second send end with result &#39;Consumed 2!&#39;...
[MAIN] Starting last send...
[CONSUMER] Fetched n...
[CONSUMER] Before returning...
Traceback (most recent call last):
  File &quot;coroutine.py&quot;, line 26, in &lt;module&gt; 
    r &#x3D; c.send(None)
StopIteration</code></pre>
</blockquote>
<p>可以看到，在第一次执行 <code>generator.send()</code> 的时候，generator 会从头开始执行.</p>
<p>之后每次便从 yield 处开始执行，先完成赋值操作，再继续执行到下一次 yield 或者 return.</p>
<p><code>yield r</code> 会把 r 作为 <code>send()</code> 函数的返回值返回给 MAIN 函数.</p>
<h3 id="asyncio"><a href="#asyncio" class="headerlink" title="asyncio"></a>asyncio</h3><p>An <strong>event loop</strong> runs in a thread (typically the main thread) and executes all callbacks and Tasks in its thread. </p>
<p>While a <strong>Task</strong> is running in the <strong>event loop</strong>, no other Tasks can run in the same thread. </p>
<p>When a <strong>Task</strong> executes an <code>await</code> expression, the running <strong>Task</strong> gets suspended, and the event loop executes the next Task.</p>
<p><code>asyncio</code>的编程模型就是一个消息循环。</p>
<p>我们从<code>asyncio</code>模块中直接获取一个<code>EventLoop</code>的引用，然后把需要执行的协程扔到<code>EventLoop</code>中执行，就实现了异步IO。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> datetime
<span class="token keyword">import</span> asyncio


<span class="token decorator annotation punctuation">@asyncio<span class="token punctuation">.</span>coroutine</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Hello world! </span><span class="token interpolation"><span class="token punctuation">&#123;</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token comment"># 异步调用asyncio.sleep(1):</span>
    r <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Hello again! </span><span class="token interpolation"><span class="token punctuation">&#123;</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


<span class="token comment"># 获取EventLoop:</span>
loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 执行coroutine</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<pre class="language-none"><code class="language-none">coroutine.py:6: DeprecationWarning: &quot;@coroutine&quot; decorator is deprecated since Python 3.8, use &quot;async def&quot; instead
  def hello():
&lt;generator object hello at 0x7f05bea44cf0&gt;
Hello world! 2021-09-06 11:20:07.045310   
Hello again! 2021-09-06 11:20:08.047006</code></pre>
<p><code>yield from</code>语法可以让我们方便地调用另一个<code>generator</code>.</p>
<h3 id="async-await"><a href="#async-await" class="headerlink" title="async/await"></a>async/await</h3><p>为了简化并更好地标识异步IO，从Python 3.5开始引入了新的语法<code>async</code>和<code>await</code>，可以让coroutine的代码更简洁易读。</p>
<p>请注意，<code>async</code>和<code>await</code>是针对coroutine的新语法，要使用新的语法，只需要做两步简单的替换：</p>
<ol>
<li>把<code>@asyncio.coroutine</code>替换为<code>async</code>；</li>
<li>把<code>yield from</code>替换为<code>await</code>。</li>
</ol>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> datetime
<span class="token keyword">import</span> asyncio


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Hello world! </span><span class="token interpolation"><span class="token punctuation">&#123;</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token comment"># 异步调用asyncio.sleep(1):</span>
    r <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Hello again! </span><span class="token interpolation"><span class="token punctuation">&#123;</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


<span class="token comment"># 获取EventLoop:</span>
loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 执行coroutine</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<pre class="language-none"><code class="language-none">Hello world! 2021-09-06 11:23:14.967038
Hello again! 2021-09-06 11:23:15.968643</code></pre>
<h2 id="Websocket"><a href="#Websocket" class="headerlink" title="Websocket"></a>Websocket</h2><h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># WS server example</span>

<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> websockets

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"&lt; </span><span class="token interpolation"><span class="token punctuation">&#123;</span>name<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    greeting <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Hello </span><span class="token interpolation"><span class="token punctuation">&#123;</span>name<span class="token punctuation">&#125;</span></span><span class="token string">!"</span></span>

    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>greeting<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>greeting<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

start_server <span class="token operator">=</span> websockets<span class="token punctuation">.</span>serve<span class="token punctuation">(</span>hello<span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">8765</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>start_server<span class="token punctuation">)</span>
asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><pre class="language-Client" data-language="Client"><code class="language-Client"># WS client example

import asyncio
import websockets

async def hello():
    uri &#x3D; &quot;ws:&#x2F;&#x2F;localhost:8765&quot;
    async with websockets.connect(uri) as websocket:
        name &#x3D; input(&quot;What&#39;s your name? &quot;)

        await websocket.send(name)
        print(f&quot;&gt; &#123;name&#125;&quot;)

        greeting &#x3D; await websocket.recv()
        print(f&quot;&lt; &#123;greeting&#125;&quot;)

asyncio.get_event_loop().run_until_complete(hello())</code></pre>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>我们要实现具有以下功能的 websocket 结构.</p>
<ul>
<li>Server<ul>
<li>每 3s 向 Client 发一条消息.</li>
<li>收到消息立刻 Prompt.</li>
</ul>
</li>
<li>Client<ul>
<li>每 1s 向 Server 发一条消息.</li>
<li>收到消息立刻 Prompt.</li>
</ul>
</li>
</ul>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Server.py</span>
<span class="token comment">#!/usr/bin/env python</span>

<span class="token comment"># WS server example</span>
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> websockets


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">recv</span><span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"&lt; </span><span class="token interpolation"><span class="token punctuation">&#123;</span>name<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment"># Send</span>
        msg <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"!Server Send! </span><span class="token interpolation"><span class="token punctuation">&#123;</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>msg<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">socket</span><span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>recv<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">,</span> send<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">)</span>
        

start_server <span class="token operator">=</span> websockets<span class="token punctuation">.</span>serve<span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">8765</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>start_server<span class="token punctuation">)</span>
asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Client.py</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> websockets

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">recv</span><span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"&lt; </span><span class="token interpolation"><span class="token punctuation">&#123;</span>name<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment"># Send</span>
        msg <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"!Client Send! </span><span class="token interpolation"><span class="token punctuation">&#123;</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>msg<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    uri <span class="token operator">=</span> <span class="token string">"ws://localhost:8765"</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> websockets<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>uri<span class="token punctuation">)</span> <span class="token keyword">as</span> websocket<span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>recv<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">,</span> send<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">sayhello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"INTER BREAK"</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sayhello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://docs.python.org/3/library/asyncio-dev.html">https://docs.python.org/3/library/asyncio-dev.html</a></li>
<li><p><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017970488768640">https://www.liaoxuefeng.com/wiki/1016959663602400/1017970488768640</a></p>
</li>
<li><p><a href="https://realpython.com/async-io-python/">https://realpython.com/async-io-python/</a></p>
</li>
<li><a href="https://websockets.readthedocs.io/en/stable/intro.html">https://websockets.readthedocs.io/en/stable/intro.html</a></li>
</ul>
]]></content>
      <tags>
        <tag>多线程</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>React-Native Android App 开发手记</title>
    <url>/2021/08/react-native-record/</url>
    <content><![CDATA[<p>是这样的，简而言之，有口大锅，让我背着。</p>
<p><s>在小学期两周速成 Android App 开发什么的，这合理嘛.</s></p>
<p>这恒河里.</p>
<p>于是这篇文章就完全是记录性质的，可能最后会根据 咕的情况 &amp;&amp; 是否便于整理成学习笔记 这两个因素决定要不要再水一篇指北。</p>
<p>咕咕咕。</p>
<span id="more"></span>
<h1 id="8-13"><a href="#8-13" class="headerlink" title="8.13"></a>8.13</h1><ul>
<li>下午 23：00</li>
</ul>
<p>开会，定App方案。第二天七夕节，大晚上还定方案。离谱（</p>
<p>实践视频改稿，等风扇转到晚上 03:00，终于能入睡，咕咕咕，啥都没干</p>
<h1 id="8-14"><a href="#8-14" class="headerlink" title="8.14"></a>8.14</h1><ul>
<li>凌晨 10:00</li>
</ul>
<p>装模作样地打开了<a href="https://reactnative.dev/">https://reactnative.dev/</a>.</p>
<p><s>明明后端更好写吧 为什么要在前端耗着</s></p>
<p>看了配置说明 感觉好麻烦x</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p><strong>什么是 React Native？</strong></p>
<p><code>React Native</code>是使用 React 来构建 Android 和 iOS 应用的开源社区框架。也就是说，我们使用 Javascript 来实现应用的主要界面和功能。</p>
<p><strong>Views</strong>: Just like ReactElement，或是 Web 开发中的一个<code>&lt;div&gt;</code>块，有层级结构</p>
<p><strong>核心组件</strong>(Core Components)与<strong>本地组件</strong>(Native Components)</p>
<p><img src="https://i.loli.net/2021/08/14/RSQOvdVLxl7fpt9.png" alt="image-20210814120050939"></p>
<p>如何理解？核心组件在两个平台上都能正常显示，本地组件只能显示在特定平台上。</p>
<ul>
<li>中午 16:40</li>
</ul>
<p>不行 不能咕咕咕了 干活干活</p>
<p>今天要不把开发环境给配置好 c7w 就是爬爬怪</p>
<h2 id="Setting-up-the-development-environment-开发环境配置"><a href="#Setting-up-the-development-environment-开发环境配置" class="headerlink" title="Setting up the development environment 开发环境配置"></a>Setting up the development environment 开发环境配置</h2><p>这里我们介绍 <code>Development OS=Linux headless(WSL), TargetOS=Android</code> 的环境配置方法。</p>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><ul>
<li>Node (12+)</li>
<li>JDK (8+)</li>
</ul>
<p>首先可以使用 <code>java -version</code> 查看是否已成功安装 java.</p>
<p>查看结果后，如果没有成功安装，我们可以运行 <code>apt install</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openjdk-11-jre-headless</code></pre>
<p>然后我们再运行查看版本:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">c7w@cc7w  /mnt/e/Project  java -version
openjdk version <span class="token string">"11.0.11"</span> <span class="token number">2021</span>-04-20
OpenJDK Runtime Environment <span class="token punctuation">(</span>build <span class="token number">11.0</span>.11+9-Ubuntu-0ubuntu2.20.04<span class="token punctuation">)</span>
OpenJDK <span class="token number">64</span>-Bit Server VM <span class="token punctuation">(</span>build <span class="token number">11.0</span>.11+9-Ubuntu-0ubuntu2.20.04, mixed mode, sharing<span class="token punctuation">)</span></code></pre>
<ul>
<li>Android SDK</li>
</ul>
<blockquote>
<p>什么是 SDK？</p>
<p>A software development kit (SDK) is a collection of software development tools in one installable package. They facilitate the creation of applications by having a compiler, debugger and perhaps a software framework. They are normally specific to a hardware platform and operating system combination. (Excerpted from Wikipedia)</p>
</blockquote>
<p>由于我们要开发 Android App，所以显然我们是需要 Android SDK的.</p>
<p>SDK的安装参考了这里.</p>
<p><a href="https://gist.github.com/steveclarke/d988d89e8cdf51a8a5766d69ecb07e7b">https://gist.github.com/steveclarke/d988d89e8cdf51a8a5766d69ecb07e7b</a></p>
<h2 id="创建新应用"><a href="#创建新应用" class="headerlink" title="创建新应用"></a>创建新应用</h2><p>新建文件夹，然后运行<code>npx react-native init AwesomeProject</code>. 简单易用.</p>
<p>要想使用 Typescript，我们可以运行<code>npx react-native init AwesomeTSProject --template react-native-template-typescript</code>.</p>
<p>然后我们就能打开喜闻乐见的编辑器.</p>
<p><img src="https://i.loli.net/2021/08/14/SbQTErNlz3qky5G.png" alt="image-20210814170452919"></p>
<p>然后什么都不管先运行了一波 <code>yarn android</code>.</p>
<p>然后项目会帮我们安装 gradle.</p>
<p>然后我们需要设置 在<code>local.properties</code> 中 <code>sdk.dir=/home/c7w/Android</code></p>
<p>然后这时再 <code>yarn android</code> 便可以成功. 但由于没有emulation env 我们仍没有完成调试的配置，<s>所以我们直接快进到打包发布</s></p>
<h2 id="打包发布"><a href="#打包发布" class="headerlink" title="打包发布"></a>打包发布</h2><p><a href="https://reactnative.cn/docs/signed-apk-androidhttps://reactnative.cn/docs/signed-apk-android">https://reactnative.cn/docs/signed-apk-androidhttps://reactnative.cn/docs/signed-apk-android</a></p>
<p><s>饿饿 饭饭</s></p>
<ul>
<li>下午 19:00</li>
</ul>
<h3 id="初次配置：设置签名"><a href="#初次配置：设置签名" class="headerlink" title="初次配置：设置签名"></a>初次配置：设置签名</h3><pre class="language-bash" data-language="bash"><code class="language-bash">keytool -genkeypair -v -storetype PKCS12 -keystore my-release-key.keystore -alias my-key-alias -keyalg RSA -keysize <span class="token number">2048</span> -validity <span class="token number">1000</span></code></pre>
<p>这条命令会要求你输入密钥库（keystore）和对应密钥的密码，然后设置一些发行相关的信息。最后它会生成一个叫做<code>my-release-key.keystore</code>的密钥库文件。</p>
<p>在运行上面这条语句之后，密钥库里应该已经生成了一个单独的密钥，有效期为 1000 天。—alias 参数后面的别名是你将来为应用签名时所需要用到的，所以记得记录这个别名。</p>
<p>然后，我们需要配置 gradle 变量.</p>
<ol>
<li>把<code>my-release-key.keystore</code>文件放到工程中的<code>android/app</code>文件夹下。</li>
<li>编辑<code>项目目录/android/gradle.properties</code>。如果没有<code>gradle.properties</code>文件你就自己创建一个，添加如下的代码（注意把其中的<code>****</code>替换为相应密码）</li>
</ol>
<pre class="language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">MYAPP_RELEASE_STORE_FILE</span><span class="token punctuation">=</span><span class="token attr-value">my-release-key.keystore</span>
<span class="token attr-name">MYAPP_RELEASE_KEY_ALIAS</span><span class="token punctuation">=</span><span class="token attr-value">my-key-alias</span>
<span class="token attr-name">MYAPP_RELEASE_STORE_PASSWORD</span><span class="token punctuation">=</span><span class="token attr-value">*****</span>
<span class="token attr-name">MYAPP_RELEASE_KEY_PASSWORD</span><span class="token punctuation">=</span><span class="token attr-value">*****</span></code></pre>
<h3 id="生成-APK"><a href="#生成-APK" class="headerlink" title="生成 APK"></a>生成 APK</h3><blockquote>
<p>What is <strong>APK</strong>?</p>
<p>Android Package (APK) is the Android <strong>application package</strong> file format used by the Android operating system, and a number of other Android-based operating systems for distribution and installation of mobile apps, mobile games and middleware.</p>
<p>(Excerpted from Wikipedia)</p>
</blockquote>
<p>只需在终端中运行以下命令：</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">cd android
.&#x2F;gradlew assembleRelease</code></pre>
<p>生成的 APK 文件位于<code>android/app/build/outputs/apk/release/app-release.apk</code>，它已经可以用来发布了。</p>
<p><strong>启用 Proguard 来减少 apk 的大小</strong></p>
<p>Proguard 是一个 Java 字节码混淆压缩工具，它可以移除掉 React Native Java（和它的依赖库中）中没有被使用到的部分，最终有效的减少 APK 的大小。</p>
<p>要启用 Proguard，修改<code>android/app/build.gradle</code>文件：</p>
<pre class="language-gradle" data-language="gradle"><code class="language-gradle">&#x2F;** 
* Run Proguard to shrink the Java bytecode in release builds. *&#x2F;
def enableProguardInReleaseBuilds &#x3D; true</code></pre>
<h2 id="碎碎念"><a href="#碎碎念" class="headerlink" title="碎碎念"></a>碎碎念</h2><blockquote>
<p>Dev on Windows with WSL</p>
<p>在 Windows 上用 WSL 优雅开发</p>
<p><a href="https://dowww.spencerwoo.com/">https://dowww.spencerwoo.com/</a> 看了这个Doc网站</p>
<p>感觉对USB调试有效.</p>
<p>是时候该升级成wsl2了.</p>
<p><a href="https://xwsoul.com/posts/199">https://xwsoul.com/posts/199</a></p>
<p>感觉似乎可行.</p>
<p>总比每次先build然后传到手机上调试好吧.</p>
<p>这就干.</p>
<p>准备水另一篇文章.</p>
</blockquote>
<h1 id="8-15"><a href="#8-15" class="headerlink" title="8.15"></a>8.15</h1><h2 id="Android-Debugging"><a href="#Android-Debugging" class="headerlink" title="Android Debugging"></a>Android Debugging</h2><h3 id="ADB-的使用"><a href="#ADB-的使用" class="headerlink" title="ADB 的使用"></a>ADB 的使用</h3><blockquote>
<p>What is <strong>ADB</strong>?</p>
<p>Android Debug Bridge (adb) is a versatile command-line tool that lets you communicate with a device. (Excerpted from developer.android.com)</p>
</blockquote>
<p>在 Windows 上下载：<a href="https://developer.android.com/studio/releases/platform-tools">https://developer.android.com/studio/releases/platform-tools</a></p>
<p>下载好直接就能用.</p>
<p>使用方法：</p>
<ul>
<li>在 Windows 上先 <code>adb devices</code> 查看可用设备列表，确保配置好 USB 调试.</li>
<li>在 Windows 上使用 <code>adb tcpip &lt;port&gt;</code> 为设备开启 tcpip 端口.</li>
<li>在 WSL 上使用 <code>abd connect &lt;Device IP&gt;:&lt;port&gt;</code> 连接该端口.</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash">c7w@cc7w  ~/Android/platform-tools  ./adb devices
List of devices attached
<span class="token number">183.172</span>.***.***:5556    device</code></pre>
<p>配置完成.</p>
<p>但是死活连接不上去，目测是辣鸡 Tsinghua-Secure 会吃掉连接.</p>
<p>从中厅把路由器拿来装好. Peking-Secure 也不行.</p>
<p>在 Windows 和 WSL 之间的通信总是会出问题.</p>
<p><s>需要把 WSL 的 IP 也纳入到 Peking-Secure 下才行，但是解决不了.</s></p>
<p>大恼，决定把整个开发环境从 WSL 里面搬出来，换成 Windows.</p>
<ul>
<li>下午 20:00</li>
</ul>
<p>整个 Windows 的环境配置完成了. 也成功在 Debug 专用板砖上输出了 Hello React Native.</p>
<ul>
<li>下午 23:00</li>
</ul>
<p>画了一个简单的登录界面. 睡大觉.</p>
<h1 id="8-16"><a href="#8-16" class="headerlink" title="8.16"></a>8.16</h1><ul>
<li>半夜 8:00</li>
</ul>
<p>舍友早九 不得已被迫起床，开始干活.</p>
<p>先从方舟挂机开始（大嘘</p>
<p><img src="https://i.loli.net/2021/08/16/xUu1hqgyZ5PrDjN.png" alt="image-20210816093146543"></p>
<p>安装 React-Native-Navigator 之后没有<code>yarn android</code> ，狂按R按了半小时，还搁那搜索为什么报错.</p>
<p>安装依赖后一定要重新 Build 一遍发到手机上再开 Debugger.</p>
<p><a href="https://reactnavigation.org/docs/navigating">https://reactnavigation.org/docs/navigating</a></p>
<h1 id="8-21-amp-8-22"><a href="#8-21-amp-8-22" class="headerlink" title="8.21 &amp; 8.22"></a>8.21 &amp; 8.22</h1><p>画前端。装了什么 icons navigator 之类的包。还在研究怎么用。</p>
<h1 id="8-23"><a href="#8-23" class="headerlink" title="8.23"></a>8.23</h1><p>做跳转。打算先从 redux 的教程写起。</p>
<h1 id="8-24"><a href="#8-24" class="headerlink" title="8.24"></a>8.24</h1><p>后端 deploy 好了。这下大鱼摸不成了。</p>
<p>写前端。把请求加进去.</p>
<p>被队友痛击.</p>
<p>前端 狗都不写.</p>
<p>逻辑十分不清晰. 感觉需要重构.</p>
<p>但是就这么一个破 App 似乎没有重构的必要.</p>
<p><em>TO BE CONTINUED</em></p>
]]></content>
      <tags>
        <tag>React</tag>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>三角函数的正整数幂的不定积分</title>
    <url>/2020/11/simple-triangular-indefinite-integral/</url>
    <content><![CDATA[<p>啊说真的排版好麻烦明天再来调吧</p>
<h2 id="Knowledge-Base"><a href="#Knowledge-Base" class="headerlink" title="Knowledge Base"></a>Knowledge Base</h2><ul>
<li>换元法（凑微分法）</li>
</ul>
<script type="math/tex; mode=display">
\int f'(\phi(x))\phi'(x)dx = \int f'(\phi(x))d\phi(x) = f(\phi(x))+C</script><script type="math/tex; mode=display">
\int f'(u)du = \int f'(\phi(x)) \phi'(x)dx = g(x)+C = g(\phi^{-1} (x))+C</script><ul>
<li>分部积分法</li>
</ul>
<h2 id="关于三角函数的幂的积分"><a href="#关于三角函数的幂的积分" class="headerlink" title="关于三角函数的幂的积分"></a>关于三角函数的幂的积分</h2><h3 id="sin-或-cos-的幂"><a href="#sin-或-cos-的幂" class="headerlink" title="sin 或 cos 的幂"></a>sin 或 cos 的幂</h3><p>若指数中存在奇数：</p>
<script type="math/tex; mode=display">
\int \cos^7x \sin^{10}xdx</script><ol>
<li>选定 cos 与 sin 中次幂较低，且为奇数的一个，使用凑微分法</li>
<li>使用公式 $sin^2x+cos^2x=1$ 替换掉剩下的项</li>
</ol>
<p><em>Solve:</em></p>
<script type="math/tex; mode=display">
\begin{aligned}
&\int \cos ^{7} x \sin ^{10} x d x \\
&=\int \cos ^{6} x \sin ^{10} x d \sin x \\
&=\int\left(1-\sin ^{2} x\right)^{3} \sin ^{10} x d \sin x \\
(t &=\sin x) \\
&= \int\left(1-3 t^{2}+3 t^{4}-t^{6}\right) t^{10} d t \\
&=\int\left(t^{10}-3 t^{12}+3 t^{14}-t^{16}\right) d t \\
&=\frac {t^{11}} {11}-\frac{3}{13} t^{13}+\frac{3}{15} t^{15}-\frac{1}{17} t^{17}+C \\
&=\frac{1}{11} \sin ^{11} x-\frac{3}{13} \sin ^{2} x+\frac{1}{5} \sin ^{10} x-\frac{1}{17} \sin ^{17} x+C
\end{aligned}</script><p>若指数中不存在奇数：</p>
<script type="math/tex; mode=display">
\quad \int \cos ^{2} x \sin ^{4} x d x</script><ol>
<li>使用二倍角公式</li>
<li>展开后分别积分</li>
</ol>
<p><em>Solve:</em></p>
<p>$\quad \int \cos ^{2} x \sin ^{4} x d x=\int \frac{1+\cos 2 x}{2} \frac{\left(1-\cos ^{2} x\right)^{2}}{4} d x$<br>$=\frac{1}{8} \int\left(\cos ^{2} 2 x-2 \cos 2 x+1\right)(1+\cos 2 x) d x$<br>$=\frac{1}{8} \int\left(\cos ^{3} 2 x-\cos ^{2} 2 x-\cos 2 x+1\right) d x$<br>$=\frac{1}{8} \int \cos ^{3} 2 x d x-\frac{1}{8} \int \cos ^{2} 2 x d x-\frac{1}{8} \int \cos 2 x d x+\frac{1}{8} \int d x$<br>$=\frac{1}{8} \cdot \frac{1}{2} \int \cos ^{2} 2x d \sin 2 x-\frac{1}{8} \int \frac{1+\cos 4 x}{2} d x-\frac{1}{8} \cdot \frac{1}{2} \sin 2 x+\frac{1}{8} x+C<br>$</p>
<p>$=\frac{1}{16} \int d \sin 2 x-\frac{1}{16} \int \sin ^{2} 2 x d \sin 2 x-\frac{1}{16} x-\frac{1}{16} \cdot \frac{1}{4} \sin 4 x-\frac{1}{16} \sin 2 x+\frac{1}{8} x+C$</p>
<p>$=\frac{x}{16}-\frac{\sin^32x}{48}-\frac{\sin4x}{64}+C$</p>
<h3 id="tan-与-cot-的幂"><a href="#tan-与-cot-的幂" class="headerlink" title="tan 与 cot 的幂"></a>tan 与 cot 的幂</h3><script type="math/tex; mode=display">
\int \tan ^{4} x d x</script><p>使用公式 $ \tan ^{2} x=\sec ^{2} x-1 $</p>
<script type="math/tex; mode=display">
\begin{array}{l}
\int \tan ^{0} x d x=\int d x=x+C \\
\int \tan ^{1} x d x=\int \frac{\sin x}{\cos x} d x=-\int \frac{1}{\cos x} d \cos x=-\ln |\cos x|+C \\
\qquad=\ln |\sec x|+C \\
\end{array}</script><script type="math/tex; mode=display">
\begin{aligned}
I_{n} &=\int \tan ^{n} x d x \\
&=\int \tan ^{n-2} x \tan ^{2} x d x \\
&=\int \tan ^{n-2} x\left(\sec ^{2} x-1\right) d x \\
&=\int \tan ^{n-2} x \sec ^{2} x d x-\int \tan ^{n-2} x d x \\
&=\int \tan ^{n-2} x d \tan x-\int \tan ^{n-2} x d x \\
&=\frac{1}{n-1} \cdot \tan ^{n-1} x-I_{n-2}
\end{aligned}</script><p><em>Solve:</em></p>
<script type="math/tex; mode=display">
\begin{aligned}
\int \tan ^{4} x d x &=\int \tan ^{2} x\left(\sec ^{2} x-1\right) d x \\
&=\int \tan ^{2} x \sec ^{2} x d x-\int \tan ^{2} x d x \\
&=\frac{1}{3} \tan ^{3} x-\int \sec ^{2} x d x+\int d x \\
&=\frac{1}{3} \tan ^{3} x-\tan x+x+C
\end{aligned}</script><p>cot 的幂读者自证不难.</p>
<h3 id="sec-与-csc-的幂"><a href="#sec-与-csc-的幂" class="headerlink" title="sec 与 csc 的幂"></a>sec 与 csc 的幂</h3><script type="math/tex; mode=display">
\begin{aligned}
\int \sec x d x &=\int \frac{(\sec x)(\sec x+\tan x)}{\sec x+\tan x} d x \\
&=\int \frac{\sec x \tan x+\sec ^{2} x}{\sec x+\tan x} d x \\
&=\ln |\sec x+\tan x|+C \\
\int \sec ^{2} x d x &=\tan x+C
\end{aligned}</script><script type="math/tex; mode=display">
\begin{aligned}
\int \sec ^{n} x d x &=\int \sec ^{n-2} x \sec ^{2} x d x \\
&=\int \sec ^{n-2} x d \tan x \\
&=\sec ^{n-2} x \tan x-\int \tan x(n-2) \sec ^{n-3} x \sec x \tan x d x \\
&=\sec ^{n-2} \tan x-(n-2) \int \sec ^{n-2} x \tan ^{2} x d x \\
&=\sec ^{n-2} x \tan x-(n-2) \int \sec ^{n-2} x\left(\sec ^{2} x-1\right) d x \\
&=\sec ^{n-2} x \tan x-(n-2) \int \sec ^{n} x d x+(n-2) \int \sec ^{n-2} x d x \\
\end{aligned}</script><p>因此我们有：</p>
<script type="math/tex; mode=display">
\int \sec ^{n} x d x=\frac{1}{n-1} \sec ^{n-2} x \tan x+\frac{n-2}{n-1} \int \sec ^{n-2} x d x</script><p>csc 的幂同理显然.</p>
]]></content>
      <tags>
        <tag>Calculus</tag>
      </tags>
  </entry>
  <entry>
    <title>Python Numpy + Matplotlib 再探</title>
    <url>/2021/08/python-numpy-matplotlib/</url>
    <content><![CDATA[<p>为什么是再探？因为之前咕了不知道多少次了，看了忘忘了看.</p>
<span id="more"></span>
<h2 id="Numpy"><a href="#Numpy" class="headerlink" title="Numpy"></a>Numpy</h2><h3 id="ndarray"><a href="#ndarray" class="headerlink" title="ndarray"></a>ndarray</h3><ul>
<li>NumPy’s array class is called <code>ndarray</code>. It is also known by the alias <code>array</code>. </li>
</ul>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

li <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>li<span class="token punctuation">.</span>ndim<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>li<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>li<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<pre class="language-none"><code class="language-none">[[ 0  1  2  3  4]
 [ 5  6  7  8  9]
 [10 11 12 13 14]
 [15 16 17 18 19]]
2
int64
20
&lt;class &#39;numpy.ndarray&#39;&gt;</code></pre>
<ul>
<li><code>arange(lower_bound, upper_bound, step)</code>, <code>zeros</code>, <code>ones</code>, <code>linspace(lo,hi,count)</code></li>
</ul>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> math
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

x <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>pi<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span></code></pre>
<pre class="language-none"><code class="language-none">[0.         0.6981317  1.3962634  2.0943951  2.7925268  3.4906585
 4.1887902  4.88692191 5.58505361 6.28318531]
 
[ 0.00000000e+00  6.42787610e-01  9.84807753e-01  8.66025404e-01      
  3.42020143e-01 -3.42020143e-01 -8.66025404e-01 -9.84807753e-01
 -6.42787610e-01 -2.44929360e-16]</code></pre>
<ul>
<li><code>reshape()</code></li>
</ul>
<h3 id="Basic-operations"><a href="#Basic-operations" class="headerlink" title="Basic operations"></a>Basic operations</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

a <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token operator">/</span>b<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token operator">*</span>b<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>

c <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
d <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>c@d<span class="token punctuation">)</span></code></pre>
<pre class="language-none"><code class="language-none">[10 20 30 40 50]
[1 2 3 4 5]
[11 22 33 44 55]
[10. 10. 10. 10. 10.]
[ 1  4  9 16 25]
[ True  True False False False]
[ 10  40  90 160 250]
550
[[19 22]
 [43 50]]</code></pre>
<ul>
<li><code>exp()</code> …</li>
</ul>
<h3 id="Indexing-and-Slicing"><a href="#Indexing-and-Slicing" class="headerlink" title="Indexing and Slicing"></a>Indexing and Slicing</h3><ul>
<li><strong>One-dimensional</strong> arrays can be indexed, sliced and iterated over, much like <a href="https://docs.python.org/tutorial/introduction.html#lists">lists</a> and other Python sequences.</li>
<li><strong>Multidimensional</strong> arrays can have one index per axis. These indices are given in a tuple separated by commas.</li>
<li>The <strong>dots</strong> (<code>...</code>) represent as many colons as needed to produce a complete indexing tuple. For example, if <code>x</code> is an array with 5 axes, then<ul>
<li><code>x[1, 2, ...]</code> is equivalent to <code>x[1, 2, :, :, :]</code>,</li>
<li><code>x[..., 3]</code> to <code>x[:, :, :, :, 3]</code> and</li>
<li><code>x[4, ..., 5, :]</code> to <code>x[4, :, :, 5, :]</code>.</li>
</ul>
</li>
</ul>
<h3 id="Iterating"><a href="#Iterating" class="headerlink" title="Iterating"></a>Iterating</h3><ul>
<li><strong>Iterating</strong> over multidimensional arrays is done with respect to the first axis.</li>
<li>But you can use <code>.flat</code> attribute which could serve as an iterator to iterate over all the elements over the array.</li>
</ul>
<h2 id="Matplotlib"><a href="#Matplotlib" class="headerlink" title="Matplotlib"></a>Matplotlib</h2><h3 id="Goals"><a href="#Goals" class="headerlink" title="Goals"></a>Goals</h3><ul>
<li><p>画不同图像</p>
<ul>
<li>散点图、折线图</li>
<li>饼图 </li>
<li>柱状图 </li>
</ul>
</li>
<li><p>更改表格的 style</p>
</li>
<li>子图</li>
</ul>
<h3 id="图像的绘制"><a href="#图像的绘制" class="headerlink" title="图像的绘制"></a>图像的绘制</h3><h4 id="散点图与折线图"><a href="#散点图与折线图" class="headerlink" title="散点图与折线图"></a>散点图与折线图</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> math

x <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>math<span class="token punctuation">.</span>pi<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">"1.png"</span><span class="token punctuation">)</span></code></pre>
<p><img src="https://i.loli.net/2021/08/30/T8Pj3ICZ64o1NQx.png" alt="1"></p>
<p>And when we changed 5 points to 500…</p>
<p><img src="https://i.loli.net/2021/08/30/FJ5qG7nApHutmET.png" alt="1"></p>
<h5 id="Markers-and-line-styles"><a href="#Markers-and-line-styles" class="headerlink" title="Markers and line styles"></a>Markers and line styles</h5><p><strong>Markers</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>character</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&#39;.&#39;</code></td>
<td>point marker</td>
</tr>
<tr>
<td><code>&#39;,&#39;</code></td>
<td>pixel marker</td>
</tr>
<tr>
<td><code>&#39;o&#39;</code></td>
<td>circle marker</td>
</tr>
<tr>
<td><code>&#39;v&#39;</code></td>
<td>triangle_down marker</td>
</tr>
<tr>
<td><code>&#39;^&#39;</code></td>
<td>triangle_up marker</td>
</tr>
<tr>
<td><code>&#39;&lt;&#39;</code></td>
<td>triangle_left marker</td>
</tr>
<tr>
<td><code>&#39;&gt;&#39;</code></td>
<td>triangle_right marker</td>
</tr>
<tr>
<td><code>&#39;1&#39;</code></td>
<td>tri_down marker</td>
</tr>
<tr>
<td><code>&#39;2&#39;</code></td>
<td>tri_up marker</td>
</tr>
<tr>
<td><code>&#39;3&#39;</code></td>
<td>tri_left marker</td>
</tr>
<tr>
<td><code>&#39;4&#39;</code></td>
<td>tri_right marker</td>
</tr>
<tr>
<td><code>&#39;8&#39;</code></td>
<td>octagon marker</td>
</tr>
<tr>
<td><code>&#39;s&#39;</code></td>
<td>square marker</td>
</tr>
<tr>
<td><code>&#39;p&#39;</code></td>
<td>pentagon marker</td>
</tr>
<tr>
<td><code>&#39;P&#39;</code></td>
<td>plus (filled) marker</td>
</tr>
<tr>
<td><code>&#39;*&#39;</code></td>
<td>star marker</td>
</tr>
<tr>
<td><code>&#39;h&#39;</code></td>
<td>hexagon1 marker</td>
</tr>
<tr>
<td><code>&#39;H&#39;</code></td>
<td>hexagon2 marker</td>
</tr>
<tr>
<td><code>&#39;+&#39;</code></td>
<td>plus marker</td>
</tr>
<tr>
<td><code>&#39;x&#39;</code></td>
<td>x marker</td>
</tr>
<tr>
<td><code>&#39;X&#39;</code></td>
<td>x (filled) marker</td>
</tr>
<tr>
<td><code>&#39;D&#39;</code></td>
<td>diamond marker</td>
</tr>
<tr>
<td><code>&#39;d&#39;</code></td>
<td>thin_diamond marker</td>
</tr>
<tr>
<td><img src="https://i.loli.net/2021/09/03/fa3MXH4lvBU6jq7.png" alt="image-20210903222651862"></td>
<td>vline marker</td>
</tr>
<tr>
<td><code>&#39;_&#39;</code></td>
<td>hline marker</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>Example</li>
</ul>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> math

x <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>math<span class="token punctuation">.</span>pi<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">"1.png"</span><span class="token punctuation">)</span></code></pre>
<p><img src="https://i.loli.net/2021/08/30/hkl36mb9unPYUtE.png" alt="1"></p>
<p><strong>Line styles</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>character</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&#39;-&#39;</code></td>
<td>solid line style</td>
</tr>
<tr>
<td><code>&#39;--&#39;</code></td>
<td>dashed line style</td>
</tr>
<tr>
<td><code>&#39;-.&#39;</code></td>
<td>dash-dot line style</td>
</tr>
<tr>
<td><code>&#39;:&#39;</code></td>
<td>dotted line style</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>Example</li>
</ul>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> math

x <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>math<span class="token punctuation">.</span>pi<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">'s-'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">"1.png"</span><span class="token punctuation">)</span></code></pre>
<p><img src="https://i.loli.net/2021/08/30/mI6pTX2EBwclnOr.png" alt="1"></p>
<h4 id="饼图"><a href="#饼图" class="headerlink" title="饼图"></a>饼图</h4><p><code>pyplot.pie(x, explode=None, labels=None, colors=None, autopct=None, pctdistance=0.6, shadow=False, labeldistance=1.1, startangle=0, radius=1, counterclock=True, wedgeprops=None, textprops=None, center=0, 0, frame=False, rotatelabels=False, *, normalize=None, data=None)[source]</code></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> math

x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"CA"</span><span class="token punctuation">,</span> <span class="token string">"LA"</span><span class="token punctuation">,</span> <span class="token string">"FOP"</span><span class="token punctuation">,</span> <span class="token string">"DM"</span><span class="token punctuation">]</span>
y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span>

plt<span class="token punctuation">.</span>pie<span class="token punctuation">(</span>y<span class="token punctuation">,</span> labels<span class="token operator">=</span>x<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">"1.png"</span><span class="token punctuation">)</span></code></pre>
<p><img src="https://i.loli.net/2021/08/30/Io1HG9FxpVXTyli.png" alt="1"></p>
<p><strong>参数的使用</strong></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> math

x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"CA"</span><span class="token punctuation">,</span> <span class="token string">"LA"</span><span class="token punctuation">,</span> <span class="token string">"FOP"</span><span class="token punctuation">,</span> <span class="token string">"DM"</span><span class="token punctuation">]</span>
y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span>

plt<span class="token punctuation">.</span>pie<span class="token punctuation">(</span>y<span class="token punctuation">,</span> labels<span class="token operator">=</span>x<span class="token punctuation">,</span> explode<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> autopct<span class="token operator">=</span><span class="token string">'%.2f%%'</span><span class="token punctuation">)</span>
<span class="token comment"># %d%% 整数百分比，%0.1f%% 一位小数百分比， %0.2f%% 两位小数百分比</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">"1.png"</span><span class="token punctuation">)</span></code></pre>
<p><img src="https://i.loli.net/2021/08/30/Cl6AKWtjYJQ2soH.png" alt="1"></p>
<h4 id="柱形图"><a href="#柱形图" class="headerlink" title="柱形图"></a>柱形图</h4><p><code>matplotlib.pyplot.bar(x, height, width=0.8, bottom=None, *, align=&#39;center&#39;, data=None, **kwargs)</code></p>
<h3 id="Prettify"><a href="#Prettify" class="headerlink" title="Prettify"></a>Prettify</h3><p><strong>设置标题</strong></p>
<p><code>plt.title(title)</code></p>
<p><strong>设置图例</strong></p>
<p><a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.legend.html#matplotlib.pyplot.legend">https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.legend.html#matplotlib.pyplot.legend</a></p>
<h3 id="Subplots"><a href="#Subplots" class="headerlink" title="Subplots"></a>Subplots</h3><p><code>plt.subplot(nrows, ncols, index)</code></p>
<p><a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplot.html#matplotlib.pyplot.subplot">https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplot.html#matplotlib.pyplot.subplot</a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://numpy.org/doc/stable/user/quickstart.html">https://numpy.org/doc/stable/user/quickstart.html</a></li>
<li><a href="https://www.runoob.com/numpy/numpy-ndarray-object.html">https://www.runoob.com/numpy/numpy-ndarray-object.html</a></li>
<li><a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.plot.html">https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.plot.html</a></li>
<li><a href="https://www.runoob.com/matplotlib/matplotlib-pie.html">https://www.runoob.com/matplotlib/matplotlib-pie.html</a></li>
</ul>
]]></content>
      <tags>
        <tag>Python</tag>
        <tag>Data Analysis</tag>
      </tags>
  </entry>
  <entry>
    <title>【机器学习】TensorFlow</title>
    <url>/2021/10/tensorflow-application/</url>
    <content><![CDATA[<p><s>好，它跑起来了，跑起来了啊，只不过 Loss 飞到 Nan 去了.</s></p>
<p>这篇文章 c7w 将把自己使用 TensorFlow 的过程分案例记录下来，旨在<s>写下踩的所有坑供人观赏</s>。<s>我下次一定记得加 sigmoid。</s></p>
<ul>
<li>Hello World! (Fashion MNIST)</li>
</ul>
<span id="more"></span>
<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World!"></a>Hello World!</h2><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p><img src="https://tensorflow.google.cn/images/fashion-mnist-sprite.png?hl=zh_cn" alt="Fashion MNIST sprite"></p>
<ul>
<li><p>数据集：Fashion MNIST</p>
</li>
<li><p>主要技术要点：新手教程，Fully Connected NN</p>
</li>
<li>目标任务：图片分类</li>
</ul>
<h3 id="数据集介绍与数据预处理"><a href="#数据集介绍与数据预处理" class="headerlink" title="数据集介绍与数据预处理"></a>数据集介绍与数据预处理</h3><p>So let’s get started. 首先我们并不知道 TensorFlow 的代码究竟该怎么写，只是久仰 Keras 的大名。</p>
<p>所以我们自然按照机器学习的基本流程开始（喂这根本没有因果逻辑联系吧），先进行数据预处理，然后 Declare 一个 Model，然后进行 Feedforward，然后进行 Backprops.</p>
<p>首先，我们的数据集可以极为方便的在 <strong>keras</strong> 中调用。具体而言，我们只需要：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># TensorFlow and tf.keras</span>
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">from</span> tensorflow <span class="token keyword">import</span> keras

<span class="token comment"># Helper libraries</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

fashion_mnist <span class="token operator">=</span> keras<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>fashion_mnist

<span class="token punctuation">(</span>train_images<span class="token punctuation">,</span> train_labels<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>test_images<span class="token punctuation">,</span> test_labels<span class="token punctuation">)</span> <span class="token operator">=</span> fashion_mnist<span class="token punctuation">.</span>load_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

class_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'T-shirt/top'</span><span class="token punctuation">,</span> <span class="token string">'Trouser'</span><span class="token punctuation">,</span> <span class="token string">'Pullover'</span><span class="token punctuation">,</span> <span class="token string">'Dress'</span><span class="token punctuation">,</span> <span class="token string">'Coat'</span><span class="token punctuation">,</span> <span class="token string">'Sandal'</span><span class="token punctuation">,</span> <span class="token string">'Shirt'</span><span class="token punctuation">,</span> <span class="token string">'Sneaker'</span><span class="token punctuation">,</span> <span class="token string">'Bag'</span><span class="token punctuation">,</span> <span class="token string">'Ankle boot'</span><span class="token punctuation">]</span></code></pre>
<p>不妨先看看这里面都是什么东西。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>train_images<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>train_images<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>train_labels<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>train_labels<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>train_images<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>train_labels<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'numpy.ndarray'</span><span class="token operator">></span>
<span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'numpy.ndarray'</span><span class="token operator">></span>
<span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">26</span>
    <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">189</span> <span class="token number">206</span> <span class="token number">187</span>  <span class="token number">32</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">26</span> <span class="token number">217</span> <span class="token number">226</span>
  <span class="token number">196</span>  <span class="token number">11</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">192</span> <span class="token number">227</span> <span class="token number">234</span> <span class="token number">243</span> <span class="token number">230</span> <span class="token number">147</span> <span class="token number">239</span> <span class="token number">242</span> <span class="token number">234</span> <span class="token number">218</span>
  <span class="token number">209</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">173</span> <span class="token number">225</span> <span class="token number">215</span> <span class="token number">233</span> <span class="token number">254</span>   <span class="token number">0</span> <span class="token number">194</span> <span class="token number">240</span> <span class="token number">217</span> <span class="token number">221</span>
  <span class="token number">190</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">139</span> <span class="token number">229</span> <span class="token number">212</span> <span class="token number">226</span> <span class="token number">255</span>   <span class="token number">0</span> <span class="token number">162</span> <span class="token number">255</span> <span class="token number">213</span> <span class="token number">226</span>
  <span class="token number">200</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">98</span> <span class="token number">232</span> <span class="token number">211</span> <span class="token number">215</span> <span class="token number">249</span>  <span class="token number">46</span> <span class="token number">162</span> <span class="token number">246</span> <span class="token number">214</span> <span class="token number">230</span>
  <span class="token number">186</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">70</span> <span class="token number">228</span> <span class="token number">213</span> <span class="token number">220</span> <span class="token number">224</span> <span class="token number">252</span> <span class="token number">239</span> <span class="token number">219</span> <span class="token number">217</span> <span class="token number">231</span>
  <span class="token number">171</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">45</span> <span class="token number">222</span> <span class="token number">214</span> <span class="token number">218</span> <span class="token number">216</span> <span class="token number">210</span> <span class="token number">215</span> <span class="token number">217</span> <span class="token number">202</span> <span class="token number">224</span>
  <span class="token number">172</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">24</span> <span class="token number">254</span> <span class="token number">214</span> <span class="token number">210</span> <span class="token number">211</span> <span class="token number">214</span> <span class="token number">215</span> <span class="token number">212</span> <span class="token number">203</span> <span class="token number">221</span>
  <span class="token number">167</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">254</span> <span class="token number">216</span> <span class="token number">215</span> <span class="token number">217</span> <span class="token number">217</span> <span class="token number">216</span> <span class="token number">216</span> <span class="token number">206</span> <span class="token number">225</span>
  <span class="token number">150</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">247</span> <span class="token number">216</span> <span class="token number">214</span> <span class="token number">217</span> <span class="token number">216</span> <span class="token number">214</span> <span class="token number">212</span> <span class="token number">203</span> <span class="token number">226</span>
  <span class="token number">136</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">245</span> <span class="token number">216</span> <span class="token number">214</span> <span class="token number">216</span> <span class="token number">217</span> <span class="token number">215</span> <span class="token number">211</span> <span class="token number">204</span> <span class="token number">225</span>
  <span class="token number">125</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">247</span> <span class="token number">216</span> <span class="token number">214</span> <span class="token number">217</span> <span class="token number">220</span> <span class="token number">217</span> <span class="token number">213</span> <span class="token number">203</span> <span class="token number">222</span>
  <span class="token number">147</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">248</span> <span class="token number">216</span> <span class="token number">215</span> <span class="token number">218</span> <span class="token number">222</span> <span class="token number">216</span> <span class="token number">214</span> <span class="token number">207</span> <span class="token number">218</span>
  <span class="token number">179</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">249</span> <span class="token number">216</span> <span class="token number">217</span> <span class="token number">219</span> <span class="token number">222</span> <span class="token number">217</span> <span class="token number">214</span> <span class="token number">210</span> <span class="token number">215</span>
  <span class="token number">211</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">38</span> <span class="token number">255</span> <span class="token number">214</span> <span class="token number">218</span> <span class="token number">219</span> <span class="token number">224</span> <span class="token number">218</span> <span class="token number">215</span> <span class="token number">211</span> <span class="token number">211</span>
  <span class="token number">231</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">79</span> <span class="token number">227</span> <span class="token number">209</span> <span class="token number">219</span> <span class="token number">219</span> <span class="token number">227</span> <span class="token number">219</span> <span class="token number">215</span> <span class="token number">213</span> <span class="token number">206</span>
  <span class="token number">254</span>  <span class="token number">58</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">146</span> <span class="token number">226</span> <span class="token number">211</span> <span class="token number">220</span> <span class="token number">219</span> <span class="token number">228</span> <span class="token number">218</span> <span class="token number">215</span> <span class="token number">216</span> <span class="token number">205</span>
  <span class="token number">219</span> <span class="token number">163</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">202</span> <span class="token number">221</span> <span class="token number">214</span> <span class="token number">221</span> <span class="token number">219</span> <span class="token number">231</span> <span class="token number">218</span> <span class="token number">215</span> <span class="token number">218</span> <span class="token number">213</span>
  <span class="token number">212</span> <span class="token number">220</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">234</span> <span class="token number">217</span> <span class="token number">216</span> <span class="token number">220</span> <span class="token number">219</span> <span class="token number">234</span> <span class="token number">217</span> <span class="token number">215</span> <span class="token number">218</span> <span class="token number">216</span>
  <span class="token number">223</span> <span class="token number">247</span>   <span class="token number">7</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">17</span> <span class="token number">254</span> <span class="token number">212</span> <span class="token number">219</span> <span class="token number">219</span> <span class="token number">220</span> <span class="token number">233</span> <span class="token number">214</span> <span class="token number">216</span> <span class="token number">219</span> <span class="token number">222</span>
  <span class="token number">153</span> <span class="token number">238</span>  <span class="token number">58</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">66</span> <span class="token number">255</span> <span class="token number">208</span> <span class="token number">220</span> <span class="token number">219</span> <span class="token number">222</span> <span class="token number">241</span> <span class="token number">220</span> <span class="token number">218</span> <span class="token number">218</span> <span class="token number">218</span>
  <span class="token number">192</span> <span class="token number">242</span>  <span class="token number">99</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">142</span> <span class="token number">235</span> <span class="token number">203</span> <span class="token number">218</span> <span class="token number">216</span> <span class="token number">231</span> <span class="token number">242</span> <span class="token number">225</span> <span class="token number">233</span> <span class="token number">219</span> <span class="token number">214</span>
  <span class="token number">216</span> <span class="token number">238</span> <span class="token number">144</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">177</span> <span class="token number">248</span> <span class="token number">227</span> <span class="token number">229</span> <span class="token number">211</span> <span class="token number">255</span>  <span class="token number">76</span>   <span class="token number">0</span> <span class="token number">247</span> <span class="token number">243</span> <span class="token number">230</span>
  <span class="token number">230</span> <span class="token number">249</span> <span class="token number">187</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">101</span> <span class="token number">241</span> <span class="token number">228</span> <span class="token number">228</span> <span class="token number">220</span> <span class="token number">255</span>  <span class="token number">64</span>   <span class="token number">0</span> <span class="token number">243</span> <span class="token number">237</span> <span class="token number">230</span>
  <span class="token number">227</span> <span class="token number">241</span> <span class="token number">142</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span> <span class="token number">255</span> <span class="token number">242</span> <span class="token number">222</span> <span class="token number">218</span> <span class="token number">255</span>  <span class="token number">62</span>   <span class="token number">0</span> <span class="token number">223</span> <span class="token number">238</span> <span class="token number">225</span>
  <span class="token number">238</span> <span class="token number">255</span>  <span class="token number">31</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">45</span> <span class="token number">255</span> <span class="token number">242</span> <span class="token number">235</span> <span class="token number">255</span>  <span class="token number">84</span>   <span class="token number">0</span> <span class="token number">246</span> <span class="token number">255</span> <span class="token number">242</span>
  <span class="token number">255</span>  <span class="token number">70</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">61</span> <span class="token number">102</span> <span class="token number">168</span>  <span class="token number">25</span>   <span class="token number">0</span> <span class="token number">139</span> <span class="token number">161</span>  <span class="token number">74</span>
    <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token number">0</span></code></pre>
<p>看起来只是 numpy 的 ndarray 嘛，我们已经很熟练了（关掉 numpy tutorial 网页）。</p>
<p>然后我们试着把这第 4 张图片画出来看看。</p>
<pre class="language-python" data-language="python"><code class="language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>train_images<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>colorbar<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="https://i.loli.net/2021/10/13/hRKQqLtM4CXxrv6.png" alt="image-20211013220656496"></p>
<p>似乎看起来确实是 “T-shirt/top”。 （像个鬼啊喂</p>
<p>于是我们考虑先对输入做 Normalization，方便我们后续的处理。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_images <span class="token operator">=</span> train_images <span class="token operator">/</span> <span class="token number">255.0</span>
test_images <span class="token operator">=</span> test_images <span class="token operator">/</span> <span class="token number">255.0</span></code></pre>
<p>然后随便再画几张图看一看。</p>
<pre class="language-python" data-language="python"><code class="language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">49</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>train_images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span>plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>binary<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span>class_names<span class="token punctuation">[</span>train_labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="https://i.loli.net/2021/10/13/2UQ1DmabWZ7pSIx.png" alt="image-20211013220902591"></p>
<p>好，现在我们已经打开理解了这个训练数据集中都是什么东西了，该开始抄代码环节了（明明上面也在抄吧喂，变量名都没改</p>
<h2 id="模型定义"><a href="#模型定义" class="headerlink" title="模型定义"></a>模型定义</h2><p>我们要构建最简单的 Fully Connected Nerual Network。</p>
<p>因为过于简单就用 mspaint 画图了。</p>
<p><img src="https://i.loli.net/2021/10/13/Kxc3S8pIwzFbMrB.png" alt="image-20211013222601931"></p>
<p>我们要知道，我们要描述这么一种线性的 Layer 结构。</p>
<p><code>Sequential</code> groups a linear stack of layers into a <a href="https://www.tensorflow.org/api_docs/python/tf/keras/Model?hl=zh_cn"><code>tf.keras.Model</code></a>.</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a href="https://www.tensorflow.org/tutorials/keras/classification?hl=zh_cn">https://www.tensorflow.org/tutorials/keras/classification?hl=zh_cn</a></li>
</ul>
<p>后面又咕了</p>
]]></content>
      <tags>
        <tag>Machine Learning</tag>
      </tags>
  </entry>
  <entry>
    <title>WSL 2 的升级与 USB 调试的配置</title>
    <url>/2021/08/wsl-update-config/</url>
    <content><![CDATA[<p><strong>什么是 WSL?</strong></p>
<p>即 <strong>Windows Subsystem for Linux</strong> 的缩写.</p>
<blockquote>
<p><strong>Windows Subsystem for Linux (WSL)</strong> is a compatibility layer for running Linux binary executables natively on Windows 10… (Excerpted from Wikipedia)</p>
</blockquote>
<p>也就是说，WSL 是安装在 Windows 系统上的 Linux 虚拟系统。</p>
<p>在 OOP 课程中我们将会初步接触到该系统的安装与使用。</p>
<p>本篇主要收集了 WSL 升级的方法和对于 Android 开发调试中的 USB 调试的实现过程。</p>
<p>此外，一旦完成了 WSL 的升级，我们还可以进行 Docker 部署等等进阶操作…</p>
<span id="more"></span>
<h2 id="WSL-2-的安装"><a href="#WSL-2-的安装" class="headerlink" title="WSL 2 的安装"></a>WSL 2 的安装</h2><p>WSL 的安装过程我们这里略去.</p>
<p>(1) 开启支持 WSL 2 的可选组件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart</code></pre>
<p>(2) 安装 Kernel update package</p>
<p>Download at: <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10#step-4---download-the-linux-kernel-update-package">https://docs.microsoft.com/en-us/windows/wsl/install-win10#step-4---download-the-linux-kernel-update-package</a></p>
<p>(3) 输入命令 进行转换</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># List all the distributions</span>
wsl --list
<span class="token comment"># Set version to WSL 2</span>
wsl --set-version <span class="token operator">&lt;</span>Distro<span class="token operator">></span> <span class="token number">2</span>
<span class="token comment"># Set default version to 2</span>
wsl --set-default-version <span class="token number">2</span>

<span class="token comment"># List all the distributions with verbose information, namely their versions</span>
wsl --list -v</code></pre>
<p>等了好久，大概两关方舟吧，就转换好了.</p>
<blockquote>
<p>[Interlude] 【插曲】</p>
<p>第一次运行时中间有个报错：<em>WSL2 请启用虚拟机平台 Windows 功能并确保在 BIOS 中启用虚拟化</em>.</p>
<p>进行了一次面向CSDN的问题解决，发现问题在于原来安装安卓虚拟机（<s>方舟挂机专用引擎</s>）的时候对某项设置进行了调整.</p>
<p><a href="https://blog.csdn.net/weixin_43271225/article/details/115698940">https://blog.csdn.net/weixin_43271225/article/details/115698940</a></p>
<p>对应的命令执行过之后，重新 <code>set-version</code> 就可以了.</p>
<p>但是，但是，这样做的问题在于，方舟挂机引擎打不开了.</p>
<p>市面上大部分安卓模拟器的通用版本和 Hyper V 还是不兼容的.</p>
<p>于是又进行了一次面向 Google 的问题解决，最终选用 Bluestacks 国际版提供的 HyperV 版本.</p>
<p><s>开发个 APP 不能老婆不养了啊对不对</s></p>
<p><s>昨天修了一个晚上 老婆材料挂机引擎还是没修好 先继续做App开发吧 大不了做完关掉HyperV（划掉</s></p>
<p>进度：最后改用了 Mumu 黄.</p>
</blockquote>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://dowww.spencerwoo.com/1-preparations/1-0-intro.html">https://dowww.spencerwoo.com/1-preparations/1-0-intro.html</a></li>
<li><a href="https://dowww.spencerwoo.com/1-preparations/1-1-installation.html#wsl-2-%E7%9A%84%E5%AE%89%E8%A3%85">https://dowww.spencerwoo.com/1-preparations/1-1-installation.html#wsl-2-%E7%9A%84%E5%AE%89%E8%A3%85</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10#step-2---check-requirements-for-running-wsl-2">https://docs.microsoft.com/en-us/windows/wsl/install-win10#step-2---check-requirements-for-running-wsl-2</a></li>
<li><a href="https://developer.android.com/studio/command-line/adb">https://developer.android.com/studio/command-line/adb</a></li>
</ul>
]]></content>
      <tags>
        <tag>WSL</tag>
      </tags>
  </entry>
  <entry>
    <title>SQLAlchemy 下的数据库关系设计</title>
    <url>/2021/08/sqlalchemy-database-relationship/</url>
    <content><![CDATA[<p><strong>SQLAlchemy</strong> 主要用于将 Python 中的类映射为数据库中的数据表，方便进行后端的管理操作。&gt;&gt; <strong>Object-relational mapper</strong> <em>(ORM)</em></p>
<p>我们从数据库关系的常见设计模式，一对一，一对多，多对一，多对多开始回顾，然后给出 <strong>SQLAlchemy</strong> 下其具体实现。</p>
<span id="more"></span>
<h2 id="引入包-Imports"><a href="#引入包-Imports" class="headerlink" title="引入包 Imports"></a>引入包 Imports</h2><p>Import all packages that will be used in the later sections.</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Table<span class="token punctuation">,</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base

Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h2 id="一对多-One-to-Many"><a href="#一对多-One-to-Many" class="headerlink" title="一对多 One to Many"></a>一对多 One to Many</h2><p>我们不妨用<code>Exam</code>表示一次考试，<code>ExamRecord</code>表示一条考试记录。</p>
<p>显而易见，一次考试应该有多条考试记录。</p>
<p>我们需要在 <code>ExamRecord</code>(Child) 的数据成员列表中添加一个数据成员并标记为<code>ForeignKey</code>，指向 <code>Exam</code>(Parent) 的 <code>PrimaryKey</code>。</p>
<p>同时，我们需要在 <code>Exam</code>(Parent) 新增数据成员 <code>records</code> 用于指向 <code>ExamRecord</code> 中的成员。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Not completed...</span>
<span class="token keyword">import</span> json
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>schema <span class="token keyword">import</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>type_api <span class="token keyword">import</span> TypeDecorator
<span class="token keyword">from</span> models<span class="token punctuation">.</span>database <span class="token keyword">import</span> Base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Boolean<span class="token punctuation">,</span> PickleType

<span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"exam_exams"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    state <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    records <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"ExamRecord"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">ExamRecord</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"exam_exam_records"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    author_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'account_users.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    exam_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'exam_exams.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    feedback <span class="token operator">=</span> Column<span class="token punctuation">(</span>PickleType<span class="token punctuation">)</span></code></pre>
<p>到此为止，我们只完成了一对多关系建立的单向更新功能。我们还需要建立该关系的另一边。可能的解决方案有两种：</p>
<ol>
<li><p>此时，如果我们想在<code>ExamRecord</code>中直接访问其对应的<code>Exam</code>对象，即要求实现<code>ExamRecord.Exam</code>的效果的话，我们还需要添加一个<code>exam</code>对象，并使用<code>back_populates</code>参数。</p>
</li>
<li><p>我们可以在其中一个<code>relationship()</code>中使用<code>relationship.backref</code>参数创建一个反向引用。</p>
</li>
</ol>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Example Code for Solution 1</span>
<span class="token keyword">import</span> json
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>schema <span class="token keyword">import</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>type_api <span class="token keyword">import</span> TypeDecorator
<span class="token keyword">from</span> models<span class="token punctuation">.</span>database <span class="token keyword">import</span> Base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Boolean<span class="token punctuation">,</span> PickleType

<span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"exam_exams"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    state <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    records <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"ExamRecord"</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"exam"</span><span class="token punctuation">)</span> <span class="token comment"># Here</span>

<span class="token keyword">class</span> <span class="token class-name">ExamRecord</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"exam_exam_records"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    author_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'account_users.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    exam_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'exam_exams.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    exam <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Exam"</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"records"</span><span class="token punctuation">)</span> <span class="token comment"># And here</span>
    feedback <span class="token operator">=</span> Column<span class="token punctuation">(</span>PickleType<span class="token punctuation">)</span></code></pre>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Example Code for Solution 2</span>
<span class="token keyword">import</span> json
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>schema <span class="token keyword">import</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>type_api <span class="token keyword">import</span> TypeDecorator
<span class="token keyword">from</span> models<span class="token punctuation">.</span>database <span class="token keyword">import</span> Base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Boolean<span class="token punctuation">,</span> PickleType

<span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"exam_exams"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    state <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    records <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"ExamRecord"</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">"exam"</span><span class="token punctuation">)</span> <span class="token comment"># Only here</span>

<span class="token keyword">class</span> <span class="token class-name">ExamRecord</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"exam_exam_records"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    author_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'account_users.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    exam_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'exam_exams.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    feedback <span class="token operator">=</span> Column<span class="token punctuation">(</span>PickleType<span class="token punctuation">)</span></code></pre>
<h3 id="如何理解-back-ref？-Why-back-ref"><a href="#如何理解-back-ref？-Why-back-ref" class="headerlink" title="如何理解 back_ref？ Why back_ref?"></a>如何理解 back_ref？ Why back_ref?</h3><p>我们该如何理解关系的“单边”性呢？如果理解了“单边”是什么意思，我们自然就知道了<code>back_populates</code>和<code>back_ref</code>的意义了。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Example Code without back_ref</span>
<span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'parent'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    children <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Child"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'child'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    parent_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'parent.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    parent <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Parent"</span><span class="token punctuation">)</span></code></pre>
<p>这时，如果我们执行如下命令：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> parent <span class="token operator">=</span> Parent<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> child <span class="token operator">=</span> Child<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> child<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre>
<p>我们会发现，<code>parent</code>的<code>child</code>字段并没有随之更新。</p>
<p>也就是说，这个关系的“单边”体现在只有一边的数据进行了更新。</p>
<p>而这显然不是我们在数据关系的处理时想要的。</p>
<p>于是我们就通过<code>back_populates</code>和<code>back_ref</code>字段的设置来完成了这种关系的双向绑定。</p>
<h3 id="自动删除-Cascade-on-delete"><a href="#自动删除-Cascade-on-delete" class="headerlink" title="自动删除 Cascade on delete"></a>自动删除 Cascade on delete</h3><p>我们想实现是，一旦一个<code>Exam</code>对象被删除，其对应的<code>ExamRecord</code>对象被全部删除的功能。</p>
<p>我们自然可以想到，在原有的数据库中，我们可以通过外键约束来实现这个功能。</p>
<p>那么，该如何在 <code>SQLAlchemy</code> 中实现这个功能呢？</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> json
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>schema <span class="token keyword">import</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>type_api <span class="token keyword">import</span> TypeDecorator
<span class="token keyword">from</span> models<span class="token punctuation">.</span>database <span class="token keyword">import</span> Base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Boolean<span class="token punctuation">,</span> PickleType

<span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"exam_exams"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    state <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    records <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"ExamRecord"</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"exam"</span><span class="token punctuation">,</span>
                           cascade<span class="token operator">=</span><span class="token string">"all, delete"</span><span class="token punctuation">,</span> passive_deletes<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">ExamRecord</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"exam_exam_records"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    author_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span>
        <span class="token string">'account_users.id'</span><span class="token punctuation">,</span> ondelete<span class="token operator">=</span><span class="token string">"CASCADE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    exam_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'exam_exams.id'</span><span class="token punctuation">,</span> ondelete<span class="token operator">=</span><span class="token string">"CASCADE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    exam <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Exam"</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"records"</span><span class="token punctuation">)</span>
    feedback <span class="token operator">=</span> Column<span class="token punctuation">(</span>PickleType<span class="token punctuation">)</span></code></pre>
<p>我们可以通过配置子表的 <code>ForeignKey.ondelete</code> 字段和父表的 <code>relationship.cascade</code> 字段来实现该功能。</p>
<h3 id="多对一-Many-to-One"><a href="#多对一-Many-to-One" class="headerlink" title="多对一 Many to One"></a>多对一 Many to One</h3><p>由于类似于一对多关系，我们不再单独分 Section.</p>
<p>如果我们在<code>Exam</code>中添加字段 <code>records_id</code>，其值赋为<code>Column(Integer, ForeignKey(&#39;exam_exam_records.id&#39;))</code>，我们便实现了一个多对一关系单边更新的创建。</p>
<p>另一边同理，也是使用<code>back_populates</code>或<code>back_ref</code>实现的。</p>
<h2 id="一对一-One-to-One"><a href="#一对一-One-to-One" class="headerlink" title="一对一 One to One"></a>一对一 One to One</h2><p>这里我们仍然使用 <code>Parent</code> 类和 <code>Child</code> 类做例子，即使在一对一关系中不应存在父子关系。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'parent'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># previously one-to-many Parent.children is now</span>
    <span class="token comment"># one-to-one Parent.child</span>
    <span class="token comment"># uselist=False #</span>
    child <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Child"</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"parent"</span><span class="token punctuation">,</span> uselist<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'child'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    parent_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'parent.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># many-to-one side remains, see tip below</span>
    parent <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Parent"</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"child"</span><span class="token punctuation">)</span></code></pre>
<p>当然，不使用<code>back_populates</code>，我们仍然可以使用<code>back_ref</code>。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> backref

<span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'parent'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'child'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    parent_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'parent.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    parent <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Parent"</span><span class="token punctuation">,</span> backref<span class="token operator">=</span>backref<span class="token punctuation">(</span><span class="token string">"child"</span><span class="token punctuation">,</span> uselist<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h2 id="多对多-Many-to-Many"><a href="#多对多-Many-to-Many" class="headerlink" title="多对多 Many to Many"></a>多对多 Many to Many</h2><p>我们考虑用户类<code>User</code>与用户组类<code>Group</code>。一个用户组中可以有多名用户，一个用户也可以同时属于多个用户组。</p>
<h3 id="使用-Table"><a href="#使用-Table" class="headerlink" title="使用 Table"></a>使用 Table</h3><p>为了实现多对多关系的建立，我们需要在<code>User</code>与<code>Group</code>之外，单独再建立一个描述二者之间关系的数据表。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Not Implemented...</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Boolean
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>schema <span class="token keyword">import</span> ForeignKey<span class="token punctuation">,</span> Table
<span class="token keyword">from</span> models<span class="token punctuation">.</span>database <span class="token keyword">import</span> Base

UserGroupAssociation <span class="token operator">=</span> Table<span class="token punctuation">(</span><span class="token string">"account_user_group"</span><span class="token punctuation">,</span> Base<span class="token punctuation">.</span>metadata<span class="token punctuation">,</span>
                             Column<span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'User.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             Column<span class="token punctuation">(</span><span class="token string">'group'</span><span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'Group.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"account_users"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    is_active <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    groups <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Group"</span><span class="token punctuation">,</span> secondary<span class="token operator">=</span>UserGroupAssociation<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Group</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"account_groups"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    is_active <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    users <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"User"</span><span class="token punctuation">,</span> secondary<span class="token operator">=</span>UserGroupAssociation<span class="token punctuation">)</span>    </code></pre>
<p>然后，我们只需要再使用<code>back_populates</code>或者<code>back_ref</code>进行双边关系绑定就好了。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Boolean
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>schema <span class="token keyword">import</span> ForeignKey<span class="token punctuation">,</span> Table
<span class="token keyword">from</span> models<span class="token punctuation">.</span>database <span class="token keyword">import</span> Base

UserGroupAssociation <span class="token operator">=</span> Table<span class="token punctuation">(</span><span class="token string">"account_user_group"</span><span class="token punctuation">,</span> Base<span class="token punctuation">.</span>metadata<span class="token punctuation">,</span>
                             Column<span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'User.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             Column<span class="token punctuation">(</span><span class="token string">'group'</span><span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'Group.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"account_users"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    is_active <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    groups <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Group"</span><span class="token punctuation">,</span> secondary<span class="token operator">=</span>UserGroupAssociation<span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"users"</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Group</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"account_groups"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    is_active <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    users <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"User"</span><span class="token punctuation">,</span> secondary<span class="token operator">=</span>UserGroupAssociation<span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"groups"</span><span class="token punctuation">)</span></code></pre>
<h3 id="使用-Association-类-Optional"><a href="#使用-Association-类-Optional" class="headerlink" title="使用 Association 类 (Optional)"></a>使用 Association 类 (Optional)</h3><p>我们可以使用一个新类来存储数据关系。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Boolean
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>schema <span class="token keyword">import</span> ForeignKey
<span class="token keyword">from</span> models<span class="token punctuation">.</span>database <span class="token keyword">import</span> Base

<span class="token keyword">class</span> <span class="token class-name">UserGroupAssociation</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"account_user_group"</span>
    user <span class="token operator">=</span> Column<span class="token punctuation">(</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'User.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    group <span class="token operator">=</span> Column<span class="token punctuation">(</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'Group.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    role <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"account_users"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    is_active <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    groups <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"UserGroupAssociation"</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Group</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"account_groups"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    is_active <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    users <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"UserGroupAssociation"</span><span class="token punctuation">)</span></code></pre>
<h2 id="总结-Conclusion"><a href="#总结-Conclusion" class="headerlink" title="总结 Conclusion"></a>总结 Conclusion</h2><p><code>SQLAlchemy</code> 是一个 Python 的 ORM 管理包，可以协助 API 及后端的开发。</p>
<p>在一对一，一对多，多对一关系中，数据关系的建立主要是通过外键<code>Foreign Key</code>来实现的。</p>
<p>而在多对多的关系中，数据关系主要是通过建立新数据表<code>Association</code>来存储的。</p>
<p>为了建立能够双向更新的数据关系，<code>back_populates</code>和<code>back_ref</code>是不可或缺的。</p>
<h2 id="参考资料-Reference"><a href="#参考资料-Reference" class="headerlink" title="参考资料 Reference"></a>参考资料 Reference</h2><ul>
<li><a href="https://docs.sqlalchemy.org/en/14/orm/basic_relationships.html#one-to-many">https://docs.sqlalchemy.org/en/14/orm/basic_relationships.html#one-to-many</a></li>
<li><a href="https://stackoverflow.com/questions/39869793/when-do-i-need-to-use-sqlalchemy-back-populates">https://stackoverflow.com/questions/39869793/when-do-i-need-to-use-sqlalchemy-back-populates</a></li>
</ul>
]]></content>
      <tags>
        <tag>Python</tag>
        <tag>SQL</tag>
        <tag>Backend</tag>
      </tags>
  </entry>
  <entry>
    <title></title>
    <url>/2021/12/games101/</url>
    <content><![CDATA[<h2 id="变换-Transformation"><a href="#变换-Transformation" class="headerlink" title="变换 Transformation"></a>变换 Transformation</h2><h3 id="为什么要学习变换？"><a href="#为什么要学习变换？" class="headerlink" title="为什么要学习变换？"></a>为什么要学习变换？</h3><p>变换分为模型变换和视图变换。</p>
<p>模型变换的例子：</p>
<ul>
<li>跳舞机器人的运动</li>
<li>PIXAR 的开场动画</li>
</ul>
<p>视图变换：</p>
<ul>
<li>3D 空间到 2D 的投影</li>
</ul>
<h3 id="二维变换"><a href="#二维变换" class="headerlink" title="二维变换"></a>二维变换</h3><h4 id="缩放变换（Scale）"><a href="#缩放变换（Scale）" class="headerlink" title="缩放变换（Scale）"></a>缩放变换（Scale）</h4><script type="math/tex; mode=display">
x'=s_xx \\
y'=s_yy \\
\begin{bmatrix}x' \\ y' \end{bmatrix}
=
\begin{bmatrix} s_x & 0 \\ 0 & s_y\end{bmatrix}
\begin{bmatrix}x \\ y \end{bmatrix}</script><h4 id="反射变换（Reflection）"><a href="#反射变换（Reflection）" class="headerlink" title="反射变换（Reflection）"></a>反射变换（Reflection）</h4><script type="math/tex; mode=display">
x'=-x \\
y'=y \\
\begin{bmatrix}x' \\ y' \end{bmatrix}
=
\begin{bmatrix} -1 & 0 \\ 0 & 1\end{bmatrix}
\begin{bmatrix}x \\ y \end{bmatrix}</script><h4 id="切变变换（Shear）"><a href="#切变变换（Shear）" class="headerlink" title="切变变换（Shear）"></a>切变变换（Shear）</h4><script type="math/tex; mode=display">
x'=x+a y \\
y'=y \\
\begin{bmatrix}x' \\ y' \end{bmatrix}
=
\begin{bmatrix} 1 & a \\ 0 & 1\end{bmatrix}
\begin{bmatrix}x \\ y \end{bmatrix}</script><h4 id="旋转（Rotation"><a href="#旋转（Rotation" class="headerlink" title="旋转（Rotation)"></a>旋转（Rotation)</h4><p>About (0,0), CCW(Counter clockwise) by default.</p>
<script type="math/tex; mode=display">
R_\theta =
\begin{bmatrix}
\cos\theta & -\sin \theta \\
\sin\theta & \cos \theta
\end{bmatrix}</script><h4 id="线性变换（Linear）"><a href="#线性变换（Linear）" class="headerlink" title="线性变换（Linear）"></a>线性变换（Linear）</h4><script type="math/tex; mode=display">
\begin{bmatrix}x' \\ y' \end{bmatrix}
=
\begin{bmatrix} a & b \\ c & d\end{bmatrix}
\begin{bmatrix}x \\ y \end{bmatrix}</script><h3 id="齐次坐标-Homogeneous-Coordinates"><a href="#齐次坐标-Homogeneous-Coordinates" class="headerlink" title="齐次坐标 (Homogeneous Coordinates)"></a>齐次坐标 (Homogeneous Coordinates)</h3><p><strong>平移</strong>不能有上述的矩阵表示。</p>
<script type="math/tex; mode=display">
\begin{bmatrix}x' \\ y' \end{bmatrix}
=
\begin{bmatrix} a & b \\ c & d\end{bmatrix}
\begin{bmatrix}x \\ y \end{bmatrix}
+
\begin{bmatrix}T_x \\ T_y \end{bmatrix}</script><p>但是我们希望使用简单的表示方法。有无能将上述变换统一的表示方式？</p>
<p>增加坐标的第三维度！(w-coordinate)</p>
<ul>
<li>2D Point: $(x,y,1)^T$</li>
<li>2D Vector: $(x, y, 0)^T$</li>
</ul>
<script type="math/tex; mode=display">
\begin{bmatrix}x' \\ y' \\ w' \end{bmatrix}
=
\begin{bmatrix} 1 & 0 & t_x \\ 
0 & 1 & t_y \\
0 & 0 & 1\end{bmatrix}
\begin{bmatrix}x \\ y \\ 1 \end{bmatrix}
=\begin{bmatrix}x+t_x \\ y+t_y \\ 1 \end{bmatrix}</script><ul>
<li>Valid Operations on w-coordinate<ul>
<li>Vec + Vec = Vec</li>
<li>Point - Point = Vec</li>
<li>Point + Vec = Point</li>
<li>Point + Point = ?<ul>
<li>Let $(x,y,w)^T := (\frac x w, \frac y w, 1), w\ne 0$</li>
<li>几何意义是 n 等分点</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>这样我们就能将仿射变换转换成统一的矩阵表示了。</p>
<h3 id="逆变换（Inverse-Transform）"><a href="#逆变换（Inverse-Transform）" class="headerlink" title="逆变换（Inverse Transform）"></a>逆变换（Inverse Transform）</h3><p>$M^{-1}$ is the inverse of transform $M$ in both a matrix and geometric sense.</p>
<h3 id="变换的合成（Composing-Transforms）"><a href="#变换的合成（Composing-Transforms）" class="headerlink" title="变换的合成（Composing Transforms）"></a>变换的合成（Composing Transforms）</h3><p>复杂的变换可以通过简单的变换得到;在变换的复合过程中，先后次序很重要.</p>
<h3 id="三维变换"><a href="#三维变换" class="headerlink" title="三维变换"></a>三维变换</h3><p>可按照上述的思路，构造出 4x4 矩阵表示的三维空间中的齐次坐标。</p>
<p>特别的，三维空间中的旋转需要固定旋转轴。</p>
<p>欧拉角 $R_{xyz}(\alpha, \beta,\gamma)=R_x(\alpha)R_y(\beta)R_z(\gamma)$​</p>
<h3 id="观测变换（Viewing-Transformation）"><a href="#观测变换（Viewing-Transformation）" class="headerlink" title="观测变换（Viewing Transformation）"></a>观测变换（Viewing Transformation）</h3><h4 id="视图变换（View-Camera-Transformation）"><a href="#视图变换（View-Camera-Transformation）" class="headerlink" title="视图变换（View/Camera Transformation）"></a>视图变换（View/Camera Transformation）</h4><p>什么是视图变换？我们可以与拍照过程进行类比。拍照的第一步是模型变换，也就是把模型放在合适的位置上。第二步是找好角度放相机（View Transformation），也就是本节要介绍的视图变换。第三步是做投影变换，将照片定格。</p>
<p>如何执行视图变换？首先要定义<strong>相机</strong>的概念：</p>
<ul>
<li>位置 $\vec e$</li>
<li>看向 $\hat g$</li>
<li>相机的向上方向 $\hat t$</li>
</ul>
<p>约定俗成地，我们在视图变换时令 $\vec e = \vec 0, \hat g = -\hat z, \hat t = \hat y \ (*)$。</p>
<p>定义 $M_{view}$ 变换相机，使得经过该变换满足上述 $(*)$。</p>
<ul>
<li>Translates $\vec e$ to origin.</li>
<li>Rotate $\hat g$ to $-\hat z$.</li>
<li>Rotate $\hat t$ to $\hat y$.</li>
<li>Then naturally $\hat g \times \hat y = \hat x$.</li>
</ul>
<p>Then the calculation process:</p>
<script type="math/tex; mode=display">
M_{view} = R_{view}T_{view} \ (**)\\

T_{view} = \begin{bmatrix} 1&0&0&-x_e\\
0&1&0&-y_e\\
0&0&1&-z_e\\
0&0&0&1\end{bmatrix}\\

R_{view}^{-1} = \begin{bmatrix} x_{\hat g \times \hat t}&x_{\hat t}&x_{-\hat g}&0\\
y_{\hat g \times \hat t}&y_{\hat t}&y_{-\hat g}&0\\
z_{\hat g \times \hat t}&z_{\hat t}&z_{-\hat g}&0\\
0&0&0&1\end{bmatrix}\\

R_{view} = (R_{view}^{-1})^T =
\begin{bmatrix} x_{\hat g \times \hat t}&y_{\hat g \times \hat t}&z_{\hat g \times \hat t}&0\\
x_{\hat t}&y_{\hat t}&z_{\hat t}&0\\
x_{-\hat g}&y_{-\hat g}&z_{-\hat g}&0\\
0&0&0&1\end{bmatrix}\\</script><p>我们要做的，是把所有物体都应用这个变换，保证相机与物体的相对运动性质不变。</p>
<p>视图变换也被称为 ModelView Transformation.</p>
<h4 id="投影变换（Projection-Transformation）"><a href="#投影变换（Projection-Transformation）" class="headerlink" title="投影变换（Projection Transformation）"></a>投影变换（Projection Transformation）</h4><p>计算机图形学中的投影：是将 3D 模型形成二维图像，有两种投影方式，正交投影与透视投影。正交投影（Orthographic projection）原来平行的线仍然平行；透视投影（Perspective projection）平行线不再平行，会有近大远小的现象。</p>
<h5 id="正交投影"><a href="#正交投影" class="headerlink" title="正交投影"></a>正交投影</h5><p>首先我们需要将相机摆在合适的位置（具体来说是满足上述 $(*)$​ 的条件），然后我们可以直接无视掉 Z 坐标，将剩余的物体直接平移并缩放到 $[-1, 1]^2$​​。</p>
<p>正交变换实际上是把空间立方体 $[l, r] \times [b,t] \times [f,n]$ 映射到标准正方体 $[-1,1]^3$​ 的过程。</p>
<p><img src="https://i.loli.net/2021/11/06/GjCdAz8hv9PtQle.png" alt="image-20211106214250684"></p>
<center>正交投影的过程</center>

<p>具体来说，我们有：</p>
<script type="math/tex; mode=display">
M_{\text {ortho }}=\left[\begin{array}{cccc}
\frac{2}{r-l} & 0 & 0 & 0 \\
0 & \frac{2}{t-b} & 0 & 0 \\
0 & 0 & \frac{2}{n-f} & 0 \\
0 & 0 & 0 & 1
\end{array}\right]\left[\begin{array}{cccc}
1 & 0 & 0 & -\frac{r+l}{2} \\
0 & 1 & 0 & -\frac{t+b}{2} \\
0 & 0 & 1 & -\frac{n+f}{2} \\
0 & 0 & 0 & 1
\end{array}\right]</script><h5 id="透视投影"><a href="#透视投影" class="headerlink" title="透视投影"></a>透视投影</h5><p>透视投影的特性是平行线相交于一点，近大远小。</p>
<p>回忆：$(x,y,z,1), (kx,ky,kz,k\ne0), (xz,yz,z^2,z\ne0)$​ 都代表同一点</p>
<ul>
<li>做透视投影的步骤：<ul>
<li>首先将视锥压成正方体 $M_{persp\rightarrow ortho}$</li>
<li>然后进行正交投影 $M_{ortho}$</li>
</ul>
</li>
</ul>
<p><img src="C:/Users/c7w/AppData/Roaming/Typora/typora-user-images/image-20211016010006341.png" alt="image-20211016010006341"></p>
<center> 做透视投影的步骤 </center>

<p>这里我们略去透视投影矩阵的推导，直接给出透视投影转换为正交投影矩阵的表示形式。具体的推导可以通过考虑以下特殊点，代入特殊值来决定矩阵的元素。</p>
<ul>
<li>近平面的坐标不改变</li>
<li>远平面的 $x,y$ 坐标被压缩至与近平面相同</li>
<li>近平面中心点与远平面中心点的位置不变</li>
</ul>
<script type="math/tex; mode=display">
M_{persp\rightarrow ortho} = 
\begin{bmatrix}
n & 0 & 0 & 0 \\
0 & n & 0 & 0 \\
0 & 0 & n+f & -nf \\
0 & 0 & 1 & 0
\end{bmatrix} \\\\
M_{persp} = M_{ortho}M_{persp \rightarrow ortho}</script><p>值得注意的是，在我们平常的应用中，我们并不是直接使用 $l, r, b,t$ 来描述一个近平面的位置，而是更倾向于使用 $fovY$​(<strong>field-of-view</strong>, 垂直视角) 和 <strong>aspect ratio</strong> 这两个量来描述一个近平面。</p>
<p>使用这两个量我们可以轻松地计算出 $l,r,b,t$ 四个近平面参数。</p>
<p><img src="https://i.loli.net/2021/11/06/NZbxWisdEH78plf.png" alt="image-20211106214646265"></p>
<h2 id="光栅化-Rasterization"><a href="#光栅化-Rasterization" class="headerlink" title="光栅化 Rasterization"></a>光栅化 Rasterization</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>在我们进行完 MVP（模型变换，视图变换，投影变换）之后，我们将三维的模型转化成了 $[-1,1]^3$​​ 上的正规立方体。在那之后，我们就要将这个立方体投影到我们的屏幕上，绘出图像了。而这图像的绘制过程，我们便将其称为<strong>光栅化</strong>。</p>
<p>在此之前，我们必须先给出<strong>屏幕</strong>的定义：</p>
<p>我们可以将屏幕视为是像素点的二维数组，其中每个像素点由 R, G, B 三种颜色构成。像素点的维数与分辨率相同。进行坐标表示时我们使用 $(x,y)$ 表示 $[x, x+1]\times[y,y+1]$ 这一个像素点，这里 x,y 是整数。</p>
<p>要将正规立方体绘制到屏幕上，这个过程与 z 是无关的，我们需要首先对 xOy 平面做变换 $[-1,1]^2\rightarrow [0, width] \times [0, height]$，这个过程我们称为<strong>视口变换</strong>。而这里用到的变换矩阵是：</p>
<script type="math/tex; mode=display">
M_{\text {viewport }}=\left(\begin{array}{cccc}
\frac{\text { width }}{2} & 0 & 0 & \frac{\text { width }}{2} \\
0 & \frac{\text { height }}{2} & 0 & \frac{h e i g h t}{2} \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1
\end{array}\right)</script><p>该怎么把 $[0, width] \times [0, height]$​ 中的内容画到屏幕上呢？这就要用到<strong>光栅化</strong>了。</p>
<h3 id="三角形的光栅化"><a href="#三角形的光栅化" class="headerlink" title="三角形的光栅化"></a>三角形的光栅化</h3><p>我们接下来要考虑如何将三维空间中的一个三角形光栅化成像素。</p>
<p>为什么选择三角形？因为三角形是最基础的多边形，任何其它多边形都可以用三角形来表示。同时，三角形的三个顶点一定在同一个平面内。三角形的内部和外部区分的十分清楚，而且可以用叉积来判断点是否在三角形中。</p>
<p>那么，如果我们得到了三角形的三个顶点在二维平面中的表示 $(x_1, y_1), (x_2, y_2), (x_3, y_3)$​ 之后，我们该如何估计这个三角形所包围的像素点的集合呢？也就是说，该如何判断一个像素（的中心点）和一个三角形的位置关系呢？</p>
<p>我们可以通过<strong>采样</strong>（Sampling）的方法来实现。采样，实际是将一个函数离散化的过程，这是图形学中的一个核心概念。</p>
<p>我们再明确一下我们的采样目标：判断某个像素的中心点是否在给定的三角形 $(x_1, y_1), (x_2, y_2), (x_3, y_3)$​​ 内部。即我们要尝试去实现如下的函数：</p>
<script type="math/tex; mode=display">
inside(t, x, y) = 
\begin{cases} 
1, & if \ Point (x,y) \ inside \ triangle \ t, \\
0, & otherwise.
\end{cases}</script><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Sampling</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> xmax<span class="token punctuation">;</span> <span class="token operator">++</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> ymax<span class="token punctuation">;</span> <span class="token operator">++</span>y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        image<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">inside</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> x<span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">,</span> y<span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>那么该如何实现 <code>inside(t, x, y)</code> 函数呢？</p>
<p><img src="https://i.loli.net/2021/11/06/Qx9SjUgGACRuBta.png" alt="image-20211106223216259"></p>
<p>我们考虑如下的三个叉积。$\overrightarrow {P_0P_1} \times \overrightarrow {P_0Q}$, $\overrightarrow {P_1P_2} \times \overrightarrow {P_1Q}$, $\overrightarrow {P_2P_0} \times \overrightarrow {P_2Q}$ 如果 z 坐标的符号相同，那么点 Q 就一定在三角形内。如果点正好落在边界上，可自行定义解决方案。</p>
<p><img src="https://i.loli.net/2021/11/06/XLsJyofHK3p9zOn.png" alt="image-20211106225745932"></p>
<center>光栅化加速：包围盒</center> 

<p>但是，如果对屏幕的所有元素采样，造成了没有必要的资源浪费。我们使用<strong>包围盒</strong>（Bounding Box）的概念，取三角形边界点的 x, y 坐标分别的最小值或最大值，作为包围盒 x, y 坐标的最小值与最大值。这样我们就能得到一张带锯齿的图像了。</p>
<p><img src="https://i.loli.net/2021/11/06/sh3uLpPWTYroKQz.png" alt="image-20211106232712939"></p>
<center>带锯齿的图像</center>

<p>图像之所以带锯齿（Jaggies）是因为，我们的采样率并不够高，并不足以描述原来的信号，因此就发生了走样（Aliasing）的问题。</p>
<h3 id="反走样"><a href="#反走样" class="headerlink" title="反走样"></a>反走样</h3><p>首先我们简单介绍一下采样理论。采样瑕疵（Sampling Artifacts）包括多种，在图形学中包括锯齿，摩尔纹等等。采样瑕疵背后都是因为信号的变化太快，以至于采样的速度跟不上信号的变化。而解决办法，便是通过首先对原图进行<strong>模糊</strong>（滤波, pre-filtering then sampling），然后再对其进行采样。</p>
<h4 id="频域的概念"><a href="#频域的概念" class="headerlink" title="频域的概念"></a>频域的概念</h4><p>频率的概念我们已经熟知，如 $\cos 2\pi fx$ 中频率为 $f$​。用频率可以定义函数周期性变化的快慢。</p>
<p>我们可以使用傅里叶级数将一个函数（从它的时域）表示成正弦函数和余弦函数的加权和的形式（转换到频域），也可以使用逆傅里叶变换将其从频域转化回时域。</p>
<p><img src="https://i.loli.net/2021/11/06/XSeh2kvlg97x6UE.png" alt="image-20211106235002520"></p>
<center>傅里叶变换和逆傅里叶变换</center>

<p>而<strong>走样</strong>是指，使用同样的采样方式，在高频信号和低频信号两个不同的信号上，得到了相同的采样结果。如下图所示：</p>
<p><img src="https://i.loli.net/2021/11/08/qPJ81KrkMgR3uoG.png" alt="image-20211108153046165"></p>
<center>走样的例子</center>

<h4 id="滤波-Filtering"><a href="#滤波-Filtering" class="headerlink" title="滤波 Filtering"></a>滤波 Filtering</h4><p>滤波是指对于某个特定的信号，仅保留其特定频率的信息。以图像为例，一个图的低通滤波等价于对这个图作用模糊效果，而一个图的高通滤波等价于描绘出这个图像的细节边界。</p>
<p>我们接下来要说明，对一张图做滤波，等价于对这张图做卷积（分 Box 加权平均）。</p>
<p><img src="https://i.loli.net/2021/11/08/txp4Ta7ugkn2IZ1.png" alt="image-20211108155427029"></p>
<center>卷积定理</center>

<p><strong>卷积定理</strong>是说，对时域的卷积，等价于对频域的乘积；在时域上的乘积，等价于在频域上的卷积。也就是说，如果我们想得到一张图像的滤波，有以下两种选择：</p>
<ul>
<li>在时域中对图像做卷积</li>
<li>先使用傅里叶变换将图像转化到频域，将其与 Box Filter 的频域相乘之后再做逆傅里叶变换</li>
</ul>
<p>事实上，这里的 Box Function 就相当于是一个低通滤波器，可以用来将图像模糊化。而这里 Box 越宽，所接受的频率就越低，所得到的图像也就越模糊。</p>
<h4 id="采样：重复频域上的内容"><a href="#采样：重复频域上的内容" class="headerlink" title="采样：重复频域上的内容"></a>采样：重复频域上的内容</h4><p><img src="https://i.loli.net/2021/11/08/1AHSzyQBpvDseNY.png" alt="image-20211108160150741"></p>
<p>卷积定理指出，在时域上的乘积，等价于在频域上的卷积。我们将原函数 $X<em>a(t)$​ 与冲激函数 $P</em>\delta(t)$ 做乘积，也就等价于将二者都使用 FFT 化归到频域后，将二者做卷积。而这结果表明，采样就是在重复一个原始信号的频谱。</p>
<p><img src="https://i.loli.net/2021/11/08/MC5PEF42YIJZDmR.png" alt="image-20211108160830500"></p>
<center>对走样的解释</center>

<p>而为什么会发生走样呢？采样的不同间隔，会引起频谱以不同的间隔去移动。如果我们采样的不够快，那么信号在频域上就产生了混叠现象。</p>
<h4 id="反走样的方法"><a href="#反走样的方法" class="headerlink" title="反走样的方法"></a>反走样的方法</h4><p>该怎么才能减少走样错误呢？</p>
<ul>
<li>增大采样率 （But very costly &amp; may need high resolution）</li>
<li>进行反走样操作：让图像的频谱的频宽变窄！如何做到？在采样前去掉高频信号！</li>
</ul>
<p>回到我们的问题上来，我们要解决现在存在的锯齿问题，也就是要先对原三角形进行模糊，然后再对其采样。那么该怎么对原来的三角形进行模糊呢？我们使用一个低通滤波器对其进行卷积即可。</p>
<p><img src="https://i.loli.net/2021/11/08/lCz2uI3KpdNhsiX.png" alt="image-20211108161654357"></p>
<center>通过计算像素点落在三角形中的平均面积来做滤波</center>

<p>而在我们具体解决问题的时候，我们选择 Supersampling 的方式，也就是将某个像素分为 $N\times N$ 个采样点，然后对这些采样点的像素值取平均。</p>
<p><img src="https://i.loli.net/2021/11/10/dlZQAvIWpihb67C.png" alt="image-20211110134128999"></p>
<p><img src="https://i.loli.net/2021/11/10/OabvGcD1oJsdrwP.png" alt="image-20211110134145650"></p>
<h3 id="深度缓冲"><a href="#深度缓冲" class="headerlink" title="深度缓冲"></a>深度缓冲</h3><p>本节我们主要立足于解决可见性/遮挡问题，解决方法就是<strong>深度缓存/深度缓冲</strong>（Z-Buffering）。</p>
<p>只有将模型按照一定的顺序放在屏幕上，才能达到正确的效果。直观的想法是，先画远处的，再画近处的，这样才能让近处的物体覆盖远处的物体。这样的算法叫做画家算法。而如果假设有 $n$ 个物体，进行 $O(n \log n)$​ 的排序后便可将其画出。但是这种算法的缺陷是，如何定义“远近”，即定义物体离相机所在处的深度，并不容易。</p>
<p><img src="https://i.loli.net/2021/11/10/K6cD4pCLA5aZSXd.png" alt="image-20211110135626091"></p>
<center>相互遮挡的例子</center>

<p>为了解决这个问题，图形学引入了深度缓存的概念。想法就是对屏幕的所有像素额外记录其当前显示物体的最浅深度（深度取正值，表示距离相机的远近）。这样类似于动态规划的算法最终复杂度是 $O(n)$ 的。而且如果我们假设在同一深度处不会出现两个模型，那么不同模型的着色顺序对结果是没有影响的。</p>
<p><img src="https://i.loli.net/2021/11/10/vkn5R7zfhoNZTjC.png" alt="image-20211110140334554"></p>
<center> 深度缓存算法 </center>

<h2 id="Shading-着色"><a href="#Shading-着色" class="headerlink" title="Shading 着色"></a>Shading 着色</h2><h3 id="Blinn-Phong-着色模型"><a href="#Blinn-Phong-着色模型" class="headerlink" title="Blinn-Phong 着色模型"></a>Blinn-Phong 着色模型</h3><p>着色是指引入明暗和颜色不同的过程，但在这里我们定义为对物体应用不同材质的过程。</p>
<p>于是我们在这里介绍一个简单的着色模型，Blinn-Phong Reflectance Model，其中包括高光，漫反射以及环境光照三部分。值得注意的是这个模型是 OpenGL 和 Direct3D 的默认着色模型。具体来说，其定义的参数如下：</p>
<p><img src="https://i.loli.net/2021/11/10/hjsMQS1zJblKIOa.png" alt="image-20211110141545558"></p>
<center> 概念的定义</center>

<p>着色是具有局部性的，即每次只考虑单个点，不考虑其他物体的存在。这样是无法表现阴影的。</p>
<h4 id="漫反射-Diffuse-Reflection"><a href="#漫反射-Diffuse-Reflection" class="headerlink" title="漫反射 Diffuse Reflection"></a>漫反射 Diffuse Reflection</h4><p>光线的接收：单位面积上接收到的光照强度为 $\cos \theta = I \cdot n$。</p>
<p>光线的反射：$I’ = \frac I {r^2}$​</p>
<p>漫反射后：$L_d = k_d(I/r^2)\max(0,\vec n \cdot \vec l)$​，其中 $k_d$ 是三维的 (R,G,B)，表示漫反射系数。</p>
<h4 id="高光-Specular-Term"><a href="#高光-Specular-Term" class="headerlink" title="高光 Specular Term"></a>高光 Specular Term</h4><p>基于如果 $v$ 视线方向和镜面方向相近，那么半程向量就跟平面法向相近的事实，我们定义半程向量 $h := bisector(v,l) = \frac {v+l} {||v+l||}$。</p>
<p>然后令 $L_s = k_s (I/r^2)max(0, \cos \alpha)^p=k_s (I/r^2)max(0, n \cdot h)^p$ 即可，其中 $k_s$ 为高光反射系数。</p>
<p>为什么要带有 $p$ 次方呢？这是因为我们想让产生高光的夹角处于一个相对较小的范围。</p>
<p><img src="https://i.loli.net/2021/11/10/lL5AVnJi8DhTZPb.png" alt="image-20211110200642332"></p>
<h4 id="环境光照-Ambientbu-Term"><a href="#环境光照-Ambientbu-Term" class="headerlink" title="环境光照 Ambientbu Term"></a>环境光照 Ambientbu Term</h4><p>环境光照的强度不取决于物体，我们在这里大胆假设每个地方、每个方向的环境光照的大小都相同。也就是说，这一项会填充图中的黑色区域，将图像整体提升某个光照强度。$L_a := k_aI_a$。</p>
<h3 id="着色频率"><a href="#着色频率" class="headerlink" title="着色频率"></a>着色频率</h3><p>不同的着色单位会有不同的着色效果，具体来说，可分为以下几种：</p>
<ul>
<li><p>逐三角形着色（Flat shading）：将每个三角形视作一个平面，但着色效果不够光滑。</p>
</li>
<li><p>逐顶点着色（Gourand shading）：使用插值的方法计算三角形内部的颜色值，但问题在于如何求顶点的法向。</p>
</li>
<li>逐像素着色（Phong shading）：对每个像素点进行模型计算。</li>
</ul>
<p><img src="https://i.loli.net/2021/11/10/rkst1SbMTCq9c7O.png" alt="image-20211110202506874"></p>
<p>值得注意的是，着色频率越低并不一定代表着效果越差。若几何体足够复杂，则可能区别甚小。</p>
<p>接下来就侧重于解决上述着色频率留下的问题：</p>
<p><img src="https://i.loli.net/2021/11/10/AldyF6mRwpCvb5a.png" alt="image-20211110202753142"></p>
<center>定义逐顶点的法线</center>

<p><img src="https://i.loli.net/2021/11/10/GJhlmoHwv2dMWaj.png" alt="image-20211110202853817"></p>
<center>定义逐像素法线</center>

<h3 id="图形管线-Graphic-Pipeline"><a href="#图形管线-Graphic-Pipeline" class="headerlink" title="图形管线 Graphic Pipeline"></a>图形管线 Graphic Pipeline</h3><p>从图形到场景的过程描述为图形管线。</p>
<p><img src="https://i.loli.net/2021/11/10/wmXdbSKyiNF95PJ.png" alt="image-20211110203343148"></p>
<h3 id="纹理映射-Texture-Mapping"><a href="#纹理映射-Texture-Mapping" class="headerlink" title="纹理映射 Texture Mapping"></a>纹理映射 Texture Mapping</h3><p>纹理映射，事实上是为每个三角形分配一个材质平面的坐标 $(u, v)$。</p>
<p><img src="https://i.loli.net/2021/11/11/hLBROgEdHIyfrkC.png" alt="image-20211111231357192"></p>
<p>其中那种拼接起来可以无限重复的材质我们称为 <strong>tiled</strong> texture.</p>
<h3 id="重心坐标插值"><a href="#重心坐标插值" class="headerlink" title="重心坐标插值"></a>重心坐标插值</h3><p>当我们知道了三角形的三个顶点的属性的时候，如果我们想要实现在三角形内部属性的平滑过渡，就要引入重心坐标的概念。</p>
<p><img src="https://i.loli.net/2021/11/11/iGVW3jLvqsERew8.png" alt="image-20211111231532132"></p>
<p>对于一个三角形 ABC 来说，其中 $(x,y) = \alpha A + \beta B + \gamma C$，若 $\alpha + \beta + \gamma = 1$，则称 $(\alpha, \beta, \gamma)$ 为该三角形内的 $(x,y)$ 点的重心坐标，其中 $\alpha, \beta, \gamma \ge 0$。</p>
<p><img src="https://i.loli.net/2021/11/11/U4jEISXchwARgZV.png" alt="image-20211111231732485"></p>
<p>而由此推导下去，在 $xOy$ 平面中我们有：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\alpha &=\frac{-\left(x-x_{B}\right)\left(y_{C}-y_{B}\right)+\left(y-y_{B}\right)\left(x_{C}-x_{B}\right)}{-\left(x_{A}-x_{B}\right)\left(y_{C}-y_{B}\right)+\left(y_{A}-y_{B}\right)\left(x_{C}-x_{B}\right)} \\
\beta &=\frac{-\left(x-x_{C}\right)\left(y_{A}-y_{C}\right)+\left(y-y_{C}\right)\left(x_{A}-x_{C}\right)}{-\left(x_{B}-x_{C}\right)\left(y_{A}-y_{C}\right)+\left(y_{B}-y_{C}\right)\left(x_{A}-x_{C}\right)} \\
\gamma &=1-\alpha-\beta
\end{aligned}</script><p>使用重心坐标可以方便我们做插值。具体来说，对于三角形 ABC，对于其内部点 $(x,y)=(\alpha, \beta, \gamma)$​，有 $V = \alpha V_A + \beta V_B + \gamma V_C$​。</p>
<p>但是值得注意的是，重心坐标在投影操作中可能会变化。这就会导致一些插值操作只能在三维空间中计算，比如计算深度插值，应该使用原始的三角形三维坐标来计算，而不应使用投影后的平面坐标。</p>
<h3 id="纹理应用-Applying-Texture"><a href="#纹理应用-Applying-Texture" class="headerlink" title="纹理应用 Applying Texture"></a>纹理应用 Applying Texture</h3><p>我们可以将纹理的颜色值设置为模型对应位置的漫反射系数，从而达到应用纹理的效果。</p>
<p>而一个像素对应的纹理的颜色值，则可以通过插值的方式计算得出。</p>
<p>这里我们可能遇到问题：</p>
<ul>
<li>如果材质对应的图像过小怎么办？</li>
<li>如果材质对应的图像过大怎么办？</li>
</ul>
<p>对于前者，我们可以使用双线性插值的方法来缓解。</p>
<p><img src="https://i.loli.net/2021/11/15/HqSbWhcoGAE8rsK.png" alt="image-20211115164939643"></p>
<p>而对于后者，我们可以使用 Mipmap / 各向异性过滤的方法来解决。</p>
<p>事实上，我们可以将纹理视为是内存中的一个数据结构，提供了便捷的查询接口，而非将纹理视为是一张图片。</p>
<h3 id="用纹理做环境光反射效果"><a href="#用纹理做环境光反射效果" class="headerlink" title="用纹理做环境光反射效果"></a>用纹理做环境光反射效果</h3><p>纹理可以用来做环境光反射的效果。实际上，如果我们将来自环境的光照组织成纹理：</p>
<p><img src="https://i.loli.net/2021/11/27/8CwUR6qT5uvHSyt.png" alt="image-20211127173639430"></p>
<center>犹他茶壶</center>

<p>环境光可以通过记录在球面上，然后将球面展开，就可以得到环境光照对应的纹理。但是这样做在纹理上下会有明显的扭曲现象。</p>
<p><img src="https://i.loli.net/2021/11/27/xv2lRyBA1a8PDG6.png" alt="image-20211127174058860"></p>
<p>为了解决这个扭曲的问题，我们使用如下的方案：</p>
<p><img src="https://i.loli.net/2021/11/27/TmiStDkjVz3IsNA.png" alt="image-20211127174158530"></p>
<p>将球面上的每个点映射到恰好包围球的包围盒的表面上（沿球面法向）。然后将包围盒展开成六个表面。</p>
<h3 id="用纹理做凹凸贴图"><a href="#用纹理做凹凸贴图" class="headerlink" title="用纹理做凹凸贴图"></a>用纹理做凹凸贴图</h3><p>事实上，我们的纹理不只是可以用来替换 Blinn-Phong 反射模型中的 $k_d$ 值。我们可以用纹理来描述表面的“属性”，比如待渲染表面的凹凸感，便可以用纹理来记录表面的相对高度。</p>
<p>其实我们可以用足够多的三角形来模拟出凹凸效果，但是这样势必会导致性能上的衰减。使用纹理来做凹凸贴图可以在不改变原模型的几何复杂程度的情况之下，达到渲染出带有凹凸感的图像的目的。</p>
<h4 id="凹凸贴图的推导"><a href="#凹凸贴图的推导" class="headerlink" title="凹凸贴图的推导"></a>凹凸贴图的推导</h4><p>计算过程：修改高度值 -&gt; 重新计算法向量值 -&gt; 着色。</p>
<p><img src="https://i.loli.net/2021/12/01/FfaVTe4LkvhR9u2.png" alt="image-20211201185543817"></p>
<center> Local Coordinate : 换基 </center>

<h4 id="位移贴图"><a href="#位移贴图" class="headerlink" title="位移贴图"></a>位移贴图</h4><p>凹凸贴图并没有改变自己的几何，所以在边缘上看不出凹凸感。同时在阴影上也体现不出来凹凸感。而位移贴图实际上改变了模型几何的位置。但我们需要要求模型足够细致。</p>
<h2 id="Geometry-几何"><a href="#Geometry-几何" class="headerlink" title="Geometry 几何"></a>Geometry 几何</h2><h3 id="几何的表示"><a href="#几何的表示" class="headerlink" title="几何的表示"></a>几何的表示</h3><p>几何的分类：Implicit 的几何和 Explicit 的几何。</p>
<p>Implicit 的几何是说，满足某些特定关系的点构成的几何，即 $f(x,y,z)=0$；Implicit 对于找出集合中的所有点很困难，但是要想判断某个点在不在其中很容易。</p>
<p>Explicit 的表示是说，通过参数映射的方法来定义表面，即将平面上的点 $(u,v)$ 映射到三维坐标 $(x,y,z)$​​​. 想找出几何体表面集合中的所有点，只需变化 $u,v$ 的值即可。但是不容易判断某个点在不在其中。</p>
<p>不同的表示方法，需要根据需要来选择。</p>
<p>此外，隐式表示还可以用 CSG(Constructive Solid Geometry) 的方法来构造，如 $A \cup B, A\cap B, A\backslash B$.</p>
<p><img src="https://i.loli.net/2021/12/01/PfKUJDwvi4FC6ZQ.png" alt="image-20211201192043523"></p>
<center> CSG 的例子 </center>

<p>隐式表示还可以用距离函数、水平集、分形等等方法来定义。</p>
<p>显式表示可以用点云，多边形面（obj 文件）等等表示。</p>
<h3 id="曲线"><a href="#曲线" class="headerlink" title="曲线"></a>曲线</h3><h4 id="贝塞尔曲线"><a href="#贝塞尔曲线" class="headerlink" title="贝塞尔曲线"></a>贝塞尔曲线</h4><p>用一系列的控制点定义出满足某些性质的曲线。</p>
<p>曲线的起点为控制点的起点，终点为控制点的终点，起始点处与终点处的切线分别为 $\overrightarrow {P<em>0P_1}, \overrightarrow{P</em>{n-1}P_n}$.</p>
<p><strong>如何画贝塞尔曲线：de Casteljau Algorithm</strong></p>
<p>（1）先考虑三个控制点，生成二次贝塞尔曲线。</p>
<p><img src="https://i.loli.net/2021/12/01/fE6FrtaL2sDQIGT.png" alt="image-20211201194418429"></p>
<p>（2）再考虑四个控制点，生成三次贝塞尔曲线。</p>
<p><img src="https://i.loli.net/2021/12/01/wR7VDnSPCrLxkKY.png" alt="image-20211201194528603"></p>
<p>(3) 代数形式：插值！</p>
<p><img src="https://i.loli.net/2021/12/01/pmW5vVa61urdbxI.png" alt="image-20211201194639946"></p>
<p>给定 $n+1$ 个控制点，有贝塞尔曲线如下：</p>
<script type="math/tex; mode=display">
b^n(t) = b^n_0(t) = \sum_{j=0}^nb_jB_j^n(t) \\
B_{i}^{n}(t)=\left(\begin{array}{l}
n\\
i
\end{array}\right) t^{i}(1-t)^{n-i}</script><p>贝塞尔曲线的性质：</p>
<script type="math/tex; mode=display">
(1) \ \ b(0) = b_0; \ b(1)=b_{n}\\
(2) \ \ b'(0)=3(b_1-b_0); \ b'(1) = 3(b_3-b_2) \ (For \ cubic \ cases) \\</script><p>(3) 在仿射变换下不变；</p>
<p>(4) 曲线包含在控制点的凸包（包含所有控制点的最小凸多边形）内。</p>
<p><strong>逐段形成贝塞尔曲线</strong>：每四个控制点形成一段贝塞尔曲线，并将其连接。</p>
<p>保证切线光滑？导数连续！保证性质(2)成立即可。</p>
<p>两段贝塞尔曲线的连续： $C^0$ 连续指点重合，$C^1$ 连续指导数连续，以此类推。</p>
<h4 id="其它曲线"><a href="#其它曲线" class="headerlink" title="其它曲线"></a>其它曲线</h4><p>样条（Spline），B-样条（basis splines），具有好的局部性。</p>
<h3 id="曲面"><a href="#曲面" class="headerlink" title="曲面"></a>曲面</h3><h4 id="贝塞尔曲面"><a href="#贝塞尔曲面" class="headerlink" title="贝塞尔曲面"></a>贝塞尔曲面</h4><p><img src="https://i.loli.net/2021/12/01/SbHh4tNQ7RKZWTy.png" alt="image-20211201201257424"></p>
<h4 id="面上的操作"><a href="#面上的操作" class="headerlink" title="面上的操作"></a>面上的操作</h4><ul>
<li>Subdivision</li>
<li>Simplification</li>
<li>Regularization</li>
</ul>
<h5 id="细分"><a href="#细分" class="headerlink" title="细分"></a>细分</h5><p>(1) 分出更多三角形 (2) 将新的三角形的位置改变，使得原模型更加光滑</p>
<p><strong>Loop Subdivision</strong></p>
<p><img src="https://i.loli.net/2021/12/01/5BsOmrFeHV29QaI.png" alt="image-20211201202358001"></p>
<p><img src="https://i.loli.net/2021/12/01/YmIofNMZ3GVULzd.png" alt="image-20211201202518340"></p>
<p><strong>Catmull-Clark Subdivision</strong></p>
<p>针对于一般的曲面，而非三角形作为图源。</p>
<p>定义：非四边形面，奇异点（度不为 4 的点）</p>
<p>细分的方式：引入点的操作十分简单，取每面的中点和该面的边的中点，并将其连接。</p>
<p>调整位置的方法：分为三种。</p>
<p><img src="https://i.loli.net/2021/12/01/uMlYoxDHJwWpq8B.png" alt="image-20211201204717217"></p>
<h5 id="简化"><a href="#简化" class="headerlink" title="简化"></a>简化</h5><p><strong>边坍缩</strong> Edge Collapse</p>
<p>Quadric Error Metrics 二次误差度量 寻找去 Collapse 某条边后新顶点的位置。</p>
<p><img src="https://i.loli.net/2021/12/01/fW8sR1ntNzoLdHa.png" alt="image-20211201205342215"></p>
<p>将所有边按二次误差测量排序，坍缩最小值所在边，更新受影响的其他边的权重。用堆来维护！</p>
<h2 id="光线追踪-Ray-Tracing"><a href="#光线追踪-Ray-Tracing" class="headerlink" title="光线追踪 Ray Tracing"></a>光线追踪 Ray Tracing</h2><h3 id="从问题出发"><a href="#从问题出发" class="headerlink" title="从问题出发"></a>从问题出发</h3><p>如何用光栅化的手法解决阴影的问题？</p>
<p>重要思想：点不在阴影中，当且仅当点必须同时被光源和摄像机看到。</p>
<ol>
<li>从光源看向场景（用 Z-buffer’ 记录深度）</li>
<li>从摄像机看向场景</li>
<li>如果两深度相同，则无需阴影；若两深度不同，则在阴影中。</li>
</ol>
<p>这样做存在的问题：</p>
<ul>
<li>Hard shadows</li>
</ul>
]]></content>
  </entry>
</search>
