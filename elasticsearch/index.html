<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ElasticSearch 实现搜索网站纪实 | c7w 的博客</title><meta name="keywords" content="ElasticSearch"><meta name="author" content="c7w"><meta name="copyright" content="c7w"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="事实上是挑战杯要搭一个文书搜索网站…暂时需要用 BM25 算法顶一下。 Elasticsearch 的默认相似度算法就是 BM25，嘛嘛，大胜利。 搜索的对象是…数目约在 $10^8$ 规模左右的文档… 嘛嘛，反正都是大调库。缝合就完事了。 &#x2F;&#x2F; WIP: 应该不会咕">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch 实现搜索网站纪实">
<meta property="og:url" content="https://www.c7w.tech/elasticsearch/index.html">
<meta property="og:site_name" content="c7w 的博客">
<meta property="og:description" content="事实上是挑战杯要搭一个文书搜索网站…暂时需要用 BM25 算法顶一下。 Elasticsearch 的默认相似度算法就是 BM25，嘛嘛，大胜利。 搜索的对象是…数目约在 $10^8$ 规模左右的文档… 嘛嘛，反正都是大调库。缝合就完事了。 &#x2F;&#x2F; WIP: 应该不会咕">
<meta property="og:locale">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2022-02-15T13:56:16.000Z">
<meta property="article:modified_time" content="2022-03-03T14:24:58.613Z">
<meta property="article:author" content="c7w">
<meta property="article:tag" content="ElasticSearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://www.c7w.tech/elasticsearch/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?08d6b753db81329ea728103fd0d2f84e";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ElasticSearch 实现搜索网站纪实',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-03 22:24:58'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="c7w 的博客" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2022/01/03/i8fNgXEPZDqnIlS.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">54</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://docs.net9.org/"><i class="fa-fw fas fa-book"></i><span> Docs</span></a></div><div class="menus_item"><a class="site-page" href="/friends/"><i class="fa-fw fas fa-heart"></i><span> Friends</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">c7w 的博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://docs.net9.org/"><i class="fa-fw fas fa-book"></i><span> Docs</span></a></div><div class="menus_item"><a class="site-page" href="/friends/"><i class="fa-fw fas fa-heart"></i><span> Friends</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ElasticSearch 实现搜索网站纪实</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-15T13:56:16.000Z" title="发表于 2022-02-15 21:56:16">2022-02-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-03T14:24:58.613Z" title="更新于 2022-03-03 22:24:58">2022-03-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/%E6%8A%80%E6%9C%AF-%E5%90%8E%E7%AB%AF/">技术/后端</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>29分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ElasticSearch 实现搜索网站纪实"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>事实上是挑战杯要搭一个文书搜索网站…暂时需要用 BM25 算法顶一下。</p>
<p>Elasticsearch 的默认相似度算法就是 BM25，嘛嘛，大胜利。</p>
<p>搜索的对象是…数目约在 $10^8$ 规模左右的文档…</p>
<p>嘛嘛，反正都是大调库。缝合就完事了。</p>
<p>// WIP: 应该不会咕</p>
<a id="more"></a>
<h2 id="索引算法"><a href="#索引算法" class="headerlink" title="索引算法"></a>索引算法</h2><p>我们首先介绍下 Sparse Retrieval 的主要算法，TF-IDF 算法和 BM25 算法。</p>
<h3 id="TF-IDF"><a href="#TF-IDF" class="headerlink" title="TF-IDF"></a>TF-IDF</h3><p>TF 是指归一化的词频，IDF 是指逆文档频率。给定文档集合 $D$，有 $d_i \in D, 1 \le i \le n$. </p>
<p>文档集合总共包含 $m$​ 个词，去除一些十分常见的词作为停用词（Stop Words），有 $w_i \in W, 1 \le i \le m$​.</p>
<p>定义 TF 如下，即一篇文档中某个词出现的频率：</p>
<script type="math/tex; mode=display">
\text{TF}(q_i, d_j) = \dfrac {f_{i, d_j}}{ |d_j| }</script><p>TF 只能描述词在文档中的频率，但假设现在有个词为“我们”，这个词可能在文档集 $D$ 中每篇文档中都会出现，并且有较高的频率。那么这一类词就不具有很好的区分文档的能力，为了降低这种通用词的作用，引入了 IDF：</p>
<script type="math/tex; mode=display">
\text{IDF}(q_i) = \ln \dfrac {|D|}{|\{d_i  : q_i \in d_i \}|}</script><p>于是我们综合这两部分， 便可以得到 TF-IDF：</p>
<script type="math/tex; mode=display">
\text{TF-IDF} = \text{TF} * \text{IDF}</script><p>TF 可以计算在一篇文档中词出现的频率，而 IDF 可以降低一些通用词的作用。因此对于一篇文档我们可以用文档中每个词的 TF−IDF 组成的向量来表示该文档，再根据余弦相似度这类的方法来计算文档之间的相关性。</p>
<h3 id="BM25"><a href="#BM25" class="headerlink" title="BM25"></a>BM25</h3><p>BM25 是信息索引领域用来计算 query 与文档相似度得分的经典算法。</p>
<p>不同于 TF-IDF，BM25 的公式主要由三个部分组成：</p>
<ol>
<li>query 中每个单词 $q_i$ 与文档 $d$ 之间的相关性</li>
<li>单词 $q_i$ 与 query 之间的相似性</li>
<li>每个单词的权重</li>
</ol>
<p>BM25 算法的一般公式：</p>
<script type="math/tex; mode=display">
score(Q,d) = \sum_i^n W_i R(q_i, d)</script><p>其中 $Q$ 表示 query，$q_i \in Q$，$d$​ 表示 document.</p>
<p>下展开介绍各部分公式：</p>
<ul>
<li><strong>$W_i$</strong></li>
</ul>
<script type="math/tex; mode=display">
W_i = IDF(q_i) = \ln \dfrac {N-df_i+0.5}{df_i+0.5}</script><p>其中 $N$​​ 是 document 总数，$df_i$​ 表示含有 $q_i$​ 的文档总数。</p>
<p>依据 IDF 的作用，对于某个 $q_i$​ ，包含 $q_i$ 的文档数越多，说明 $q_i$ 重要性越小，或者区分度越低，IDF 越小，因此 IDF 可以用来刻画 $q_i$ 与文档的相似性。</p>
<ul>
<li><strong>$R(q_i, d)$​</strong></li>
</ul>
<p>BM25 的设计依据一个重要的发现：<strong>词频和相关性之间的关系是非线性的</strong>，也就是说，每个词对于文档的相关性分数不会超过一个特定的阈值，当词出现的次数达到一个阈值后，其影响就不在线性增加了，而这个阈值会跟文档本身有关。</p>
<script type="math/tex; mode=display">
R(q_i, d) = \dfrac {f_i \cdot (k_1+1)}{f_i+K} \cdot \dfrac {qf_i \cdot(k_2+1)}{qf_i+k_2}</script><p>我们可以分成两部分来看待上述公式，其中 $f_i$​ 为 $q_i$​ 在 $d$​ 中出现的次数，$k_1, k_2, K$​ 是常数。</p>
<p>后一部分 $\dfrac {qf_i \cdot(k_2+1)}{qf_i+k_2}$ 在控制 $q_i$​ 和 Query 的相似度。</p>
<p>前一部分在计算 $q_i$ 与 $d$​ 的相似度，其中 $K = k_1 \cdot (1-b+b\cdot \dfrac {|d|}{AVG_n(|d|)})$，参数 $b$ 在调节文本长度对相关性的影响。</p>
<p>不失一般性地我们可以取 $k_1 = 2, k_2 = 0, b = 0.75$​.</p>
<p>反正在接下来的运用也是大调库，调参数可以通过更改配置文件来进行。</p>
<h2 id="网站搭建纪实：Elasticsearch"><a href="#网站搭建纪实：Elasticsearch" class="headerlink" title="网站搭建纪实：Elasticsearch"></a>网站搭建纪实：Elasticsearch</h2><blockquote>
<p><strong>Elasticsearch</strong> is the distributed <strong>search and analytics engine</strong> at the heart of the Elastic Stack. <em>Logstash</em> and <em>Beats</em> facilitate collecting, aggregating, and enriching your data and storing it in Elasticsearch. <em>Kibana</em> enables you to interactively explore, visualize, and share insights into your data and manage and monitor the stack. <strong>Elasticsearch is where the indexing, search, and analysis magic happens.</strong></p>
<p>Elasticsearch 是一个开源的搜索引擎，建立在一个全文搜索引擎库 Apache Lucene™ 基础之上。</p>
<p>那 Lucene 又是什么？Lucene 可能是目前存在的，不论开源还是私有的，拥有最先进，高性能和全功能搜索引擎功能的库，但也仅仅只是一个库。</p>
<p>要用上 Lucene，我们需要编写 Java 并引用 Lucene 包才可以，而且我们需要对信息检索有一定程度的理解才能明白 Lucene 是怎么工作的，反正用起来没那么简单。</p>
<p>那么为了解决这个问题，Elasticsearch 就诞生了。Elasticsearch 也是使用 Java 编写的，它的内部使用 Lucene 做索引与搜索，但是它的目标是使全文检索变得简单，相当于 Lucene 的一层封装，它提供了一套简单一致的 RESTful API 来帮助我们实现存储和检索。</p>
<p>所以 Elasticsearch 仅仅就是一个简易版的 Lucene 封装吗？那就大错特错了，Elasticsearch 不仅仅是 Lucene，并且也不仅仅只是一个全文搜索引擎。它可以被下面这样准确的形容：</p>
<ul>
<li>一个分布式的实时文档存储，每个字段可以被索引与搜索</li>
<li>一个分布式实时分析搜索引擎</li>
<li>能胜任上百个服务节点的扩展，并支持 PB 级别的结构化或者非结构化数据</li>
</ul>
<p>总之，是一个相当牛逼的搜索引擎，维基百科、Stack Overflow、GitHub 都纷纷采用它来做搜索。</p>
</blockquote>
<p>总之我们先来到了下载网站看看：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch。然后选择了适用">https://www.elastic.co/cn/downloads/elasticsearch。然后选择了适用</a> Linux 的安装方式：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/targz.html。然后就是把">https://www.elastic.co/guide/en/elasticsearch/reference/current/targz.html。然后就是把</a> <code>./config/elasticsearch.yml</code> 的关于安全的设定全部设置成 <code>false</code>（毕竟还要过一层 Django 转接）。然后执行 <code>curl localhost:9200</code>，返回：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"thunlp-3"</span><span class="token punctuation">,</span>
  <span class="token property">"cluster_name"</span> <span class="token operator">:</span> <span class="token string">"elasticsearch"</span><span class="token punctuation">,</span>
  <span class="token property">"cluster_uuid"</span> <span class="token operator">:</span> <span class="token string">"7O7KbQ6hQGOUieAXeKm10g"</span><span class="token punctuation">,</span>
  <span class="token property">"version"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"number"</span> <span class="token operator">:</span> <span class="token string">"8.0.0"</span><span class="token punctuation">,</span>
    <span class="token property">"build_flavor"</span> <span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>
    <span class="token property">"build_type"</span> <span class="token operator">:</span> <span class="token string">"tar"</span><span class="token punctuation">,</span>
    <span class="token property">"build_hash"</span> <span class="token operator">:</span> <span class="token string">"1b6a7ece17463df5ff54a3e1302d825889aa1161"</span><span class="token punctuation">,</span>
    <span class="token property">"build_date"</span> <span class="token operator">:</span> <span class="token string">"2022-02-03T16:47:57.507843096Z"</span><span class="token punctuation">,</span>
    <span class="token property">"build_snapshot"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"lucene_version"</span> <span class="token operator">:</span> <span class="token string">"9.0.0"</span><span class="token punctuation">,</span>
    <span class="token property">"minimum_wire_compatibility_version"</span> <span class="token operator">:</span> <span class="token string">"7.17.0"</span><span class="token punctuation">,</span>
    <span class="token property">"minimum_index_compatibility_version"</span> <span class="token operator">:</span> <span class="token string">"7.0.0"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"tagline"</span> <span class="token operator">:</span> <span class="token string">"You Know, for Search"</span>
<span class="token punctuation">&#125;</span></code></pre>
<blockquote>
<p>观前提示：官方的中文 Doc 已经过时了，不少接口和格式都已经改了，请阅读最新版的文档。<s>好大的坑</s></p>
<p>2022-2-17 00:23:38：姑且是把后端调通了，不过这份学习笔记我觉得可以近似作废了，找时间再改吧。下面的教程并不适用 ES 最新版本，虽然大多数思想是相同的，比较便于迁移学习。</p>
</blockquote>
<h3 id="Node-与-Cluster"><a href="#Node-与-Cluster" class="headerlink" title="Node 与 Cluster"></a>Node 与 Cluster</h3><p>Elastic 本质上是一个<strong>分布式</strong>数据库，允许多台服务器协同工作，每台服务器可以运行多个 Elastic 实例。</p>
<p>单个 Elastic 实例称为一个<strong>节点</strong>（node）。一组节点构成一个<strong>集群</strong>（cluster）。</p>
<h4 id="集群与分布式"><a href="#集群与分布式" class="headerlink" title="集群与分布式"></a>集群与分布式</h4><p>（只是趁着这次机会顺便就把 Elasticsearch 上手学一遍，这次毕竟只有单节点（x）</p>
<blockquote>
<p>事实上，Elasticsearch 被设计出来就是以集群运作为基础的。</p>
<p>ElasticSearch 的主旨是随时可用和按需扩容。 而扩容可以通过购买性能更强大（垂直扩容，或纵向扩容）或者数量更多的服务器（水平扩容，或横向扩容）来实现。虽然 Elasticsearch 可以获益于更强大的硬件设备，但是垂直扩容是有极限的。 真正的扩容能力是来自于水平扩容—为集群添加更多的节点，并且将负载压力和稳定性分散到这些节点中。</p>
</blockquote>
<ul>
<li>结点与集群：一个运行中的 Elasticsearch 实例称为一个节点，而集群是由一个或者多个拥有相同 <code>cluster.name</code> 配置的节点组成， 它们共同承担数据和负载的压力。当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。</li>
<li>主节点：管理集群范围内的所有变更，例如增加、删除索引，或者增加、删除节点等。用户可以将请求发送到任意结点，每个节点都知道任意文档所处的位置，并且能够将我们的请求直接转发到存储我们所需文档的节点。</li>
<li>集群健康状态：通过 <code>[GET] /_cluster/health</code> 可以查询当前节点所在集群的状态。其中返回值的 <code>status</code> 字段如果为 <code>green</code>，代表所有主分片和副本分片都在正常运行；如果为 <code>yellow</code>，代表所有主分片都在正常运行，副本分片并不是都在正常运行；如果为 <code>red</code>，说明有主分片没能正常运行。</li>
<li>主分片与副本分片：<ul>
<li>分片：索引实际上是指向一个或者多个物理<strong>分片</strong>的逻辑命名空间。一个分片是一个底层的工作单元，它保存了全部数据中的一部分。现在我们只需知道一个分片是一个 Lucene 的实例，以及它本身就是一个完整的搜索引擎。 我们的文档被存储和索引到分片内，但是应用程序是直接与索引而不是与分片进行交互。</li>
<li>主分片：索引内任意一个文档都归属于一个主分片，所以主分片的数目决定着索引能够保存的最大数据量。</li>
<li>副本分片：一个副本分片只是一个主分片的拷贝。副本分片作为硬件故障时保护数据不丢失的冗余备份，并为搜索和返回文档等读操作提供服务。副本分片的存在目的是为了在故障的情况下不至于丢失数据。如在下图这个具有三个节点的集群中，$P_i$ 代表主分片，$R_i$ 代表副本分片，每个主分片拥有 2 个其对应的副本分片。</li>
</ul>
</li>
</ul>
<p><img src="https://www.elastic.co/guide/cn/elasticsearch/guide/current/images/elas_0205.png" alt="拥有2份副本分片3个节点的集群"></p>
<h3 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h3><p>Index 里面单条的记录称为 Document（<strong>文档</strong>）。许多条 Document 构成了一个 Index。</p>
<p>Document 使用 JSON 格式表示，下面是一个例子。</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"user"</span><span class="token operator">:</span> <span class="token string">"张三"</span><span class="token punctuation">,</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"工程师"</span><span class="token punctuation">,</span>
  <span class="token property">"desc"</span><span class="token operator">:</span> <span class="token string">"数据库管理"</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>同一个 Index 里面的 Document，<strong>不要求有相同的结构</strong>（scheme），但是最好保持相同，这样有利于提高搜索效率。</p>
<p>文档的元数据：</p>
<ul>
<li><p><strong><code>_id</code></strong>：文档的 ID 字符串</p>
</li>
<li><p><strong><code>_type</code></strong>：文档的类型名</p>
</li>
<li><p><strong><code>_index</code></strong>：文档所在的索引</p>
</li>
<li><p><strong><code>_uid</code></strong>：<code>_type</code> 和 <code>_id</code> 连接在一起构造成 <code>type#id</code></p>
</li>
<li><strong><code>_source</code></strong>：原模原样的 JSON 文件</li>
<li><strong><code>_all</code></strong>：全文拼接</li>
</ul>
<p>文档路由到分片中的方式为：<code>shard = hash(routing) % number_of_primary_shards</code>，其中默认 <code>routing</code> 是一个可变值，默认是文档的 <code>_id</code>。所有的文档 API（<code>get</code>、<code>index</code>、<code>delete</code>、<code>bulk</code>、<code>update</code> 以及 <code>mget</code>）都接受一个叫做 <code>routing</code> 的路由参数 ，通过这个参数我们可以自定义文档到分片的映射。</p>
<h3 id="Indexing"><a href="#Indexing" class="headerlink" title="Indexing"></a>Indexing</h3><p>Elastic 会索引所有字段，经过处理后写入一个<strong>倒排索引</strong>（Inverted Index）。查找数据的时候，直接查找该索引。</p>
<p>所以，Elastic 数据管理的顶层单位就叫做<strong>索引</strong>（Index）。它是单个数据库的同义词。每个 Index （即数据库）的名字必须是小写。</p>
<h4 id="索引与中文分析器"><a href="#索引与中文分析器" class="headerlink" title="索引与中文分析器"></a>索引与中文分析器</h4><ul>
<li>索引的创建</li>
</ul>
<pre class="language-json" data-language="json"><code class="language-json">PUT /my_index
<span class="token punctuation">&#123;</span>
    <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"number_of_shards"</span> <span class="token operator">:</span>   <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// 主分片数</span>
        <span class="token property">"number_of_replicas"</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type_one"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> ... any mappings ... <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"type_two"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> ... any mappings ... <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        ...
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<ul>
<li>索引的删除：<code>[DELETE] /my_index</code></li>
</ul>
<h5 id="分析器-Analysis"><a href="#分析器-Analysis" class="headerlink" title="分析器 Analysis"></a>分析器 Analysis</h5><ul>
<li><p>索引的设置：分析器（<code>analysis</code>），用于将全文字符串转换为适合搜索的倒排索引的工具。</p>
</li>
<li><p>何为<strong>分析</strong>？</p>
</li>
</ul>
<p><strong>Exact Values 与 Full Text</strong></p>
<p>Elasticsearch 中的数据可以分为两类：精确值（Exact Values）和全文本（Full Text）。</p>
<p>精确值是指一些精确的数据，比如日期或者用户 ID。相比较起来，精确值类型的数据很容易查询。结果是二进制的：要么匹配查询，要么不匹配。</p>
<p>全文本数据指的是长文本数据，比如一个推文的内容或者一封邮件的内容。查询全文数据要微妙的多。我们问的不只是“这个文档匹配查询吗”，而是“该文档匹配查询的程度有多大？”换句话说，该文档与给定查询的相关性如何？</p>
<p>为了促进这类在全文本域中的查询，Elasticsearch 首先 <strong>分析</strong> 文档，之后根据结果创建 <strong>倒排索引</strong> 。在接下来的两节，我们会讨论倒排索引和分析过程。</p>
<p><strong>倒排索引</strong></p>
<p>Elasticsearch 使用一种称为 <strong>倒排索引</strong> 的结构，它适用于快速的全文搜索。一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，有一个包含它的文档列表。</p>
<p>例如，假设我们有两个文档，每个文档的 <code>content</code> 域包含如下内容：</p>
<ol>
<li>The quick brown fox jumped over the lazy dog</li>
<li>Quick brown foxes leap over lazy dogs in summer</li>
</ol>
<p>为了创建倒排索引，我们首先将每个文档的 <code>content</code> 域拆分成单独的词（我们称它为 <code>词条</code> 或 <code>tokens</code> ），创建一个包含所有不重复词条的排序列表，然后列出每个词条出现在哪个文档。结果如下所示：</p>
<pre class="language-none"><code class="language-none">Term      Doc_1  Doc_2
-------------------------
Quick   |       |  X
The     |   X   |
brown   |   X   |  X
dog     |   X   |
dogs    |       |  X
fox     |   X   |
foxes   |       |  X
in      |       |  X
jumped  |   X   |
lazy    |   X   |  X
leap    |       |  X
over    |   X   |  X
quick   |   X   |
summer  |       |  X
the     |   X   |
------------------------</code></pre>
<p>现在，如果我们想搜索 <code>quick brown</code> ，我们只需要查找包含每个词条的文档：</p>
<pre class="language-none"><code class="language-none">Term      Doc_1  Doc_2
-------------------------
brown   |   X   |  X
quick   |   X   |
------------------------
Total   |   2   |  1</code></pre>
<p>但是，我们目前的倒排索引有一些问题：</p>
<ul>
<li><code>Quick</code> 和 <code>quick</code> 以独立的词条出现，然而用户可能认为它们是相同的词。</li>
<li><code>fox</code> 和 <code>foxes</code> 非常相似, 就像 <code>dog</code> 和 <code>dogs</code> ；他们有相同的词根。</li>
<li><code>jumped</code> 和 <code>leap</code>, 尽管没有相同的词根，但他们的意思很相近。他们是同义词。</li>
</ul>
<p>如果我们将词条和用户查询都规范为标准模式，那么我们可以找到与用户搜索的词条不完全一致，但具有足够相关性的文档。</p>
<p>这种<strong>分词</strong>和<strong>标准化</strong>的过程就称为是<strong>分析</strong>。</p>
<p><strong>分析和分析器</strong></p>
<p><strong>分析</strong>包含下面的过程：</p>
<ul>
<li>首先，将一块文本分成适合于倒排索引的独立的 <strong>Tokens</strong></li>
<li>之后，将这些词条统一化为标准格式以提高它们的“可搜索性”</li>
</ul>
<p><strong>分析器</strong>执行上面的工作。 <strong>分析器</strong> 实际上是将三个功能封装到了一个包里：</p>
<ul>
<li><p><strong>字符过滤器</strong></p>
<p>首先，字符串按顺序通过每个 <strong>字符过滤器</strong> 。他们的任务是在分词前整理字符串。一个字符过滤器可以用来去掉 HTML，或者将 <code>&amp;</code> 转化成 <code>and</code>。</p>
</li>
<li><p><strong>分词器</strong></p>
<p>其次，字符串被 <strong>分词器</strong> 分为单个的词条。一个简单的分词器遇到空格和标点的时候，可能会将文本拆分成词条。</p>
</li>
<li><p><strong>Token 过滤器</strong></p>
<p>最后，词条按顺序通过每个 <strong>token 过滤器</strong> 。这个过程可能会改变词条（例如，小写化 <code>Quick</code> ），删除词条（例如， 像 <code>a</code>， <code>and</code>， <code>the</code> 等无用词，我们一般称为停用词，Stop Word），或者增加词条（例如，像 <code>jump</code> 和 <code>leap</code> 这种同义词）。</p>
</li>
</ul>
<p><strong>内置的分析器</strong></p>
<ul>
<li>Standard analyzer：对于西方语种表现较好，标准分析器</li>
<li>Simple analyzer：在任何不是字母的地方分隔文本，将词条小写</li>
<li>Whitespace analyzer：在空格的地方划分文本</li>
<li>Language analyzers：考虑指定语言的特点的分析器</li>
</ul>
<p><strong>测试分析器</strong></p>
<pre class="language-json" data-language="json"><code class="language-json">GET /_analyze
<span class="token punctuation">&#123;</span>
  <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span>
  <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"Text to analyze"</span>
<span class="token punctuation">&#125;</span></code></pre>
<p><strong>中文分析器</strong></p>
<p>在本节的最后会介绍一个中文分析器插件 IK Analysis for Elasticsearch：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></li>
</ul>
<p>提供的分析器：</p>
<ul>
<li><code>ik_smart</code>：将需要分词的文本做最大粒度的拆分。</li>
<li><code>ik_max_word</code>：将需要分词的文本做最小粒度的拆分，尽量分更多的词。</li>
</ul>
<p>安装：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./elasticsearch-plugin -v <span class="token function">install</span> https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v8.0.0/elasticsearch-analysis-ik-8.0.0.zip</code></pre>
<h4 id="Type-amp-Mappings"><a href="#Type-amp-Mappings" class="headerlink" title="Type &amp; Mappings"></a>Type &amp; Mappings</h4><p>Document 可以分组，比如 <code>weather</code> 这个 Index 里面，可以按城市分组（北京和上海），也可以按气候分组（晴天和雨天）。这种分组就叫做 Type，它是虚拟的逻辑分组，用来过滤 Document。</p>
<p>不同的 Type 应该有相似的结构（schema），举例来说，<code>id</code> 字段不能在这个组是字符串，在另一个组是数值。这是与关系型数据库的表的<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/guide/current/mapping.html">一个区别</a>。性质完全不同的数据（比如 <code>products</code> 和 <code>logs</code>）应该存成两个 Index，而不是一个 Index 里面的两个 Type（虽然可以做到）。</p>
<p>类型（Type）由名称（Name）和映射（Mapping）组成。<strong>映射</strong>，就像数据库中的 schema，描述了文档可能具有的字段或属性以及每个字段的数据类型 —— 比如 <code>string</code>，<code>integer</code> 或 <code>date</code> —— 以及 Lucene 是如何索引和存储这些字段的。</p>
<h5 id="映射-Mappings"><a href="#映射-Mappings" class="headerlink" title="映射 Mappings"></a>映射 Mappings</h5><p>为了能够将时间域视为时间，数字域视为数字，字符串域视为全文本或精确值字符串， Elasticsearch 需要知道每个域中数据的类型。这个信息包含在映射中。</p>
<p>索引中每个文档都有 <strong>类型</strong>，每种类型都有它自己的 <strong>映射</strong>。映射定义了类型中的域，每个域的数据类型，以及 Elasticsearch 如何处理这些域。映射也用于配置与类型有关的元数据。</p>
<p>所有可用的域类型枚举如下：</p>
<ul>
<li>字符串: <code>string</code></li>
<li>整数: <code>byte</code>, <code>short</code>, <code>integer</code>, <code>long</code></li>
<li>浮点数: <code>float</code>, <code>double</code></li>
<li>布尔型: <code>boolean</code></li>
<li>日期: <code>date</code></li>
<li>多层级对象: <code>object</code></li>
</ul>
<p><strong>自定义域映射</strong></p>
<p>针对于简单域类型：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"number_of_clicks"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span><span class="token punctuation">,</span> <span class="token comment">// 指定类型</span>
        
        <span class="token comment">// analyzed 作为全文本域索引; </span>
        <span class="token comment">// not_analyzed 作为精确值索引;</span>
        <span class="token comment">// no 不索引.</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token string">"not_analyzed"</span><span class="token punctuation">,</span> 
        
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"whitespace"</span> <span class="token comment">// 分析器 默认为 standard</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>针对于多层级对象：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"gb"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"tweet"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> 
      <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"tweet"</span><span class="token operator">:</span>            <span class="token punctuation">&#123;</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"user"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> 
          <span class="token property">"type"</span><span class="token operator">:</span>             <span class="token string">"object"</span><span class="token punctuation">,</span>
          <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"id"</span><span class="token operator">:</span>           <span class="token punctuation">&#123;</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token property">"gender"</span><span class="token operator">:</span>       <span class="token punctuation">&#123;</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token property">"age"</span><span class="token operator">:</span>          <span class="token punctuation">&#123;</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token property">"name"</span><span class="token operator">:</span>   <span class="token punctuation">&#123;</span> 
              <span class="token property">"type"</span><span class="token operator">:</span>         <span class="token string">"object"</span><span class="token punctuation">,</span>
              <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token property">"full"</span><span class="token operator">:</span>     <span class="token punctuation">&#123;</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token property">"first"</span><span class="token operator">:</span>    <span class="token punctuation">&#123;</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token property">"last"</span><span class="token operator">:</span>     <span class="token punctuation">&#123;</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span> <span class="token punctuation">&#125;</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>事实上这将被索引为：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"tweet"</span><span class="token operator">:</span>            <span class="token punctuation">[</span>elasticsearch<span class="token punctuation">,</span> flexible<span class="token punctuation">,</span> very<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"user.id"</span><span class="token operator">:</span>          <span class="token punctuation">[</span>@johnsmith<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"user.gender"</span><span class="token operator">:</span>      <span class="token punctuation">[</span>male<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"user.age"</span><span class="token operator">:</span>         <span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"user.name.full"</span><span class="token operator">:</span>   <span class="token punctuation">[</span>john<span class="token punctuation">,</span> smith<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"user.name.first"</span><span class="token operator">:</span>  <span class="token punctuation">[</span>john<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"user.name.last"</span><span class="token operator">:</span>   <span class="token punctuation">[</span>smith<span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>总结起来，我们可以在 <code>[PUT] /my_index</code> 时使用：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"tweet"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 类型名</span>
      <span class="token property">"properties"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"tweet"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span> <span class="token operator">:</span>    <span class="token string">"string"</span><span class="token punctuation">,</span>
          <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"english"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"date"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span> <span class="token operator">:</span>   <span class="token string">"date"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span> <span class="token operator">:</span>   <span class="token string">"string"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"user_id"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span> <span class="token operator">:</span>   <span class="token string">"long"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="数据操作"><a href="#数据操作" class="headerlink" title="数据操作"></a>数据操作</h3><h4 id="新增记录"><a href="#新增记录" class="headerlink" title="新增记录"></a>新增记录</h4><ul>
<li><code>[PUT] /Index/Type/Id</code></li>
</ul>
<p>比如，向<code>/accounts/person</code>发送请求，就可以新增一条人员记录。服务器返回的 JSON 对象，会给出 Index、Type、Id、Version 等信息。</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"_index"</span><span class="token operator">:</span><span class="token string">"accounts"</span><span class="token punctuation">,</span>
  <span class="token property">"_type"</span><span class="token operator">:</span><span class="token string">"person"</span><span class="token punctuation">,</span>
  <span class="token property">"_id"</span><span class="token operator">:</span><span class="token string">"1"</span><span class="token punctuation">,</span>
  <span class="token property">"_version"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"result"</span><span class="token operator">:</span><span class="token string">"created"</span><span class="token punctuation">,</span>
  <span class="token property">"_shards"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"total"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">"successful"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"failed"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"created"</span><span class="token operator">:</span><span class="token boolean">true</span>
<span class="token punctuation">&#125;</span></code></pre>
<ul>
<li><code>[POST] /Index/Type</code></li>
</ul>
<p>新增记录的时候，也可以不指定 Id，这时要改成 POST 请求。这时，服务器返回的 JSON 对象里面，<code>_id</code>字段就是一个随机字符串。</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"_index"</span><span class="token operator">:</span><span class="token string">"accounts"</span><span class="token punctuation">,</span>
  <span class="token property">"_type"</span><span class="token operator">:</span><span class="token string">"person"</span><span class="token punctuation">,</span>
  <span class="token property">"_id"</span><span class="token operator">:</span><span class="token string">"AV3qGfrC6jMbsbXb6k1p"</span><span class="token punctuation">,</span>
  <span class="token property">"_version"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"result"</span><span class="token operator">:</span><span class="token string">"created"</span><span class="token punctuation">,</span>
  <span class="token property">"_shards"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"total"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">"successful"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"failed"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"created"</span><span class="token operator">:</span><span class="token boolean">true</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>注意，如果没有先创建 Index（这个例子是<code>accounts</code>），直接执行上面的命令，Elastic 也不会报错，而是直接生成指定的 Index。</p>
<h4 id="查看记录"><a href="#查看记录" class="headerlink" title="查看记录"></a>查看记录</h4><ul>
<li><code>[GET] /Index/Type/Id</code></li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">curl</span> <span class="token string">'localhost:9200/accounts/person/1?pretty=true'</span></code></pre>
<p>上面代码请求查看<code>/accounts/person/1</code>这条记录，URL 的参数<code>pretty=true</code>表示以易读的格式返回。</p>
<p>返回的数据中，<code>found</code>字段表示查询成功，<code>_source</code>字段返回原始记录。</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"accounts"</span><span class="token punctuation">,</span>
  <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"person"</span><span class="token punctuation">,</span>
  <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
  <span class="token property">"_version"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"found"</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"user"</span> <span class="token operator">:</span> <span class="token string">"张三"</span><span class="token punctuation">,</span>
    <span class="token property">"title"</span> <span class="token operator">:</span> <span class="token string">"工程师"</span><span class="token punctuation">,</span>
    <span class="token property">"desc"</span> <span class="token operator">:</span> <span class="token string">"数据库管理"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>如果 Id 不正确，就查不到数据，<code>found</code>字段就是<code>false</code>。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">curl</span> <span class="token string">'localhost:9200/weather/beijing/abc?pretty=true'</span>

<span class="token punctuation">&#123;</span>
  <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"accounts"</span>,
  <span class="token string">"_type"</span> <span class="token builtin class-name">:</span> <span class="token string">"person"</span>,
  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"abc"</span>,
  <span class="token string">"found"</span> <span class="token builtin class-name">:</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span></code></pre>
<h4 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h4><ul>
<li><code>[PUT] /Index/Type/Id</code></li>
</ul>
<p>更新记录就是使用 PUT 请求，重新发送一次数据。比如我们将原始数据从”数据库管理”改成”数据库管理，软件开发”。 返回结果里面，有几个字段发生了变化。</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token property">"_version"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token property">"result"</span> <span class="token operator">:</span> <span class="token string">"updated"</span><span class="token punctuation">,</span>
<span class="token property">"created"</span> <span class="token operator">:</span> <span class="token boolean">false</span></code></pre>
<p>可以看到，记录的 Id 没变，但是版本（version）从 <code>1</code> 变成 <code>2</code>，操作类型（result）从 <code>created</code> 变成 <code>updated</code>，<code>created</code> 字段变成 <code>false</code>，因为这次不是新建记录。</p>
<h4 id="部分更新记录"><a href="#部分更新记录" class="headerlink" title="部分更新记录"></a>部分更新记录</h4><p>使用 <code>update</code> API 我们还可以部分更新文档，例如在某个请求时对计数器进行累加。</p>
<ul>
<li><code>[POST] /Index/Type/Id/_update</code></li>
</ul>
<p><code>update</code> 请求最简单的一种形式是接收文档的一部分作为 <code>doc</code> 的参数， 它只是与现有的文档进行合并。对象被合并到一起，覆盖现有的字段，增加新的字段。 例如，我们增加字段 <code>tags</code> 和 <code>views</code> 到我们的博客文章：</p>
<pre class="language-json" data-language="json"><code class="language-json">POST /website/blog/<span class="token number">1</span>/_update
<span class="token punctuation">&#123;</span>
   <span class="token property">"doc"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"tags"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"testing"</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"views"</span><span class="token operator">:</span> <span class="token number">0</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>如果请求成功，我们看到类似于 <code>index</code> 请求的响应：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
   <span class="token property">"_index"</span> <span class="token operator">:</span>   <span class="token string">"website"</span><span class="token punctuation">,</span>
   <span class="token property">"_id"</span> <span class="token operator">:</span>      <span class="token string">"1"</span><span class="token punctuation">,</span>
   <span class="token property">"_type"</span> <span class="token operator">:</span>    <span class="token string">"blog"</span><span class="token punctuation">,</span>
   <span class="token property">"_version"</span> <span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">&#125;</span></code></pre>
<h4 id="删除记录"><a href="#删除记录" class="headerlink" title="删除记录"></a>删除记录</h4><ul>
<li><code>[DELETE] /Index/Type/Id</code></li>
</ul>
<h4 id="取回多个文档"><a href="#取回多个文档" class="headerlink" title="取回多个文档"></a>取回多个文档</h4><p>将多个请求合并成一个，避免单独处理每个请求花费的网络延时和开销。如果你需要从 Elasticsearch 检索很多文档，那么使用 <code>mget</code> API 来将这些检索请求放在一个请求中，将比逐个文档请求更快地检索到全部文档。<strong>每个文档都是单独检索和报告的。</strong>要想知道请求数组中某个请求是否确实找到，检查 <code>found</code> 字段。</p>
<pre class="language-json" data-language="json"><code class="language-json">GET /_mget
<span class="token punctuation">&#123;</span>
   <span class="token property">"docs"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
         <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"website"</span><span class="token punctuation">,</span>
         <span class="token property">"_type"</span> <span class="token operator">:</span>  <span class="token string">"blog"</span><span class="token punctuation">,</span>
         <span class="token property">"_id"</span> <span class="token operator">:</span>    <span class="token number">2</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
         <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"website"</span><span class="token punctuation">,</span>
         <span class="token property">"_type"</span> <span class="token operator">:</span>  <span class="token string">"pageviews"</span><span class="token punctuation">,</span>
         <span class="token property">"_id"</span> <span class="token operator">:</span>    <span class="token number">1</span><span class="token punctuation">,</span>
         <span class="token property">"_source"</span><span class="token operator">:</span> <span class="token string">"views"</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>返回值：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
   <span class="token property">"docs"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
         <span class="token property">"_index"</span> <span class="token operator">:</span>   <span class="token string">"website"</span><span class="token punctuation">,</span>
         <span class="token property">"_id"</span> <span class="token operator">:</span>      <span class="token string">"2"</span><span class="token punctuation">,</span>
         <span class="token property">"_type"</span> <span class="token operator">:</span>    <span class="token string">"blog"</span><span class="token punctuation">,</span>
         <span class="token property">"found"</span> <span class="token operator">:</span>    <span class="token boolean">true</span><span class="token punctuation">,</span>
         <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"text"</span> <span class="token operator">:</span>  <span class="token string">"This is a piece of cake..."</span><span class="token punctuation">,</span>
            <span class="token property">"title"</span> <span class="token operator">:</span> <span class="token string">"My first external blog entry"</span>
         <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
         <span class="token property">"_version"</span> <span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
         <span class="token property">"_index"</span> <span class="token operator">:</span>   <span class="token string">"website"</span><span class="token punctuation">,</span>
         <span class="token property">"_id"</span> <span class="token operator">:</span>      <span class="token string">"1"</span><span class="token punctuation">,</span>
         <span class="token property">"_type"</span> <span class="token operator">:</span>    <span class="token string">"pageviews"</span><span class="token punctuation">,</span>
         <span class="token property">"found"</span> <span class="token operator">:</span>    <span class="token boolean">true</span><span class="token punctuation">,</span>
         <span class="token property">"_version"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
         <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"views"</span> <span class="token operator">:</span> <span class="token number">2</span>
         <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>
<h4 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h4><p>与 <code>mget</code> 可以使我们一次取回多个文档同样的方式， <code>bulk</code> API 允许在单个步骤中进行多次 <code>create</code> 、 <code>index</code> 、 <code>update</code> 或 <code>delete</code> 请求。 如果你需要索引一个数据流比如日志事件，它可以排队和索引数百或数千批次。</p>
<p><code>bulk</code> 与其他的请求体格式稍有不同，如下所示：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span> action<span class="token operator">:</span> <span class="token punctuation">&#123;</span> metadata <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>\n
<span class="token punctuation">&#123;</span> request body1        <span class="token punctuation">&#125;</span>\n
<span class="token punctuation">&#123;</span> action<span class="token operator">:</span> <span class="token punctuation">&#123;</span> metadata <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>\n
<span class="token punctuation">&#123;</span> request body2        <span class="token punctuation">&#125;</span>\n
...</code></pre>
<p>这种格式就是每行写一个 JSON 格式的数据，通过换行符(<code>\n</code>)连接到一起。注意两个要点：</p>
<ul>
<li>每行一定要以换行符(<code>\n</code>)结尾，<strong>包括最后一行</strong>。这些换行符被用作一个标记，可以有效分隔行。</li>
<li>这些行不能包含未转义的换行符，因为他们将会对解析造成干扰。这意味着这个 JSON不能使用 pretty 参数打印。</li>
</ul>
<p><code>action</code> 必须是以下选项之一:</p>
<ul>
<li><strong><code>create</code></strong>：如果文档不存在，那么就创建它。</li>
<li><strong><code>index</code></strong>：创建一个新文档或者替换一个现有的文档。</li>
<li><strong><code>update</code></strong>：部分更新一个文档。</li>
<li><strong><code>delete</code></strong>：删除一个文档。不需要再另附一行请求体。</li>
</ul>
<p><code>metadata</code> 应该指定被索引、创建、更新或者删除的文档的 <code>_index</code> 、 <code>_type</code> 和 <code>_id</code> 。</p>
<p>举个例子：</p>
<pre class="language-json" data-language="json"><code class="language-json">POST /_bulk
<span class="token punctuation">&#123;</span> <span class="token property">"delete"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"website"</span><span class="token punctuation">,</span> <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"blog"</span><span class="token punctuation">,</span> <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"123"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> 
<span class="token punctuation">&#123;</span> <span class="token property">"create"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"website"</span><span class="token punctuation">,</span> <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"blog"</span><span class="token punctuation">,</span> <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"123"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token property">"title"</span><span class="token operator">:</span>    <span class="token string">"My first blog post"</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token property">"index"</span><span class="token operator">:</span>  <span class="token punctuation">&#123;</span> <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"website"</span><span class="token punctuation">,</span> <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"blog"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token property">"title"</span><span class="token operator">:</span>    <span class="token string">"My second blog post"</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token property">"update"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"website"</span><span class="token punctuation">,</span> <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"blog"</span><span class="token punctuation">,</span> <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"123"</span><span class="token punctuation">,</span> <span class="token property">"_retry_on_conflict"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token property">"doc"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"title"</span> <span class="token operator">:</span> <span class="token string">"My updated blog post"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> </code></pre>
<p>返回值：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
   <span class="token property">"took"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
   <span class="token property">"errors"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> 
   <span class="token property">"items"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>  <span class="token property">"delete"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"_index"</span><span class="token operator">:</span>   <span class="token string">"website"</span><span class="token punctuation">,</span>
            <span class="token property">"_type"</span><span class="token operator">:</span>    <span class="token string">"blog"</span><span class="token punctuation">,</span>
            <span class="token property">"_id"</span><span class="token operator">:</span>      <span class="token string">"123"</span><span class="token punctuation">,</span>
            <span class="token property">"_version"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token property">"status"</span><span class="token operator">:</span>   <span class="token number">200</span><span class="token punctuation">,</span>
            <span class="token property">"found"</span><span class="token operator">:</span>    <span class="token boolean">true</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>  <span class="token property">"create"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"_index"</span><span class="token operator">:</span>   <span class="token string">"website"</span><span class="token punctuation">,</span>
            <span class="token property">"_type"</span><span class="token operator">:</span>    <span class="token string">"blog"</span><span class="token punctuation">,</span>
            <span class="token property">"_id"</span><span class="token operator">:</span>      <span class="token string">"123"</span><span class="token punctuation">,</span>
            <span class="token property">"_version"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token property">"status"</span><span class="token operator">:</span>   <span class="token number">201</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>  <span class="token property">"create"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"_index"</span><span class="token operator">:</span>   <span class="token string">"website"</span><span class="token punctuation">,</span>
            <span class="token property">"_type"</span><span class="token operator">:</span>    <span class="token string">"blog"</span><span class="token punctuation">,</span>
            <span class="token property">"_id"</span><span class="token operator">:</span>      <span class="token string">"EiwfApScQiiy7TIKFxRCTw"</span><span class="token punctuation">,</span>
            <span class="token property">"_version"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">"status"</span><span class="token operator">:</span>   <span class="token number">201</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>  <span class="token property">"update"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"_index"</span><span class="token operator">:</span>   <span class="token string">"website"</span><span class="token punctuation">,</span>
            <span class="token property">"_type"</span><span class="token operator">:</span>    <span class="token string">"blog"</span><span class="token punctuation">,</span>
            <span class="token property">"_id"</span><span class="token operator">:</span>      <span class="token string">"123"</span><span class="token punctuation">,</span>
            <span class="token property">"_version"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
            <span class="token property">"status"</span><span class="token operator">:</span>   <span class="token number">200</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>批量大小选择：一个好的办法是开始时将 1,000 到 5,000 个文档作为一个批次, 如果你的文档非常大，那么就减少批量的文档个数。一个好的批量大小在开始处理后所占用的物理大小约为 <strong>5-15 MB</strong>。</p>
<h3 id="数据查询"><a href="#数据查询" class="headerlink" title="数据查询"></a>数据查询</h3><h4 id="返回所有记录"><a href="#返回所有记录" class="headerlink" title="返回所有记录"></a>返回所有记录</h4><ul>
<li><code>[GET] /Index/Type/_search</code></li>
</ul>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"took"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">"timed_out"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">"_shards"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"total"</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token property">"successful"</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token property">"failed"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"hits"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
    <span class="token property">"total"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">"max_score"</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token property">"hits"</span><span class="token operator">:</span><span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token property">"_index"</span><span class="token operator">:</span><span class="token string">"accounts"</span><span class="token punctuation">,</span>
        <span class="token property">"_type"</span><span class="token operator">:</span><span class="token string">"person"</span><span class="token punctuation">,</span>
        <span class="token property">"_id"</span><span class="token operator">:</span><span class="token string">"AV3qGfrC6jMbsbXb6k1p"</span><span class="token punctuation">,</span>
        <span class="token property">"_score"</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"user"</span><span class="token operator">:</span> <span class="token string">"李四"</span><span class="token punctuation">,</span>
          <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"工程师"</span><span class="token punctuation">,</span>
          <span class="token property">"desc"</span><span class="token operator">:</span> <span class="token string">"系统管理"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token property">"_index"</span><span class="token operator">:</span><span class="token string">"accounts"</span><span class="token punctuation">,</span>
        <span class="token property">"_type"</span><span class="token operator">:</span><span class="token string">"person"</span><span class="token punctuation">,</span>
        <span class="token property">"_id"</span><span class="token operator">:</span><span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token property">"_score"</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"user"</span> <span class="token operator">:</span> <span class="token string">"张三"</span><span class="token punctuation">,</span>
          <span class="token property">"title"</span> <span class="token operator">:</span> <span class="token string">"工程师"</span><span class="token punctuation">,</span>
          <span class="token property">"desc"</span> <span class="token operator">:</span> <span class="token string">"数据库管理，软件开发"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>上面代码中，返回结果的 <code>took</code> 字段表示该操作的耗时（单位为毫秒），<code>timed_out</code> 字段表示是否超时，<code>hits</code> 字段表示命中的记录，里面子字段的含义如下。</p>
<ul>
<li><code>total</code>：返回记录数，本例是 2 条。</li>
<li><code>max_score</code>：最高的匹配程度，本例是 <code>1.0</code>。</li>
<li><code>hits</code>：返回的记录组成的数组。</li>
</ul>
<p>返回的记录中，每条记录都有一个<code>_score</code>字段，表示匹配的程序，默认是按照这个字段降序排列。</p>
<h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><ul>
<li><code>[GET] /Index/Type?size=10&amp;from=10</code></li>
</ul>
<p>分页实现的逻辑：</p>
<p>当我们请求结果的第一页（结果从 1 到 10），每一个分片产生前 10 的结果，并且返回给 <strong>协调节点</strong> ，协调节点对 50 个结果排序得到全部结果的前 10 个。</p>
<p>现在假设我们请求第 1000 页 —— 结果从 10001 到 10010。所有都以相同的方式工作除了每个分片不得不产生前 10010 个结果以外。然后协调节点对全部 50050 个结果排序最后丢弃掉这些结果中的 50040 个结果。</p>
<p>可以看到，在分布式系统中，对结果排序的成本随分页的深度成指数上升。这就是 Web 搜索引擎对任何查询都不要返回超过 1000 个结果的原因。</p>
<h4 id="搜索-API：轻量版"><a href="#搜索-API：轻量版" class="headerlink" title="搜索 API：轻量版"></a>搜索 API：轻量版</h4><p>有两种形式的 <code>搜索</code> API：一种是 “轻量的” <strong>查询字符串</strong> 版本，要求在查询字符串中传递所有的参数，另一种是更完整的 <strong>请求体</strong> 版本，要求使用 JSON 格式和更丰富的查询表达式作为搜索语言。</p>
<p>在 <code>name</code> 字段中包含 <code>john</code> 并且在 <code>tweet</code> 字段中包含 <code>mary</code> 的文档。实际的查询就是这样：</p>
<pre class="language-none"><code class="language-none">+name:john +tweet:mary</code></pre>
<p>但是查询字符串参数所需要的 URL 编码实际上更加难懂：</p>
<p><code>[GET] /_search?q=%2Bname%3Ajohn+%2Btweet%3Amary</code></p>
<p>下面的查询使用以下的条件：</p>
<ul>
<li><code>name</code> 字段中包含 <code>mary</code> 或者 <code>john</code></li>
<li><code>date</code> 值大于 <code>2014-09-10</code></li>
<li><code>_all</code> 字段包含 <code>aggregations</code> 或者 <code>geo</code>（除非设置特定字段，否则查询字符串就使用 <code>_all</code> 字段进行搜索）</li>
</ul>
<pre class="language-sense" data-language="sense"><code class="language-sense">+name:(mary john) +date:&gt;2014-09-10 +(aggregations geo)</code></pre>
<p>从之前的例子中可以看出，这种 <strong>轻量</strong> 的查询字符串搜索效果还是挺让人惊喜的。 它的查询语法在相关参考文档中有详细解释，以便简洁的表达很复杂的查询。对于通过命令做一次性查询，或者是在开发阶段，都非常方便。</p>
<p>但同时也可以看到，这种精简让调试更加晦涩和困难。而且很脆弱，一些查询字符串中很小的语法错误，像 <code>-</code>，<code>:</code>，<code>/</code> 或者 <code>&quot;</code> 不匹配等，将会返回错误而不是搜索结果。</p>
<p>最后，查询字符串搜索允许任何用户在索引的任意字段上执行可能较慢且重量级的查询，这可能会暴露隐私信息，甚至将集群拖垮。</p>
<p>相反，我们经常在生产环境中更多地使用功能全面的 <strong>request body</strong> 查询 API，除了能完成以上所有功能，还有一些附加功能。</p>
<h4 id="搜索-API：请求体"><a href="#搜索-API：请求体" class="headerlink" title="搜索 API：请求体"></a>搜索 API：请求体</h4><h5 id="返回所有记录与分页"><a href="#返回所有记录与分页" class="headerlink" title="返回所有记录与分页"></a>返回所有记录与分页</h5><p><code>[GET/POST] /Index/Type/_search</code></p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span>
<span class="token punctuation">&#125;</span></code></pre>
<h5 id="查询语句"><a href="#查询语句" class="headerlink" title="查询语句"></a>查询语句</h5><p><strong>查询语句（Query clauses）</strong>就像一些简单的组合块，这些组合块可以彼此之间合并组成更复杂的查询。这些语句可以是如下形式：</p>
<ul>
<li><strong>叶子语句（Leaf clauses）</strong>(比如 <code>match</code> 语句) 被用于将查询字符串和一个字段（或者多个字段）对比。</li>
<li><strong>复合(Compound)</strong> 语句主要用于合并其它查询语句。 比如，一个 <code>bool</code> 语句允许在你需要的时候组合其它语句，无论是 <code>must</code> 匹配、 <code>must_not</code> 匹配还是 <code>should</code> 匹配，同时它可以包含不评分的过滤器（filters）：</li>
</ul>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"must"</span><span class="token operator">:</span>     <span class="token punctuation">&#123;</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"tweet"</span><span class="token operator">:</span> <span class="token string">"elasticsearch"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"must_not"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"name"</span><span class="token operator">:</span>  <span class="token string">"mary"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"should"</span><span class="token operator">:</span>   <span class="token punctuation">&#123;</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"tweet"</span><span class="token operator">:</span> <span class="token string">"full text"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"filter"</span><span class="token operator">:</span>   <span class="token punctuation">&#123;</span> <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"age"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"gt"</span> <span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h5 id="查询与过滤"><a href="#查询与过滤" class="headerlink" title="查询与过滤"></a>查询与过滤</h5><p>我们的搜索一般有以下两种情况：过滤情况（filtering context）和查询情况（query context）。</p>
<p>当使用于 <strong>过滤情况</strong> 时，查询被设置成一个“不评分”或者“过滤”查询。即，这个查询只是简单的问一个问题：“这篇文档是否匹配？”。回答也是非常的简单，yes 或者 no ，二者必居其一。</p>
<p>当使用于 <strong>查询情况</strong> 时，查询就变成了一个“评分”的查询。和不评分的查询类似，也要去判断这个文档是否匹配，同时它还需要判断这个文档匹配的有 <strong>多好</strong>（匹配程度如何）。一个评分查询计算每一个文档与此查询的 <strong>相关程度</strong>，同时将这个相关程度分配给表示相关性的字段 <code>_score</code>，并且按照相关性对匹配到的文档进行排序。这种相关性的概念是非常适合全文搜索的情况，因为全文搜索几乎没有完全 “正确” 的答案。</p>
<p>在一般情况下，一个 filter 会比一个 query 性能更优异，并且每次都表现的很稳定。</p>
<p>通常的规则是，使用查询（query）语句来进行 <strong>全文</strong> 搜索或者其它任何需要影响 <strong>相关性得分</strong> 的搜索。除此以外的情况都使用过滤（filters)。</p>
<h5 id="Leaf-Clauses"><a href="#Leaf-Clauses" class="headerlink" title="Leaf Clauses"></a>Leaf Clauses</h5><ul>
<li><code>match_all</code></li>
</ul>
<p><code>match_all</code> 查询简单的匹配所有文档。在没有指定查询方式时，它是默认的查询：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span> <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>
<p>它经常与 filter 结合使用—例如，检索收件箱里的所有邮件。所有邮件被认为具有相同的相关性，所以都将获得分值为 <code>1</code> 的中性 <code>_score</code>。</p>
<ul>
<li><code>match</code></li>
</ul>
<p>无论你在任何字段上进行的是全文搜索还是精确查询，<code>match</code> 查询是你可用的标准查询。如果你在一个全文字段上使用 <code>match</code> 查询，<strong>在执行查询前，它将用正确的分析器去分析查询字符串</strong>。也就是说，如果在一个精确值的字段上使用它，例如数字、日期、布尔或者一个 <code>not_analyzed</code> 字符串字段，那么它将会精确匹配给定的值。</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"tweet"</span><span class="token operator">:</span> <span class="token string">"About Search"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>
<ul>
<li><code>multi_match</code></li>
</ul>
<p><code>multi_match</code> 查询可以在多个字段上执行相同的 <code>match</code> 查询：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"multi_match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"query"</span><span class="token operator">:</span>    <span class="token string">"full text search"</span><span class="token punctuation">,</span>
        <span class="token property">"fields"</span><span class="token operator">:</span>   <span class="token punctuation">[</span> <span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">"body"</span> <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<ul>
<li><code>range</code></li>
</ul>
<p><code>range</code> 查询找出那些落在指定区间内的数字或者时间：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"age"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"gte"</span><span class="token operator">:</span>  <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token property">"lt"</span><span class="token operator">:</span>   <span class="token number">30</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>被允许的操作符如下：</p>
<ul>
<li><strong><code>gt</code></strong>：大于</li>
<li><strong><code>gte</code></strong>：大于等于</li>
<li><strong><code>lt</code></strong>：小于</li>
<li><strong><code>lte</code></strong>：小于等于</li>
</ul>
<ul>
<li><code>term</code></li>
</ul>
<p><code>term</code> 查询被用于精确值匹配，这些精确值可能是数字、时间、布尔或者那些 <code>not_analyzed</code> 的字符串：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span> <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"age"</span><span class="token operator">:</span>    <span class="token number">26</span>           <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"date"</span><span class="token operator">:</span>   <span class="token string">"2014-09-01"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"public"</span><span class="token operator">:</span> <span class="token boolean">true</span>         <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"tag"</span><span class="token operator">:</span>    <span class="token string">"full_text"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>
<p><code>term</code> 查询对于输入的文本不分析，所以它将给定的值进行精确查询。</p>
<ul>
<li><code>terms</code></li>
</ul>
<p><code>terms</code> 查询和 <code>term</code> 查询一样，但它允许你指定多值进行匹配。如果这个字段包含了指定值中的任何一个值，那么这个文档满足条件：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span> <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"tag"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"search"</span><span class="token punctuation">,</span> <span class="token string">"full_text"</span><span class="token punctuation">,</span> <span class="token string">"nosql"</span> <span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>
<ul>
<li><code>exists / missing</code></li>
</ul>
<p><code>exists</code> 查询和 <code>missing</code> 查询被用于查找那些指定字段中有值 (<code>exists</code>) 或无值 (<code>missing</code>) 的文档。这与SQL中的 <code>IS_NULL</code> (<code>missing</code>) 和 <code>NOT IS_NULL</code> (<code>exists</code>) 在本质上具有共性：</p>
<pre class="language-sense" data-language="sense"><code class="language-sense">&#123;
    &quot;exists&quot;:   &#123;
        &quot;field&quot;:    &quot;title&quot;
    &#125;
&#125;</code></pre>
<h5 id="Compound-Clauses"><a href="#Compound-Clauses" class="headerlink" title="Compound Clauses"></a>Compound Clauses</h5><p>现实的查询需求从来都没有那么简单；它们需要在多个字段上查询多种多样的文本，并且根据一系列的标准来过滤。为了构建类似的高级查询，你需要一种能够将多查询组合成单一查询的查询方法。</p>
<p>你可以用 <code>bool</code> 查询来实现你的需求。这种查询将多查询组合在一起，成为用户自己想要的布尔查询。它接收以下参数：</p>
<ul>
<li><strong><code>must</code></strong>：文档 <strong>必须</strong> 匹配这些条件才能被包含进来。</li>
<li><strong><code>must_not</code></strong>：文档 <strong>必须不</strong> 匹配这些条件才能被包含进来。</li>
<li><strong><code>should</code></strong>：如果满足这些语句中的任意语句，将增加 <code>_score</code> ，否则，无任何影响。它们主要用于修正每个文档的相关性得分。</li>
<li><strong><code>filter</code></strong>：<strong>必须</strong> 匹配，但它以不评分、过滤模式来进行。这些语句对评分没有贡献，只是根据过滤标准来排除或包含文档。</li>
</ul>
<p>例子：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"must"</span><span class="token operator">:</span>     <span class="token punctuation">&#123;</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"how to make millions"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"must_not"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"tag"</span><span class="token operator">:</span>   <span class="token string">"spam"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"should"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"tag"</span><span class="token operator">:</span> <span class="token string">"starred"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> 
              <span class="token property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                  <span class="token punctuation">&#123;</span> <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"date"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"gte"</span><span class="token operator">:</span> <span class="token string">"2014-01-01"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                  <span class="token punctuation">&#123;</span> <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">29.99</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
              <span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token property">"must_not"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                  <span class="token punctuation">&#123;</span> <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"ebooks"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
              <span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"desc"</span><span class="token operator">:</span> <span class="token string">"软件"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"desc"</span><span class="token operator">:</span> <span class="token string">"系统"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h2 id="网站搭建纪实：前端"><a href="#网站搭建纪实：前端" class="headerlink" title="网站搭建纪实：前端"></a>网站搭建纪实：前端</h2><p>没啥好讲的，用的是自己最熟悉的 React+Redux 框架半天肝了个 Prototype…</p>
<p>嘛嘛，反正前端不是主要部分啦x</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jiangxinyang/p/10516302.html">https://www.cnblogs.com/jiangxinyang/p/10516302.html</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/79202151">https://zhuanlan.zhihu.com/p/79202151</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</a></li>
<li><a target="_blank" rel="noopener" href="https://cuiqingcai.com/6214.html">https://cuiqingcai.com/6214.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2017/08/elasticsearch.html">https://www.ruanyifeng.com/blog/2017/08/elasticsearch.html</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">c7w</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.c7w.tech/elasticsearch/">https://www.c7w.tech/elasticsearch/</a></span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ElasticSearch/">ElasticSearch</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/eslint/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ESLint 配置指北</div></div></a></div><div class="next-post pull-right"><a href="/latex/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">LaTeX 从入坑到退坑</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2022/01/03/i8fNgXEPZDqnIlS.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">c7w</div><div class="author-info__description">Forever a c7w.</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">54</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/c7w" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:cc7w@foxmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://twitter.com/c7wc7w" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%AE%97%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">索引算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TF-IDF"><span class="toc-number">1.1.</span> <span class="toc-text">TF-IDF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BM25"><span class="toc-number">1.2.</span> <span class="toc-text">BM25</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%AB%99%E6%90%AD%E5%BB%BA%E7%BA%AA%E5%AE%9E%EF%BC%9AElasticsearch"><span class="toc-number">2.</span> <span class="toc-text">网站搭建纪实：Elasticsearch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-%E4%B8%8E-Cluster"><span class="toc-number">2.1.</span> <span class="toc-text">Node 与 Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">2.1.1.</span> <span class="toc-text">集群与分布式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Document"><span class="toc-number">2.2.</span> <span class="toc-text">Document</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Indexing"><span class="toc-number">2.3.</span> <span class="toc-text">Indexing</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E4%B8%8E%E4%B8%AD%E6%96%87%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">2.3.1.</span> <span class="toc-text">索引与中文分析器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%99%A8-Analysis"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">分析器 Analysis</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Type-amp-Mappings"><span class="toc-number">2.3.2.</span> <span class="toc-text">Type &amp; Mappings</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%A0%E5%B0%84-Mappings"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">映射 Mappings</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">2.4.</span> <span class="toc-text">数据操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E8%AE%B0%E5%BD%95"><span class="toc-number">2.4.1.</span> <span class="toc-text">新增记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%AE%B0%E5%BD%95"><span class="toc-number">2.4.2.</span> <span class="toc-text">查看记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95"><span class="toc-number">2.4.3.</span> <span class="toc-text">更新记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95"><span class="toc-number">2.4.4.</span> <span class="toc-text">部分更新记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%AE%B0%E5%BD%95"><span class="toc-number">2.4.5.</span> <span class="toc-text">删除记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%96%E5%9B%9E%E5%A4%9A%E4%B8%AA%E6%96%87%E6%A1%A3"><span class="toc-number">2.4.6.</span> <span class="toc-text">取回多个文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="toc-number">2.4.7.</span> <span class="toc-text">批量操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.5.</span> <span class="toc-text">数据查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E6%89%80%E6%9C%89%E8%AE%B0%E5%BD%95"><span class="toc-number">2.5.1.</span> <span class="toc-text">返回所有记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5"><span class="toc-number">2.5.2.</span> <span class="toc-text">分页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2-API%EF%BC%9A%E8%BD%BB%E9%87%8F%E7%89%88"><span class="toc-number">2.5.3.</span> <span class="toc-text">搜索 API：轻量版</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2-API%EF%BC%9A%E8%AF%B7%E6%B1%82%E4%BD%93"><span class="toc-number">2.5.4.</span> <span class="toc-text">搜索 API：请求体</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E6%89%80%E6%9C%89%E8%AE%B0%E5%BD%95%E4%B8%8E%E5%88%86%E9%A1%B5"><span class="toc-number">2.5.4.1.</span> <span class="toc-text">返回所有记录与分页</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5"><span class="toc-number">2.5.4.2.</span> <span class="toc-text">查询语句</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E4%B8%8E%E8%BF%87%E6%BB%A4"><span class="toc-number">2.5.4.3.</span> <span class="toc-text">查询与过滤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Leaf-Clauses"><span class="toc-number">2.5.4.4.</span> <span class="toc-text">Leaf Clauses</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Compound-Clauses"><span class="toc-number">2.5.4.5.</span> <span class="toc-text">Compound Clauses</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%AB%99%E6%90%AD%E5%BB%BA%E7%BA%AA%E5%AE%9E%EF%BC%9A%E5%89%8D%E7%AB%AF"><span class="toc-number">3.</span> <span class="toc-text">网站搭建纪实：前端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">4.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="framework-info"><span>Powered by Hexo &amp; Theme Butterfly &amp; GitHub Pages</span></div><div class="copyleft"><span>Copyright © 2020-2022 c7w. LICENSE CC BY-NC-SA 4.0.</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>